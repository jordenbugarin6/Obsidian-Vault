
This Learning Unit covers the following Learning Objectives:

1. Understand the basic syntax of XML
2. Understand the basic concepts of XML Entities

XML documents contain _markup_[1](https://portal.offsec.com/courses/web-200-28380/learning/xml-external-entities-30967/xml-external-entities-31472#fn-local_id_487-1) and content. The primary form of markup in XML are _tags_.[2](https://portal.offsec.com/courses/web-200-28380/learning/xml-external-entities-30967/xml-external-entities-31472#fn-local_id_487-2) Tags provide information about, or structure to, the content. When applications process an XML document, they use the markup to validate and organize the data.

The layout of an XML document somewhat resembles an HTML document. However, HTML has predefined tags (such as _div_, _img_, or _form_) and XML does not. Each XML document defines its own set of tags. The tags then define the elements and structures that make up the XML content within a given document.

For example, consider this simple XML document.

```xml
1  <?xml version="1.0" encoding="UTF-8"?>
2  <contact>
3    <firstName>Tom</firstName>
4    <lastName>Jones</lastName>
5  </contact>
```

Beginning on line 1, this document begins with an XML declaration, which is optional. Lines 2 through 5 define a _contact_ element. An element is defined as everything between (and including) corresponding start and end tags. In this example, the start tag for _contact_ is on line 2. The corresponding end tag is on line 5. The _firstName_ and _lastName_ elements on lines 4 and 4 are sub-elements of _contact_.

Element _attributes_ are defined within the start tag.
```xml
01  <?xml version="1.0" encoding="UTF-8"?>
02  <contacts>
03    <contact id="123">
04      <firstName>Tom</firstName>
05      <lastName>Jones</lastName>
06    </contact>
07    <contact id="456">
08      <firstName>Tom</firstName>
09      <lastName>Petty</lastName>
10    </contact>
11  </contacts>
```

In Listing 2, there are two _contact_ elements nested within one _contacts_ element. Each _contact_ element contains an _id_ attribute with a numeric value. Attribute values must be single- or double-quoted. Since XML does not require pre-defined structures, sub-elements and attributes are largely interchangeable.

This allows for flexibility but the document must be _well-formed_, meaning it must adhere to several rules.[3](https://portal.offsec.com/courses/web-200-28380/learning/xml-external-entities-30967/introduction-to-xml-31281/introduction-to-xml-31471#fn-local_id_487-3) An XML document must have a single root element that contains all other elements. Each element must have a beginning and an end tag unless it is an empty element. All tags are case sensitive, and elements must be nested correctly.

The "<" and ">" characters are reserved for tags. If an XML document needs to include these characters as text, the characters need to be encoded or enclosed in a _character data_[4](https://portal.offsec.com/courses/web-200-28380/learning/xml-external-entities-30967/introduction-to-xml-31281/introduction-to-xml-31471#fn-local_id_487-4) (CDATA) section. The format of a CDATA section is as follows.

```xml
<![CDATA[ content ]]>
```

An XML parser treats the contents of a CDATA section as text instead of markup. Unlike normal tags, a CDATA section is self-contained and does not use a separate closing tag. Instead, the "]]>" character sequence marks the end of the tag.

Most browsers include an XML parser. We can test this by opening a valid XML file in our browser. In our case, the Firefox browser on our Kali machine formats the XML and allows us to expand or contract elements within the document.

![[Pasted image 20240923191946.png]]
If an XML document is not well-formed, the browser will display an error message instead of the document. This is a simple way to quickly validate an XML document.

![[Pasted image 20240923192028.png]]
XML documents can define structures and data types with _Document Type Definitions_ (DTD)[5](https://portal.offsec.com/courses/web-200-28380/learning/xml-external-entities-30967/introduction-to-xml-31281/introduction-to-xml-31471#fn-local_id_487-5) and _Schemas_, which instruct the XML parser to enforce certain rules that may dictate which tags are required or what the data types should be.[6](https://portal.offsec.com/courses/web-200-28380/learning/xml-external-entities-30967/introduction-to-xml-31281/introduction-to-xml-31471#fn-local_id_487-6) If the XML document requires these, the document must contain an inline definition or link to the external DTD or Schema.

From the attacker's perspective, DTDs are a particularly interesting feature of XML that we will explore in this Learning Module.

--------------
#### 10.1.1. XML Entities

DTDs can be used to declare XML entities within an XML document. In very general terms, an XML entity is a data structure containing valid XML code that will be referenced multiple times in a document. It can also be thought of as a placeholder for content. We can define or modify it in a single place and it will be propagated throughout a given document with minimal effort, similar to a variable in a programming language.

DTDs are defined at the beginning of an XML document with a special _DOCTYPE_ tag as demonstrated below.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE name [ 
... one or more entities ...
]>
```

Unlike normal tags, the DOCTYPE and entity tags are not matched with a closing tag. Entities are defined within the square brackets.
Generally speaking, there are three types of XML entities: _internal_, _external_, and _parameter_. Let's briefly discuss each.

##### Internal Entities

Internal entities are _locally_ defined within the DTD. Their general format is as follows.
```xml
<!ENTITY name "entity_value">
```
This is a very trivial example of an internal entity.
```xml
<!ENTITY test "<entity-value>test value</entity-value>">
```
Note that an entity does not have any XML closing tags and uses a special declaration containing an exclamation mark. For example, the internal entity in Listing 6 is using a hardcoded string value that contains valid XML code.

##### External Entities

By definition, external entities are used when referencing data that is not defined locally within an XML document. As such, the URI from which the external data will be retrieved is a critical component of the external entity definition.
External entities can be split into two groups: _private_ and _public_. The syntax for a private external entity is:

```xml
<!ENTITY name SYSTEM "URI">
```
This is an example of a private external entity using an external endpoint.
```xml
<!ENTITY offsecinfo SYSTEM "http://www.offsec.com/company.xml">
```
The _SYSTEM_ keyword indicates that this is a _private_ external entity. Private external entities are designed to be used by a single developer or a group of developers at a company. In other words, this type of entity is not intended for public use.

By contrast, _public_ external entities are intended for a much wider audience. For example, this might be used when designing standards that use XML like (X)HTML or SVG.[1](https://portal.offsec.com/courses/web-200-28380/learning/xml-external-entities-30967/introduction-to-xml-31281/xml-entities-31030#fn-local_id_22-1) The syntax for a public external entity is:

```xml
<!ENTITY name PUBLIC "public_id" "URI">
```
This is an example of a public external entity.
```
<!ENTITY offsecinfo PUBLIC "-//W3C//TEXT companyinfo//EN" "http://www.offsec.com/companyinfo.xml">
```
The _PUBLIC_ keyword indicates that this is a public external entity.

Additionally, public external entities may specify a _public_id_. XML pre-processors use this value to generate alternate URIs for the externally-parsed entity. While it's important for developers to use the correct declaration, for our purposes we will treat "SYSTEM" and "PUBLIC" as synonymous.

##### Parameter Entities
Parameter entities exist solely within a DTD, but are otherwise very similar to any other entity. Their definition syntax differs only by the inclusion of the _%_ prefix.

```
<!ENTITY % name SYSTEM "URI">
```
In this example, a parameter entity is used along with an internal entity.
```
<!ENTITY % course 'WEB 200'>
<!ENTITY Title 'Offensive Security presents %course;'>
```
XML parsers expand parameter entities within a DTD so they can be combined in other entities as shown above. The value of the "Title" entity in this case would be "Offensive Security presents WEB 200".

The entities we have reviewed in this section are all "parsed" entities, but DTDs can also contain "unparsed" entities. As the name suggests, an XML parser does not parse these types of entities, making them similar to a CDATA section. Instead, an application handles the unparsed entity. We will not be discussing unparsed entities in this Learning Module.