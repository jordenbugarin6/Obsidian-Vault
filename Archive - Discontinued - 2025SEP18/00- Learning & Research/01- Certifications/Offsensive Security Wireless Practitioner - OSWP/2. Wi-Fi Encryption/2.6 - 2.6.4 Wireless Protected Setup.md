Also known as Wi-Fi Simple Configuration, this protocol allows users to pair devices to a network without having to enter the ESSID and/or its (sometimes complex) passphrase.

In the past, different vendors provided various solutions to this problem but they were incompatible between each other. The Wi-Fi alliance launched WPS in 2006 with the aim of standardizing the solutions.

WPS currently supports Open or WPA2 networks (with CCMP or GCMP) as well as WPA2 Enterprise networks. WPA (TKIP) has been deprecated in the current version of the specification.

Enrollment can be done in various ways such as using a push button on the access point, entering a PIN from a label, via a display on the Access Point, from its web interface (static or dynamic PIN), or using Near Field Communications (NFC) with tap to connect.

-----
### 2.6.1. WPS Architecture

WPS defines three components:

- Enrollee: a device seeking to join a WLAN
- Access point
- Registrar: an entity with the authority to issue or revoke credentials for a WLAN

There are three interfaces:

- **E:** logically located between the Enrollee and the Registrar. The purpose is for the Registrar to issue credentials to an Enrollee
- **M:** the interface between the Registrar and the Access Point. It manages and configures the access point
- **A:** enables the discovery of WPS access points (via IE in beacons) and for external registrars, enables communications between the enrollees and the registrars

![Figure 15: WPS components and interfaces](https://static.offsec.com/offsec-courses/PEN-210/images/Encryption/6a956b3404cd511929f19dcd53ea6131-Picture15.png)

Figure 15: WPS components and interfaces

Although the Registrar often runs on the access point (known as "standalone AP" or "internal registrar"), the Registrar and AP can be distinct systems, such as a mobile device used to configure the Enrollee. The Registrar can also be located on a centralized management interface.

Even though WPS is thought to be WPA-PSK only, it can technically also be used in some cases for WPA Enterprise. In the case of a WPA-PSK network, it is possible to have one client become a registrar and configure new clients.

-----
### 2.6.2. WPS Configuration Methods

A device supporting Wi-Fi Simple Configuration should always have a default PIN available (aka device password), printed on the AP or on a label affixed to it. However, it is recommended that the PIN be changeable by the end-user.

Two modes of operations are available: in-band configuration and out-of-band configuration. In-band is done via WLAN communication and out-of-band is done using any other communication channel or method, such as by using a NFC tag or USB thumbdrive.

Out-of-band can be unencrypted and has the advantage that it can be reused with multiple enrollees but if an attacker gets their hands on the media, they have the WLAN credentials. Out-of-band methods can also hold encrypted WLAN credentials. It uses the enrollee public key obtained over the WLAN channel. One last possibility is to do a Diffie-Hellman key exchange over NFC, then encrypt the credentials delivered to the NFC interface using AES.

In in-band, a Diffie-Hellman key exchange is done and authenticated using a shared secret (the device password) via manual entry or using NFC. In most cases, using a headless device, the PIN has to be 8-digit long (where the last digit is a checksum). If the device has a display, the PIN can be either 8 or 4 digits long but in this case, it has to be randomly generated.

-----
### 2.6.3. WPS Protocol

The WPS protocol varies based on the different possible scenarios. We will only address the most common scenario where the enrollee uses WPS PIN on a standalone AP. Detailed protocols of other possible scenarios can be found in the Wi-Fi Simple Configuration technical specification.[1](https://portal.offsec.com/courses/pen-210-9545/learning/wi-fi-encryption-15794/wireless-protected-setup-15890/wps-protocol-16046#fn-local_id_129-1)

![Figure 16: Setup using a standalone AP/Registrar](https://static.offsec.com/offsec-courses/PEN-210/images/Encryption/17965d04c75f1138276f649df78a0695-Picture16.png)

Figure 16: Setup using a standalone AP/Registrar

In Figure 16, the first step is the discovery where the enrollee queries the AP with a Wi-Fi Simple Configuration Information Element (IE) in the probe request. If it responds positively, the device will do the usual authentication and association process then proceed to initiate the 802.1X process and respond with a **WFA-SimpleConfig-Enrollee-1-0** identity. The enrollee gets provisioned after the exchange of message M1 to M8. Finally, the device gets disconnected from the AP and reconnects with the credentials received earlier.

The M1 and M2 messages may be exchanged while waiting for the user to input the enrollee device password from the device in the AP interface.

When using an external registrar and/or push button, the communication between the enrollee and the AP is essentially the same as what was described above. Communication between the AP and registrar is what differs.

Once we reach M5, we know the first half of the PIN. If we receive a NACK after M6, the second half is incorrect.

-----
### 2.6.4. WPS Registration Protocol Messages

The M1 to M8 EAP messages are specific to the WPS registration protocol and are created as follow:

1. M1 = Version || N1 || Description || PKE
2. M2 = Version || N1 || N2 || Description || PKR [ || ConfigData ] || HMACAuthKey( M1 || M2* )
3. M3 = Version || N2 || E-Hash1 || E-Hash2 || HMACAuthKey( M2 || M3* )
4. M4 = Version || N1 || R-Hash1 || R-Hash2 || ENCKeyWrapKey(R-S1) || HMACAuthKey( M3 || M4* )
5. M5 = Version || N2 || ENCKeyWrapKey(E-S1) || HMACAuthKey( M4 || M5* )
6. M6 = Version || N1 || ENCKeyWrapKey(R-S2) || HMACAuthKey( M5 || M6* )
7. M7 = Version || N2|| ENCKeyWrapKey(E-S2 [||ConfigData]) || HMACAuthKey( M6 || M7* )
8. M8 = Version || N1 || [ ENCKeyWrapKey(ConfigData) ] || HMACAuthKey( M7 || M8* )

The following explains the meaning of the different symbols and items used above:

- **||**: concatenation of parameters to form a message
- Subscripts are used in the context of a cryptographic function such as HMACKey. In this case, it refers to the **key** used by that function (**HMAC**)
- When a message is followed by *****, it is referring to the message minus its HMAC-SHA-256 value
- **Version**: identifies the type of _Registration Protocol_ message
- **N1** and **N2**: 128-bit nonces (random number generated once) generated by the Enrollee and the Registrar respectively
- **Description**: human-readable description of the sending device (UUID, manufacturer, model number, MAC address, etc.) and device capabilities such as supported algorithms, I/O channels, Registration Protocol role, etc. Description data is also included in 802.11 probe request and probe response messages
- **PKE** and **PKR**: Diffie-Hellman public keys of the Enrollee and Registrar, respectively. If support for other cipher suites (such as elliptic curve) is added in the future, a different protocol Version number will be used
- **AuthKey**: authentication key derived from the Diffie-Hellman secret gAB mod p, the nonces _N1_ and _N2_, and the Enrollee’s MAC address. If M1 and M2 are both transported over a channel that is not susceptible to man-in-the-middle attacks, the Enrollee’s device password may be omitted from the key derivation
- **E-Hash1** and **E-Hash2**: pre-commitments made by the Enrollee to prove knowledge of the two halves of its own device password
- **R-Hash1** and **R-Hash2**: pre-commitments made by the Registrar to prove knowledge of the two halves of the Enrollee’s device password
- **ENCKeyWrapKey(...)**: indicates symmetric encryption of the values in parentheses using the key _KeyWrapKey_ with the AES-CBC encryption algorithm per FIPS 197, with PKCS#5 v2.0 padding
- **R-S1** and **R-S2**: secret 128-bit nonces that, together with _R-Hash1_ and _R-Hash2_, can be used by the Enrollee to confirm the Registrar’s knowledge of the first and second half of the Enrollee’s device password, respectively
- **E-S1** and **E-S2**: secret 128-bit nonces that, together with _E-Hash1_ and _E-Hash2_, can be used by the Registrar to confirm the Enrollee’s knowledge of the first and second half of the Enrollee’s device password, respectively
- **HMACAuthKey(...)**: indicates an Authenticator attribute that contains a HMAC keyed hash over the values in parentheses and using the key _AuthKey_. The keyed hash function is HMAC-SHA-256 per FIPS 180-2 and RFC-2104. To reduce message sizes, only 64 bits of the 256-bit HMAC output are included in the Authenticator attribute
- **ConfigData**: WLAN settings and credentials for the Enrollee. Additional settings for other networks and applications may also be included in _ConfigData_. Although it is shown here as always being encrypted, encryption is only mandatory for keys and key bindings and is optional for other configuration data. It is the sender’s decision whether or not to encrypt a given part of the _ConfigData_