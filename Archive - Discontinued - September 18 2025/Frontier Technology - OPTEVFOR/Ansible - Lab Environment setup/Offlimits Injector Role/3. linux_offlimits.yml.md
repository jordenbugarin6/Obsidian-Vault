`root@bugs-VMware-Virtual-Platform:/home/bugs/ansible_playbooks/roles/offlimits_injector_role/tasks# cat main.yml `

```bash
---
- name: Offlimits Injector Role for Linux
  hosts: linux  # Specify the group or hosts from your inventory
  tasks:
    - name: Delete existing offlimits connection (if it exists)
      command: nmcli con delete offlimits
      ignore_errors: true  # Ignore errors if the connection does not exist

    - name: Check if offlimits connection was deleted
      command: nmcli con show
      register: nmcli_show_result

    - name: Debug nmcli show result after deletion
      debug:
        var: nmcli_show_result.stdout_lines

    - name: Check if interface ens34 already exists
      command: ip link show ens34
      register: ens34_check
      ignore_errors: true  # Ignore if the interface does not exist

    - name: Create virtual interface ens34 based on ens33 if it does not exist
      command: ip link add ens34 type veth
      when: ens34_check.rc != 0  # Only create if it does not exist

    - name: Set the new interface up
      command: ip link set ens34 up
      when: ens34_check.rc != 0  # Only set up if it was just created

    - name: Add and configure network interface with nmcli
      command: nmcli con add type ethernet con-name offlimits ifname ens34 ipv4.addresses 10.2.11.20/24 ipv4.method manual
      register: nmcli_add_result

    - name: Debug nmcli add result
      debug:
        var: nmcli_add_result

    - name: Verify new interface is added
      command: nmcli con show
      register: nmcli_show_result_after_add

    - name: Debug nmcli show result after adding
      debug:
        var: nmcli_show_result_after_add.stdout_lines

    - name: Bring up the new interface
      command: nmcli con up offlimits
      register: nmcli_up_result

    - name: Debug nmcli up result
      debug:
        var: nmcli_up_result

    - name: Verify new interface is up
      command: ip addr show ens34
      register: interface_status

    - name: Output message if interface is up
      debug:
        msg: "The offlimits interface has been added and configured with IP 10.2.11.20"
      when: "'inet 10.2.11.20' in interface_status.stdout"

```


#### full working with service addition but needs cleanup

```bash
root@bugs-VMware-Virtual-Platform:/home/bugs/ansible_playbooks/testing# cat linux_offlimits_pers19.yml 
- name: Offlimits Injector Role for Rocky Linux 9
  hosts: linux  # Specify the group or hosts from your inventory
  become: yes   # Use privilege escalation if necessary (e.g., for creating interfaces)

  tasks:
    # Ensure the offlimits connection is deleted (if exists)
    - name: Delete existing offlimits connection (if it exists)
      command: nmcli con delete offlimits
      ignore_errors: true  # Ignore errors if the connection does not exist

    # Verify that offlimits connection has been deleted
    - name: Check if offlimits connection was deleted
      command: nmcli con show
      register: nmcli_show_result

    - name: Debug nmcli show result after deletion
      debug:
        var: nmcli_show_result.stdout_lines

    # Check if ens34 interface exists
    - name: Check if interface ens34 already exists
      command: ip link show ens34
      register: ens34_check
      ignore_errors: true  # Ignore if the interface does not exist

    # Create virtual interface ens34 based on ens33 if it doesn't exist
    - name: Create virtual interface ens34 based on ens33 if it does not exist
      command: ip link add ens34 type veth
      when: ens34_check.rc != 0  # Only create if it doesn't exist

    # Bring the new interface up
    - name: Set the new interface up
      command: ip link set ens34 up
      when: ens34_check.rc != 0  # Only set up if it was just created

    # Add and configure network interface with nmcli
    - name: Add and configure network interface with nmcli
      command: nmcli con add type ethernet con-name offlimits ifname ens34 ipv4.addresses 10.2.11.20/24 ipv4.method manual
      register: nmcli_add_result

    - name: Debug nmcli add result
      debug:
        var: nmcli_add_result

    # Verify that the new interface is added
    - name: Verify new interface is added
      command: nmcli con show
      register: nmcli_show_result_after_add

    - name: Debug nmcli show result after adding
      debug:
        var: nmcli_show_result_after_add.stdout_lines

    # Ensure the offlimits connection autostarts on boot
    - name: Set offlimits connection to autostart
      command: nmcli con mod offlimits connection.autoconnect yes

    # Ensure the NetworkManager service is enabled and running
    - name: Ensure NetworkManager service is enabled and running
      systemd:
        name: NetworkManager
        enabled: true
        state: started

    # Bring up the offlimits connection explicitly
    - name: Bring up the offlimits connection (explicitly)
      command: nmcli con up offlimits
      register: nmcli_up_result

    - name: Debug nmcli up result
      debug:
        var: nmcli_up_result

    # Verify that the new interface is up
    - name: Verify new interface is up
      command: ip addr show ens34
      register: interface_status

    # Output message if interface is up
    - name: Output message if interface is up
      debug:
        msg: "The offlimits interface has been added and configured with IP 10.2.11.20"
      when: "'inet 10.2.11.20' in interface_status.stdout"

    # Explicitly configure the interface in /etc/sysconfig/network-scripts for boot
    - name: Ensure ens34 is configured in /etc/sysconfig/network-scripts/ifcfg-ens34
      copy:
        dest: /etc/sysconfig/network-scripts/ifcfg-ens34
        content: |
          DEVICE=ens34
          BOOTPROTO=static
          ONBOOT=yes
          IPADDR=10.2.11.20
          NETMASK=255.255.255.0
        mode: '0644'

    # Restart the network service to ensure interface comes up
    - name: Restart NetworkManager
      systemd:
        name: NetworkManager
        state: restarted

    # Create the script that will bring up the interface without sleep
    - name: Create script to bring up ens34
      copy:
        dest: /usr/local/bin/bring_up_ens34.sh
        content: |
          #!/bin/bash
          ip link add ens34 type veth
          ip link set ens34 up
          nmcli con up offlimits
        mode: '0755'

    # Create the systemd service file to bring up ens34
    - name: Create systemd service file for bringing up ens34
      copy:
        dest: /etc/systemd/system/bring_up_ens34.service
        content: |
          [Unit]
          Description=Bring up ens34 interface

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/bring_up_ens34.sh

          [Install]
          WantedBy=multi-user.target
        mode: '0644'

    # Create the systemd timer file to trigger the service every minute
    - name: Create systemd timer file to run bring_up_ens34 every minute
      copy:
        dest: /etc/systemd/system/bring_up_ens34.timer
        content: |
          [Unit]
          Description=Timer to bring up ens34 interface every minute

          [Timer]
          OnUnitActiveSec=1min
          Unit=bring_up_ens34.service
          AccuracySec=1s

          [Install]
          WantedBy=timers.target
        mode: '0644'

    # Reload systemd to apply the new timer and service
    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    # Enable and start the systemd timer
    - name: Enable and start bring_up_ens34.timer
      systemd:
        name: bring_up_ens34.timer
        enabled: yes
        state: started

    # Enable and start the systemd service
    - name: Enable and start bring_up_ens34.service
      systemd:
        name: bring_up_ens34.service
        enabled: yes
        state: started

  handlers:
    - name: Reload systemd
      systemd:
        daemon_reload: yes

```

#### Full Service method -  establishes offlimits IP address, stays persistent with service even after reboot

- **Removed** redundant tasks for checking if the interface exists and bringing the connection up manually in the playbook.
- **Removed** NetworkManager restart task, as it might not be needed unless explicitly required.
- Streamlined the configuration by keeping only essential tasks for interface creation, configuration, and systemd service setup.

added to github as ### [`â€Žroles/injector_roles/offlimits_injector_role/tasks/main_persistent.yml`](https://github.com/PwnLibrary/stargate/commit/f968485174529390ae77faf636c306253c574176#diff-4d7c2c31ff1c50cb7acdfcc7052cc89f24c5f1126b96d312648b32f368ce3919)
```bash
- name: Offlimits Injector Role for Rocky Linux 9
  hosts: linux
  become: yes

  tasks:
    # Check and create virtual interface ens34 if it doesn't exist
    - name: Create virtual interface ens34 if it does not exist
      command: ip link add ens34 type veth
      ignore_errors: true  # Ignore error if the interface exists

    # Bring the new interface up
    - name: Set the new interface up
      command: ip link set ens34 up

    # Add and configure network interface with nmcli
    - name: Add and configure network interface with nmcli
      command: nmcli con add type ethernet con-name offlimits ifname ens34 ipv4.addresses 10.2.11.20/24 ipv4.method manual
      register: nmcli_add_result

    # Ensure the offlimits connection autostarts on boot
    - name: Set offlimits connection to autostart
      command: nmcli con mod offlimits connection.autoconnect yes

    # Ensure NetworkManager service is enabled and running
    - name: Ensure NetworkManager service is enabled and running
      systemd:
        name: NetworkManager
        enabled: true
        state: started

    # Create the script that will bring up the interface
    - name: Create script to bring up ens34
      copy:
        dest: /usr/local/bin/bring_up_ens34.sh
        content: |
          #!/bin/bash
          ip link add ens34 type veth
          ip link set ens34 up
          nmcli con up offlimits
        mode: '0755'

    # Create the systemd service file to bring up ens34
    - name: Create systemd service file for bringing up ens34
      copy:
        dest: /etc/systemd/system/bring_up_ens34.service
        content: |
          [Unit]
          Description=Bring up ens34 interface

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/bring_up_ens34.sh

          [Install]
          WantedBy=multi-user.target
        mode: '0644'

    # Create the systemd timer file to run bring_up_ens34 every minute
    - name: Create systemd timer file to run bring_up_ens34 every minute
      copy:
        dest: /etc/systemd/system/bring_up_ens34.timer
        content: |
          [Unit]
          Description=Timer to bring up ens34 interface every minute

          [Timer]
          OnUnitActiveSec=1min
          Unit=bring_up_ens34.service
          AccuracySec=1s

          [Install]
          WantedBy=timers.target
        mode: '0644'

    # Reload systemd to apply the new timer and service
    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    # Enable and start bring_up_ens34.timer
    - name: Enable and start bring_up_ens34.timer
      systemd:
        name: bring_up_ens34.timer
        enabled: yes
        state: started

    # Enable and start bring_up_ens34.service
    - name: Enable and start bring_up_ens34.service
      systemd:
        name: bring_up_ens34.service
        enabled: yes
        state: started
```