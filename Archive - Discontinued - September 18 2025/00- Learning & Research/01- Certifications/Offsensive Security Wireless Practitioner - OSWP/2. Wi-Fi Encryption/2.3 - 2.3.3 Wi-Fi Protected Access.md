
The IEEE 802.11i group, aimed at improving wireless security, proceeded to develop two new link layer encryption protocols: Temporal Key Integrity Protocol (TKIP)[1](https://portal.offsec.com/courses/pen-210-9545/learning/wi-fi-encryption-15794/wired-equivalent-privacy-15861/wep-authentication-16020#fn-local_id_83-1) and Counter Mode with CBC-MAC (CCMP)[2](https://portal.offsec.com/courses/pen-210-9545/learning/wi-fi-encryption-15794/wired-equivalent-privacy-15861/wep-authentication-16020#fn-local_id_83-2).

CCMP was designed from the ground up and took much more time to complete in comparison to TKIP. TKIP ended up with the commercial name _WPA1_ while _WPA2_ was given to CCMP.

WPA encryption comes in two flavors:

- **WPA Personal**: Makes use of pre-shared key authentication (WPA-PSK), a passphrase shared by all peers of the network.
- **WPA Enterprise**: Uses 802.1X and a Radius server for Authentication, Authorization, and Accounting (AAA).

In Figure 5 below, we have an illustration of the setup to create the WPA secure communication channel.

![Figure 5: The WPA connection process](https://static.offsec.com/offsec-courses/PEN-210/images/Encryption/54b9c9085d8ab9f589ac64b28630b058-Picture5.png)

Figure 5: The WPA connection process

### 2.3.1. WPA Ciphers

Two ciphers are available, TKIP, for legacy hardware that can only handle WEP, and CCMP, that is based on Advanced Encryption Standard (AES).[1](https://portal.offsec.com/courses/pen-210-9545/learning/wi-fi-encryption-15794/wi-fi-protected-access-15866/wi-fi-protected-access-16019#fn-local_id_84-1)

#### TKIP

TKIP is based on the third draft of 802.11i. It was designed to be backward compatible with legacy hardware and still uses WEP as the encryption algorithm although it addresses the flaws found in WEP with the following elements:

- Per packet key mixing
- IV sequencing to avoid replay attacks
- New Message Integrity Check (MIC), using the Michael algorithm and countermeasures on MIC failures
- Key distribution and rekeying mechanism

#### CCMP

CCMP is the implementation of the final version of 802.11i and is also called Robust Security Network (RSN). It makes use of a new AES-based algorithm. It was designed from the ground up and is not compatible with older hardware.

------
### 2.3.2. WPA Network Connection

The secure communication channel is set up in four steps:

1. Agreement on security protocols
2. Authentication
3. Key distribution and verification
4. Data encryption and integrity

In Figure 6 below, we have an illustration of the setup to create the WPA Enteprise secure communication channel.

![Figure 6: The WPA Enterprise connection process](https://static.offsec.com/offsec-courses/PEN-210/images/Encryption/54b9c9085d8ab9f589ac64b28630b058-Picture5.png)

Figure 6: The WPA Enterprise connection process

In WPA-PSK systems, the process is slightly simplified, as only 3 steps are required. The authentication step is removed as illustrated below.

![Figure 7: The WPA-PSK connection process](https://static.offsec.com/offsec-courses/PEN-210/images/Encryption/19e8e34e2b068e6d68883a2224c064d5-Picture6.png)

Figure 7: The WPA-PSK connection process

#### Agreement on Security Protocols

The different security protocols allowed by the AP are provided in its beacons:

- Authentication means, either by PSK or by 802.1X using a AAA server
- Unicast and multicast/broadcast traffic encryption suite: TKIP, CCMP

The STA first sends a probe request in order to receive network information (i.e. rates, encryption, channel, etc.) and will join the network by using open authentication followed by association where it indicates which ciphers will be used.

----

### 2.3.3. WPA Authentication

The authentication step is only done in WPA Enterprise configurations. It is based on the Extensible Authentication Protocol (EAP)[1](https://portal.offsec.com/courses/pen-210-9545/learning/wi-fi-encryption-15794/wi-fi-protected-access-15866/wpa-network-connection-16053#fn-local_id_86-1) and can be done with the following:

- EAP-TLS with client and server certificates
- EAP-TTLS
- PEAP for hybrid authentication where only the server certificate is required

This authentication is started when the client selects the authentication mode to use. Several EAP messages, depending on the authentication mode, will be exchanged between the authenticator and the supplicant in order to generate a Master Key (MK).

At the end of the procedure, if successful, a "Radius Accept" message is sent to the AP containing the MK and another message, an EAP message sent to the client to indicate success.

#### Key Distribution and Verification

The third phase focuses on the exchange of the different keys used for authentication, message integrity, and message encryption. This is done via the 4-way handshake to exchange the Pairwise Transient Key (PTK) and the current Group Temporal Key (GTK), respectively the keys used for unicast and multicast/broadcast, and then the Group Key handshake to renew the GTK.

This part allows:

- Confirmation of the cipher suite used
- Confirmation of the PMK knowledge by the client
- Installation of the integrity and encryption keys
- Send GTK securely

An illustration of the key distribution and verification phases is shown in Figure 8.

![Figure 8: The key distribution and verification phase](https://static.offsec.com/offsec-courses/PEN-210/images/Encryption/34ed5022a05e7410dd6a1bc7b3fb837a-Picture7.png)

Figure 8: The key distribution and verification phase

**Note:** The authenticator is the AP and the supplicant is the STA.

1. The authenticator sends a nonce to the supplicant, called _ANonce_.
2. The supplicant creates the PTK and sends its nonce, _SNonce_, with the MIC. After the construction of the PTK, it will check if the supplicant has the right PMK. If the MIC check fails, the supplicant has the wrong PMK.
3. The message from the authenticator to the supplicant will contain, when WPA2/3 is used, the current GTK. This key is used to decrypt multicast/broadcast traffic. If that messages fails to be received, it is re-sent. If 802.11w is negotiated, IGTK is included. With WPA1, GTK will be sent in a later exchange.
4. Finally, the supplicant sends an acknowledgement to the authenticator. The supplicant installs the keys and starts encryption.

The group key handshake is much simpler than pairwise keys because it is done after the 4-way handshake (after installing keys) and thus we now have a secure link. It is also done via Extensible Authentication Protocol over LAN (EAPoL) messages but this time, the messages are encrypted. The diagram below illustrates this process.

![Figure 9: The group key handshake process](https://static.offsec.com/offsec-courses/PEN-210/images/Encryption/e8ac0161195cbbc11ac3593ab24d8174-Picture8.png)

Figure 9: The group key handshake process

If 802.11w is negotiated, an IGTK is sent along the GTK. The MIC is verified by the STA and acknolwedged in message 2.

This update process happens for the following reasons:

- WPA1, after the 4-way handshake
- A station joins the network
- A station leaves the network
- When a timer expires (controlled by the authenticator, the AP)
- A station can request it by sending an unsolicited confirmation message
- A station can request it by sending an EAPOL-Key frame with both Request and Group Key bits set

#### Pairwise Transient Key

In Figure 10, we have the process to generate the Pairwise Transient Key (PTK), derived from the Pairwise Master Key (PMK).

![Figure 10: The Pairwise Transient Key generation process](https://static.offsec.com/offsec-courses/PEN-210/images/Encryption/919f3c2172664d81f213e77cbcd77e52-Picture9.png)

Figure 10: The Pairwise Transient Key generation process

#### Input

As input, it takes both nonce values, both MAC addresses (supplicant and authenticator), and the PMK. The PMK calculation works as follows:

If the system is WPA Personal, it uses the PBKDF2 function[2](https://portal.offsec.com/courses/pen-210-9545/learning/wi-fi-encryption-15794/wi-fi-protected-access-15866/wpa-network-connection-16053#fn-local_id_86-2) with the following values to generate the PSK (the PSK is then used as the PMK):

- Password, the passphrase
- SSID (and its length)
- The number of iterations, 4096
- The length of the result key, 256 bits

For WPA Enterprise using a Radius server, the PMK is generated from the Master Key (obtained during the exchange with the server) via the TLS-PRF function.

#### Hash Algorithm

PRF-X using HMAC-SHA1, X being 128, 192, 256, 384, 512 or 704, which indicates the size of the output in bits.

#### Output

The PTK is then divided in different keys. Below are the common parts from TKIP and CCMP:

1. Key Encryption Key (KEK) (128-bit; bits 0-127): used by the AP to encrypt additional data sent to the STA, for example, the RSN IE or the GTK
2. Key Confirmation Key (KCK) (128-bit; bits 128-255): used to compute the MIC on WPA EAPOL Key messages
3. Temporal Key (TK) (128-bit or 256-bit; bits 256-383 or 256-511): used to encrypt/decrypt unicast data packets

The CCMP PTK size is 384 bits, comprised of the three keys shown above. TKIP requires two more keys for message integrity, thus increasing the PTK size to 512 bits:

- MIC TX Key (64-bit; bits 384-447): used to compute MIC on unicast data packets sent by the AP
- MIC RX Key (64-bit; bits 448-511): used to compute MIC on unicast data packets sent by the STA

TK is 128-bit unless the following cipher suites are used:

- WEP-40 (40 bits)
- WEP-104 (104 bits)
- GCMP-256 (256-bits)
- CCMP-256 (256-bits)
- BIP-GMAC-256 (256-bits)
- BIP-CMAC-256 (256-bits)

#### Group Temporal Key

The GTK is used to encrypt and decrypt multicast/broadcast traffic. Its construction takes place according to the following illustration. Note that the GTK is just a random number, which means any pseudorandom function can be used to generate it.

![Figure 11: The GTK construction process](https://static.offsec.com/offsec-courses/PEN-210/images/Encryption/f7560aac1d7d3f5fb6c980b230526c89-Picture10.png)

Figure 11: The GTK construction process

#### Data Encryption and Integrity

There are three different algorithms that can be used for data encryption and integrity:

- Temporal Key Integrity Protocol (TKIP)[3](https://portal.offsec.com/courses/pen-210-9545/learning/wi-fi-encryption-15794/wi-fi-protected-access-15866/wpa-network-connection-16053#fn-local_id_86-3)
- Counter Mode with CBC-MAC (CCMP)[4](https://portal.offsec.com/courses/pen-210-9545/learning/wi-fi-encryption-15794/wi-fi-protected-access-15866/wpa-network-connection-16053#fn-local_id_86-4)
- Wireless Robust Authenticated Protocol (WRAP)[5](https://portal.offsec.com/courses/pen-210-9545/learning/wi-fi-encryption-15794/wi-fi-protected-access-15866/wpa-network-connection-16053#fn-local_id_86-5)

These algorithms are far more complex than WEP and will not be detailed here.

#### Temporal Key Integrity Protocol

The following diagram shows the different fields in a TKIP encrypted frame:

![Figure 12: A TKIP encrypted frame](https://static.offsec.com/offsec-courses/PEN-210/images/Encryption/884ee7897ec802fc3246d21146db9a2a-Picture11.png)

Figure 12: A TKIP encrypted frame

#### Counter Mode with CBC-MAC

13 below shows the different fields in a CCMP encrypted frame:

![Figure 13: A CCMP encrypted frame](https://static.offsec.com/offsec-courses/PEN-210/images/Encryption/9b5ba58686bab203f96bc7d422eb9a79-Picture12.png)

Figure 13: A CCMP encrypted frame

#### Wireless Robust Authenticated Protocol

WRAP is based on AES but uses the Offset Codebook Mode (OCB) cipher and authentication scheme. It was the first to be selected by the 802.11i working group but was abandoned due to intellectual property reasons.