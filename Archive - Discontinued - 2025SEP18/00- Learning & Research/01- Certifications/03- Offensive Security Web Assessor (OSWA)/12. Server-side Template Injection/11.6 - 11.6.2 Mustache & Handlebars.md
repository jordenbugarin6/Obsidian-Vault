The _Mustache_[1](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/mustache-and-handlebars-discovery-and-exploitation-31311/mustache-and-handlebars-discovery-31006#fn-local_id_312-1) templating engine is supported by multiple languages and frameworks. It was named "mustache" for its use of the curly braces as delimiters, which look like a mustache when turned sideways. It can render templates on the server- or client-side using JavaScript. However, Mustache is unique compared to the other templating engines because it is considered "logic-less". While many other templating engines support closer access to the underlying programming languages via more complex statements and filters, Mustache only supports simple _if_ statements to check whether variables exist or to loop through an array.

Mustache is designed this way to help force developers to separate logic into the controller instead of the view. This inflexibility also provides some security advantages. Since we don't have access to the underlying programming language, it's much harder to exploit SSTI and achieve RCE. Instead, Mustache injections might only lead to sensitive information disclosure if we know which variables to display, or XSS.

Developers often found Mustache too restrictive. Because of this, the _Handlebars_ templating engine was created to offer more helpers and integration with the underlying programming language. The most popular Handlebars library is for JavaScript,[2](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/mustache-and-handlebars-discovery-and-exploitation-31311/mustache-and-handlebars-discovery-31006#fn-local_id_312-2) which allows for client and server-side rendering; however, there are also Handlebars libraries for Java,[3](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/mustache-and-handlebars-discovery-and-exploitation-31311/mustache-and-handlebars-discovery-31006#fn-local_id_312-3) .NET,[4](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/mustache-and-handlebars-discovery-and-exploitation-31311/mustache-and-handlebars-discovery-31006#fn-local_id_312-4) PHP,[5](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/mustache-and-handlebars-discovery-and-exploitation-31311/mustache-and-handlebars-discovery-31006#fn-local_id_312-5) and more. In this section, we'll focus on _handlebars.js_.

The client-side Handlebars template can be found on /handlebars on the sandbox. Let's review a Handlebars template to understand what it might consist of.

```js
01  <h1>Hello {{name}}</h1>
02  {{#if nicknames}}
03  Also known as:
04    {{#each nicknames}}
05        {{this}}
06    {{/each}}
07  {{/if}}
08
09  We are using handlebars locally in your browser to generate this template
```
We'll pair this template with a set of variables that define the _name_ and _nicknames_.
![[Pasted image 20241028164344.png]]
In this example, we can find the use of an expression on the first line displaying the username.

```js
01  <h1>Hello {{name}}</h1>
```
We'll also notice a couple of default block helpers that act as _if_ statements and _for_ loops.
```js
02  {{#if nicknames}}
03  Also known as:
04    {{#each nicknames}}
05        {{this}}
06    {{/each}}
07  {{/if}}
```
While these are technically "statements" in a template, it's important for us to understand that these exist only because there are specific pre-defined helpers for "if" statements and "each" loops.

Go to `http://template-sandbox/handlebars` for the following exercises.

##### Labs
`OS{ZdravkoColic}`
![[Pasted image 20241028164752.png]]

![[Pasted image 20241028164639.png]]

```python
01  <h1>Hello {{SECRET_STRING}}</h1>
02  {{#if nicknames}}
03  Also known as:
04    {{#each nicknames}}
05        {{this}}
06    {{/each}}
07  {{/if}}
08
09  We are using handlebars locally in your browser to generate this template
```

2. 
![[Pasted image 20241028203620.png]]
Compared this to Twig notes.
![[Pasted image 20241028203707.png]]

---------------


Since Handlebars is designed to be as logic-less as possible, the attack surface for it is slightly different from the other templating engines we've discussed.

Handlebars does not natively support functions that can lead to RCE without additional exploits. There have been exploits performed on Handlebars reaching RCE using SSTI, but such exploits are typically patched.[1](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/mustache-and-handlebars-discovery-and-exploitation-31311/mustache-and-handlebars-discovery-31006#fn-local_id_336-1)

However, developers might add additional helpers to Handlebars, thus exposing more of the underlying programming language to the template. To reduce time, developers might import pre-made helpers into Handlebars. One example is a repository named _handlebars-helpers_.[2](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/mustache-and-handlebars-discovery-and-exploitation-31311/mustache-and-handlebars-discovery-31006#fn-local_id_336-2) Reviewing the handlebars-helpers repository, we can find some helpers that might be useful to us, specifically _read_ and _readdir_.

The _read_[3](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/mustache-and-handlebars-discovery-and-exploitation-31311/mustache-and-handlebars-discovery-31006#fn-local_id_336-3) helper is used to "read a file from the file system." The _readdir_[4](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/mustache-and-handlebars-discovery-and-exploitation-31311/mustache-and-handlebars-discovery-31006#fn-local_id_336-4) helper will "return an array of files from the given directory." If an application uses the Handlebars templating engine and uses handlebars-helpers, we may be able to steal sensitive files from the file system.

Since file system access isn't very useful on client-side rendering, we will need to target an instance to test this in which Handlebars renders server-side content. We'll use /handlebars_remote on the template sandbox for this.

Let's start by using the `readdir` helper to list the contents of the /etc/ folder. Since we know that this will return an array, we'll use an _each_ helper to print each string in the array.

![[Pasted image 20241028204055.png]]
```python
{{#each (readdir "/etc")}}
	{{this}}
{{/each}}
```
In this list, we can find the /etc/passwd file. Let's use the _read_ helper to display its contents.

![[Pasted image 20241028204136.png]]

```python
{{read "/etc/passwd"}}
```
Great! We now have the ability to read a file on the file system and list directories. Using this information, we might be able to find a path to code execution.

Go to `http://template-sandbox/handlebars_remote` for the following exercise.


##### Labs

1.
![[Pasted image 20241028205242.png]]
Utilize this to identify the path of the secret flag
```python
{{#each (readdir "/secret")}}
	{{this}}
{{/each}}
```
![[Pasted image 20241028204602.png]]
use this to read the flag
```python
{{read "/secret/flag.txt"}}
```
![[Pasted image 20241028205222.png]]
