This Learning Unit covers the following Learning Objectives:

1. Understand common command injection scenarios.
2. Understand how to discover command injection.
3. Understand why we execute the _id_ or _whoami_ commands first.
4. Understand how we chain commands together and why.

In this section, we'll introduce the Command Injection Sandbox, which will serve as a practice environment for this Learning Module.

----------

#### 12.1.1. Accessing the Command Injection Sandbox

In this Learning Unit, we will be using the Command Injection Sandbox (_CI-Sandbox_), a custom sandbox application for command injection.

To begin, let's make an entry for the sandbox in the /etc/hosts file on Kali. This will allow us to connect to it via its hostname rather than IP address.

```bash
127.0.0.1       localhost
127.0.1.1       kali

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
192.168.233.101 ci-sandbox 
```

#### 12.1.2. Familiarizing Ourselves with the Sandbox

Browsing http://ci-sandbox:80/ presents the main page. This includes links for _PHP Command Injection_, _Python Command Injection_, and _NodeJS Command Injection_, as well as various exercise links.

![[Pasted image 20241029212827.png]]
We can use these command injection links to perform injection in a variety of languages. For now, we'll click _Python Command Injection_ to walk through a simple command injection example.

![[Pasted image 20241029212916.png]]
This page emulates a web application that is running a command. The URL reveals that the _ip_ parameter is set to "127.0.0.1". As the page loads, the output resembles the output from the _ping_ command. Behind the scenes, the page accepts the _ip_ parameter and passes it as input to ping. The server executes the command and presents the output.

Since we know that the server is executing a command, let's try to inject our own. We will (safely) assume that the command is being run in a system shell. If this is true, and the web application doesn't sanitize input, we may be able to use a pipe (|) symbol after the _ip_ value to inject (or chain) another command, like id.

Here's the altered URL:

```bash
http://ci-sandbox:80/python/index.py?ip=127.0.0.1|id
```

![[Pasted image 20241029213036.png]]

Very nice! We just discovered and executed our first command injection! The system ran our _id_ command, revealing that we have the ability to execute commands as the www-data user.

In the upcoming sections we'll expand on this technique.

---------------
#### 12.1.3. Where is Command Injection Most Common?

In order to explain the nuances of code injection, we'll begin by examining vulnerable code.

As we've mentioned, command injection can occur when unsanitized user input is passed into a web application and executed.

By way of demonstration, consider this PHP code snippet, which pings a remote system.

```php
<?php
$IP = $_GET['IP'];

echo "<pre>";
system("ping -c 5 ".$IP);
echo "</pre>";
?>
```

This code will ping the system specified by _IP_. Notice that the command is run through the _system()_ function. This is cause for alarm and a classic command injection vulnerability since the command is built using user-supplied input (_IP_).

Of course, in the event that we stumble across a web application in our engagement that seems to be performing _any_ kind of system-level execution, we should go ahead and perform command injection checks on any and all input fields that might work on the back end directly with the system.

To explain why, imagine the _$IP_ parameter as pure input into a web application. If we are inputting into an existing system-level command, we can use various techniques to chain together system commands and leverage it for our own code execution.


***There are many reasons why web applications might execute operating system commands. Other than just the ping command, we might come across web applications that are continuously monitoring connections with netstat. Further, we might come across web applications that are making use of the ls command to check for files present on a machine, and also their respective sizes. Further, the net command native to Server Message Block (SMB)[1](https://portal.offsec.com/courses/web-200-28380/learning/command-injection-35143/discovery-of-command-injection-35190/where-is-command-injection-most-common%3F-35163#fn-local_id_365-1) on Windows could be used from the web to check for the existence of users on a local machine or even across a network.***

In the next section we'll discuss chaining, which will allow us to run multiple commands.

---------

#### 12.1.4. About the Chaining of Commands & System Calls

Most operating systems allow users to run multiple commands together on one line. In the case of Linux, we can use the semicolon (;), the logical AND (&&), the logical OR (||), and even a single pipe character (|).

For example, consider a simple ls -ls command run on our Kali Linux VM to list all directories and files in our home directory.

```bash
kali@kali:~$ ls -ls  
total 32
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Desktop
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Documents
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Downloads
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Music
4 drwxr-xr-x 2 kali kali 4096 Aug 23 07:12 Pictures
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Public
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Templates
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Videos
```

As expected, this lists files and directories. As an example of simple command chaining, we will add a semicolon to the end of the command (marking the end of a command in Linux) and follow it with id. This should execute the command sequentially.

```bash
kali@kali:~$ ls -ls ; id
total 32
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Desktop
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Documents
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Downloads
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Music
4 drwxr-xr-x 2 kali kali 4096 Aug 23 07:12 Pictures
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Public
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Templates
4 drwxr-xr-x 2 kali kali 4096 May 31 03:34 Videos

uid=1000(kali) gid=1000(kali) groups=1000(kali),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),118(bluetooth),120(wireshark),134(scanner),142(kaboxer)
```

This single-line command executed both commands sequentially.

More than a simple example, the _id_ command is extremely helpful as it reveals the user id we are running as (our _execution context_). We can also use _whoami_, which works natively on both Windows and Linux.

We can also use && to chain commands. In this case the second command will only run if the first exits without error:

```bash
kali@kali:~$ whoami && hostname
kali
kali
```

Next, we use && again and note that if the first command fails, the second one won't run.

```bash
kali@kali:~$ foobar && hostname
foobar: command not found
```

Alternatively, a logical OR `(||)` will only run the second command if the first fails.

```bash
kali@kali:~$ whoami || id      
kali
```

In this example, the second command (id) did not run because the first command (whoami) exited without error.

Let's use the logical OR in another example, this time with a command we know will fail:

```bash
kali@kali:~$ foobar || whoami  
foobar: command not found
kali
```

This time, the second command (whoami) runs.

***In addition to the semicolon, which allows us to chain multiple commands together in one statement, another unique separator for Linux is the newline (\n), which exists in every HTTP request. Its hexadecimal value is 0x0A.***

Finally, let's discuss some Linux-specific inline execution[1](https://portal.offsec.com/courses/web-200-28380/learning/command-injection-35143/discovery-of-command-injection-35190/about-the-chaining-of-commands-and-system-calls-35155#fn-local_id_368-1) mechanisms. Considers these examples, which use the backtick (`) character and the _$()_ null statement to "wrap" a command ("cmd").


```bash
`cmd`
$(cmd)
```

This can be an odd mechanism. Let's create a simple example.

```bash
kali@kali:~$ echo "This is an echo statement"
This is an echo statement

kali@kali:~$ echo "This is an `whoami` echo statement"
This is an kali echo statement

kali@kali:~$ echo "This is an $(whoami) echo statement"
This is an kali echo statement
```

Note that the first command is a simple echo statement. However, the second and third command embed whoami into the statement. As the name suggests, the embedded command is executed inline and the command output is effectively merged.

Now that we've discussed command chaining, let's turn our focus to typical input normalization techniques that are designed to prevent this type of attack.

##### Labs
`OS{this-is-the-answer-required}`
![[Pasted image 20241029214432.png]]

```bash
http://ci-sandbox:80/nodejs/index.js?ip=127.0.0.1
/var/tmp/exercise_chaining_flag.txt

http://ci-sandbox:80/nodejs/index.js?ip=127.0.0.1|cat /var/tmp/exercise_chaining_flag.txt
```
![[Pasted image 20241029214508.png]]

-------------
#### 11.2. Dealing with Common Protections
