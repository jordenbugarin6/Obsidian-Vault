This Learning Unit covers the following Learning Objectives:

1. Understand the concept of CORS
2. Understand the common headers found on CORS requests
3. Understand the common headers found on CORS responses

In its simplest terms, CORS instructs a browser, via headers, which origins may access resources from the server. It allows web applications to intentionally loosen SOP restrictions on themselves by specifying which external domains can access resources and how those resources can be accessed. Remember, the SOP blocks JavaScript and our browsers from accessing cross-origin resources, but it does not block the outgoing requests for such resources. When misconfigured, attackers can exploit CORS to perform actions in a user's session through client-side attacks, similar in concept to CSRF. Let's start out by reviewing some CORS fundamentals before we cover some misconfigurations.

---------------
#### 6.5.1. Anatomy of the CORS Request

Before sending the actual cross-origin request, the browser makes a _preflight_ request to the intended destination using the OPTIONS HTTP method to determine if the requesting domain may perform the requested action.

Sample Preflight Request:
```html
OPTIONS /foo HTTP/1.1
Host: megacorpone.com
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Connection: keep-alive
Origin: https://offensive-security.com
Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-UserId
```

All cross-origin requests, including the preflight request, include an _Origin_ header with the value of the domain initiating the request. A preflight request may also include _Access-Control-Request-Method_ and _Access-Control-Request-Headers_ headers to indicate what HTTP method and request headers the browser will include on the actual request. The server will process these headers and respond with the allowed values.

Some cross-origin requests do not trigger a preflight request. These are known as _simple requests_,[1](https://portal.offsec.com/courses/web-200-28380/learning/cross-origin-attacks-30961/cross-origin-resource-sharing-cors-31323/anatomy-of-the-cors-request-30977#fn-local_id_124-1) which include standard GET, HEAD, and POST requests. However, other request methods, requests with custom HTTP headers, or POST requests with nonstandard content-types will require a preflight request.



(Mozilla, 2021), [https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple_requests](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple_requests) [↩︎](https://portal.offsec.com/courses/web-200-28380/learning/cross-origin-attacks-30961/cross-origin-resource-sharing-cors-31323/anatomy-of-the-cors-request-30977#fnref-local_id_124-1)

-------------------
#### 6.5.2. Response Headers

Servers can set several headers[1](https://portal.offsec.com/courses/web-200-28380/learning/cross-origin-attacks-30961/cross-origin-resource-sharing-cors-31323/anatomy-of-the-cors-request-30977#fn-local_id_126-1) to enable CORS. Let's review the most commonly encountered ones.

Sample Preflight Response:
```
HTTP/1.1 200 OK
Server: nginx/1.14.0 (Ubuntu)
Date: Wed, 23 Jun 2021 17:38:47 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 0
Connection: close
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Allow-Origin: https://offensive-security.com
Access-Control-Allow-Credentials: true
Access-Control-Allow-Headers: X-UserId
```

The `Access-Control-Allow-Origin` header indicates which origins are allowed to access resources from the server. A wildcard value `(*)` used in this header indicates any origin can access the resource. Generally, servers should only use this setting for resources that are considered publicly accessible. The header can also specify a single origin. If an application needs to allow multiple origins to access it, the application must contain logic to respond with the appropriate domain 

The _Access-Control-Allow-Credentials_ header indicates if the browser should include credentials, such as cookies or authorization headers. The only valid value for this header is "true". Instead of setting a "false" value, servers can simply omit the header. A web application must set a non-wildcard value in the _Access-Control-Allow-Origin_ header if it wishes to set _Access-Control-Allow-Credentials_ to "true". However, the browser will enforce the _SameSite_ attribute on any cookies that it would send cross-origin regardless of the destination's CORS settings. In other words, if the cookie has _SameSite=Lax_, the browser will not send it even if the preflight request indicates that the destination server allows credentials on CORS requests.

The _Access-Control-Allow-Methods_ header indicates which HTTP methods cross-origin requests may use. The header value can contain one or more methods in a comma-separated list.

Similarly, the _Access-Control-Allow-Headers_ header indicates which HTTP headers may be used on a cross-origin request. The header value can contain one or more header names in a comma-separated list. Browsers will consider some headers safe, such as Content-Type, and therefore, always use them in cross-origin requests.[2](https://portal.offsec.com/courses/web-200-28380/learning/cross-origin-attacks-30961/cross-origin-resource-sharing-cors-31323/response-headers-30968#fn-local_id_126-2) However, servers must use the _Access-Control-Allow-Headers_ header to allow the _authorization_ header or custom headers on CORS requests.

(Mozilla, 2021), [https://developer.mozilla.org/en-US/docs/Glossary/CORS#cors_headers](https://developer.mozilla.org/en-US/docs/Glossary/CORS#cors_headers) [↩︎](https://portal.offsec.com/courses/web-200-28380/learning/cross-origin-attacks-30961/cross-origin-resource-sharing-cors-31323/response-headers-30968#fnref-local_id_126-1)
(Mozilla, 2021), [https://developer.mozilla.org/en-US/docs/Glossary/CORS-safelisted_request_header](https://developer.mozilla.org/en-US/docs/Glossary/CORS-safelisted_request_header) [↩︎](https://portal.offsec.com/courses/web-200-28380/learning/cross-origin-attacks-30961/cross-origin-resource-sharing-cors-31323/response-headers-30968#fnref-local_id_126-2)