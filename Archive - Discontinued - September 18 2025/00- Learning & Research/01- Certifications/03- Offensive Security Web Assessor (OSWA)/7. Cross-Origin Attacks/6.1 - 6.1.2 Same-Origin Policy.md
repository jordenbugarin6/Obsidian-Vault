
This Learning Unit covers the following Learning Objectives:

1. Understand what an origin is
2. Understand the Same-Origin Policy and how it interacts with cross-origin requests

-------------
#### 6.1.1. Accessing CORS Sandbox

In this Learning Module, we'll use two applications to learn about cross-origin attacks:

- **CORS Sandbox**: A custom sandbox application with CORS and Fetch API functionality.
- **Apache OFBiz**: An open sourceÂ _Enterprise Resource Planning_Â (ERP) application, which is vulnerable to CSRF.

We'll access these applications viaÂ /etc/hostsÂ file entries on our Kali Linux VM.

```bash
@kali:~$ sudo mousepad /etc/hosts

kali@kali:~$ cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       kali

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

192.168.50.101  cors-sandbox
192.168.50.110  ofbiz
```

For now, we only need to start the CORS Sandbox machine listed below and make the corresponding IP address update on our Kali machine before starting our work. We'll use this VM in this Learning Unit and revisit it in a later Learning Unit.

## Resources

Some of the labs require you toÂ start the target machine(s)Â below.

Please note that the IP addresses assigned to your target machines may not match those referenced in the Module text and video

| CORS Sandbox 1 | 192.168.167.101 |     |
| -------------- | --------------- | --- |
##### Labs
![[Pasted image 20240812172321.png]]
Ping
```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[12Aug2024 21:11:09]-[/home/kali]                                                                                                                                   
â””â”€# ping cors-sandbox                                                                                                                                                                                      
PING cors-sandbox (192.168.167.101) 56(84) bytes of data.                                                                                                                              
64 bytes from cors-sandbox (192.168.167.101): icmp_seq=1 ttl=61 time=43.4 ms                                                                                                           
64 bytes from cors-sandbox (192.168.167.101): icmp_seq=2 ttl=61 time=43.8 ms 
```
Nmap
```bash
â”Œâ”€â”€(rootðŸ’€gobots)-[12Aug2024 21:11:14]-[/home/kali]                                                                                                                                   
â””â”€# nmap -Pn -sV cors-sandbox                                                                                                                                                          
Nmap scan report for cors-sandbox (192.168.167.101)                                                                                                                                                        
PORT     STATE SERVICE  VERSION                                                                                                                                                        
22/tcp   open  ssh      OpenSSH 8.3p1 Ubuntu 1ubuntu0.1 (Ubuntu Linux; protocol 2.0)                                                                                                   
80/tcp   open  http     Golang net/http server (Go-IPFS json-rpc or InfluxDB API)                                                                                                      
443/tcp  open  ssl/http Pylons Waitress WSGI server                                                                                                                                    
8000/tcp open  http-alt waitress    
```
Curl -i
![[Pasted image 20240812172534.png]]


-------------
#### 6.1.2 Introduction to the Same-Origin Policy

An origin is the combination of a protocol, hostname, and port number. Browsers enforce a same-origin policy to prevent one origin from accessing resources (images, HTML, data, JSON, etc.) on a different origin.

Without the same-origin policy, the web would be a much more dangerous place, allowing any website we visit to read our emails, check our bank balances, and view other information even from our logged-in sessions.

In other words,Â megacorpone.comÂ can have a link toÂ kali.org, but it cannot directly load the HTML content. This might seem confusing since plenty of websites have images, scripts, and other resources loaded from third-party origins. However, the purpose of SOP is not to prevent the browser from sending a request for a resource, but to prevent JavaScript from reading the response.

In other words, SOP allows images, IFrames, and other resources to be loaded onto the page, while blocking the JavaScript engine from accessing the contents of a response.

This is functionally similar to theÂ _HttpOnly_[1](https://portal.offsec.com/courses/web-200-28380/learning/cross-origin-attacks-30961/same-origin-policy-31314/accessing-the-cors-sandbox-31007#fn-local_id_111-1)Â cookie flag, which prevents JavaScript from accessing the cookie, but allows the browser to send it with HTTP requests.

We can test this behavior in the sandbox application atÂ `https://cors-sandbox/fetch`. Let's use Burp Suite's embedded browser so that we can review the HTTP requests that the web page generates.

![[Pasted image 20240812175002.png]]

This application uses theÂ _Fetch_[2](https://portal.offsec.com/courses/web-200-28380/learning/cross-origin-attacks-30961/same-origin-policy-31314/introduction-to-the-same-origin-policy-30978#fn-local_id_166-2)Â API to send GET requests to a URL that we specify. We can also dynamically insert images into the page. We'll start exploring cross-origin requests by using the application to send a request toÂ `https://www.megacorpone.com/`. We'll enter the URL in the application and clickÂ _Send Request_.

![[Pasted image 20240812175050.png]]
Our request failed. Let's check the browser's console for more information. We will open the developer tools withÂ `CTRL + SHIFT + I`Â and then click onÂ _Console_.

![[Pasted image 20240812175147.png]]

Since the target domain does not have a CORS policy, the browser blocks JavaScript from accessing the response. However, if we check the HTTP history tab in Burp Suite, we will find that our browser did send the request and it received a response.

![[Pasted image 20240812175334.png]]

It is important to remember that SOP blocks JavaScript from accessing a response but it does not block the outgoing request.

Let's try to load an image. We previously mentioned that SOP allows images to be loaded cross-origin. However, it is important to note that this is allowed for image tags within HTML. If we attempt to load an image cross-domain with JavaScript, SOP should block JavaScript from accessing the response (unless it has been specifically allowed by CORS).

We will enterÂ `https://www.megacorpone.com/old-site/nano.jpg`Â in the URL field and again clickÂ _Send Request_.

![[Pasted image 20240812175457.png]]
We received the same error message. But what happens if we use the URL in an image tag? Let's close the Developer Tools by clicking theÂ _X_Â in the upper right-hand corner and then clickÂ _Embed Image_.

![[Pasted image 20240812175602.png]]
The page embedded the image in the HTML and our browser loaded and displayed it. The important distinction here is that SOP blocks JavaScript from accessing the response of a cross-origin request, but the request is still sent. In some instances, simply sending a request can be enough to trigger some sort of state-change in a web application. CORS can be used to selectively relax SOP, which we will explore later in this Learning Module.

In most applications, requests that perform an action require authentication. While browsers previously sent the cookie for every request, this has recently changed with the addition of the SameSite attribute on cookies.

Before continuing to the next section, make sure to follow the steps above and practice sending cross-origin requests with the sandbox application and inspecting the results.

-----------
(Mozilla, 2021),Â [https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/cross-origin-attacks-30961/same-origin-policy-31314/introduction-to-the-same-origin-policy-30978#fnref-local_id_166-1)
(Mozilla, 2021),Â [https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)Â [â†©ï¸Ž](https://portal.offsec.com/courses/web-200-28380/learning/cross-origin-attacks-30961/same-origin-policy-31314/introduction-to-the-same-origin-policy-30978#fnref-local_id_166-2)